<!DOCTYPE html>
<html lang="ar" dir="rtl" style="zoom:99%;">
<head>
    <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
 
<!-- Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø­ÙˆØ§Ù Ø§Ù„Ù†ÙˆØªØ´ -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>CarPlay</title>
   
    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for modern, customizable SVG icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome for additional icons (e.g., Trip log) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Chart.js for the new weekly forecast chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  

    <!-- YouTube Iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <link 
        rel="stylesheet" 
        href="https://dmusera.netlify.app/carplay.css" 
        media="print" 
        onload="this.media='all'"
    >
    <style>
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
#bottom-left-controls {
    display: none !important;
}
/* ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ù…Ø®ØªØ§Ø± */
.grid-item:focus, .navigable:focus {
    transform: scale(1.08) !important;
    border: 3px solid #0A84FF !important; /* Ø£Ø²Ø±Ù‚ CarPlay */
    box-shadow: 0 0 20px rgba(10, 132, 255, 0.6) !important;
    z-index: 100;
}

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± Ù„Ù…Ù†Ø¹ ØªØ´ØªÙŠØª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.tab-content, .reader-container {
    scrollbar-width: none;
    -ms-overflow-style: none;
}
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
.carousel-slide span[id*="-day-big"], 
#carplay-weather-temp-big {
    font-size: 5rem; /* Ø­Ø¬Ù… Ø¶Ø®Ù… */
    font-weight: 900;
    line-height: 1;
    display: block;
    background: linear-gradient(to bottom, #ffffff, #a5a5a5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4));
}

/* Prevent focus ring clipping in scrolled containers */
.favorites-dashboard-horizontal-scroll, 
.scroll-viewport {
    overflow-y: visible !important;
    padding-top: 15px !important;
    padding-bottom: 15px !important;
}

/* Clear visual indicator for Remote users */
.navigable:focus {
    transform: scale(1.1) translateY(-5px) !important;
    outline: 4px solid #0A84FF !important;
    z-index: 100 !important;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6) !important;
}

div#weather-widget-container {
    padding: 1.2px!important;
}

.absolute.bg-black\/70.backdrop-blur-md.p-3.min-h-\[40\%\].flex.items-center.overflow-hidden {
    width: 100%;
    bottom: 0px;
    height: 20%;
}


/* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ù‡ÙˆØ± ØªØ­Øª Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
.carousel-slide span[id*="-month-text"] {
    font-size: 1.5rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.8);
    margin-top: -5px;
}

#carplay-carousel-container {
    perspective: 1000px;
}

.grid.grid-cols-3.gap-1.w-full.mt-1 {
    margin-top: 4.25rem!important;
}

span#greg-day-num {
    transform: scale(2);
    filter: none!important;
    opacity: 70%;
}



div#weather-widget-container {
    width: 100% !important;
    height:40%  !important;
}

.carousel-slide, .carousel-slide-dash {
    position: absolute !important;
    inset: 0;
    display: flex !important;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 1s cubic-bezier(0.4, 0, 0.2, 1), 
                transform 1s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0;
    visibility: hidden;
    transform: scale(0.95) translateY(10px);
}

.carousel-slide.active, .carousel-slide-dash.active {
    opacity: 1;
    visibility: visible;
    transform: scale(1) translateY(0);
    z-index: 10;
}


.carousel-slide.hidden , .carousel-slide-dash.hidden {
    display: none;
}

#carplay-mini-map, #video-popup-container {
    transform: translateZ(0); /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø³Ø­Ø±ÙŠ ÙŠØ¹Ø²Ù„ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø·Ø¨Ù‚Ø© GPU Ø®Ø§ØµØ© */
    backface-visibility: hidden;
    perspective: 1000;
}
#screen-DashboardCarPlay .glass-surface {
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.4s ease;
}
#dashboard-google-map {
    /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø³Ø±ÙŠØ¹ */
    backface-visibility: hidden;
    transform: translate3d(0, 0, 0);
    -webkit-perspective: 1000;
}

#screen-DashboardCarPlay .navigable:focus {
    transform: scale(1.02);
    border: 2px solid rgba(255, 255, 255, 0.5) !important;
    box-shadow: 0 0 40px rgba(59, 130, 246, 0.4) !important;
}

@keyframes pulse-slow {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.02); opacity: 0.9; }
}

.animate-pulse-slow {
    animation: pulse-slow 4s infinite ease-in-out;
}

#carplay-prayer-mini-grid .prayer-item {
    background: rgba(255,255,255,0.03);
    border-radius: 1rem;
    padding: 8px;
    text-align: center;
}

/* 1. Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ³Ø±Ù‰ (Pause, Zoom) ÙÙ‚Ø· ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ */
body.app-Radio-active #bottom-left-controls {
    display: flex !important;
}

/* 2. Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± KEY 1/2 (ÙØ­Øµ Ø§Ù„Ù…ÙØ§ØªÙŠØ­) ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
body.app-Dashboard-active #manual-key-switcher {
    display: flex !important;
}

/* 3. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„ØµÙˆØªÙŠØ© ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù† Ù…Ø§Ø¹Ø¯Ø§ Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒØ¨ÙŠØ±Ø©) */
body.app-Media-active #floating-minimized-video-button {
    opacity: 0.1; /* Ø¬Ø¹Ù„Ù‡Ø§ Ø´ÙØ§ÙØ© Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ù„ÙƒÙŠ Ù„Ø§ ØªØ­Ø¬Ø¨ Ø§Ù„ØªØ§Ø¨Ø§Øª */
    pointer-events: none;
}

div#universal-date-display>.date-wrapper>span.day-highlight {
    font-size:3.4rem!important;
}

div#universal-date-display>.date-wrapper>.date-details {
      font-size:3.4rem!important;
}

.date-wrapper>span.day-highlight {
    font-size:1.8rem!important;
    color:white;
}

.date-wrapper>.date-details {
      font-size:1.3rem!important;
    color:white;
}

.gmnoprint.gm-bundled-control.gm-bundled-control-on-bottom {
    bottom: 16rem!important;
}

span#carplay-weather-temp-big {
    background: #ffffffb0;
    -webkit-background-clip: text;
    position: fixed;
}
/* ØªØ­Ø±ÙŠØ± Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª */
.suggestions-main-wrapper {
    overflow: visible !important; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¨Ø±ÙˆØ² ÙÙˆÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙˆØºÙŠØ±Ù‡Ø§ */
    width: 100%;
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙŠ ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ */
.scroll-viewport {
    width: 200vw !important; /* Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¨ÙƒØ§Ù…Ù„ Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© */
    margin-left: calc(-68vw + -100%); /* ØªÙ‚Ù†ÙŠØ© Ù„ØªÙˆØ³ÙŠØ· Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙˆØªÙˆØ³ÙŠØ¹Ù‡Ø§ */
    overflow-x: auto !important;
    overflow-y: visible !important; /* Ø£Ù‡Ù… Ø³Ø·Ø± Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙƒØ±ÙˆØª Ø¨Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„ */
    padding: 40px 0 !important; /* Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙƒØ¨ÙŠØ± (Hover) */
    scrollbar-width: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙÙŠ ÙÙŠØ±ÙÙˆÙƒØ³ */
}

.scroll-viewport::-webkit-scrollbar {
    display: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙÙŠ ÙƒØ±ÙˆÙ… */
}

/* Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø§ ØªÙ‚Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
#favorites-popup-grid {
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: nowrap !important;
    gap: 25px !important;
    padding: 0 100px !important; /* Ù…Ø³Ø§Ø­Ø© Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ */
    overflow: visible !important; 
    width: max-content !important;
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ÙˆÙ‚ÙˆÙ Ø¨Ø§Ù„Ø±ÙŠÙ…ÙˆØª Ø£Ùˆ Ø§Ù„Ù…Ø§ÙˆØ³ */
.simple-suggestion-card {
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
    z-index: 1;
}

.simple-suggestion-card:focus, .simple-suggestion-card:hover {
    transform: scale(1.15) translateY(-10px) !important; /* Ø§Ù„ÙƒØ±Øª Ø³ÙŠØ®Ø±Ø¬ Ù„Ù„Ø£Ø¹Ù„Ù‰ ÙˆÙŠÙƒØ¨Ø± */
    z-index: 100 !important;
    box-shadow: 0 20px 40px rgba(0,0,0,0.5);
}
    .scroll-viewport::-webkit-scrollbar {
    display: none; /* Ø¥Ø®ÙØ§Ø¡ ÙÙŠ Chrome Ùˆ Safari */
}
.scroll-viewport {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}
/* 1. The Container: Enable Horizontal Scrolling */
#favorites-popup-grid {
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: nowrap !important; /* Prevents cards from dropping to next line */
    overflow-x: auto !important;  /* Enables horizontal scroll */
    overflow-y: hidden !important;
    gap: 16px !important;
    width: 100% !important;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS */
    scrollbar-width: none; /* Hides scrollbar in Firefox */
    padding-bottom: 20px !important; /* Extra space for shadow/focus effects */
}

/* 2. Hide Scrollbar for Chrome, Safari and Edge */
#favorites-popup-grid::-webkit-scrollbar {
    display: none;
}

/* 3. The Cards: Fixed Width and No Shrinking */
.simple-suggestion-card {
    flex: 0 0 auto !important; /* CRITICAL: Prevents cards from shrinking to fit the screen */
    width: 200px !important;   /* Set a fixed width for the cards */
    transition: transform 0.2s ease;
}

/* Optional: Focus effect to match dashboard */
.simple-suggestion-card:focus {
    outline: 3px solid #9333ea;
    transform: scale(1.05);
}
        /* 1. ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©: Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† Ø§Ù„Ø§Ø¨Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ div */
/* 1. ØªÙƒØ¨ÙŠØ± Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø²Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
.suggested-d-dashboard-card.navigable.grid-item.p-2 > div {
    position: relative;
    /* Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙƒØ§Ù† 11.1rem Ã— 6.1rem */
    width: 14rem !important;   /* Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    height: 8rem !important;   /* Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    border-radius: 15px;
    overflow: hidden;
    transition: transform 0.3s ease;
}

/* 2. ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ù†ÙØ³Ù‡Ø§ Ù„ØªÙ…Ù„Ø£ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.suggested-d-dashboard-card.navigable.grid-item.p-2 div > img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 15px !important;
    display: block;
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ù€ Bookmark Ø§Ù„Ø¹Ø§Ø¦Ù… */
.dashboard-only-bookmark {
    position: absolute !important;
      width: 42px !important;
    height: 42px !important;
    top: 8px !important;
    right: 8px !important;
    z-index: 10; /* ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© */
    background: rgba(0, 0, 0, 0.5) !important;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 50% !important;
    width: 28px !important;
    height: 28px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: white !important;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* 4. ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ±ÙƒÙŠØ² (Focus) Ù„Ù„Ø±ÙŠÙ…ÙˆØª ÙƒÙ†ØªØ±ÙˆÙ„ */
.dashboard-only-bookmark:focus, 
.dashboard-only-bookmark.tv-focus {
    background: #9333ea !important; /* Ø¨Ù†ÙØ³Ø¬ÙŠ */
    transform: scale(1.1);
    border-color: white !important;
    box-shadow: 0 0 10px rgba(147, 51, 234, 0.8);
    outline: none;
}

/* ØªØµØºÙŠØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¨ÙˆÙƒÙ…Ø§Ø±Ùƒ */
.dashboard-only-bookmark svg {
    width: 14px !important;
    height: 14px !important;
}

/* 5. Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
.suggested-d-dashboard-card.navigable.grid-item.p-2 .video-details,
.suggested-d-dashboard-card.navigable.grid-item.p-2 h6,
.suggested-d-dashboard-card.navigable.grid-item.p-2 p {
    display: none !important;
}

        /* Import Amiri Quran font for Adhkar text */
        @import url('https://fonts.googleapis.com/css2?family=Amiri+Quran:wght@400;700&display=swap');
        /* NEW: Import Amiri font for Thuluth-like style */
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
.simple-suggestion-card.flex.flex-col.gap-2.p-3.rounded-xl.bg-white\/10.cursor-pointer.navigable.grid-item.flex-shrink-0 {
    background: black;
    width: 265px;
    height: 214px;
    border:solid;
}

#suggested-d-dashboard-parent {
    position: relative !important;
    width: 100% !important;
    margin-top: 10px !important;
}

div#manual-key-switcher>button {
    width: 5rem;
    height: 3rem;
}

div#manual-key-switcher {
    bottom: 6rem!important;
    transform: scale(0.7) !important;
}
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø± Ù„ÙŠÙƒÙˆÙ† ÙÙŠ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
.playlist-shuffle-btn {
    position: absolute !important;
    bottom: 47px !important;
    left: 77px !important;
    z-index: 50 !important; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ ÙÙˆÙ‚ Ø§Ù„ÙƒØ±ÙˆØª */
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    background: linear-gradient(135deg, #9333ea 0%, #2563eb 100%) !important;
    color: white !important;
    padding: 8px 16px !important;
    border-radius: 12px !important;
    font-size: 0.9rem !important;
    font-weight: bold !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5) !important;
    cursor: pointer !important;
}

.playlist-shuffle-btn:hover {
    transform: scale(1.05) !important;
    filter: brightness(1.1) !important;
}

.simple-suggestion-card:hover, .simple-suggestion-card:focus {
    transform: scale(1.05) !important;
    background: #1b8a53 !important;
    z-index: 101 !important;
}

.video-popup-player-container {
    position: relative !important;
    overflow: visible !important;
    display: block !important;
    flex-direction: row !important;
    gap: 10px !important;
}
#video-popup-player-container {
  
    height: 155% 1important;
   
}

.simple-suggestion-card.flex.items-center.gap-3.p-2.rounded-lg.bg-white\/10.cursor-pointer.navigable.grid-item {
    display: flex !important;
    flex-direction: row !important; /* Ø§Ù„ØµÙˆØ±Ø© ÙÙˆÙ‚ Ø§Ù„Ù†Øµ */
    flex-shrink: 0 !important; /* Ù‡Ù€Ø§Ù… Ø¬Ø¯Ø§Ù‹: ÙŠÙ…Ù†Ø¹ Ø§Ù†ÙƒÙ…Ø§Ø´ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù„ÙŠØ¨Ù‚Ù‰ Ø¨Ø§Ø±Ø²Ø§Ù‹ Ù„Ù„Ø®Ø§Ø±Ø¬ */
    width: 240px !important; /* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø®Ø¶Ø± */
    height: 140px !important;
    background: #156d41 !important; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± */
    border-radius: 12px !important;
    padding: 8px !important;
    transition: transform 0.2s ease !important;
    border: none !important;
}
.favorites-popup-grid {
    display: flex !important; /* ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ© Ø¥Ù„Ù‰ ØµÙ Ø£ÙÙ‚ÙŠ */
    flex-direction: row !important;
    flex-wrap: nowrap !important; /* Ù…Ù†Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
    gap: 15px !important;
    padding: 10px 5px !important;
    
    /* Ù…ÙŠØ²Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙˆØ§Ù„Ø¨Ø±ÙˆØ² Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
    overflow-x: auto !important; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ */
    overflow-y: visible !important; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¨Ø±ÙˆØ² Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ Ø¥Ù† Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± */
    scrollbar-width: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ ÙÙŠØ±ÙÙˆÙƒØ³ */
    
    /* Ù„Ø¶Ù…Ø§Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙˆØ¨Ø±ÙˆØ²Ù‡Ø§ Ù„Ù„Ø®Ø§Ø±Ø¬ */
    width: auto !important;
    min-width: 100% !important;
}

div#favorites-popup-grid {
    display: flex !important;
    overflow: visible !important;
}

div#video-popup-container {
    overflow: visible !important;
}
        
.suggested-d-dashboard-card.navigable.grid-item.p-2>img {
    height: 9rem !important;
    min-width: 16rem !important;
}

        #suggested-d-dashboard-container {
    display: flex!important;
    flex-direction: row!important;
    justify-content: flex-start!important; 
    
    /* ğŸ›‘ 1. Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ø³Ù…: Ù…Ù†Ø¹ Ø§Ù„Ø§Ù„ØªÙØ§ÙØŒ Ù…Ù…Ø§ ÙŠØ¬Ø¨Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ */
    flex-wrap: nowrap!important; 
    
    /* ğŸ›‘ 2. Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø£ÙÙ‚ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶Ø±ÙˆØ±Ø© */
    overflow-x: auto!important; 
    
    /* ğŸ›‘ 3. Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºÙ‹Ø§ */
    overflow-y: hidden!important;
    
    gap: 16px!important; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
}
#suggested-d-dashboard-container {
    display: flex;
    flex-direction: row; /* Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ ØµÙ */
    justify-content: flex-start; /* Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±/Ø§Ù„ÙŠÙ…ÙŠÙ† */
    flex-wrap: wrap; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙ Ø¬Ø¯ÙŠØ¯ */
    /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§ */
    justify-content: space-evenly !important; 
}

/* Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¹Ø±Ø¶ Ù„Ø¶Ù…Ø§Ù† Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¹Ù†Ø§ØµØ± */
div#suggested-d-dashboard-row {
    min-width: 99%;
}

section#screen-Dashboard>div {
    width: 98%;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ± (ØªÙ… ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…ÙØ­Ø¯Ø¯ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) */
/* ÙŠÙØªØ±Ø¶ Ø£Ù† Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª ØªØ³ØªØ®Ø¯Ù… ÙƒÙ„Ø§Ø³ 'suggested-video-card' */
.suggested-video-card > img,
.suggested-d-dashboard-card.navigable.grid-item > img,
.fav-d-dashboard-card.navigable.grid-item > img {
    width: 11.1rem !important;
    height: 6.1rem !important;
}

/* ğŸ›‘ ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
h6.mb-0.text-truncate,
.video-details.flex-grow-1,
.flex.flex-col.flex-grow.min-w-0.h-full.justify-between.ml-2 {
    display: none !important;
}

@keyframes marquee {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}

.animate-marquee {
    display: inline-block;
    animation: marquee 8s linear infinite;
    padding-left: 10%;
}

/* Ù„Ø³Ø·Ø±ÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ Ù‚ØµÙŠØ±Ø§Ù‹ */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    white-space: normal !important;
}

#fav-d-dashboard-container{justify-content:space-evenly!important;}

div#fav-d-dashboard-container {
    display: flex;
}
.fav-d-dashboard-card.navigable.grid-item>img {width: 11.1rem!important;height: 6.1rem!important;}

.flex.flex-col.flex-grow.min-w-0.h-full.justify-between.ml-2 {
    display: none;
}

button#floating-mic-button {
    bottom: 32px !important;
    position: relative;
}

.dashboard-main-grid.grid.grid-cols-1.md\:grid-cols-3.grid-rows-\[80\%_20\%\].gap-4.md\:gap-6.h-full.w-full.grid-container {
    overflow: scroll;
}
section#screen-Dashboard {
    padding: 20px;
    border: 0px;
    margin: 0px;
    height: 110% !important;
}
 #floating-media-button {
        padding: 0px!important;
    }

img.w-full.h-full.object-contain.p-1 {
    width: 65px!important;
}

#bottom-left-controls {
    /* ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù†Ù…Ø§Ø· inline ÙÙŠ HTML Ù„ØªÙƒÙˆÙ† Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹ØŒ ÙˆÙ„ÙƒÙ† Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: */
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    padding: 10px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù… Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
#bottom-left-controls button {
    display: flex;
    align-items: center;
    justify-content: center;
    /* ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© ÙÙŠ HTML) ... */
}

button#add-video-by-url-btn {
    position: fixed;
    bottom: 76px;
    right: 30px;
}
/* --- START: Last Watched & History Styles --- */
/* --- START: Fullscreen Toggle Button Styles --- */
img#dashboard-weather-icon {
    border-radius: 50px;
}

.simple-suggestion-card.flex.items-center.gap-3.p-2.rounded-lg.bg-white\/10.cursor-pointer.navigable.grid-item {
    width: 50%;
}

/* 2. Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© (Ù„Ø¶Ø¨Ø· Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯) */
.favorites-popup-card .thumbnail-container,.simple-suggestion-card {
    width: 100%;
    /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø³Ø¨Ø© Ø£Ø¨Ø¹Ø§Ø¯ Ù‚ÙŠØ§Ø³ÙŠØ© (16:9) */
    aspect-ratio: 16 / 9;
    position: relative;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    overflow: hidden;
}

/* 3. Ø§Ù„ØµÙˆØ±Ø© (ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§ÙˆÙŠØ©) */
.simple-suggestion-card>img {
    width: 101%;
    height: 100%;
    object-fit: cover;
}

h4.font-semibold.text-sm.truncate.text-white {
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 0.1rem;
    z-index: 1000;
}
.favorites-popup-card .title-overlay p {
    font-size: 0.8rem; 
}

.simple-suggestion-card>.min-w-0.flex-grow{
    position: absolute;
    bottom: 2px;
    background: linear-gradient(45deg, black, #2a1f1f91);
}


div#favorites-popup-grid {
 display: ruby;
}

span.text-xs.text-white\/50.flex-shrink-0 {
    position: absolute;
    bottom: 2px;
}

#floating-minimized-video-button {
    width: 320px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ 3 Ø£Ø²Ø±Ø§Ø± */
    height: auto;
    padding: 0.4rem;
    gap: 0.4rem;
    display: flex;
    align-items: center;
    border-radius: 9999px; /* Ø´ÙƒÙ„ ÙƒØ¨Ø³ÙˆÙ„Ø© */
    /* ... (Ø¨Ù‚ÙŠØ© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©) ... */
}
#video-popup-container {
    right: 4rem !important;
}

#universal-date-display {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px 0;
    margin-top: auto; /* ÙŠØ¯ÙØ¹Ù‡ Ù„Ø£Ø³ÙÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
    clear: both;
}

.date-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(255, 255, 255, 0.03);
    padding: 10px 30px;
    border-radius: 50px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.day-highlight {
    font-size: 1.4rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 4px;
}

.date-details {
    display: flex;
    gap: 10px;
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.6);
    white-space: nowrap;
}

.separator {
    color: #a855f7;
    font-weight: bold;
}

.hijri-text {
    color: #c084fc; /* Ù„ÙˆÙ† Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø§Ù„Ù…Ù…ÙŠØ² */
}

/* ØªØ­Ø³ÙŠÙ† Ù„Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
@media (max-width: 600px) {
    .date-details {
        flex-direction: column;
        gap: 2px;
    }
    .separator {
        display: none;
    }
}
#floating-minimized-video-button .rate-btn {
    /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø±Ø¨Ø¹ ØµØºÙŠØ± ÙˆÙ…Ø¯Ù…Ø¬ */
    width: 40px !important;
    height: 40px !important;
    padding: 0;
    font-size: 0.65rem; 
    font-weight: bold;
    color: white;
    background-color: rgba(0, 0, 0, 0.4); /* Ø®Ù„ÙÙŠØ© Ø®Ø§Ù…Ù„Ø© */
    border: none;
    border-radius: 6px;
    opacity: 0.7;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

/* ğŸš€ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø· (Active Rate Style) - ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø²Ø± ÙŠØ¨Ø±Ø² */
#floating-minimized-video-button .rate-btn.active-rate {
    background-color: #FACC15 !important; /* Ù„ÙˆÙ† Ø£ØµÙØ± Ø³Ø§Ø·Ø¹ */
    color: black !important;
    opacity: 1;
    box-shadow: 0 0 8px rgba(250, 204, 21, 0.8); /* ØªÙˆÙ‡Ø¬ Ø¨Ø§Ø±Ø² */
}
/* ğŸš€ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø· (Active Rate Style) - CRITICAL */


div#channel-search-results {
    width: 100%;
}

.fullscreen-toggle-button {
    /* Positioning the button inside the section, usually top right */
    position: absolute; 
    bottom: 1rem;
    left: 1rem;
    z-index: 99;
     /* Ensure it's above content but below floating buttons (like popup video) */
    
    /* Aesthetic styling (can be adjusted to match your glass-surface style) */
    background-color: rgba(255, 255, 255, 0.1); 
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    backdrop-filter: blur(5px);
    transition: all 0.3s ease;
}

img#dash-nasa-moon {
    HEIGHT: 9REM;
    WIDTH: 9REM;
}


/* --- CSS Required for Traffic Buttons --- */

.home-traffic-btn {
    width: 100%;
    padding: 1rem 0;
    font-size: 0.8rem;
    font-weight: bold;
    border-radius: 12px;
    transition: background-color 0.3s ease;
}

/* ğŸ›‘ Ø£Ù„ÙˆØ§Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù… (ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡Ø§ ÙÙŠ JavaScript) */
.traffic-green { background-color: #10B981; color: white; }
.traffic-yellow { background-color: #FBBF24; color: black; }
.traffic-red { background-color: #EF4444; color: white; }
.traffic-unknown { background-color: #6B7280; color: white; }
/* --- CSS Ù„ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ --- */

/* ğŸ’¡ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ù„Ù„Ø³Ø±Ø¹Ø© */


div#add-reciter-prompt-content {
    max-width: 98%;
}

.fullscreen-toggle-button:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}


/* --- CSS Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´ÙƒÙ„ Ø§Ù„Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø§Ù„Ù…ØªÙ†Ø§Ø¸Ø± --- */
#direction-controls-3d button.active-direction {
    /* 1. Ø§Ù„ØªÙˆÙ‡Ø¬ ÙˆØ§Ù„Ø­Ø¯: Ø¥Ø¶Ø§Ø¡Ø© Ø²Ø±Ù‚Ø§Ø¡ Ù‚ÙˆÙŠØ© */
    outline: 3px solid #0A84FF !important; 
    box-shadow: 0 0 18px rgba(10, 132, 255, 0.8), /* ØªÙˆÙ‡Ø¬ Ø®Ø§Ø±Ø¬ÙŠ Ù‚ÙˆÙŠ */
                inset 0 0 8px rgba(255, 255, 255, 0.3); /* Ø¥Ø¶Ø§Ø¡Ø© Ø¯Ø§Ø®Ù„ÙŠØ© */
                
    /* 2. Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ø®Ù„ÙÙŠØ©: Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø²Ø±Ù‚Ø§Ø¡ */
    background-color: rgba(10, 132, 255, 0.4) !important; 
    color: white !important;
    
    /* 3. Ø§Ù„Ø­Ø±ÙƒØ©: ØªÙƒØ¨ÙŠØ± Ø®ÙÙŠÙ */
    transform: scale(1.08); /* ØªÙƒØ¨ÙŠØ± Ù…Ù„Ø­ÙˆØ¸ */
}

/* ğŸ’¡ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù†Ø¯ Ù…Ø±ÙˆØ± Ø§Ù„ÙØ£Ø±Ø© (Hover) */
#direction-controls-3d button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.4); 
    cursor: pointer;
}

/* 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ© Grid */
#direction-controls-3d {
    transform:scale(0.8);
    /* ğŸ›‘ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù…ØªÙ†Ø§Ø¸Ø±Ø© (Ù…Ø«Ù„Ø§Ù‹: 50px Ù„ÙƒÙ„ Ø²Ø± Ùˆ 10px Ù…Ø³Ø§ÙØ©) */
    grid-template-columns: repeat(3, 50px) !important; 
    width: 170px !important; /* 3*50px + 2*10px gap = 170px */
    height: 170px !important; 
    gap: 10px !important; 
  /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„ÙŠÙ…ÙŠÙ† */
    /* Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§ (1, 2, 3, 4, 5, 6, 7, 8, 9) */
}

/* 2. Ø¶Ù…Ø§Ù† Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ ÙˆØ§Ù„Ø­Ø¬Ù… Ø§Ù„Ø«Ø§Ø¨Øª Ù„ÙƒÙ„ Ø²Ø± */
#direction-controls-3d button {
    width: 50px !important; 
    height: 50px !important; 
    border-radius: 50% !important; 
    margin: 0 !important; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ø³Ù„Ø¨ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
    padding: 0; 
}

/* ğŸš€ 3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø²Ø§Ø­Ø© (Transform) Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ÙŠØ· Ø¯Ø§Ø¦Ø±ÙŠ ÙˆÙ‡Ù…ÙŠ */
/* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø²Ø§Ø­ØªÙ‡Ø§ Ù‡ÙŠ (Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø± + Ø§Ù„Ù…Ø³Ø§ÙØ©) / 2 = (50px + 10px) / 2 = 30px */
/*
   Ø§Ù„ØªØ±ØªÙŠØ¨ (RTL Grid Index):
   [1] NE | [2] N | [3] NW
   [4] E  | [5] X | [6] W
   [7] SE | [8] S | [9] SW
*/

/* N (Ø§Ù„ØªØ±ØªÙŠØ¨ 2): Ø¥Ø²Ø§Ø­Ø© Ù„Ù„Ø£Ø³ÙÙ„ ÙÙ‚Ø· */
#direction-controls-3d button:nth-child(2) { transform: translate(-50px,-20px); }

/* S (Ø§Ù„ØªØ±ØªÙŠØ¨ 8): Ø¥Ø²Ø§Ø­Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ ÙÙ‚Ø· */
#direction-controls-3d button:nth-child(8) { transform: translate(-112px,20px); }

/* E (Ø§Ù„ØªØ±ØªÙŠØ¨ 4): Ø¥Ø²Ø§Ø­Ø© Ù„Ù„ÙŠØ³Ø§Ø± ÙÙ‚Ø· (Ù†Ø­Ùˆ Ø§Ù„Ù…Ø±ÙƒØ²) */
#direction-controls-3d button:nth-child(4) { transform: translate(-20px, 0px); }

/* W (Ø§Ù„ØªØ±ØªÙŠØ¨ 6): Ø¥Ø²Ø§Ø­Ø© Ù„Ù„ÙŠÙ…ÙŠÙ† ÙÙ‚Ø· (Ù†Ø­Ùˆ Ø§Ù„Ù…Ø±ÙƒØ²) */
#direction-controls-3d button:nth-child(6) { transform: translate(-140px, -0px); }


/* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø·Ø±ÙŠØ© (ØªØªØ·Ù„Ø¨ Ø¥Ø²Ø§Ø­Ø© Ø¹Ù„Ù‰ ÙƒÙ„Ø§ Ø§Ù„Ù…Ø­ÙˆØ±ÙŠÙ† X Ùˆ Y) */
/* NE (Ø§Ù„ØªØ±ØªÙŠØ¨ 1): Ù„Ù„Ø£Ø³ÙÙ„ (Y+) ÙˆÙ„Ù„ÙŠØ³Ø§Ø± (X-) */
#direction-controls-3d button:nth-child(1) { transform: translate(-50px, 3px); }

/* NW (Ø§Ù„ØªØ±ØªÙŠØ¨ 3): Ù„Ù„Ø£Ø³ÙÙ„ (Y+) ÙˆÙ„Ù„ÙŠÙ…ÙŠÙ† (X+) */
#direction-controls-3d button:nth-child(3) { transform: translate(-50px, 1px); }

/* SE (Ø§Ù„ØªØ±ØªÙŠØ¨ 7): Ù„Ù„Ø£Ø¹Ù„Ù‰ (Y-) ÙˆÙ„Ù„ÙŠØ³Ø§Ø± (X-) */
#direction-controls-3d button:nth-child(7) { transform:  translate(70px, 60px); }

/* SW (Ø§Ù„ØªØ±ØªÙŠØ¨ 9): Ù„Ù„Ø£Ø¹Ù„Ù‰ (Y-) ÙˆÙ„Ù„ÙŠÙ…ÙŠÙ† (X+) */
#direction-controls-3d button:nth-child(9) { transform: translate(-110px, -5px); }

/* 4. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ */
#direction-controls-3d .center-spacer {
    display: none;
}

#quran-go-button, #fullscreen-reciters-iframe-btn, #fullscreen-radio-iframe-btn {
    z-index: 999;
    left: 102px;
    bottom: 130px;
}
/* CRITICAL: The class that forces the section to cover the viewport 
*/
  .reader-container {
    direction: rtl!important;
}
        
.is-fullscreen {
    /* Overrides parent containers and positions relative to the viewport */
    position: fixed !important; 
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    z-index: 100 !important; /* Must be high to cover everything else */
    border-radius: 0 !important; /* Removes rounded corners for a true fullscreen feel */
    overflow-y: auto !important; /* Ensure content remains scrollable if needed */
    transition: all 0.5s ease-in-out; /* Smooth transition for the effect */
}

/* Optional: Hide the navigation bar when a screen is fullscreen */
body.fullscreen-mode nav {
    display: none !important; 
}

section#screen-Reciters {
    HEIGHT: 100% ! IMPORTANT;
    PADDING: 1px;
    MARGIN: 0px;
}
/* --- START: Last Watched Carousel (2.5 items) Styles --- */
#last-watched-container {
    width: 100%;
    max-width: 600px; /* Optional: constrain max width for larger screens */
  
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}
 .tabs-container.flex.p-1.rounded-full.bg-black\/20.self-center {
    bottom: 51px!important;
    left: 99px!important;
    position: fixed!important;
     z-index: 1000!important;
}
.iframe-src-button.active {
  background-color: #a855f7; /* Brighter purple for active */
  box-shadow: 0 0 10px rgba(168, 85, 247, 0.7);
}
.flex.gap-2.mt-2.homebtn {
    display: none;
}
button#video-popup-bookmark-button {
    position: fixed;
    left: 2px;
}
div#add-channel-prompt-content {
    max-width: 100%;
}
.video-meta>div>div>img {
    width: 37px!important;
    height: 37px!important;
    border-radius: 70px!important;
}
.video-meta>div {justify-content: right;font-size:1.3rem;}
.video-meta>span {justify-content: right;font-size:1.2rem;}

h3.video-title {
    text-align-last: right;
    font-size:1.3rem;
}
.last-watched-carousel-wrapper {
    position: relative;
    width: 237%;
}
.last-watched-carousel-wrapper {
    direction: ltr;
}
/* NEW: Carousel Navigation Buttons */
        section#screen-Dashboard,section#screen-Media {
        height: 105% !important;
}



.carousel-nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: none; /* Hidden by default */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.carousel-nav-button:hover {
    background-color: rgba(0, 0, 0, 0.6);
    transform: translateY(-50%) scale(1.1);
}
section#screen-Map {
    width: 100% !important;
    height: 100% !important;
}
.carousel-nav-button.prev {
    right: 10px;
     width: 70px;
     height: 70px;
    
}
.carousel-nav-button.next {
     right: 73px;
     width: 70px;
     height: 70px;
}
/* This is the scrollable viewport */
.last-watched-slides-container {
    display: flex;
    gap: 1rem; /* The space between cards */
    overflow-x: auto; /* This enables horizontal scrolling */
    scroll-snap-type: x mandatory; /* This enables snapping behavior */
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    padding: 0.5rem 1rem; /* Adds some vertical and horizontal padding */
    clip-path: inset(-5px -10px -5px -10px); /* Prevents padding from clipping box-shadow */
    scrollbar-width: none; /* Hides scrollbar for Firefox */
}
/* Hides scrollbar for Chrome, Safari, and Opera */
.last-watched-slides-container::-webkit-scrollbar {
    display: none;
}
div#youtube-suggestions {
    overflow: clip;
}
.last-watched-slide {
    flex: 0 0 45%; /* Each slide is ~45% of the container. 2 slides = 90% + gap, leaving the 3rd one partially visible. */
    scroll-snap-align: start; /* Each card will snap to the start of the container when scrolling stops */
    scroll-snap-stop: always; /* Ensures it stops precisely on each snap point */
}

.last-watched-slide .glass-surface {
    width: 100%;
}

/* Ensure text doesn't wrap and overflow awkwardly */
.last-watched-slide h3, .last-watched-slide p {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
button.delete-channel-btn.absolute.bottom-2.right-2.p-1\.5.bg-red-600\/80.hover\:bg-red-500.rounded-full.transition-colors.z-10.navigable.grid-item {
    z-index: 0;
}
/* --- END: Last Watched Carousel Styles --- */
.resume-play-button {
    background-color: rgba(99, 102, 241, 0.8); /* Indigo color */
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
    border: none;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.resume-play-button:hover {
    background-color: rgba(79, 70, 229, 1);
}

.youtube-video-card.is-watched .video-title {
    color: #a5b4fc; /* Lighter, muted color for watched videos */
}

/* --- END: Last Watched & History Styles --- */

/* --- START: Bookmark Styles --- */
.bookmark-button {
    position: absolute;
    top: 8px;
    left: 8px; /* For RTL layout */
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 5;
}
.bookmark-button:hover {
    background-color: rgba(99, 102, 241, 1); /* Indigo */
}
.bookmark-button.saved-d {
    color: #60a5fa; /* Blue 400 */
}
.bookmark-button.saved-m {
    color: #f472b6; /* Pink 400 */
}
.bookmark-button.saved-both {
    background: linear-gradient(45deg, #60a5fa, #f472b6);
    color: white;
}

.favorites-menu {
    position: fixed; /* Use fixed to break out of scrolling containers */
    background-color: rgba(30, 41, 59, 0.9);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    padding: 0.5rem;
    z-index: 150; /* High z-index */
    display: none;
    min-width: 150px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.favorites-menu.show {
    display: block;
}
.favorites-menu button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    text-align: right;
    font-size: 0.9rem;
    color: white;
    background-color: transparent;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s;
}
.favorites-menu button:hover {
    background-color: rgba(71, 85, 105, 0.7);
}

.remove-favorite-button {
    position: absolute;
    top: 8px;
    left: 8px;
    background-color: rgba(220, 38, 38, 0.7); /* Red */
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 5;
}
.remove-favorite-button:hover {
    background-color: rgba(185, 28, 28, 1);
}
/* --- END: Bookmark Styles --- */

div#tv{display:none;}
div#geolocation-error-overlay {
    display: none !important;
}
button#back-to-search-floating-button {
    Z-INDEX: 99999;
}

.search-results-nav {
    width: 50%;
    justify-self: center;
}

.w-full.grid.grid-cols-3.items-center.p-2.sticky.bottom-0.bg-black\/40.backdrop-blur-sm.flex-shrink-0 {
    WIDTH: 50%;
    JUSTIFY-SELF: CENTER;
}



 .flex.flex-wrap.justify-center.gap-2.w-full {zoom: 0.85;}

/* --- Try removing !important from these rules --- */
.tabs-container {
  display: flex; /* Remove !important */
  gap: 0.5rem; /* Remove !important */
  padding: 0.25rem; /* Remove !important */
  border-radius: 9999px; /* Remove !important */
  background-color: rgba(0, 0, 0, 0.8)!important; /* Remove !important */
  align-self: center; /* Remove !important */
  margin-bottom: 1rem; /* Remove !important */
}

button#back-to-playlists-bottom-button-search {
    position: sticky;
    justify-self: anchor-center;
}
        /* Import Inter font for a modern, clean look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Default background gradient - UPDATED: black parts are wider, animation is 3x slower */
            background: linear-gradient(-45deg, #000000 0%, #000000 30%, #00FFFF 35%, #000000 60%, #4B0082 65%, #8A2BE2 70%, #FF00FF 75%, #000000 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite; /* Animation duration decreased to 15s */
            transition: background-image 0.5s ease; /* Smooth transition for background changes */
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Prevent body scroll */
        }
        
div#hourly-forecast-container {
    min-height: 93px;
}
button#tab-tarteel {
    display: none;
}

.flex.items-center.justify-between.w-full.gap-2 {
    direction: rtl;
}
        body.animation-paused {
            animation-play-state: paused !important;
        }
        body.video-playing {
            animation-duration: 75s !important; /* 80% slower animation */
        }
.bg-black2 {
    background-image: linear-gradient(45deg, #000000, #6f6f6f39)!important;
}
        img.max-w-full.max-h-full.object-contain { max-width: 50%;
    mix-blend-mode: hard-light;
}
        /* Ensure RTL direction for specific elements if needed */
        div#youtube-video-list-view, div#youtube-search-results-view {
            direction: rtl;
        }
        div#youtube-readers-section {
            direction: rtl;
        }
        /* Define different background themes for customization */
        body.theme-gradient-1 {
            background: linear-gradient(-45deg, #000000 0%, #000000 30%, #00FFFF 35%, #000000 60%, #4B0082 65%, #8A2BE2 70%, #FF00FF 75%, #000000 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
       
        div#quran-quick-access {
            display: none !important;
        }

        .h-full {
            height: 97% !important;
        }

        /* NEW GLASS SURFACE CSS - Enhanced for liquid 3D effect and "drop glass" */
        .glass-surface {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: opacity 0.26s ease-out;
            border-radius: 1.5rem; /* Ensure rounded corners */
        }
        .glass-surface__filter {
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            inset: 0;
            opacity: 0;
            z-index: -1;
        }

        div#youtube-search-results-view {
    overflow: scroll;
}

/* --- NEW CSS for LARGE Moon Widget --- */

/* Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… ØµÙˆØ±Ø© Ø§Ù„Ù‚Ù…Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ widget */
.moon-icon-large {
    width: 80px;  /* ğŸ‘ˆ Ø­Ø¬Ù… Ø£ÙƒØ¨Ø± Ù„Ù„ØµÙˆØ±Ø© */
    height: 80px; 
    border-radius: 50%; /* ğŸ‘ˆ Ø¶Ù…Ø§Ù† Ø¯Ø§Ø¦Ø±ÙŠØªÙ‡Ø§ */
    object-fit: cover;
    /* Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ÙˆØ¯ Ø¨Ø³ÙŠØ·Ø© Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠ */
    border: 2px solid rgba(255, 255, 255, 0.2); 
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
}

/* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù€ Border Radius Ù„ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ù‚Ù…Ø± Ù„Ø¬Ø¹Ù„Ù‡ Ø£ÙƒØ«Ø± Ù†Ø¹ÙˆÙ…Ø© */
#3d-screen-moon-widget {
    /* ğŸ‘ˆ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù€ padding Ù„Ù„Ø­Ø§ÙˆÙŠØ© */
    padding: 1.5rem !important; 
    
    /* ğŸ‘ˆ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù€ Border Radius Ù„Ù„Ø¹Ù†ØµØ± Ù†ÙØ³Ù‡ */
    border-radius: 2.5rem !important; 
}

/* ğŸ’¡ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø§Ù…: Ø¶Ù…Ø§Ù† Ø£Ù† ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø© ØµØºÙŠØ± Ø§Ù„Ø­Ø¬Ù… */
#3d-screen-weather-widget {
    width: 140px; 
    height: auto; 
    justify-content: flex-start;
}
#3d-screen-weather-widget span {
    font-size: 1.5rem !important; /* ØªØµØºÙŠØ± Ø®Ø· Ø§Ù„Ø­Ø±Ø§Ø±Ø© */
}
#3d-screen-weather-widget svg {
    margin-right: 5px;
}

.glass-surface.glass-surface--svg.youtube-video-card.navigable.grid-item {
    direction: ltr!important;
}


        .glass-surface__content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: inherit;
            position: relative;
            z-index: 1;
        }
        div#geares {
    height: 114px;
}

div#\33 d-screen-weather-widget {
    height: 85px;
    width: 116px;
}
        .glass-surface--svg {
            /* Adjusted background for a more pronounced "drop" effect */
            background: light-dark(hsl(0 0% 100% / var(--glass-frost, 0.1)), /* Slightly more opaque background */
                hsl(0 0% 0% / var(--glass-frost, 0.2))); /* Darker opaque background for dark mode */
            
            /* Enhanced backdrop-filter for stronger blur and saturation */
            backdrop-filter: var(--filter-id, url(#glass-filter)) blur(8px) saturate(1.8) brightness(1.1); /* e.g., 8px instead of 10px */
     -webkit-backdrop-filter: blur(8px) saturate(1.8) brightness(1.1);/* Webkit prefix */

            /* More pronounced box-shadow for a "dropped" effect */
            box-shadow:
                0 0 5px 2px rgba(255, 255, 255, 0.1) inset, /* Inner light glow */
                0 0 15px 6px rgba(0, 255, 255, 0.15) inset, /* Inner cyan glow */
                0px 8px 30px rgba(17, 17, 26, 0.1), /* Stronger outer shadow */
                0px 16px 60px rgba(17, 17, 26, 0.15), /* Even stronger outer shadow */
                0px 24px 80px rgba(17, 17, 26, 0.2), /* Deepest outer shadow */
                inset 0 0 20px 8px rgba(0,0,0,0.3), /* Deeper inner shadow for depth */
                inset 0 0 25px 10px rgba(0,0,0,0.2), /* Even deeper inner shadow */
                0 0 20px rgba(255, 255, 255, 0.15); /* Added subtle outer white glow for "shine" */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Added a subtle white border */
        }
        
        /* Fallback for browsers not supporting backdrop-filter - also enhanced */
        .glass-surface--fallback {
            background: rgba(255, 255, 255, 0.35); /* More opaque fallback */
            backdrop-filter: blur(15px) saturate(2.0) brightness(1.2); /* Stronger fallback blur/saturate */
            -webkit-backdrop-filter: blur(15px) saturate(2.0) brightness(1.2);
            border: 1px solid rgba(255, 255, 255, 0.4); /* Stronger border */
            box-shadow:
                0 10px 40px 0 rgba(31, 38, 135, 0.3), /* Stronger fallback shadow */
                0 4px 20px 0 rgba(31, 38, 135, 0.2),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 0 rgba(255, 255, 255, 0.3);
        }
        @media (prefers-color-scheme: dark) {
            .glass-surface--fallback {
                background: rgba(255, 255, 255, 0.15); /* Dark mode fallback */
                backdrop-filter: blur(15px) saturate(2.0) brightness(1.3);
                -webkit-backdrop-filter: blur(15px) saturate(2.0) brightness(1.3);
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow:
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 0 rgba(255, 255, 255, 0.2);
            }
        }
        @supports not (backdrop-filter: blur(10px)) {
            .glass-surface--fallback {
                background: rgba(255, 255, 255, 0.5); /* Strongest fallback for no backdrop-filter */
                box-shadow:
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.6),
                    inset 0 -1px 0 0 rgba(255, 255, 255, 0.4);
            }
            .glass-surface--fallback::before {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(255, 255, 255, 0.2); /* More opaque overlay */
                border-radius: inherit;
                z-index: -1;
            }
        }
        
        /* TV Remote Focus Style */
        .navigable:focus, .navigable.tv-focus {
            outline: 3px solid #0A84FF !important; /* Use !important to override other outlines */
            box-shadow: 0 0 20px rgba(10, 132, 255, 0.7) !important; /* Use !important */
            transform: scale(1.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }


section#screen-Map>.w-full.h-full.bg-black2.rounded-3xl.flex.items-center.justify-center.p-1.overflow\:hidden {
   
 /* 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    border: 3px solid transparent; /* ğŸ›‘ Ù‡Ø§Ù…: ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¯ */
    border-radius: 1.5rem; /* ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ ØªØµÙ…ÙŠÙ…Ùƒ */
    
    /* 3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¬ (Gradient Border) */
    border-image: linear-gradient(45deg, #00ffff05,#00ffff99 15%, #8a2be200, #ff00ffd9,#00ffff99 , #000000) 1;
    /* Ø§Ù„Ø´Ø±Ø­:
      linear-gradient(45deg, #00FFFF, #8A2BE2, #FF00FF, #000000): ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù†.
      1: ÙŠØ­Ø¯Ø¯ Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ø­Ø¯ (slice width).
    */
    
    /* 4. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø§ ØªÙ…ØªØ¯ Ø¹Ø¨Ø± Ø§Ù„Ø­Ø¯ */
    background-clip: padding-box;
}




.w-full.h-full.bg-black2.rounded-3xl.flex.items-center.justify-center.p-1.overflow\:hidden {}


        /* Keyframe animation for the background gradient */
        @keyframes gradient {
              
          0% {
    background-position: 29.0118% 50%;
  }
  50% {
    background-position: 65.0118% 50%;
  }
    0% {
    background-position: 29.0118% 50%;
  }
        }

        /* Styles for individual app screens */
        .app-screen {
            display: none; /* Hidden by default */
            animation: fadeIn 0.1s ease-in-out; /* Fade-in transition */
            width: 100%;
            height: 100%;
            flex-direction: column;
            border-radius: 1.5rem; /* Ensure app screens have rounded corners */
        }
        .app-screen.active {
            display: flex; /* Display when active */
        }
        
        /* Fade-in animation for screen transitions */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Styling for iframes to fit their containers */
        .full-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 1.5rem;
        }

        .homebtn{display:none}

        /* Floating Button Styles - Positioned and styled for glass effect */
        #floating-media-button,
        #back-to-playlists-bottom-button,
        #back-to-playlists-bottom-button-search,
        #floating-keyboard-button,
        #start-trip-floating-button { 
            position: fixed;
            background-color: rgba(138, 8, 6, 0.5); /* Purple glass */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 9999px; /* Pill shape */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 100; /* Above everything else */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* UPDATED: Clear Search Button style */
        #clear-search-button {
            background-color: rgba(220, 38, 38, 0.6); /* Red glass */
            color: white;
            padding: 0.75rem;
            border-radius: 9999px; /* Pill shape */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #floating-media-button:hover,
        #back-to-playlists-bottom-button:hover,
        #floating-keyboard-button:hover,
        #clear-search-button:hover,
        #start-trip-floating-button:hover {
            transform: scale(1.05); /* Only scale, no translate */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        /* Specific positioning for floating buttons */
        #floating-media-button { bottom: 1rem; right: 1rem; }
        #floating-keyboard-button {
            bottom: 4rem!important;
            right: 5rem; /* Adjusted to be next to media button */
        
        }
        #floating-keyboard-button.active-keyboard {
            background-color: #90EE90; /* Chrome Green */
            color: cyan; /* Black icon */
        }
        #floating-keyboard-button.inactive-keyboard {
            background-color: #FF0000; /* Red */
            color: white; /* White icon */
        }

        #back-to-playlists-bottom-button, #back-to-playlists-bottom-button-search {
            bottom: 1rem;
            left: 50%;
        
            display: none; /* Hidden by default */
        }

        #start-trip-floating-button {
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10B981; /* Green color */
            display: none; /* Hidden by default */
        }

        /* NEW: Style for the minimized video player button */
       /* --- CSS Ù„ØªØ­ÙˆÙŠÙ„ Ø²Ø± Ø§Ù„ØªØµØºÙŠØ± Ø¥Ù„Ù‰ ÙƒØ¨Ø³ÙˆÙ„Ø© Ø£ÙÙ‚ÙŠØ© --- */

#floating-minimized-video-button {
    /* ğŸ›‘ ÙŠØ¬Ø¨ Ø£Ù† ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰ Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    position: fixed;
    bottom: 7rem;
    right: 5rem;
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© */
    display: flex; /* ğŸ‘ˆ Ø¶Ø±ÙˆØ±ÙŠ Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø£ÙÙ‚ÙŠØ§Ù‹ */
    align-items: center;
    gap: 0.5rem;
    width: 44%; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ù„Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© */
    height: 60px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
    padding: 0.5rem;
    
    /* ØªÙ†Ø³ÙŠÙ‚ Glassmorphism (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹) */
    border-radius: 9999px; /* Ø´ÙƒÙ„ ÙƒØ¨Ø³ÙˆÙ„Ø© (Pill Shape) */
    z-index: 105;
    
    /* ğŸ’¡ Ø§Ù„ØªÙˆÙ‡Ø¬ Ù„ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ø£Ù†Ù‡Ø§ ØªØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© */
    box-shadow: 0 0 15px rgba(255, 255, 0, 0.4); 
    transition: all 0.3s ease;
}

/* ğŸ’¡ ÙˆÙŠØ¯Ø¬Øª Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø°ÙŠ ØªÙ… Ù†Ù‚Ù„Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙƒØ§Ù†Ù‡ Ø¢Ù…Ù†Ø§Ù‹ */
#right-side-info-widgets {
    z-index: 100; /* ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© */
}
        


        /* Top bar positioning and transition */
        .top-bar {
            top: 1rem;
            transition: opacity 0.3s ease;
        }

        /* Main CarPlay interface container adjustments */
        #carplay-main-interface {
    position: fixed;
    top: 0%;
    left: 0%;
    width: 100vw;
    height: 100vh;
    transition: all 0.5s ease-in-out;
    border-radius: 2rem;
}

        /* Pseudo-fullscreen class for the CarPlay interface */
        #carplay-main-interface.carplay-pseudo-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            border-radius: 0;
            z-index: 99; /* Ensure it's above other content but below the floating button */
            max-width: 100vw; /* When fullscreen, it should take full width */
        }

        /* Shrink content when in pseudo-fullscreen mode for better fit */
        #carplay-main-interface.carplay-pseudo-fullscreen #digital-time {
            font-size: 2.2rem !important;
        }
        #carplay-main-interface.carplay-pseudo-fullscreen #weather-temp-main {
            font-size: 4rem !important;
        }

        /* Scrollbar styling for better aesthetics */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }

        /* Active app icon styling */
        .app-icon.active {
            background-color: #6b22ff; /* Purple */
            color: white;
            transform: scale(1.1);
        }

        /* Gemini-like Chat Styling */
        .chat-message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem; /* More rounded */
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            font-size: 0.9rem; /* Slightly smaller font for chat */
        }

        .chat-message.user {
            background-color: #4f46e5; /* Blue */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.5rem; /* Pointy bottom right */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .chat-message.ai {
            background-color: #2d3748; /* Darker gray */
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 0.5rem; /* Pointy bottom left */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #ai-input {
            border-radius: 2rem; /* Fully rounded pill shape */
            padding: 0.75rem 1.25rem;
            background-color: rgba(255, 255, 255, 0.15); /* Lighter glass */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        #ai-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        #ai-input:focus {
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.4), 0 0 0 2px rgba(147, 51, 234, 0.5);
        }
        
        /* YouTube Video Card Styling (List View and Search Results) - UPDATED */
        .youtube-video-card, .youtube-search-card {
            display: flex;
            flex-direction: row;
            align-items: flex-start; /* CHANGED to align items to the top */
            padding: 0.75rem;
            border-radius: 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            width: 100%;
            box-sizing: border-box;
            cursor: pointer;
            gap: 1rem;
        }
        .youtube-video-card:hover, .youtube-search-card:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .youtube-video-card .thumbnail-container {
            position: relative;
            width: 180px;  /* INCREASED */
            height: 101.25px; /* INCREASED (16:9 ratio) */
            flex-shrink: 0;
            overflow: hidden; /* Important for progress bar */
        }

        .glass-surface.glass-surface--svg.p-4.rounded-3xl.text-center.flex.flex-col.items-center.justify-center.navigable.grid-item {
    height: 169px;
}
        /* NEW: Styles for Watched Progress Bar */
        .watched-progress-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
        }
        .watched-progress-bar {
            height: 100%;
            background-color: #ef4444; /* Red color */
            border-radius: 0 2px 2px 0;
        }

        /* NEW: Style for Watched Badge */
        .watched-badge {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .youtube-video-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .video-duration {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .video-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
            flex-grow: 1;
            min-width: 0;
        }
        .video-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .video-meta {
            display: flex;
            flex-direction: column;
            gap: 4px; /* Gap between channel line and stats line */
            font-size: 0.8rem;
            color: #a7f3d0; /* A minty color, less harsh than cyan */
            font-weight: 500;
        }

        /* NEW: Explicit scrollbar for search results */
        #search-results-container::-webkit-scrollbar {
            width: 8px;
            display: block; /* Ensure it's always displayed */
        }
        #search-results-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        #search-results-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
        }
        
        /* YouTube Reader Card Styling (Suggestions) - UPDATED */
        .youtube-reader-card {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out;
            border-radius: 1.25rem;
            background-color: rgba(255, 255, 255, 0.05);
        }
        .youtube-reader-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .youtube-reader-card img {
            width: 100px; /* MODIFIED: Increased size */
            height: 100px; /* MODIFIED: Increased size */
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .youtube-reader-card h3 {
            font-size: 1.1rem; /* MODIFIED: Increased font size */
            font-weight: 600;
            color: white;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 95%;
            margin-bottom: 1rem; /* MODIFIED: Increased margin */
        }
        .youtube-reader-card.selected {
            background-color: #9333ea !important;
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.8);
            transform: translateY(-5px) scale(1.05);
        }
        /* UPDATED: Reader container is now a grid */
        .reader-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* MODIFIED: Responsive columns */
            overflow-y: auto;
            padding-bottom: 1rem;
            gap: 1.25rem; /* MODIFIED: Increased gap */
            direction: ltr;
            max-height: 45vh; /* MODIFIED: Increased height */
            width: 100%; /* MODIFIED: Ensure full width */
        }
        .reader-container::-webkit-scrollbar { display: block; }
        .reader-container { -ms-overflow-style: auto; scrollbar-width: thin; }


        /* YouTube Suggestion Buttons (for Surahs) - UPDATED */
        .youtube-suggestion-button {
            color: white;
            padding: 0.25rem 0.75rem; /* Zoomed out padding */
            border-radius: 9999px;
            font-size: 0.75rem; /* Zoomed out font */
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* NEW: Switched to inline-flex for variable width */
            display: inline-flex;
            width: auto;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            position: relative;
            overflow: hidden; /* Keep overflow hidden on the button itself */
        }
        .youtube-suggestion-button:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .youtube-suggestion-button:active {
            transform: translateY(0);
        }
        
        /* NEW: Style for the Surah name text to handle long names */
        .surah-name-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: right; /* Align text to the right for RTL */
        }

        /* NEW: Badge for Juz number */
        .youtube-suggestion-button .juz-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            flex-shrink: 0; /* Prevent badge from shrinking */
            line-height: 1;
            position: relative; /* Allow z-index */
            z-index: 2; /* Ensure it's on top */
        }

        /* YouTube Suggestion Category Tag */
        .youtube-suggestion-category-tag {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
            align-self: flex-start;
        }
        /* NEW: Surah Buttons Scrollable Container */
        .surah-buttons-scrollable {
    /* ğŸ›‘ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ø³Ù…: Ø¥Ø²Ø§Ù„Ø© max-height ÙˆØªØ¹ÙŠÙŠÙ† height: 100% */
    height: 100% !important; /* ØªØ£Ø®Ø° ÙƒØ§Ù…Ù„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…ØªØ§Ø­ Ù…Ù† Ø§Ù„Ø£Ø¨ */
    overflow-y: auto;
    padding-right: 8px; 
    padding-left: 8px; 
    /* ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª) */
}

/* Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£Ø¨ÙˆÙŠ:
   #tabs-content-container-surah
   ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ height: 100% Ø£Ùˆ flex-grow Ù„ÙŠØ¹Ø·ÙŠ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ©. 
*/
#tabs-content-container-surah {
    height: 100%; /* ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø¨ÙˆÙŠØ© ØªØ¹Ø·ÙŠ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙƒØ§Ù…Ù„ */
    display: flex;
    flex-direction: column;
}
        .surah-buttons-scrollable::-webkit-scrollbar { width: 6px; }
        .surah-buttons-scrollable::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .surah-buttons-scrollable::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.4); border-radius: 10px; }
        
        /* NEW: Styling for Tabs in Media Screen */
        .tabs-container {
            display: flex;
            gap: 0.5rem;
            padding: 0.25rem;
            border-radius: 9999px; /* pill shape */
            background-color: rgba(0, 0, 0, 0.8);
            align-self: center; /* Center the tab bar */
            margin-bottom: 1rem;
        }
        .tab-button {
            padding: 0.5rem 1.25rem;
            background-color: transparent;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            border-radius: 9999px; /* pill shape */
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .tab-button.active {
            color: white;
            background-color: rgba(147, 51, 234, 0.6); /* Purple */
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .tab-content {
            width: 100%;
            height: 100%;
        }
        .tab-content.hidden {
            display: none;
        }


        /* Dashboard Logo Effect */
        .metallic-logo-effect {
            width: 300px;
            height: auto;
            margin-bottom: 1rem;
            filter: grayscale(100%) brightness(30%);
        }

        /* Car Dashboard Specific Styles */
        .car-dashboard-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .gauge-container.absolute-pos {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .gauge-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.25rem;
        }

        .speed-display {
            font-size: 2.5rem;
            line-height: 1;
        }

        .rpm-display {
            font-size: 1.2rem;
            line-height: 1;
        }

        .gear-indicator {
            font-size: 4rem;
            font-weight: bold;
            color: #10b981;
        }

        div#youtube-suggestions {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

.glass-surface.glass-surface--svg.p-3.rounded-2x1.text-center.flex.items-center.gap-3.navigable.grid-item {
    height: 122px;
}.glass-surface.glass-surface--svg.p-3.rounded-2x1.text-center.flex.items-center.gap-3.navigable.grid-item {}

div#\33 d-screen-gear {
    font-size: 2.7rem;
}

/* NEW: Style for direction indicator */
div#\33 d-screen-dir {
    font-size: 2.7rem;
}


div#youtube-readers-section {
    height: 100%;
}

.reader-container {
    max-width: 100% !important;
    max-height: 100% !important;
} 

section#screen-Media {
    height: 101%!important;
    padding: 0px!important;
    overflow-y: auto;
    background: #000000b5;
}

        
div#youtube-readers-section {
    height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.7);
            overflow: hidden;
            position: relative;
        }
        .car-cam-360-container img {
            height: 160% !important;
            width: 100%; 
            object-fit: cover;
        }
        .car-cam-360-controls {
            position: absolute;
            bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 20;
        }
        .car-cam-360-controls button {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .car-cam-360-controls button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }


        /* Digital Clock Styles (Apple iOS 19 style) */
        #digital-time {
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: baseline;
            gap: 0.2rem;
            direction: ltr; /* FIX: Enforce LTR for correct HH:MM:SS order */
        }
        #digital-time span {
            transition: opacity 0.3s ease;
        }
        #digital-time .hours { opacity: 1; }
        #digital-time .minutes { opacity: 0.8; }
       #digital-time .seconds {
    opacity: 0.6;
    font-size: 2.2rem;
}

        /* Updated #digital-date styles based on user request */
        #digital-date {
            font-size: 1.2rem;
            color: rgb(255 255 255 / 99%);
            font-weight: bold;
            text-align: center;
            line-height: 1.4;
        }
        /* Countdown to Azan */
        .countdown-azan {
            color: cyan !important;
        }
        /* Countdown to Iqama */
        .countdown-iqama {
            color: orange !important;
        }
        /* Count-up after Iqama */
        .countdown-up {
            color: #98FB98 !important; /* PaleGreen, close to lightmint */
        }


        /* Settings Range Input Styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #9333ea;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #9333ea;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5);
        }

        /* Animated Weather Icon Styles */
        @keyframes pulse-float {
            0% { transform: scale(1) translateY(0px); opacity: 1; }
            50% { transform: scale(1.05) translateY(-2px); opacity: 0.9; }
            100% { transform: scale(1) translateY(0px); opacity: 1; }
        }
        #dashboard-weather-icon, #weather-icon {
            animation: pulse-float 3s ease-in-out infinite alternate;
            transition: transform 0.3s ease-in-out;
        }

@media (max-width: 768px) {
    /* ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©) ... */

/* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠ */
.glass-surface {
    /* ğŸ›‘ 1. Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ© (CRITICAL for Glass Effect) */
    backdrop-filter: blur(12px) saturate(180%);
    -webkit-backdrop-filter: blur(12px) saturate(180%); /* Ø¯Ø¹Ù… Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ÙˆÙŠØ¨ ÙƒÙŠØª */

    /* 2. Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´ÙØ§ÙØ© Ø§Ù„Ù…Ø§Ø¦Ù„Ø© Ù„Ù„Ø«Ù„Ø¬ */
    background-color: rgba(255, 255, 255, 0.15); /* Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ Ø®ÙÙŠÙ */
    
    /* 3. Ø­Ø¯ÙˆØ¯ Ø´ÙØ§ÙØ© Ø®ÙÙŠÙØ© (Ù„Ø¥Ø­Ø³Ø§Ø³ Ø§Ù„Ø¹Ù…Ù‚) */
    border: 1px solid rgba(255, 255, 255, 0.1); 
    
    /* 4. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¸Ù„ Ø®ÙÙŠÙ ÙˆØ¹Ø§Ø¦Ù… */
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    
    /* 5. ØªØ¬Ø¹Ù„ Ø§Ù„Ø­ÙˆØ§Ù Ø£ÙƒØ«Ø± Ù†Ø¹ÙˆÙ…Ø© */
    border-radius: 16px;
    
    /* 6. Ù…Ù†Ø¹ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ù…Ù†Ø¸ÙˆØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ */
    overflow: hidden; 
    
    /* 7. Ø§Ø³ØªØ®Ø¯Ø§Ù… 3D Transform Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ£Ø«ÙŠØ± ÙÙŠ Safari */
    transform: translateZ(0); 
}

/* ğŸ›‘ Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ù„Ù…Ø¹Ø§Ù† Ø®ÙÙŠÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
.glass-surface::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ ÙŠØ¹Ø·ÙŠ Ø¥Ø­Ø³Ø§Ø³ Ø¨Ø§Ù„Ù„Ù…Ø¹Ø§Ù† Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„ÙŠØ³Ø§Ø± */
    background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.1),
        rgba(255, 255, 255, 0)
    );
    pointer-events: none; /* Ù„Ø§ ÙŠØ¹ÙŠÙ‚ Ø§Ù„Ù†Ù‚Ø± */
}

button.youtube-suggestion-button {
    font-size: 1rem;
}

.youtube-suggestion-button {
            color: white;
            padding: 0.25rem 0.75rem; /* Zoomed out padding */
            border-radius: 9999px;
            font-size: 0.75rem; /* Zoomed out font */
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* NEW: Switched to inline-flex for variable width */
            display: inline-flex;
            width: auto;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            position: relative;
            overflow: hidden; /* Keep overflow hidden on the button itself */
        }
        .youtube-suggestion-button:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .youtube-suggestion-button:active {
            transform: translateY(0);
        }
        
        /* NEW: Style for the Surah name text to handle long names */
        .surah-name-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: right; /* Align text to the right for RTL */
        }

        /* NEW: Badge for Juz number */
        .youtube-suggestion-button .juz-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            flex-shrink: 0; /* Prevent badge from shrinking */
            line-height: 1;
            position: relative; /* Allow z-index */
            z-index: 2; /* Ensure it's on top */
        }

button.youtube-suggestion-button.navigable.grid-item {
    font-size: 1rem;
}

div#youtube-surah-section {
    min-height: 547px;
}

button.youtube-suggestion-button.navigable.grid-item {
    height: 50px;
}

span.surah-name-text {
    font-size: 1rem;
}

    /* ğŸ›‘ Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    button[data-app="Map"] {
        display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Map/3D Car (ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØªÙ‡Ø§) */
    }
    button[data-app="Radio"] {
        display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Radio */
    }
    
    /* ğŸ›‘ Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ø¹Ø§Ø¦Ù… (Ù…ÙƒØ±Ø± Ù…Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„) */
   

    /* Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØªÙ… Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ø®ÙØ§Ø¡ floating-media-button Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø´Ø§Ø´Ø© Media Ù†Ø´Ø·Ø© ÙÙŠ handleMediaViewSwitch */
    
    /* ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯) ... */
}

        /* NEW: Responsive padding toggle */
        @media (min-width: 768px) {

.glass-surface {
    /* ğŸ›‘ 1. Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ© (CRITICAL for Glass Effect) */
    backdrop-filter: blur(12px) saturate(180%)!important;
    -webkit-backdrop-filter: blur(12px) saturate(180%)!important; /* Ø¯Ø¹Ù… Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ÙˆÙŠØ¨ ÙƒÙŠØª */

    /* 2. Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´ÙØ§ÙØ© Ø§Ù„Ù…Ø§Ø¦Ù„Ø© Ù„Ù„Ø«Ù„Ø¬ */
    background-color: rgba(255, 255, 255, 0.15)!important; /* Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ Ø®ÙÙŠÙ */
    
 
    /* 4. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¸Ù„ Ø®ÙÙŠÙ ÙˆØ¹Ø§Ø¦Ù… */
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3)!important;
}
            button.youtube-suggestion-button {
    font-size: 1rem;
}

.youtube-suggestion-button {
            color: white;
            padding: 0.25rem 0.75rem; /* Zoomed out padding */
            border-radius: 9999px;
            font-size: 0.75rem; /* Zoomed out font */
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* NEW: Switched to inline-flex for variable width */
            display: inline-flex;
            width: auto;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            position: relative;
            overflow: hidden; /* Keep overflow hidden on the button itself */
        }
        .youtube-suggestion-button:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .youtube-suggestion-button:active {
            transform: translateY(0);
        }
        
        /* NEW: Style for the Surah name text to handle long names */
        .surah-name-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: right; /* Align text to the right for RTL */
        }

        /* NEW: Badge for Juz number */
        .youtube-suggestion-button .juz-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            flex-shrink: 0; /* Prevent badge from shrinking */
            line-height: 1;
            position: relative; /* Allow z-index */
            z-index: 2; /* Ensure it's on top */
        }

            body.small-padding .md\:p-6 {
                padding: 1.5rem !important;
            }
        }
          #digital-time .hours { font-size: 2.2rem; }
        #digital-time .minutes { font-size: 2.2rem; }
       #digital-time .seconds { 
    font-size: 1.8rem;
}


div#bottom-left-controls {
    left: 90px!important;
}
        img.w-full.h-full.object-cover.rounded-lg.opacity-80 {
            position: fixed;
        }
        /* Prayer Times Specific Styles */
        .prayer-times-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            margin-top: 1rem;
        }
        .prayer-time-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            min-width: 80px;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        /* UPDATED: Current prayer is green */
        .prayer-time-item.current-prayer {
            background-color: rgba(16, 185, 129, 0.4); /* Greenish */
            font-weight: bold;
            border: 1px solid #10B981;
        }
        /* UPDATED: Next prayer is orange */
        .prayer-time-item.next-prayer {
            background-color: rgba(251, 146, 60, 0.3); /* Orangey */
            border: 1px solid #fb923c;
        }
        .prayer-name {
           color: rgba(255, 255, 255);
    font-size: 1rem;
    font-family: sans-serif;
    font-weight: bold;
    margin-bottom: 0.2rem;
        }
        .prayer-time {
           color: rgba(255, 255, 255,0.85);
            font-size: 1.4rem;
            font-weight: bold;
   
        }
       span.prayer-iqama{
             font-size: 1rem;
             color: rgb(255 179 20 / 85%);
             font-family: sans-serif;
             font-weight: bold;
            margin-bottom: 0.2rem;
            font-size: 1rem;
            
        }

        /* --- START: Islamic Daily Reminders Styles (MODIFIED) --- */

.reminders-grid {
    display: grid;
    grid-template-columns: repeat(2, 48%); /* Ø¹Ù…ÙˆØ¯ÙŠÙ† Ø¨Ø¹Ø±Ø¶ 48% Ù„ÙƒÙ„ Ù…Ù†Ù‡Ù…Ø§ */
    justify-content: center; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
    gap: 1rem;
    width: 100%;
    height: 100%;
    align-content: center; 
    padding: 1rem; 
}

.reminder-item {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1.25rem;
    padding: 0.8rem 1rem; /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ */
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: flex-start;
    gap: 0.75rem; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© */
    transition: all 0.3s ease;
    cursor: pointer;
    height:80%;
}

.reminder-item .icon {
    color: rgba(255, 255, 255, 0.5); 
    flex-shrink: 0; /* Ù„Ù…Ù†Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ù† Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
    /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„ØªØªÙ†Ø§Ø³Ù‚ Ù…Ø¹ Ø§Ù„Ù†Øµ */
    width: 1.6rem !important;
    height: 1.6rem !important;
}

.reminder-item .text {
    font-size: 1.2rem; /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    text-align: right; /* Ù„Ø¶Ù…Ø§Ù† Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†Øµ Ù„Ù„ÙŠÙ…ÙŠÙ† */
}

/* ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ù…ØªØ§Ø² */
.reminder-item.active {
    background-color: rgba(20, 184, 166, 0.3); 
    border-color: rgba(45, 212, 191, 0.7);
    box-shadow: 0 0 20px rgba(20, 184, 166, 0.5);
}

.reminder-item.active .icon {
    color: #5eead4; 
}

.reminder-item.active .text {
    color: #ffffff; 
}

/* NEW: Upcoming reminder glow */
.reminder-item.upcoming {
    background-color: rgba(249, 115, 22, 0.2); /* Orange transparent bg */
    border-color: rgba(251, 146, 60, 0.6);   /* Orange border */
    box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); /* Orange glow */
}
.reminder-item.upcoming .icon {
    color: #fdba74; /* Light orange icon */
}
.reminder-item.upcoming .text {
    color: #ffffff; /* White text for contrast */
}

/* â–¼â–¼â–¼ NEW: Completed reminder style â–¼â–¼â–¼ */
.reminder-item.completed {
    background-color: rgba(107, 114, 128, 0.15); /* Grayish transparent bg */
    border-color: rgba(107, 114, 128, 0.3);
    opacity: 0.7; /* Make it more faded */
}
.reminder-item.completed .icon {
    color: #4ade80; /* Green check icon */
}
.reminder-item.completed .text {
    color: rgba(255, 255, 255, 0.5); /* Faded text */
}


/* â–¼â–¼â–¼ NEW: Missed and Dropdown Styles â–¼â–¼â–¼ */
.reminder-item.missed {
    background-color: rgba(239, 68, 68, 0.2); /* Red transparent bg */
    border-color: rgba(248, 113, 113, 0.6);   /* Red border */
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); /* Red glow */
}
.reminder-item.missed .icon {
    color: #fca5a5; /* Light red icon */
}
.reminder-item.missed .text {
    color: #ffffff; /* White text for contrast */
}

/* Dropdown menu for reminders */
.reminder-status-dropdown {
    position: absolute;
    top: 90%; /* Position slightly overlapping the icon */
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(30, 41, 59, 0.9); /* slate-800 with transparency */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    padding: 0.5rem;
    z-index: 50;
    display: none; /* Hidden by default */
    min-width: 120px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.reminder-status-dropdown.show {
    display: block;
}
.reminder-status-dropdown button {
    display: block; width: 100%; padding: 0.5rem 0.75rem; text-align: right; font-size: 0.9rem; color: white; background-color: transparent; border: none; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s;
}
.reminder-status-dropdown button:hover {
    background-color: rgba(71, 85, 105, 0.7); /* slate-600 with transparency */
}
/* â–²â–²â–² END: New Styles â–²â–²â–² */


/* --- END: Islamic Daily Reminders Styles (MODIFIED) --- */
        /* OBD-II Specific Styles */
        .obd-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .obd-data-card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .obd-data-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 0.25rem;
        }
        .obd-data-card .label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£ÙˆØ³Ø¹ */
        @media (min-width: 992px) {
.glass-surface {
    /* ğŸ›‘ 1. Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ© (CRITICAL for Glass Effect) */
    backdrop-filter: blur(12px) saturate(180%)!important;
    -webkit-backdrop-filter: blur(12px) saturate(180%)!important; /* Ø¯Ø¹Ù… Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ÙˆÙŠØ¨ ÙƒÙŠØª */

    /* 2. Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´ÙØ§ÙØ© Ø§Ù„Ù…Ø§Ø¦Ù„Ø© Ù„Ù„Ø«Ù„Ø¬ */
    background-color: rgba(255, 255, 255, 0.15)!important; /* Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ Ø®ÙÙŠÙ */
    
 
    /* 4. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¸Ù„ Ø®ÙÙŠÙ ÙˆØ¹Ø§Ø¦Ù… */
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3)!important;
}

/* ğŸ›‘ Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ù„Ù…Ø¹Ø§Ù† Ø®ÙÙŠÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
.glass-surface::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ ÙŠØ¹Ø·ÙŠ Ø¥Ø­Ø³Ø§Ø³ Ø¨Ø§Ù„Ù„Ù…Ø¹Ø§Ù† Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„ÙŠØ³Ø§Ø± */
    background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.1),
        rgba(255, 255, 255, 0)
    );
    pointer-events: none; /* Ù„Ø§ ÙŠØ¹ÙŠÙ‚ Ø§Ù„Ù†Ù‚Ø± */
}
/* Cleaned base body styles - animation and gradient moved to screens */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background: #000000; /* Simple black fallback */
Â  Â  Â  Â  Â  Â  background-size: auto; /* Reset size */
Â  Â  Â  Â  Â  Â  animation: none; /* Remove body animation */
Â  Â  Â  Â  Â  Â  transition: background-image 0.5s ease;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

button.youtube-suggestion-button.navigable.grid-item {
    font-size: 1rem;
}

div#youtube-surah-section {
    min-height: 547px;
}

button.youtube-suggestion-button.navigable.grid-item {
    height: 50px;
}

span.surah-name-text {
    font-size: 1rem;
}

.w-full.h-full.bg-black2.rounded-3xl.flex.items-center.justify-center.p-1.overflow\:hidden {
    background: linear-gradient(45deg, black, #00000024) ;
}

section#screen-Map>.w-full.h-full.bg-black2.rounded-3xl.flex.items-center.justify-center.p-1.overflow\:hidden {
    background: linear-gradient(45deg, black, transparent);!important}

            .carousel-nav-button.prev {
                display: flex;
            }

            div#video-popup-container {
    height: 17rem;
    width: 29rem;
    bottom:8rem;
    right:4rem;
}

  #digital-time .hours { font-size: 3.2rem; }
        #digital-time .minutes { font-size: 3.2rem; }
       #digital-time .seconds { 
    font-size: 2.5rem;
}
           
     .flex.gap-2.mt-2.homebtn {
    display: none;
}
section#screen-Dashboard{
  background: #00000084;   
}
            body{
                      background: url(https://dmusera.netlify.app/tvbgc1.webp) !important;
        background-size: contain !important;
        background-color: black !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
            }

            /* NEW: Date widget styles */
            #full-date-widget-container {
                display: flex !important; /* Make it visible */
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: white;
                text-shadow: 0 1px 3px rgba(0,0,0,0.5);
                padding: 0.2rem; /* Increased padding */
                background-color: rgba(0,0,0,0.2);
                border-radius: 1rem;
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                margin-bottom: 0.4rem; /* Add some space below it */
                font-family: 'Amiri', serif; /* Apply Thuluth-like font */
            }
            #full-date-widget-container p { margin: 0; }
            #gregorian-date { font-size: 1.6rem; font-weight: 700; } /* Increased font size and made bold */
            #hijri-date { font-size: 1.6rem; opacity: 0.9; font-weight: 700;padding:0px;margin:0px} /* Increased font size and made bold */

            /* NEW: Larger clock on desktop */
            #digital-time {
                font-size: 3rem !important;
            }


            /* --- START: Hide Elements in TV UI --- */

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ„ÙØ§Ø² */

            .glass-surface.glass-surface--svg.p-2.flex.flex-col.items-center.justify-center.text-center.car-cam-360-container.col-span-1.row-start-1.navigable.grid-item {
    display: none;
}
                              /* Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù€ 3D Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
            #car-360-image {
                visibility: hidden;
            }
            div#tv{display:block;background:#00000050}
            


        .car-cam-360-controls.grid-container>button {
    display: none;
}

            .car-cam-360-container {
                background-image: url('https://dmusera.netlify.app/tv-cont.png');
                background-size: cover;
                background-position: center center;
                background-repeat: no-repeat;
            }
            /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø¹Ø§Ø± Ù„ÙƒØ²Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£ÙˆØ³Ø¹ */
            img[src*="Lexus-Logo.wine.svg"] {
                display: none !important;
            }
        }
        
        /* NEW: Show next button on even wider screens */
        @media (min-width: 1080px) {
            section#screen-Map {
    background: linear-gradient(45deg, black 66%, transparent);
}
            [data-app="Map"],                  /* Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù€ 3D Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
            #car-360-image {
                display:none
            }
            .glass-surface.glass-surface--svg.p-2.flex.flex-col.items-center.justify-center.text-center.car-cam-360-container.col-span-1.row-start-1.navigable.grid-item {
    display: block;
}
       .flex.gap-2.mt-2.homebtn {
    display: block;
}
div#map{display:none}

            div#tv{display:block;background:#00000050}
            .carousel-nav-button.next {
                display: flex;
            }
        }
    </style>
</head>
<body class="animated-bg text-white overflow-hidden theme-gradient-1 animation-paused">
    <!-- SVG Filter Definition for Liquid Glass Effect -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
  <defs>
    <filter id="glass-filter" colorInterpolationFilters="sRGB" x="0%" y="0%" width="100%" height="100%">
      <feImage x="0" y="0" width="100%" height="100%" preserveAspectRatio="none" result="map" href="data:image/svg+xml,%3Csvg viewBox='0 0 400 200'
				xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='red-grad' x1='100%25' y1='0%25' x2='0%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%230000'/%3E%3Cstop offset='100%25' stop-color='red'/%3E%3C/linearGradient%3E%3ClinearGradient id='blue-grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%230000'/%3E%3Cstop offset='100%25' stop-color='blue'/%3E%3C/defs%3E%3Crect x='0' y='0' width='400' height='200' fill='black'/%3E%3Crect x='0' y='0' width='400' height='200' rx='20' fill='url(%23red-grad)'/%3E%3Crect x='0' y='0' width='400' height='200' rx='20' fill='url(%23blue-grad)' style='mix-blend-mode: difference'/%3E%3Crect x='1.4' y='1.4' width='397.2' height='197.2' rx='20' fill='hsl(0 0% 50% / 0.93)' style='filter:blur(11px)'/%3E%3C/svg%3E" />
      <feDisplacementMap in="SourceGraphic" in2="map" id="redchannel" scale="300" xChannelSelector="R" yChannelSelector="G" result="dispRed" />
      <feColorMatrix in="dispRed" type="matrix" values="1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0" result="red" />
      <feDisplacementMap in="SourceGraphic" in2="map" id="greenchannel" scale="310" xChannelSelector="R" yChannelSelector="G" result="dispGreen" />
      <feColorMatrix in="dispGreen" type="matrix" values="0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0" result="green" />
      <feDisplacementMap in="SourceGraphic" in2="map" id="bluechannel" scale="320" xChannelSelector="R" yChannelSelector="G" result="dispBlue" />
      <feColorMatrix in="blue" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0" result="blue" />
      <feBlend in="red" in2="green" mode="screen" result="rg" />
      <feBlend in="rg" in2="blue" mode="screen" result="output" />
      <feGaussianBlur in="output" stdDeviation="5" />
    </filter>
  </defs>
</svg>
<div class="w-full h-screen flex flex-col items-center justify-center p-4 sm:p-6">
  <!-- Top Bar: Wifi, 5G, Current Time -->
  <div class="w-full max-w-7xl flex justify-between items-center text-white/80 text-sm px-4 py-2 absolute top-4 left-1/2 -translate-x-1/2 z-10 top-bar">
    <div class="flex items-center gap-2"></div>
  </div>
  <!-- Lexus Logo Fixed at Top Center -->
  <img src="https://dmusera.netlify.app/Lexus-Logo.wine.svg" width="200px" alt="Lexus Logo" class="fixed top-2 left-1/2 -translate-x-1/2 h-12 z-[1000] opacity-80" style="filter: invert(1) grayscale(100%) brightness(200%);" />
  <!-- Main CarPlay Interface Container -->
  <div id="carplay-main-interface" class="flex flex-row shadow-2xl rounded-3xl overflow-hidden bg-black/20 border border-white/10">
    <!-- Main content area for app screens -->
    <main class="flex-1 flex flex-col h-full">
      <!-- Dashboard Screen -->
      <section id="screen-Dashboard" class="app-screen p-4 md:p-6 flex-col h-full">
        <!-- UPDATED: Dashboard layout changed -->
        <div class="dashboard-main-grid grid grid-cols-1 md:grid-cols-3 grid-rows-[80%_20%] gap-4 md:gap-6 h-full w-full grid-container">
          <!-- Map Widget (Now first) -->
          <button class="playlist-shuffle-btn navigable grid-item" style="position: absolute;bottom: 15px;left: 15px;z-index: 9999;background: transparent!important;color: transparent!important;width: 9rem;height: 3rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="shuffle" class="lucide lucide-shuffle">
              <path d="m18 14 4 4-4 4"></path>
              <path d="m18 2 4 4-4 4"></path>
              <path d="M2 18h1.973a4 4 0 0 0 3.3-1.7l5.454-8.6a4 4 0 0 1 3.3-1.7H22"></path>
              <path d="M2 6h1.972a4 4 0 0 1 3.6 2.2"></path>
              <path d="M22 18h-6.041a4 4 0 0 1-3.3-1.8l-.359-.45"></path>
            </svg> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„ </button>
          <div id="map" class="rounded-3xl relative overflow-hidden flex items-center justify-center glass-surface glass-surface--svg p-1 col-span-1 row-start-1 navigable grid-item" tabindex="0">
            <div id="dashboard-google-map" class="full-iframe"></div>
            <!-- NEW: Geolocation Error Overlay -->
            <div id="geolocation-error-overlay" class="hidden absolute top-0 left-0 w-full h-full bg-black/70 text-white flex-col items-center justify-center text-center p-4 z-10 rounded-3xl">
              <i data-lucide="map-pin-off" class="w-12 h-12 text-red-500 mb-4"></i>
              <h3 class="font-bold text-lg mb-2">Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù…Ø¹Ø·Ù„Ø©</h3>
              <p class="text-sm text-white/80">ÙŠØ±Ø¬Ù‰ ØªÙ…ÙƒÙŠÙ† Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©.</p>
            </div>
            <div class="absolute bottom-4 left-4 flex gap-2">
              <button id="get-my-location-button-dashboard" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center text-sm navigable grid-item" tabindex="0" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹">
                <i data-lucide="map-pin" class="w-5 h-5"></i>
              </button>
              <div id="map-tuner-controls" class="relative z-[1000] flex flex-col gap-2">
    <div class="flex gap-2 bg-black/50 p-2 rounded-xl backdrop-blur">
        <button onclick="adjustScale(0.05)" class="bg-white/20 px-3 py-1 rounded text-white">+</button>
        <span class="text-white text-xs self-center">car</span>
        <button onclick="adjustScale(-0.05)" class="bg-white/20 px-3 py-1 rounded text-white">-</button>
    </div>
    <div class="flex gap-2 bg-black/50 p-2 rounded-xl backdrop-blur border border-white/10">
        <button onclick="adjustTilt(5)" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-white">â†‘</button>
        <span class="text-white text-[10px] uppercase font-bold self-center w-8 text-center">Tilt</span>
        <button onclick="adjustTilt(-5)" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-white">â†“</button>
    </div>
   
</div>
             <button id="save-tuner-btn" onclick="saveCurrentTuner()" 
            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-2xl font-bold shadow-lg transition-all">
        ğŸ’¾
    </button>
            </div>
          </div>
          <!-- 360 Camera View (Stays in middle) -->
          <div class="glass-surface glass-surface--svg p-2 flex flex-col items-center justify-center text-center car-cam-360-container col-span-1 row-start-1 navigable grid-item" tabindex="0">
            <img id="car-360-image" src="https://dmusera.netlify.app/es350gb.png" alt="Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ 360 Ø¯Ø±Ø¬Ø© Ù„Ù„Ø³ÙŠØ§Ø±Ø©" class="w-full h-full object-contain rounded-lg opacity-80">
            <div class="car-cam-360-controls grid-container">
              <input type="file" id="upload-360-image-input" accept="image/*" class="hidden" />
              <button id="upload-360-image-button" class="navigable grid-item" tabindex="0">
                <i data-lucide="upload" class="w-4 h-4"></i> ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© </button>
              <button id="reset-360-image-button" class="navigable grid-item" tabindex="0">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† </button>
            </div>
          </div>
          <!-- Weather and Clock/Prayer Widgets (Now third) -->
          <div class="flex flex-col gap-4 md:gap-6 col-span-1 row-start-1 grid-container">
            <div id="full-date-widget-container" class="hidden"></div>
            <div id="weather-widget-container" class="glass-surface glass-surface--svg p-4 flex-grow flex flex-col items-center justify-center text-center navigable grid-item" tabindex="0">
              <div id="dash-carousel-container" class="relative w-full h-full flex flex-col items-center justify-center">
                <div id="dash-card-media" class="carousel-slide-dash active w-full h-full relative overflow-hidden rounded-2xl">
    <img id="dash-media-thumb" src="" class="absolute inset-0 w-full object-cover shadow-lg">
    
    <div class="absolute bg-black/70 backdrop-blur-md p-3 min-h-[40%] flex items-center overflow-hidden">
        <div id="dash-media-title-container" class="w-full relative overflow-hidden">
            <h3 id="dash-media-title" class="minimized-title text-lg font-black text-white leading-tight whitespace-nowrap inline-block">
                Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
            </h3>
        </div>
    </div>
</div>
                
                <div id="dash-card-nasa" class="carousel-slide-dash w-full relative flex flex-col items-center justify-center">
    
    <div class="relative w-24 h-24 mb-2">
        <div id="hijri-moon-overlay" 
             class="absolute inset-0 flex items-center justify-center z-10 font-black text-6xl opacity-30" 
             style="webkit-text-stroke: 1.5px rgba(255,255,255,0.7); pointer-events: none; text-shadow: 0 4px 10px rgba(0,0,0,0.5);transform: scale(3.5);">
            ${hijriDay}
            
        </div>
        
        <img id="dash-nasa-moon" 
             src="" 
             class="w-full h-full rounded-full object-cover border border-purple-500/20 shadow-lg">
    </div>

    <h3 class="text-lg font-bold text-purple-300 leading-none">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ù…Ø±</h3>
    <p id="carplay-moon-phase" class="text-[10px] text-white/50 mt-1 uppercase tracking-widest">NASA SVS</p>

</div>

<div id="dash-card-gregorian-date" class="carousel-slide-dash w-full flex flex-col items-center justify-center p-4">
    <div class="glass-date-wrapper flex flex-col items-center">
        <span id="greg-day-num" class="text-7xl font-black leading-none tracking-tighter"   
                   style="pointer-events: none; text-shadow: rgba(0, 0, 0, 0.16) 0px 4px 10px; font-weight: 900; -webkit-text-fill-color: transparent; background-image: linear-gradient(rgb(255, 255, 255) 0%, rgb(161, 161, 161) 100%); background-clip: text;">
 
            
        </span>
        <span id="greg-month-name" class="text-2xl font-bold text-white/90 mt-2 italic" >
            11
        </span>
    </div>
</div>
                
                <div id="carplay-card-weather" class="carousel-slide flex flex-col items-center justify-center">
                </div>
                <div id="dash-card-weather" class="carousel-slide-dash w-full">
                                                      <span id="carplay-weather-temp-big" class="text-7xl font-black text-white">--Â°</span>
                  <img id="dash-weather-icon-big" src="" class="w-20 h-20 object-contain mb-1">
                  <div class="grid grid-cols-3 gap-1 w-full mt-1">
                    <div class="bg-black/20 p-1.5 rounded-lg text-center">
                      <div class="font-bold text-sm text-blue-300" id="dash-metric-temp">--Â°</div>
                      <div class="text-[8px] opacity-60">Temp</div>
                    </div>
                    <div class="bg-black/20 p-1.5 rounded-lg text-center">
                      <div class="font-bold text-sm text-yellow-300" id="dash-metric-uv">--</div>
                      <div class="text-[8px] opacity-60">UV</div>
                    </div>
                    <div class="bg-black/20 p-1.5 rounded-lg text-center">
                      <div class="font-bold text-sm text-cyan-300" id="dash-metric-humidity">--%</div>
                      <div class="text-[8px] opacity-60">Hum</div>
                    </div>
                  </div>

                </div>


              </div> <!-- cour close-->
            </div>
            <div class="glass-surface glass-surface--svg p-4 flex-grow flex flex-col items-center justify-center text-center navigable grid-item" tabindex="0">
              <div id="digital-clock-widget" class="w-full h-full flex flex-col items-center justify-center text-center">
                <div id="digital-time">
                  <span class="hours">00</span>: <span class="minutes">00</span>
                  <span id="time-icon-container"></span>
                </div>
                <div id="digital-date">
                  <div id="digital-date-line1"></div>
                  <div id="digital-date-line2"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- Prayer Times Row (Stays at bottom) -->
          <div class="glass-surface glass-surface--svg p-4 flex flex-col items-center justify-center text-center col-span-full row-start-2 navigable grid-item" tabindex="0">
            <div id="prayer-times-container" class="prayer-times-row grid-container">
              <!-- Prayer times will be loaded here by JavaScript -->
              <p class="text-white/70 col-span-full">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©...</p>
            </div>
          </div>
          <div id="suggested-d-dashboard-row" class="glass-surface glass-surface--svg p-4 flex col-span-full justify-start rounded-3xl navigable grid-item" tabindex="0" style="height: 180px;">
            <div id="suggested-d-dashboard-container" class="favorites-dashboard-horizontal-scroll flex-grow overflow-x-auto whitespace-nowrap flex gap-4" style="flex-direction: row; justify-content: flex-start;"></div>
          </div>
          <div id="favorites-d-dashboard-row" class="glass-surface glass-surface--svg p-4 flex col-span-full justify-start rounded-3xl navigable grid-item" tabindex="0" style="height: 180px;">
            <div id="fav-d-dashboard-container" class="favorites-dashboard-horizontal-scroll flex-grow overflow-x-auto 
                 whitespace-nowrap 
                 flex 
                 gap-4" style="flex-direction: row; justify-content: flex-start;">
              <p class="text-white/70 text-center p-4 w-full">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
          </div>
          <div id="tv" class="glass-surface glass-surface--svg p-4 flex flex-col items-center justify-center text-center car-cam-360-container col-span-1 row-start-1 navigable grid-item" tabindex="0"></div>
          <div id="universal-date-display" class="navigable"></div>
        </div>
      </section>
      <!-- Media (YouTube) Screen -->
      <section id="screen-Media" class="app-screen p-4 md:p-6 flex-col items-center h-full relative">
        <button id="fullscreen-screen-Media-btn" onclick="toggleFullscreen('screen-Media')" class="fullscreen-toggle-button navigable grid-item" title="Toggle Fullscreen Map">
          <i class="fas fa-expand"></i>
        </button>
        <!-- NEW: Floating "Back to Search" Button -->
        <button id="back-to-search-floating-button" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-5 rounded-full shadow-lg z-50 flex items-center gap-2 navigable grid-item" tabindex="0" style="display: none;">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
          <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«</span>
        </button>
        <div class="w-full flex flex-col gap-4">
          <!-- Search Row -->
          <div class="w-full flex flex-row items-center gap-2 grid-container flex-shrink-0">
            <button id="youtube-search-button" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full transition-colors duration-200 flex items-center justify-center navigable grid-item" tabindex="0">
              <i data-lucide="search"></i>
            </button>
            <button id="floating-keyboard-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item " tabindex="0">
              <i data-lucide="keyboard" class="w-6 h-6"></i>
            </button>
            <button id="clear-search-button" class="navigable grid-item" tabindex="0">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <input type="text" id="youtube-search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨..." class="flex-grow p-3 rounded-full bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 navigable grid-item" tabindex="0" readonly="true" />
          </div>
          <div id="youtube-suggestions" class="w-full flex-grow flex flex-col">
            <div id="last-watched-container" class="hidden"></div>
            <div id="suggestions-content" class="flex flex-col gap-4 w-full"></div>
          </div>
        </div>
        <div id="youtube-video-list-view" class="hidden flex-col items-center justify-center h-full w-full absolute top-0 left-0 p-4 overflow-y-auto gap-4 flex-grow bg-black/50 backdrop-blur-sm">
          <button id="back-to-playlists-from-videos" class="absolute top-4 left-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm navigable grid-item z-10" tabindex="0">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© </button>
          <h2 class="text-3xl font-bold mb-4 text-center w-full pt-12">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</h2>
          <div id="video-list-container" class="flex flex-col gap-4 w-full grid-container"></div>
          <button id="back-to-playlists-bottom-button" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-full transition-colors duration-200 flex items-center justify-center gap-2 text-base navigable grid-item" tabindex="0">
            <i data-lucide="arrow-left" class="w-5 h-5"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« </button>
        </div>
        <div id="youtube-search-results-view" class="hidden flex-col h-full w-full absolute top-0 left-0 bg-black/50 backdrop-blur-sm">
          <div id="search-results-container" class="flex flex-col gap-4 w-full p-4 overflow-y-auto flex-grow grid-container"></div>
          <!-- NEW: Bottom navigation container -->
          <div class="w-full grid grid-cols-3 items-center p-2 sticky bottom-0 bg-black/40 backdrop-blur-sm flex-shrink-0 search-results-nav">
            <!-- Previous Button container -->
            <div class="flex justify-start">
              <button id="previous-item-button" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-full transition-all duration-200 flex items-center justify-center gap-2 text-sm navigable grid-item" style="display: none;" tabindex="0"></button>
            </div>
            <!-- Back Button container -->
            <div class="flex justify-center">
              <button id="back-to-playlists-bottom-button-search" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-full transition-all duration-200 flex items-center justify-center gap-2 text-sm navigable grid-item" tabindex="0">
                <i data-lucide="arrow-left" class="w-5 h-5"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« </button>
            </div>
            <!-- Next Button container -->
            <div class="flex justify-end">
              <button id="next-item-button" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-full transition-all duration-200 flex items-center justify-center gap-2 text-sm navigable grid-item" style="display: none;" tabindex="0"></button>
            </div>
          </div>
        </div>
      </section>
      <section id="screen-DashboardCarPlay" class="app-screen p-4 flex-col h-full bg-black/40 backdrop-blur-md">
        <div class="grid grid-cols-12 grid-rows-6 gap-4 h-full w-full max-w-7xl mx-auto p-2">
          <div class="col-span-8 row-span-6 glass-surface glass-surface--svg rounded-[2.5rem] overflow-hidden relative border border-white/20 shadow-2xl navigable grid-item" tabindex="0">
            <div id="carplay-mini-map" class="w-full h-full"></div>
            <div class="absolute bottom-4 left-4 bg-black/60 p-3 rounded-2xl backdrop-blur-md border border-white/10 flex items-center gap-3">
              <i data-lucide="navigation" class="w-5 h-5 text-blue-400"></i>
              <span class="text-sm font-bold truncate max-w-[150px]" id="carplay-location-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</span>
            </div>
          </div>
          <div id="carplay-card" class="col-span-4 row-span-4 glass-surface rounded-[2.5rem] p-6 flex flex-col items-center justify-between border border-white/20 shadow-xl overflow-hidden relative">
            <div id="carplay-carousel-container" class="relative w-full h-full flex flex-col items-center justify-center">
              <div id="carplay-card-media" class="carousel-slide active w-full">
                <img id="carplay-media-thumb" src="" class="w-32 h-32 rounded-3xl object-cover shadow-2xl border-2 border-white/10 mb-4">
                <div class="text-center w-full">
                  <h3 id="carplay-media-title" class="text-lg font-bold truncate">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
                  <p id="carplay-media-channel" class="text-sm text-white/60">YouTube</p>
                </div>
              </div>
              <div id="carplay-card-nasa" class="carousel-slide w-full">
                <img id="carplay-nasa-moon" src="" class="w-32 h-32 rounded-full object-cover shadow-2xl border-2 border-purple-500/30 mb-4">
                <div class="text-center w-full">
                  <h3 class="text-lg font-bold text-purple-300">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ù…Ø±</h3>
                  <p id="carplay-moon-phase" class="text-sm text-white/60">NASA SVS</p>
                </div>
              </div>
              <div id="carplay-card-weather" class="carousel-slide w-full">
                <div class="flex flex-col items-center w-full">
                  <img id="carplay-weather-icon-big" src="" class="w-24 h-24 object-contain mb-2">
                  <div class="grid grid-cols-3 gap-2 w-full px-2 mt-2">
                    <div class="bg-black/20 p-2 rounded-xl text-center border border-white/5">
                      <div class="font-bold text-base text-blue-400" id="carplay-metric-temp">--Â°</div>
                      <div class="text-[10px] opacity-70">Ø­Ø±Ø§Ø±Ø©</div>
                    </div>
                    <div class="bg-black/20 p-2 rounded-xl text-center border border-white/5">
                      <div class="font-bold text-base text-yellow-400" id="carplay-metric-uv">--</div>
                      <div class="text-[10px] opacity-70">UV</div>
                    </div>
                    <div class="bg-black/20 p-2 rounded-xl text-center border border-white/5">
                      <div class="font-bold text-base text-cyan-400" id="carplay-metric-humidity">--%</div>
                      <div class="text-[10px] opacity-70">Ø±Ø·ÙˆØ¨Ø©</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex gap-6 mt-4 items-center z-10">
              <div id="carplay-capsule-prev" class="cursor-pointer opacity-50 hover:opacity-100">
                <i data-lucide="skip-back" class="w-6 h-6"></i>
              </div>
              <div id="carplay-capsule-play-pause" class="p-4 bg-white/10 rounded-full border border-white/20 cursor-pointer">
                <i data-lucide="play" class="w-8 h-8 fill-white"></i>
              </div>
              <div id="carplay-capsule-next" class="cursor-pointer opacity-50 hover:opacity-100">
                <i data-lucide="skip-forward" class="w-6 h-6"></i>
              </div>
            </div>
          </div>
          <div class="col-span-4 row-span-3 glass-surface glass-surface--svg rounded-[2.5rem] p-5 flex flex-col justify-center border border-white/20 shadow-xl navigable grid-item" tabindex="0">
            <div class="flex items-center gap-3 mb-4 bg-white/5 p-3 rounded-2xl border border-white/10">
              <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center">
                <i data-lucide="sun" class="w-6 h-6 text-orange-400"></i>
              </div>
              <div>
                <p class="text-xs text-white/50">Ø§Ù„Ø£Ø°Ø§Ù† Ø§Ù„Ù‚Ø§Ø¯Ù…</p>
                <h4 id="carplay-next-prayer-name" class="text-xl font-black text-orange-300">--</h4>
              </div>
              <div class="mr-auto text-2xl font-black text-white" id="carplay-next-prayer-time">--:--</div>
            </div>
            <div class="grid grid-cols-2 gap-2" id="carplay-prayer-mini-grid"></div>
          </div>
        </div>
      </section>
      <!-- Radio Screen -->
      <section id="screen-Radio" class="app-screen items-center justify-center h-full w-full p-4 md:p-6">
        <iframe id="iframe-Radio" class="full-iframe" title="Quran Reciters" src="https://quran.com/radio" allow="geolocation"></iframe>
        <button id="fullscreen-radio-iframe-btn" onclick="toggleIframeFullscreen('iframe-Radio')" class="fullscreen-toggle-button navigable grid-item" title="Toggle Fullscreen Map">
          <i class="fas fa-expand"></i>
        </button>
      </section>
      <!-- Athkar Screen -->
      <section id="screen-Athkar" class="app-screen p-4 md:p-6 flex-col items-center h-full">
        <div class="tabs-container flex p-1 rounded-full bg-black/20 self-center mb-4">
          <button id="tab-sabah" class="tab-button navigable grid-item active" tabindex="0">Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­</button>
          <button id="tab-masaa" class="tab-button navigable grid-item" tabindex="0">Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡</button>
          <button id="tab-monthly" class="tab-button navigable grid-item" tabindex="0">Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</button>
        </div>
        <div id="athkar-content-container" class="w-full flex-grow overflow-y-auto">
          <button id="fullscreen-athkar-btn" onclick="toggleFullscreen('athkar-content-container')" class="fullscreen-toggle-button navigable grid-item" title="Toggle Fullscreen Map">
            <i class="fas fa-expand"></i>
          </button>
          <!-- Morning Athkar Panel -->
          <div id="athkar-sabah-content" class="tab-content athkar-grid">
            <div id="ts-1" class="athkar-item navigable grid-item athkar-color-1" tabindex="0">
              <p>Ø¢ÙŠØ© Ø§Ù„ÙƒØ±Ø³ÙŠ</p>
              <span class="repetition">(Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</span>
            </div>
            <div id="ts-2" class="athkar-item navigable grid-item athkar-color-2" tabindex="0">
              <p>Ø§Ù„Ù„Ù‡Ù… Ø£Ø¹Ù†ÙŠ Ø¹Ù„Ù‰ Ø°ÙƒØ±Ùƒ ÙˆØ´ÙƒØ±Ùƒ ÙˆØ­Ø³Ù† Ø¹Ø¨Ø§Ø¯ØªÙƒ.</p>
            </div>
            <div id="ts-3" class="athkar-item navigable grid-item athkar-color-3" tabindex="0">
              <p> Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ø®Ù„Ø§ØµØŒ Ø³ÙˆØ±Ø© Ø§Ù„ÙÙ„Ù‚ØŒ Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø§Ø³</p>
              <span class="repetition">(Ù£ Ù…Ø±Ø§Øª)</span>
            </div>
            <div id="ts-4" class="athkar-item navigable grid-item athkar-color-5" tabindex="0">
              <p>Ø§Ù„Ù„Ù‡Ù… Ø¨Ùƒ Ø£ØµØ¨Ø­Ù†Ø§ØŒ ÙˆØ¨Ùƒ Ø£Ù…Ø³ÙŠÙ†Ø§ØŒ ÙˆØ¨Ùƒ Ù†Ø­ÙŠØ§ØŒ ÙˆØ¨Ùƒ Ù†Ù…ÙˆØªØŒ ÙˆØ¥Ù„ÙŠÙƒ Ø§Ù„Ù†Ø´ÙˆØ±.</p>
            </div>
            <div id="tm-3" class="athkar-item navigable grid-item athkar-color-4" tabindex="0">
              <p>Ø­Ø³Ø¨ÙŠ Ø§Ù„Ù„Ù‡ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ù‡Ùˆ Ø¹Ù„ÙŠÙ‡ ØªÙˆÙƒÙ„Øª ÙˆÙ‡Ùˆ Ø±Ø¨ Ø§Ù„Ø¹Ø±Ø´ Ø§Ù„Ø¹Ø¸ÙŠÙ…</p>
              <span class="repetition">(Ù§ Ù…Ø±Ø§Øª)</span>
            </div>
            <div id="tm-1" class="athkar-item navigable grid-item athkar-color-1" tabindex="0">
              <p>Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ¶Ø± Ù…Ø¹ Ø§Ø³Ù…Ù‡ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ø£Ø±Ø¶ ÙˆÙ„Ø§ ÙÙŠ Ø§Ù„Ø³Ù…Ø§Ø¡ ÙˆÙ‡Ùˆ Ø§Ù„Ø³Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù„ÙŠÙ…</p>
              <span class="repetition">(Ù£ Ù…Ø±Ø§Øª)</span>
            </div>
            <div id="tm-2" class="athkar-item navigable grid-item athkar-color-2" tabindex="0">
              <p>ÙŠØ§ Ø­ÙŠ ÙŠØ§ Ù‚ÙŠÙˆÙ… Ø¨Ø±Ø­Ù…ØªÙƒ Ø£Ø³ØªØºÙŠØ«ØŒ Ø£ØµÙ„Ø­ Ù„ÙŠ Ø´Ø£Ù†ÙŠ ÙƒÙ„Ù‡ ÙˆÙ„Ø§ ØªÙƒÙ„Ù†ÙŠ Ø¥Ù„Ù‰ Ù†ÙØ³ÙŠ Ø·Ø±ÙØ© Ø¹ÙŠÙ†.</p>
            </div>
            <div id="tl-1" class="athkar-item navigable grid-item athkar-color-3 col-span-2" tabindex="0">
              <p>Ø§Ù„Ù„Ù‡Ù… Ø¹Ø§Ù„Ù… Ø§Ù„ØºÙŠØ¨ ÙˆØ§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙØ§Ø·Ø± Ø§Ù„Ø³Ù…Ø§ÙˆØ§Øª ÙˆØ§Ù„Ø£Ø±Ø¶ØŒ Ø±Ø¨ ÙƒÙ„ Ø´ÙŠØ¡ ÙˆÙ…Ù„ÙŠÙƒÙ‡ØŒ Ø£Ø´Ù‡Ø¯ Ø£Ù† Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†ØªØŒ Ø£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø´Ø± Ù†ÙØ³ÙŠØŒ ÙˆÙ…Ù† Ø´Ø± Ø§Ù„Ø´ÙŠØ·Ø§Ù† ÙˆØ´Ø±ÙƒÙ‡ØŒ ÙˆØ£Ù† Ø£Ù‚ØªØ±Ù Ø¹Ù„Ù‰ Ù†ÙØ³ÙŠ Ø³ÙˆØ¡Ø§Ù‹ Ø£Ùˆ Ø£Ø¬Ø±Ù‡ Ø¥Ù„Ù‰ Ù…Ø³Ù„Ù….</p>
            </div>
            <div id="tl-2" class="athkar-item navigable grid-item athkar-color-4 col-span-2" tabindex="0">
              <p>Ø³ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØºØºØ§Ø±: Ø§Ù„Ù„Ù‡Ù… Ø£Ù†Øª Ø±Ø¨ÙŠ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†ØªØŒ Ø®Ù„Ù‚ØªÙ†ÙŠ ÙˆØ£Ù†Ø§ Ø¹Ø¨Ø¯ÙƒØŒ ÙˆØ£Ù†Ø§ Ø¹Ù„Ù‰ Ø¹Ù‡Ø¯Ùƒ ÙˆÙˆØ¹Ø¯Ùƒ Ù…Ø§ Ø§Ø³ØªØ·Ø¹ØªØŒ Ø£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø´Ø± Ù…Ø§ ØµÙ†Ø¹ØªØŒ Ø£Ø¨ÙˆØ¡ Ù„Ùƒ Ø¨Ù†Ø¹Ù…ØªÙƒ Ø¹Ù„ÙŠØŒ ÙˆØ£Ø¨ÙˆØ¡ Ø¨Ø°Ù†Ø¨ÙŠ ÙØ§ØºÙØ± Ù„ÙŠØŒ ÙØ¥Ù†Ù‡ Ù„Ø§ ÙŠØºÙØ± Ø§Ù„Ø°Ù†ÙˆØ¨ Ø¥Ù„Ø§ Ø£Ù†Øª.</p>
            </div>
            <div id="tsl-1" class="athkar-item navigable grid-item athkar-color-5 col-span-4" tabindex="0">
              <p>Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø§Ù„Ø¹ÙÙˆ ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¯Ù†ÙŠØ§ ÙˆØ§Ù„Ø¢Ø®Ø±Ø©ØŒ Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø§Ù„Ø¹ÙÙˆ ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ© ÙÙŠ Ø¯ÙŠÙ†ÙŠ ÙˆØ¯Ù†ÙŠØ§ÙŠ ÙˆØ£Ù‡Ù„ÙŠ ÙˆÙ…Ø§Ù„ÙŠØŒ Ø§Ù„Ù„Ù‡Ù… Ø§Ø³ØªØ± Ø¹ÙˆØ±Ø§ØªÙŠ ÙˆØ¢Ù…Ù† Ø±ÙˆØ¹Ø§ØªÙŠØŒ Ø§Ù„Ù„Ù‡Ù… Ø§Ø­ÙØ¸Ù†ÙŠ Ù…Ù† Ø¨ÙŠÙ† ÙŠØ¯ÙŠ ÙˆÙ…Ù† Ø®Ù„ÙÙŠ ÙˆØ¹Ù† ÙŠÙ…ÙŠÙ†ÙŠ ÙˆØ¹Ù† Ø´Ù…Ø§Ù„ÙŠ ÙˆÙ…Ù† ÙÙˆÙ‚ÙŠØŒ ÙˆØ£Ø¹ÙˆØ° Ø¨Ø¹Ø¸Ù…ØªÙƒ Ø£Ù† Ø£ØºØªØ§Ù„ Ù…Ù† ØªØ­ØªÙŠ.</p>
            </div>
            <div id="tsl-2" class="athkar-item navigable grid-item athkar-color-1 col-span-4" tabindex="0">
              <p>Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ£ØµØ¨Ø­ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡ØŒ ÙˆØ§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ØŒ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡ØŒ Ù„Ù‡ Ø§Ù„Ù…Ù„Ùƒ ÙˆÙ„Ù‡ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ‡Ùˆ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¯ÙŠØ±. Ø±Ø¨ Ø£Ø³Ø£Ù„Ùƒ Ø®ÙŠØ± Ù…Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ÙˆØ®ÙŠØ± Ù…Ø§ Ø¨Ø¹Ø¯Ù‡ØŒ ÙˆØ£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø´Ø± Ù…Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ÙˆØ´Ø± Ù…Ø§ Ø¨Ø¹Ø¯Ù‡ØŒ Ø±Ø¨ Ø£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø§Ù„ÙƒØ³Ù„ ÙˆØ³ÙˆØ¡ Ø§Ù„ÙƒØ¨Ø±ØŒ Ø±Ø¨ Ø£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø¹Ø°Ø§Ø¨ ÙÙŠ Ø§Ù„Ù†Ø§Ø± ÙˆØ¹Ø°Ø§Ø¨ ÙÙŠ Ø§Ù„Ù‚Ø¨Ø±.</p>
            </div>
            <div id="tsl-3" class="athkar-item navigable grid-item athkar-color-1 col-span-4" tabindex="0">
              <p></p>
            </div>
          </div>
          <!-- Evening Athkar Panel -->
          <div id="athkar-masaa-content" class="tab-content athkar-grid hidden">
            <div id="ts-1" class="athkar-item navigable grid-item athkar-color-1" tabindex="0">
              <p>Ø¢ÙŠØ© Ø§Ù„ÙƒØ±Ø³ÙŠ</p>
              <span class="repetition">(Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</span>
            </div>
            <div id="ts-2" class="athkar-item navigable grid-item athkar-color-2" tabindex="0">
              <p>Ø§Ù„Ù„Ù‡Ù… Ø£Ø¹Ù†ÙŠ Ø¹Ù„Ù‰ Ø°ÙƒØ±Ùƒ ÙˆØ´ÙƒØ±Ùƒ ÙˆØ­Ø³Ù† Ø¹Ø¨Ø§Ø¯ØªÙƒ.</p>
            </div>
            <div id="ts-3" class="athkar-item navigable grid-item athkar-color-3" tabindex="0">
              <p>Ø§Ù„Ù…Ø¹ÙˆØ°Ø§Øª: Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ø®Ù„Ø§ØµØŒ Ø³ÙˆØ±Ø© Ø§Ù„ÙÙ„Ù‚ØŒ Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø§Ø³</p>
              <span class="repetition">(Ù£ Ù…Ø±Ø§Øª)</span>
            </div>
            <div id="ts-4" class="athkar-item navigable grid-item athkar-color-4" tabindex="0">
              <p>Ø­Ø³Ø¨ÙŠ Ø§Ù„Ù„Ù‡ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ù‡Ùˆ Ø¹Ù„ÙŠÙ‡ ØªÙˆÙƒÙ„Øª ÙˆÙ‡Ùˆ Ø±Ø¨ Ø§Ù„Ø¹Ø±Ø´ Ø§Ù„Ø¹Ø¸ÙŠÙ…</p>
              <span class="repetition">(Ù§ Ù…Ø±Ø§Øª)</span>
            </div>
            <div id="tm-1" class="athkar-item navigable grid-item athkar-color-5" tabindex="0">
              <p>Ø§Ù„Ù„Ù‡Ù… Ø¨Ùƒ Ø£Ù…Ø³ÙŠÙ†Ø§ØŒ ÙˆØ¨Ùƒ Ø£ØµØ¨Ø­Ù†Ø§ØŒ ÙˆØ¨Ùƒ Ù†Ø­ÙŠØ§ØŒ ÙˆØ¨Ùƒ Ù†Ù…ÙˆØªØŒ ÙˆØ¥Ù„ÙŠÙƒ Ø§Ù„Ù…ØµÙŠØ±.</p>
            </div>
            <div id="tm-2" class="athkar-item navigable grid-item athkar-color-1" tabindex="0">
              <p>Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ¶Ø± Ù…Ø¹ Ø§Ø³Ù…Ù‡ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ø£Ø±Ø¶ ÙˆÙ„Ø§ ÙÙŠ Ø§Ù„Ø³Ù…Ø§Ø¡ ÙˆÙ‡Ùˆ Ø§Ù„Ø³Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù„ÙŠÙ…</p>
              <span class="repetition">(Ù£ Ù…Ø±Ø§Øª)</span>
            </div>
            <div id="tm-3" class="athkar-item navigable grid-item athkar-color-2" tabindex="0">
              <p>ÙŠØ§ Ø­ÙŠ ÙŠØ§ Ù‚ÙŠÙˆÙ… Ø¨Ø±Ø­Ù…ØªÙƒ Ø£Ø³ØªØºÙŠØ«ØŒ Ø£ØµÙ„Ø­ Ù„ÙŠ Ø´Ø£Ù†ÙŠ ÙƒÙ„Ù‡ ÙˆÙ„Ø§ ØªÙƒÙ„Ù†ÙŠ Ø¥Ù„Ù‰ Ù†ÙØ³ÙŠ Ø·Ø±ÙØ© Ø¹ÙŠÙ†.</p>
            </div>
            <div id="tl-1" class="athkar-item navigable grid-item athkar-color-3" tabindex="0">
              <p>Ø§Ù„Ù„Ù‡Ù… Ù…Ø§ Ø£Ù…Ø³Ù‰ Ø¨ÙŠ Ù…Ù† Ù†Ø¹Ù…Ø© Ø£Ùˆ Ø¨Ø£Ø­Ø¯ Ù…Ù† Ø®Ù„Ù‚Ùƒ ÙÙ…Ù†Ùƒ ÙˆØ­Ø¯Ùƒ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„ÙƒØŒ ÙÙ„Ùƒ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ„Ùƒ Ø§Ù„Ø´ÙƒØ±.</p>
            </div>
            <div id="tl-2" class="athkar-item navigable grid-item athkar-color-4 col-span-2" tabindex="0">
              <p>Ø³ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØºØºØ§Ø±: Ø§Ù„Ù„Ù‡Ù… Ø£Ù†Øª Ø±Ø¨ÙŠ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†ØªØŒ Ø®Ù„Ù‚ØªÙ†ÙŠ ÙˆØ£Ù†Ø§ Ø¹Ø¨Ø¯ÙƒØŒ ÙˆØ£Ù†Ø§ Ø¹Ù„Ù‰ Ø¹Ù‡Ø¯Ùƒ ÙˆÙˆØ¹Ø¯Ùƒ Ù…Ø§ Ø§Ø³ØªØ·Ø¹ØªØŒ Ø£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø´Ø± Ù…Ø§ ØµÙ†Ø¹ØªØŒ Ø£Ø¨ÙˆØ¡ Ù„Ùƒ Ø¨Ù†Ø¹Ù…ØªÙƒ Ø¹Ù„ÙŠØŒ ÙˆØ£Ø¨ÙˆØ¡ Ø¨Ø°Ù†Ø¨ÙŠ ÙØ§ØºÙØ± Ù„ÙŠØŒ ÙØ¥Ù†Ù‡ Ù„Ø§ ÙŠØºÙØ± Ø§Ù„Ø°Ù†ÙˆØ¨ Ø¥Ù„Ø§ Ø£Ù†Øª.</p>
            </div>
            <div id="tsl-1" class="athkar-item navigable grid-item athkar-color-5 col-span-4" tabindex="0">
              <p>Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø§Ù„Ø¹ÙÙˆ ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¯Ù†ÙŠØ§ ÙˆØ§Ù„Ø¢Ø®Ø±Ø©ØŒ Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø§Ù„Ø¹ÙÙˆ ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ© ÙÙŠ Ø¯ÙŠÙ†ÙŠ ÙˆØ¯Ù†ÙŠØ§ÙŠ ÙˆØ£Ù‡Ù„ÙŠ ÙˆÙ…Ø§Ù„ÙŠØŒ Ø§Ù„Ù„Ù‡Ù… Ø§Ø³ØªØ± Ø¹ÙˆØ±Ø§ØªÙŠ ÙˆØ¢Ù…Ù† Ø±ÙˆØ¹Ø§ØªÙŠØŒ Ø§Ù„Ù„Ù‡Ù… Ø§Ø­ÙØ¸Ù†ÙŠ Ù…Ù† Ø¨ÙŠÙ† ÙŠØ¯ÙŠ ÙˆÙ…Ù† Ø®Ù„ÙÙŠ ÙˆØ¹Ù† ÙŠÙ…ÙŠÙ†ÙŠ ÙˆØ¹Ù† Ø´Ù…Ø§Ù„ÙŠ ÙˆÙ…Ù† ÙÙˆÙ‚ÙŠØŒ ÙˆØ£Ø¹ÙˆØ° Ø¨Ø¹Ø¸Ù…ØªÙƒ Ø£Ù† Ø£ØºØªØ§Ù„ Ù…Ù† ØªØ­ØªÙŠ.</p>
            </div>
            <div id="tsl-2" class="athkar-item navigable grid-item athkar-color-1 col-span-4" tabindex="0">
              <p>Ø£Ù…Ø³ÙŠÙ†Ø§ ÙˆØ£Ù…Ø³Ù‰ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡ØŒ ÙˆØ§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ØŒ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡ØŒ Ù„Ù‡ Ø§Ù„Ù…Ù„Ùƒ ÙˆÙ„Ù‡ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ‡Ùˆ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¯ÙŠØ±. Ø±Ø¨ Ø£Ø³Ø£Ù„Ùƒ Ø®ÙŠØ± Ù…Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø© ÙˆØ®ÙŠØ± Ù…Ø§ Ø¨Ø¹Ø¯Ù‡Ø§ØŒ ÙˆØ£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø´Ø± Ù…Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø© ÙˆØ´Ø± Ù…Ø§ Ø¨Ø¹Ø¯Ù‡Ø§ØŒ Ø±Ø¨ Ø£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø§Ù„ÙƒØ³Ù„ ÙˆØ³ÙˆØ¡ Ø§Ù„ÙƒØ¨Ø±ØŒ Ø±Ø¨ Ø£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø¹Ø°Ø§Ø¨ ÙÙŠ Ø§Ù„Ù†Ø§Ø± ÙˆØ¹Ø°Ø§Ø¨ ÙÙŠ Ø§Ù„Ù‚Ø¨Ø±.</p>
            </div>
            <div id="tsl-4" class="athkar-item navigable grid-item athkar-color-1 col-span-4" tabindex="0">
              <p></p>
            </div>
          </div>
          <!-- NEW: Monthly Reminders Panel -->
          <div id="athkar-monthly-content" class="tab-content athkar-grid-monthly hidden">
            <div class="athkar-item navigable grid-item header col-span-5" tabindex="0">
              <p>ØªØ°ÙƒÙŠØ±Ø§Øª ÙˆØ£Ø¹Ù…Ø§Ù„ Ø´Ù‡Ø±ÙŠØ©</p>
            </div>
            <div class="athkar-item navigable grid-item athkar-color-1" tabindex="0">
              <p>Ø§Ù„ØµØ¯Ù‚Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</p>
            </div>
            <div class="athkar-item navigable grid-item athkar-color-2" tabindex="0">
              <p>ØµÙŠØ§Ù… Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø¨ÙŠØ¶</p>
              <span class="repetition">(Ù¡Ù£ØŒ Ù¡Ù¤ØŒ Ù¡Ù¥)</span>
            </div>
            <div class="athkar-item navigable grid-item athkar-color-3" tabindex="0">
              <p>Ù‚Ø±Ø§Ø¡Ø© Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù</p>
              <span class="repetition">(ÙƒÙ„ Ø¬Ù…Ø¹Ø©)</span>
            </div>
            <div class="athkar-item navigable grid-item athkar-color-4" tabindex="0">
              <p>ØµÙ„Ø© Ø§Ù„Ø±Ø­Ù…</p>
            </div>
            <div class="athkar-item navigable grid-item athkar-color-5" tabindex="0">
              <p> Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø£Ù† </p>
            </div>
            <div class="athkar-item navigable grid-item athkar-color-1 col-span-2" tabindex="0">
              <p>Ø¬Ù„Ø³Ø© Ù…Ø­Ø§Ø³Ø¨Ø© Ù„Ù„Ù†ÙØ³</p>
            </div>
            <div class="athkar-item navigable grid-item athkar-color-2" tabindex="0">
              <p>Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯</p>
            </div>
            <div class="athkar-item navigable grid-item athkar-color-3 col-span-2" tabindex="0">
              <p>ØªØ¹Ù„Ù… Ù…Ø³Ø£Ù„Ø© ÙÙ‚Ù‡ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</p>
            </div>
            <div id="tsl-5" class="athkar-item navigable grid-item athkar-color-1 col-span-4" tabindex="0">
              <p></p>
            </div>
          </div>
        </div>
      </section>
      <!-- Reciters Screen -->
      <section id="screen-Reciters" class="app-screen p-4 md:p-6 flex-col items-center justify-center h-full w-full">
        <button id="fullscreen-reciters-iframe-btn" onclick="toggleIframeFullscreen('reciters-iframe')" class="fullscreen-toggle-button navigable grid-item" title="Toggle Fullscreen Map"></button>
        <iframe id="reciters-iframe" class="full-iframe flex-grow" onclick="toggleIframeFullscreen('reciters-iframe')" class="fullscreen-toggle-button navigable grid-item" title="Reciters/TV" src="https://hihi2.com/" allow="geolocation; fullscreen" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true">
          <i class="fas fa-expand"></i>
        </iframe>
        <div class="mb-4 flex flex-wrap justify-center gap-2 flex-shrink-0 grid-container" style="
    transform: scale(1.1);
">
          <button data-src="https://hihi2.com/" class="iframe-src-button bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item active" tabindex="0"> Ù…Ø¨Ø§Ø±ÙŠØ§Øª </button>
          <button data-src="https://direct.aflam4you.net/playeraf.php?vid=9311&aflam_s=1&aflam_k=ff09665543234455" class="iframe-src-button bg-black-600 hover:bg-black-700 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> Ø«Ù…Ø§Ù†ÙŠØ© 1 </button>
          <button data-src="https://direct.aflam4you.net/zremb472.php?vid=68&aflam_s=1&aflam_w=360&aflam_h=250&aflam_k=1831551111111" class="iframe-src-button bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> beIN 1 </button>
          <button data-src="https://direct.aflam4you.net//zremb472.php?vid=2&aflam_s=1&aflam_w=360&aflam_h=250&aflam_k=183871551111" class="iframe-src-button bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> beIN 2 </button>
          <button data-src="https://direct.aflam4you.net/playeraf.php?vid=1&aflam_s=1&aflam_k=ff09665543234455" class="iframe-src-button bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> beIN 3 </button>
          <button data-src="https://player.mangomolo.com/v1/live?id=MTY4&channelid=MTYx&countries=Q0M=&w=100%25&h=100%25&filter=DENY&signature=3fd1e8dd84138a41bf33d93afd4a7f09&language=en&app_id=&fullscreen=yes&player_profile=&base_url=aHR0cHM6Ly9heW4ub20vbGl2ZS8xNjEvJUQ5JTgyJUQ5JTg2JUQ4JUE3JUQ4JUE5LSVEOCVCOSVEOSU4NSVEOCVBNyVEOSU4Ni0lRDklODUlRDglQTglRDglQTclRDglQjQlRDglQjE=&autoplay=true&vast=true" class="iframe-src-button bg-red-800 hover:bg-red-900 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> Ø¹Ù…Ø§Ù† Ù…Ø¨Ø§Ø´Ø± </button>
          <button data-src="https://play.arab-stream.live/p/mbc-1-ksa.html" class="iframe-src-button bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> MBC 1 </button>
          <button data-src="https://direct.aflam4you.net/playeraf.php?vid=51&aflam_s=1&aflam_k=ff09665543234455" class="iframe-src-button bg-yellow-800 hover:bg-yellow-900 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> Ø§Ù„Ù‚Ø±Ø§Ù† Ø§Ù„ÙƒØ±ÙŠÙ… </button>
          <button data-src="https://direct.aflam4you.net/playeraf.php?vid=4834&aflam_s=1&aflam_k=ff09665543234455" class="iframe-src-button bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> Ø«Ù…Ø§Ù†ÙŠØ© 2 </button>
          <button data-src="https://direct.aflam4you.net/playeraf.php?vid=94&aflam_s=1&aflam_k=ff09665543234455" class="iframe-src-button bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> Ø«Ù…Ø§Ù†ÙŠØ© 3 </button>
          <button data-src="https://direct.aflam4you.net/zremb472.php?vid=500&aflam_s=1&aflam_w=360&aflam_h=250&aflam_k=1831551111111" class="iframe-src-button bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> MBC ACTION </button>
          <button data-src="https://direct.aflam4you.net/browse-watch-koora_live-tv-live-videos-1-date.html" class="iframe-src-button bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full transition-colors duration-200 text-sm navigable grid-item" tabindex="0"> OTHERS </button>
        </div>
      </section>
      <!-- Weather Screen -->
      <section id="screen-Weather" class="app-screen p-4 md:p-6 flex-col items-center justify-start h-full">
        <div class="w-full h-full flex flex-col gap-4 flex-grow">
          <!-- Hourly Forecast -->
          <div id="hourly-forecast-container" class="grid grid-cols-7 gap-2 w-full glass-surface glass-surface--svg p-3 rounded-3xl">
            <!-- JS will populate this -->
            <div class="text-center text-white/70 col-span-7">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª...</div>
          </div>
          <!-- Location Temperatures -->
          <div id="location-temps-container" class="grid grid-cols-2 sm:grid-cols-4 gap-4 w-full flex-grow">
            <!-- JS will populate this -->
            <div class="text-center text-white/70 col-span-full">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...</div>
          </div>
        </div>
      </section>
      <!-- 3D Screen (Formerly Map Screen) -->
      <section id="screen-Map" class="app-screen p-4 md:p-6 flex-col h-full items-center justify-center relative">
        <button id="fullscreen-map-btn" onclick="toggleIframeFullscreen('screen-Map')" class="fullscreen-toggle-button navigable grid-item" title="Toggle Fullscreen Map">
          <i class="fas fa-expand"></i>
        </button>
        <div class="w-full h-full bg-black2 rounded-3xl flex items-center justify-center p-1 overflow:hidden">
          <iframe id="cardash" title="LEXSUS ES" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share WIDTH="95%" HEIGHT="95%" src="https://sketchfab.com/models/17ed331fd31f491fa3907156f0b0b55e/embed?autostart=1&preload=1&annotations_visible=0&annotation=0&annotation_cycle=6&transparent=1&ui_theme=dark"></iframe>
        </div>
        <!-- Right side widget -->
        <div id="right-side-info-widgets" class="absolute top-8 right-8 flex flex-col gap-3 z-10">
          <div id="3d-screen-weather-widget" class="p-3 rounded-2xl text-center flex items-center gap-2 navigable grid-item" tabindex="0" style="background-color: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="thermometer" class="lucide lucide-thermometer w-6 h-6 text-red-400">
              <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"></path>
            </svg>
            <span class="text-xl font-bold" id="3d-screen-weather-temp">--Â°C</span>
          </div>
          <div id="3d-screen-moon-widget" class="p-4 rounded-2xl text-center flex flex-col items-center justify-center navigable grid-item glass-surface glass-surface--svg" tabindex="0">
            <img id="3d-moon-icon" src="https://cdn.weatherapi.com/weather/64x64/night/113.png" alt="Moon Phase" class="moon-icon-large mb-2" />
            <div class="text-sm text-white/70">Ø§Ù„Ù‚Ù…Ø± (Ø¥Ø¶Ø§Ø¡Ø©)</div>
            <div class="text-2xl font-bold" id="3d-moon-phase">--%</div>
          </div>
        </div>
        <!-- NEW: Left side widgets -->
        <div id="3d-screen-info-widgets" class="absolute top-8 left-8 flex flex-col gap-3 z-10">
          <div class="p-3 rounded-2xl text-center flex items-center gap-3 navigable grid-item" tabindex="0">
            <i data-lucide="moon" class="w-7 h-7 text-cyan-300"></i>
            <div>
              <div class="text-sm text-white/70">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
              <div class="text-xl font-bold" id="3d-screen-next-prayer">--</div>
            </div>
          </div>
          <div class="p-3 rounded-2xl text-center flex items-center gap-3 navigable grid-item" tabindex="0">
            <i data-lucide="gauge-circle" class="w-7 h-7 text-green-400"></i>
            <div>
              <div class="text-sm text-white/70">Ø§Ù„Ø³Ø±Ø¹Ø©</div>
              <div class="text-xl font-bold" id="3d-screen-speed">-- km/h</div>
            </div>
          </div>
          <div id="geares" class="p-3 rounded-2xl text-center flex items-center gap-3 navigable grid-item" tabindex="0">
            <i data-lucide="parking-circle" class="w-7 h-7 text-orange-400"></i>
            <div>
              <div class="text-sm text-white/70">Ø§Ù„Ù‚ÙŠØ±</div>
              <div class="text-xl font-bold" id="3d-screen-gear">--</div>
            </div>
          </div>
          <!-- NEW: Direction Widget -->
          <div class="p-3 rounded-2xl text-center flex items-center gap-3 navigable grid-item" tabindex="0">
            <i data-lucide="compass" class="w-7 h-7 text-blue-300"></i>
            <div>
              <div class="text-sm text-white/70">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</div>
              <div class="text-xl font-bold" id="3d-screen-dir">--</div>
            </div>
          </div>
        </div>
        <!-- NEW: Sticky Directional Controls -->
        <div id="direction-controls-3d" class="absolute top-1/2 -translate-y-1/2 right-8 grid grid-cols-3 z-10">
          <button data-dir="NE" class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">NE</button>
          <button data-dir="N" class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">N</button>
          <button data-dir="NW" class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">NW</button>
          <button data-dir="E" class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">E</button>
          <div class="center-spacer w-10 h-10"></div>
          <button data-dir="W" class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">W</button>
          <button data-dir="SE" class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">SE</button>
          <button data-dir="S" class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">S</button>
          <button data-dir="SW" class="glass-surface glass-surface--svg p-2 rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold navigable grid-item" tabindex="0">SW</button>
        </div>
      </section>
      <!-- Electronic Quran App Screen -->
      <section id="screen-Quran" class="app-screen flex-col items-center justify-center h-full relative">
        <button id="fullscreen-screen-Quran-btn" onclick="toggleIframeFullscreen('quran-iframe')" class="fullscreen-toggle-button navigable grid-item" title="Toggle Fullscreen Map">
          <i class="fas fa-expand"></i>
        </button>
        <div id="quran-quick-access" class="mt-4 bg-black/30 p-4 rounded-xl flex flex-col gap-3 items-end z-20 glass-surface glass-surface--svg w-full max-w-md">
          <button id="quran-go-button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition-colors duration-200 flex items-center gap-2 text-sm self-center navigable grid-item" tabindex="0"></button>
        </div>
        <div class="w-full h-full glass-surface glass-surface--svg p-4 rounded-xl flex flex-col items-center flex-grow" style="height: 100%!important;">
          <iframe id="quran-iframe" class="full-iframe" src="https://quran.com/?lang=ar" lang="ar" title="Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…" frameborder="0" allow="fullscreen; picture-in-picture"></iframe>
        </div>
      </section>
    </main>
    <!-- Navigation Dock (Left Sidebar) -->
    <nav class="w-20 sm:w-24 bg-black/20 flex flex-col items-center justify-start pt-8 p-2 space-y-4 border-l border-white/10 flex-shrink-0 transition-opacity 0.3s ease grid-container">
      <button data-app="Dashboard" class="app-icon navigable grid-item" tabindex="0">
        <i data-lucide="layout-grid"></i>
      </button>
      <button data-app="Media" class="app-icon navigable grid-item" tabindex="0">
        <i data-lucide="play-circle"></i>
      </button>
      <button data-app="DashboardCarPlay" class="app-icon navigable grid-item" tabindex="0">
        <i data-lucide="layout-template" class="text-blue-400"></i>
      </button>
      <button data-app="Radio" class="app-icon navigable grid-item" tabindex="0">
        <i data-lucide="radio"></i>
      </button>
      <button data-app="Athkar" class="app-icon navigable grid-item" tabindex="0">
        <i data-lucide="book-heart"></i>
      </button>
      <button data-app="Reciters" class="app-icon navigable grid-item" tabindex="0">
        <i data-lucide="tv"></i>
      </button>
      <button data-app="Weather" class="app-icon navigable grid-item" tabindex="0">
        <i data-lucide="cloud-sun"></i>
      </button>
      <button data-app="Map" class="app-icon navigable grid-item" tabindex="0">
        <i data-lucide="map"></i>
      </button>
      <button data-app="Quran" class="app-icon navigable grid-item" tabindex="0">
        <i data-lucide="book-open"></i>
      </button>
    </nav>
  </div>
</div>
<!-- Floating UI Elements -->
<button id="floating-media-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item" tabindex="0">
  <img src="https://imgs.search.brave.com/XDd5Wmrn5fv_N_K9IAwx2BnetQI2wEZh4jQvIHQm6PE/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jZG4w/Lmljb25maW5kZXIu/Y29tL2RhdGEvaWNv/bnMvdHV0cy8xMjgv/eW91dHViZS5wbmc" width="22px" alt="YouTube" class="w-full h-full object-contain p-1" />
</button>
<button id="add-video-by-url-btn" class="navigable grid-item bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full shadow-lg" title="Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·">
  <i data-lucide="plus-circle" class="w-6 h-6"></i>
</button>
<button id="start-trip-floating-button" class="glass-surface glass-surface--svg rounded-full navigable grid-item" tabindex="0">
  <i data-lucide="map-pin" class="w-6 h-6"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© </button>
<!-- NEW: Minimized Video Button -->
<div id="floating-minimized-video-button" class="navigable grid-item glass-surface glass-surface--svg" tabindex="0">
  <button id="minimized-restore-btn" title="ØªÙƒØ¨ÙŠØ±/Ø§Ø³ØªØ¹Ø§Ø¯Ø©" class="p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-colors navigable grid-item">
    <i data-lucide="maximize-2" class="w-5 h-5"></i>
  </button>
  <div class="flex flex-col items-start overflow-hidden flex-grow px-1 min-w-0">
    <span class="minimized-title font-semibold text-sm truncate w-full">Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª...</span>
  </div>
  <button id="minimized-play-pause-btn" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù" class="p-2 rounded-full bg-white/20 text-white/90 hover:bg-white/30 transition-colors navigable grid-item">
    <i data-lucide="play" class="w-5 h-5 play-icon"></i>
    <i data-lucide="pause" class="w-5 h-5 pause-icon hidden"></i>
  </button>
  <div id="playback-rates-group" class="flex gap-1 flex-shrink-0">
    <button data-rate="1.0" class="rate-btn  navigable grid-item" tabindex="0">1.0x</button>
    <button data-rate="1.25" class="rate-btn navigable grid-item" tabindex="0">1.25x</button>
    <button data-rate="1.65" class="rate-btn navigable grid-item" tabindex="0">1.65x</button>
  </div>
</div>
<!-- NEW: Bottom Left Controls -->
<button id="floating-mic-button" class="navigable grid-item floating-button" tabindex="0" title="Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="mic" class="w-6 h-6">
    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path>
    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
    <line x1="12" x2="12" y1="19" y2="22"></line>
  </svg>
</button>
<div id="bottom-left-controls" class="fixed bottom-4 left-4 flex flex-row gap-2 z-[100] grid-container">
  <button id="pause-animation-button" class="glass-surface glass-surface--svg rounded-full p-3 navigable grid-item" tabindex="0" title="Ø¥ÙŠÙ‚Ø§Ù/ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©">
    <i data-lucide="play" class="w-5 h-5"></i>
    <i data-lucide="pause" class="w-5 h-5 hidden"></i>
  </button>
  <button id="zoom-in-button" class="glass-surface glass-surface--svg rounded-full p-3 navigable grid-item" tabindex="0" title="ØªÙƒØ¨ÙŠØ±">
    <i data-lucide="zoom-in" class="w-5 h-5"></i>
  </button>
  <button id="zoom-out-button" class="glass-surface glass-surface--svg rounded-full p-3 navigable grid-item" tabindex="0" title="ØªØµØºÙŠØ±">
    <i data-lucide="zoom-out" class="w-5 h-5"></i>
  </button>
  <button id="remove-cache-button" class="glass-surface glass-surface--svg rounded-full p-3 navigable grid-item" tabindex="0" title="Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª">
    <i data-lucide="trash-2" class="w-5 h-5"></i>
  </button>
</div>
<!-- Video Pop-up Container -->
<div id="video-popup-container">
  <div id="video-popup-player-container"></div>
  <div class="video-popup-controls grid-container">
    <button id="video-popup-close-button" title="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ" class="navigable grid-item" tabindex="0">
      <i data-lucide="x" class="w-4 h-4"></i>
    </button>
    <button id="video-popup-minimize-button" title="ØªØµØºÙŠØ± Ø¥Ù„Ù‰ ÙƒØ¨Ø³ÙˆÙ„Ø©" class="navigable grid-item" tabindex="0">
      <i data-lucide="chevrons-down-up" class="w-4 h-4"></i>
    </button>
  </div>
</div>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.152.0/build/three.module.js",
      "three/examples/jsm/loaders/GLTFLoader": "https://unpkg.com/three@0.152.0/examples/jsm/loaders/GLTFLoader.js"
    }
  }
</script>

<script type="module">
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';
  
  // Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ù‡ÙŠ Ø§Ù„Ø£Ù‡Ù…: ØªØ¬Ø¹Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù…Ø±Ø¦ÙŠØ© Ù„ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
  window.THREE = THREE;
  window.GLTFLoader = GLTFLoader; 
  console.log("âœ… Three.js & GLTFLoader are now Global");
</script>

    <script>
// --- ØªØ¹Ø±ÙŠÙ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø© ---
const isRTL = document.documentElement.dir === 'rtl';

// --- Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Main Entry) ---
function handleNavigation(e) {
    const key = e.key.toLowerCase();
    const activeEl = document.activeElement;

    // 1. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¥Ø°Ø§ ÙÙÙ‚Ø¯ Ø£Ùˆ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    if (!activeEl || activeEl === document.body) {
        if (key === 'arrowdown' || key === 'enter') {
            const firstIcon = document.querySelector('nav .app-icon');
            if (firstIcon) setFocus(firstIcon);
            e.preventDefault();
            return;
        }
    }

    // 2. ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù†Ø´Ø·
    const inScrollList = activeEl.closest('.favorites-dashboard-horizontal-scroll, .scroll-viewport');
    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø¹Ø§Ø¦Ù…Ø§Ù‹ (Ù…Ø«Ù„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠØ©)
    const isFloating = activeEl.closest('#bottom-left-controls, #floating-media-button, #floating-mic-button, #floating-minimized-video-button, #back-to-search-floating-button, #add-video-by-url-btn');

    // 3. ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ù†Ø·Ù‚
    if (isFloating) {
        handleFloatingNav(key, activeEl); // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
    } else if (inScrollList) {
        handleScrollListNav(key, activeEl); // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø²Ù„Ù‚Ø©
    } else {
        // Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø§Ù„Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        handleSpatialNav(key, activeEl);
    }
}

// --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© (Fixed Floating Buttons) ---
function handleFloatingNav(key, el) {
    if (key === 'arrowup') {
        // Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        jumpToMainContent();
    } else if (key === 'arrowright') {
        // Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
        focusSidebar();
    } else if (key === 'arrowleft') {
        // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¬Ø§ÙˆØ±Ø©
        handleSpatialNav(key, el); 
    } else if (key === 'enter' || key === 'ok') {
        el.click();
    }
}

// --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø²Ù„Ù‚Ø© (Scroll Lists) ---
function handleScrollListNav(key, el) {
    const container = el.parentElement;
    const items = Array.from(container.querySelectorAll('.grid-item'));
    const idx = items.indexOf(el);

    if (key === 'arrowright') { // RTL: Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ù„Ù„ÙŠÙ…ÙŠÙ†)
        if (idx > 0) {
            setFocus(items[idx - 1]);
            container.scrollBy({ left: 200, behavior: 'smooth' });
        } else {
            focusSidebar(); // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        }
    } else if (key === 'arrowleft') { // RTL: Ø§Ù„ØªØ§Ù„ÙŠ (Ù„Ù„ÙŠØ³Ø§Ø±)
        if (idx < items.length - 1) {
            setFocus(items[idx + 1]);
            container.scrollBy({ left: -200, behavior: 'smooth' });
        }
    } else if (key === 'arrowup') {
        handleSpatialNav('up', el);
    } else if (key === 'arrowdown') {
        handleSpatialNav('down', el);
    } else if (key === 'enter' || key === 'ok') {
        el.click();
    }
}

// --- Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø§Ù„Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© (Spatial Navigation) ---
function handleSpatialNav(key, el) {
    const directionMap = {
        'arrowup': 'up', 'arrowdown': 'down',
        'arrowleft': 'left', 'arrowright': 'right',
        'enter': 'enter', 'ok': 'enter'
    };
    const direction = directionMap[key];
    if (!direction) return;

    if (direction === 'enter') {
        el.click();
        return;
    }

    const nextEl = findNextFocus(el, direction);

    if (nextEl) {
        setFocus(nextEl);
    } else {
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙˆØ§Ù (Edge Cases)
        const inSidebar = el.closest('nav');
        // Ù…Ù† Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± -> Ù„Ù„Ù…Ø­ØªÙˆÙ‰ (ÙŠØ³Ø§Ø± ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
        if (inSidebar && direction === 'left') { 
             jumpToMainContent();
        }
        // Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -> Ù„Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± (ÙŠÙ…ÙŠÙ† ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
        else if (!inSidebar && direction === 'right') {
            focusSidebar();
        }
    }
}

// --- Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ (Geometric Search) ---
function findNextFocus(currentEl, direction) {
    const rect = currentEl.getBoundingClientRect();
    const currentCenter = {
        x: rect.left + rect.width / 2,
        y: rect.top + rect.height / 2
    };

    const allCandidates = Array.from(document.querySelectorAll('.navigable, .grid-item')).filter(el => {
        return el !== currentEl && el.offsetParent !== null && !el.closest('.hidden');
    });

    let bestCandidate = null;
    let minDistance = Infinity;

    allCandidates.forEach(candidate => {
        const cRect = candidate.getBoundingClientRect();
        const cCenter = {
            x: cRect.left + cRect.width / 2,
            y: cRect.top + cRect.height / 2
        };

        let isValid = false;
        // ØªØ³Ø§Ù…Ø­ 20px Ù„ØªØ¹ÙˆÙŠØ¶ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©
        switch (direction) {
            case 'up': isValid = cRect.bottom <= rect.top + 20; break;
            case 'down': isValid = cRect.top >= rect.bottom - 20; break;
            case 'left': isValid = cRect.right <= rect.left + 20; break;
            case 'right': isValid = cRect.left >= rect.right - 20; break;
        }

        if (isValid) {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¥Ù‚Ù„ÙŠØ¯ÙŠØ©
            const dist = Math.sqrt(Math.pow(cCenter.x - currentCenter.x, 2) + Math.pow(cCenter.y - currentCenter.y, 2));
            
            // Ø¥Ø¶Ø§ÙØ© ÙˆØ²Ù† Ù„Ù„Ù…Ø­Ø§Ø°Ø§Ø© (ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø®Ø·)
            const alignmentBonus = (direction === 'up' || direction === 'down') 
                ? Math.abs(cCenter.x - currentCenter.x) 
                : Math.abs(cCenter.y - currentCenter.y);

            const totalScore = dist + (alignmentBonus * 2.5); 

            if (totalScore < minDistance) {
                minDistance = totalScore;
                bestCandidate = candidate;
            }
        }
    });

    return bestCandidate;
}

// --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
function jumpToMainContent() {
    const activeScreen = document.querySelector('.app-screen.active');
    if (!activeScreen) return;
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¹Ù†ØµØ± Ù…Ø­ØªÙˆÙ‰ Ø±Ø¦ÙŠØ³ÙŠ
    const target = activeScreen.querySelector('.tab-content:not(.hidden) .grid-item') || 
                   activeScreen.querySelector('.dashboard-main-grid .grid-item') ||
                   activeScreen.querySelector('.grid-item');

    if (target) setFocus(target);
}

function focusSidebar() {
    const activeIcon = document.querySelector('nav .app-icon.active') || document.querySelector('nav .app-icon');
    if (activeIcon) setFocus(activeIcon);
}

function setFocus(el) {
    if (!el) return;
    document.querySelectorAll('.tv-focus').forEach(i => i.classList.remove('tv-focus'));
    el.classList.add('tv-focus');
    el.focus({ preventScroll: true });
    el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
}









function handleHorizontalMapping(key, el) {
    const items = Array.from(el.parentElement.querySelectorAll('.grid-item'));
    const idx = items.indexOf(el);

    switch(key) {
        case 'arrowright': // Move Next
            if (idx < items.length - 1) {
                setFocus(items[idx + 1]);
                items[idx + 1].parentElement.scrollBy({ left: 250, behavior: 'smooth' });
            }
            break;
        case 'arrowleft': // Move Previous
            if (idx > 0) {
                setFocus(items[idx - 1]);
                items[idx - 1].parentElement.scrollBy({ left: -250, behavior: 'smooth' });
            } else {
                // Exit to Sidebar if at the start
                const sidebarIcon = document.querySelector('nav .app-icon.active');
                if (sidebarIcon) setFocus(sidebarIcon);
            }
            break;
        case 'arrowup': // Exit to Search Row
            const searchInput = document.getElementById('youtube-search-input');
            if (searchInput) setFocus(searchInput);
            break;
    }
}

function handleGridMapping(key, el) {
    const container = el.closest('.grid-container') || el.closest('.reader-container');
    if (!container) return;

   const currentScreen = el.closest('.app-screen');
    const items = Array.from(currentScreen.querySelectorAll('.navigable')).filter(i => i.offsetParent !== null);
    const idx = items.indexOf(el);

    if (key === 'arrowleft' && (idx === 0 || el.classList.contains('app-icon'))) {
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ§Ø¨ Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
        const activeIcon = document.querySelector('nav .app-icon.active');
        setFocus(activeIcon);
        return;
    }


    switch(key) {
        case 'arrowright': if (idx % cols !== 0) setFocus(items[idx - 1]); break;
        case 'arrowleft': 
            if ((idx + 1) % cols === 0) {
                const sidebarIcon = document.querySelector('nav .app-icon.active');
                if (sidebarIcon) setFocus(sidebarIcon);
            } else if (idx < items.length - 1) {
                setFocus(items[idx + 1]);
            }
            break;
        case 'arrowup': if (idx >= cols) setFocus(items[idx - cols]); break;
        case 'arrowdown': if (idx + cols < items.length) setFocus(items[idx + cols]); break;
    }
}


    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
// Ù‚Ù…Ù†Ø§ Ø¨ØªÙˆØ­ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø¥Ù„Ù‰ savedTuner Ù„Ù…Ù†Ø¹ Ø®Ø·Ø£ Ø§Ù„Ù€ ReferenceError
const savedTunerData = localStorage.getItem('custom_tuner_settings');
const savedTuner = savedTunerData ? JSON.parse(savedTunerData) : null;

window.tuner = savedTuner || { 
    zoom: 19.5, 
    tilt: 65, 
    scale: 1.02, 
    offset: 50 
};

// 2. Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… (Car Scale)
function adjustScale(amount) {
    // Ù†Ø¶Ù…Ù† Ø£Ù†Ù†Ø§ Ù†Ø¹Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
    window.tuner.scale = Math.max(0.1, (window.tuner.scale || 0.75) + amount);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø³ÙŠØ§Ø±Ø© ÙÙˆØ±Ø§Ù‹
    if (window.carOverlay) window.carOverlay.requestRedraw();
    console.log("ğŸ“ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", window.tuner.scale.toFixed(2));
}

// 3. Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙŠÙ„Ø§Ù† (Tilt) Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø± â†‘ â†“
function adjustTilt(amount) {
    if (!window.dashboardGoogleMap) return;
    
    let currentTilt = window.dashboardGoogleMap.getTilt();
    let newTilt = Math.min(Math.max(currentTilt + amount, 0), 75);
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙˆØ±Ø§Ù‹
    window.dashboardGoogleMap.setTilt(newTilt);
    
    window.tuner.tilt = newTilt;
    console.log("ğŸ“ Ø§Ù„Ù…ÙŠÙ„Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯:", newTilt);
}

// 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© (ğŸ’¾)
// Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…ØªØµÙØ­
// 1. ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø±Ø³Ø§Ù„Ø©
window.saveCurrentTuner = function() {
    if (!window.dashboardGoogleMap) return;
    
    // Ù‚Ù†Øµ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù…ÙˆØ¯ÙŠÙ„
    const currentZoom = window.dashboardGoogleMap.getZoom();
    const currentTilt = window.dashboardGoogleMap.getTilt();
    const currentScale = window.tuner.scale || 0.75;
    const currentOffset = window.tuner.offset || 40;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
    window.tuner.zoom = currentZoom;
    window.tuner.tilt = currentTilt;
    // Ø§Ù„Ø³ÙƒÙŠÙ„ ÙˆØ§Ù„Ø§ÙØ³ÙŠØª ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ù…Ø§ Ù„Ø­Ø¸ÙŠØ§Ù‹ Ø¹Ø¨Ø± Ø£Ø²Ø±Ø§Ø±Ù‡Ù… Ø¨Ø§Ù„ÙØ¹Ù„

    // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­ (Ø§Ù„ÙƒØ§Ø´)
    localStorage.setItem('custom_tuner_settings', JSON.stringify(window.tuner));
    
    // Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„ØªØ¹ÙˆØ¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…Ù„Ø§Ø­Ù‚Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    window.isUserAdjusting = false;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    alert(`âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­!
-------------------------
ğŸ” Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø²ÙˆÙ…: ${currentZoom.toFixed(2)}
ğŸ“ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ù…ÙŠÙ„Ø§Ù†: ${currentTilt}Â°
ğŸš— Ø­Ø¬Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${currentScale.toFixed(2)}
â†”ï¸ Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©: ${currentOffset}px`);

    console.log("ğŸ’¾ Saved Settings:", window.tuner);
};

// 2. ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ù‚Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
window.updateGoogleMapLocation = function(pos) {
    if (!pos || !pos.coords || !window.dashboardGoogleMap) return;

    const { latitude: lat, longitude: lng, heading } = pos.coords;
    const currentHeading = heading || 0;

    window.appState.currentLocation = { lat, lng };
    window.appState.car.heading = currentHeading;

    const cameraOptions = {
        center: { lat, lng },
        heading: currentHeading,
        tilt: window.tuner.tilt // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙ„Ø§Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸
    };

    // Ù„Ø§ Ù†ØºÙŠØ± Ø§Ù„Ø²ÙˆÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ„Ù…Ø³ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
    if (!window.isUserAdjusting) {
        cameraOptions.zoom = window.tuner.zoom; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø²ÙˆÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸
        window.dashboardGoogleMap.moveCamera(cameraOptions);
        window.dashboardGoogleMap.panBy(window.tuner.offset, 0);
    }

    if (window.carOverlay) window.carOverlay.requestRedraw();
};

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙŠÙ„Ø§Ù† (Tilt)
window.adjustTilt = function(amount) {
    if (!window.dashboardGoogleMap) return;
    let newTilt = Math.min(Math.max(window.dashboardGoogleMap.getTilt() + amount, 0), 75);
    window.dashboardGoogleMap.setTilt(newTilt);
    window.tuner.tilt = newTilt;
};

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… (Scale)
window.adjustScale = function(amount) {
    window.tuner.scale = Math.max(0.1, (window.tuner.scale || 0.75) + amount);
    if (window.carOverlay) window.carOverlay.requestRedraw();
};
    
    
        // 1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ù„ØªØ¯ÙˆÙŠØ±
let carplayRotationIndex = 0;
let dashRotationIndex = 0;

// 2. Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª (ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù€ IDs ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ HTML Ù„Ø¯ÙŠÙƒ)
const carplaySlideIds = [
    'carplay-card-media', 
    'carplay-card-nasa',
    'carplay-card-weather'
];

const dashSlideIds = [
    'dash-card-media', 
    'dash-card-nasa', 
    'dash-card-weather',
    'dash-card-gregorian-date' // Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¶Ø§Ù Ù‡Ù†Ø§
];

// 3. Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ­Ø¯ÙŠØ« (ÙŠØ¹Ù…Ù„ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©)
function updateAllDisplays() {
    window.updateGregorianCard();
    const player = window.popupPlayer || window.player;
    const now = Date.now();

    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙƒÙ„
    syncDataToElements(player);

    // ØªØ¯ÙˆÙŠØ± ÙƒØ±ÙˆØª CarPlay ÙƒÙ„ 7 Ø«ÙˆØ§Ù†ÙŠ
    if (!window.lastCarplaySwap || (now - window.lastCarplaySwap > 7000)) {
        rotateSlidesSpecific('.carousel-slide', carplaySlideIds, 'carplay');
        window.lastCarplaySwap = now;
    }

    // ØªØ¯ÙˆÙŠØ± ÙƒØ±ÙˆØª Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙƒÙ„ 7 Ø«ÙˆØ§Ù†ÙŠ
    if (!window.lastDashSwap || (now - window.lastDashSwap > 7000)) {
        rotateSlidesSpecific('.carousel-slide-dash', dashSlideIds, 'dash');
        window.lastDashSwap = now;
    }
}

window.updateGregorianCard = function() {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡Ø§
    const dayEl = document.getElementById('greg-day-num');
    const monthEl = document.getElementById('greg-month-name');
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±ØŒ ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ£Ø®ÙŠØ±)
    if (!dayEl || !monthEl) {
        console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ IDs Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø¹Ø¯ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹...");
        return; 
    }

    const today = new Date(); //
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const dayFormatter = new Intl.DateTimeFormat('en-SA', { day: 'numeric' }); //
    const monthFormatter = new Intl.DateTimeFormat('en-SA', { month: 'long' }); //
    
    const dayInArabic = dayFormatter.format(today); //
    const monthInArabic = monthFormatter.format(today); //
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
    dayEl.innerText = dayInArabic; //
    monthEl.innerText = monthInArabic; //
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ
    Object.assign(dayEl.style, {
        backgroundImage: 'linear-gradient(180deg, #ffffff 0%, #a1a1a1 100%)', //
        webkitBackgroundClip: 'text', //
        webkitTextFillColor: 'transparent', //
        filter: 'drop-shadow(0 4px 8px rgba(0,0,0,0.4))', //
        fontWeight: '900' //
    });
};
// ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„
// 4. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„
function rotateSlidesSpecific(selector, idArray, type) {
    let idx;
    if (type === 'carplay') {
        carplayRotationIndex = (carplayRotationIndex + 1) % idArray.length;
        idx = carplayRotationIndex;
    } else {
        dashRotationIndex = (dashRotationIndex + 1) % idArray.length;
        idx = dashRotationIndex;
    }

    const nextId = idArray[idx];
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø¨ØµØ±ÙŠØ§Ù‹
    document.querySelectorAll(selector).forEach(slide => {
        if (slide.id === nextId) {
            slide.classList.add('active');
            slide.classList.remove('hidden');
        } else {
            slide.classList.remove('active');
            // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ù„Ø¶Ù…Ø§Ù† Ø³Ù„Ø§Ø³Ø© Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
            setTimeout(() => {
                if (!slide.classList.contains('active')) slide.classList.add('hidden');
            }, 600); 
        }
    });
}

// 5. Ø¯Ø§Ù„Ø© Ø­Ù‚Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
function syncDataToElements(player) {
// 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´ØºÙ„ ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ±
const activePlayer = window.popupPlayer || window.player || player; //
const dashTitleEl = document.getElementById('dash-media-title');
const dashThumbEl = document.getElementById('dash-media-thumb');

// 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø£ÙˆÙ„ÙˆÙŠØ© Ø°ÙƒÙŠØ©
let finalTitle = "";
if (activePlayer && typeof activePlayer.getVideoData === 'function') {
    const vData = activePlayer.getVideoData();
    finalTitle = (vData && vData.title) ? vData.title : ""; //
}

// Ø§Ù„Ø­Ù„ Ø§Ù„Ø¨Ø¯ÙŠÙ„: Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù…Ø´ØºÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­)
if (!finalTitle || finalTitle === "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") {
    finalTitle = document.title.split(' - YouTube')[0]; //
}

// 3. Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
if (dashTitleEl && finalTitle && finalTitle !== "" && finalTitle !== "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") {
    dashTitleEl.textContent = finalTitle; //
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©
    if (dashThumbEl && activePlayer && typeof activePlayer.getVideoData === 'function') {
        const vData = activePlayer.getVideoData();
        if (vData.video_id) {
            dashThumbEl.src = `https://img.youtube.com/vi/${vData.video_id}/hqdefault.jpg`; //
        }
    }

    // 4. Ø¶Ø¨Ø· Ø§Ù„ØªØ­Ø±ÙŠÙƒ (Marquee)
    const container = document.getElementById('dash-media-title-container');
    if (container && dashTitleEl.scrollWidth > container.offsetWidth) {
        dashTitleEl.className = "text-lg font-black text-white animate-marquee whitespace-nowrap"; //
    } else {
        dashTitleEl.className = "text-lg font-black text-white line-clamp-2"; //
    }
}
    const now = new Date(); 
    const weather = appState.weather;
    const moon = appState.moonData;


    // Ø£. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙŠØ¯ÙŠØ§
    if (player && typeof player.getVideoData === 'function') {
        const vData = player.getVideoData();
        const thumbUrl = `https://img.youtube.com/vi/${vData.video_id}/hqdefault.jpg`;
        
        ['carplay', 'dash'].forEach(p => {
            const title = document.getElementById(`${p}-media-title`);
            const thumb = document.getElementById(`${p}-media-thumb`);
            if (title) title.textContent = vData.title;
            if (thumb) thumb.src = thumbUrl;
        });
    }

    // Ø¨. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù‚Ø³ ÙˆØ§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³
    if (weather) {
        ['carplay', 'dash'].forEach(p => {
            const tempBig = document.getElementById(`${p}-weather-temp-big`);
            const icon = document.getElementById(`${p}-weather-icon-big`);
            const tempMetric = document.getElementById(`${p}-metric-temp`);
            
            if (tempBig) tempBig.textContent = `${Math.round(weather.temperature)}Â°`;
            if (icon) icon.src = weather.iconUrl;
            if (tempMetric) tempMetric.textContent = `${Math.round(weather.temperature)}Â°C`;
        });
    }

    // Ø¬. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù…Ø± (NASA)
    if (appState.dynamicMoonImageUrl) {
        ['carplay', 'dash'].forEach(p => {
            const img = document.getElementById(`${p}-nasa-moon`);
            const phaseTxt = document.getElementById(`${p}-moon-phase`);
            if (img) img.src = appState.dynamicMoonImageUrl;
            if (phaseTxt && moon) phaseTxt.textContent = `Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©: ${moon.phase.toFixed(1)}%`;
        });
    }
}

// 6. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
if (window.globalSyncInterval) clearInterval(window.globalSyncInterval);
window.globalSyncInterval = setInterval(updateAllDisplays, 1000);

window.isYouTubeApiReady = false;


// 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠÙ†Ø§Ø¯ÙŠÙ‡Ø§ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
window.onYouTubeIframeAPIReady = function() {
    window.isYouTubeApiReady = true;
    console.log("âœ… YouTube API is Ready.");
};

function playRandomSuggested() {
    // Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙÙ„ØªØ±Ø© (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©)
    const availableVideos = filterWatchedVideos(window.suggestedVideos || []);
    
    if (availableVideos.length === 0) {
        console.log("ÙƒÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ØªÙ…Øª Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡Ø§! Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...");
        // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        return;
    }

    const randomIndex = Math.floor(Math.random() * Math.min(availableVideos.length, 30));
    const selectedVideo = availableVideos[randomIndex];
    
    playYoutubeVideo(selectedVideo.id, selectedVideo.title);
}


function filterWatchedVideos(videoList) {
    // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªÙŠ Ø§ÙƒØªÙ…Ù„Øª Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡Ø§ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ
    const watchedData = JSON.parse(localStorage.getItem('youtube_watched_history') || '{}');
    
    // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ÙˆØ³Ù…Ù‡Ø§ ÙƒÙ€ "Ù…ÙƒØªÙ…Ù„Ø©" (Ù…Ø«Ù„Ø§Ù‹ ØªØ¬Ø§ÙˆØ²Øª 95% Ù…Ù† ÙˆÙ‚ØªÙ‡Ø§)
    // Ø£Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© 'completed'
    const completedVideos = JSON.parse(localStorage.getItem('completed_videos_ids') || '[]');

    return videoList.filter(video => {
        // Ù„Ø§ ØªØ³ØªØ¨Ø¹Ø¯ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£Ø¨Ø¯Ø§Ù‹
        if (video.isLive) return true;
        
        // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
        return !completedVideos.includes(video.id);
    });
}

// 2. Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¥Ø°Ø§ ØªØ£Ø®Ø±Øª
function loadYouTubeApi() {
    if (window.YT && window.YT.Player) {
        window.isYouTubeApiReady = true;
        return;
    }
    
    // ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„ØµÙØ­Ø©ØŸ
    if (!document.querySelector('script[src*="youtube.com/iframe_api"]')) {
        console.log("ğŸ“¥ Injecting YouTube API Script...");
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹
loadYouTubeApi();

// ============================================================
// 1. SYSTEM HEADER: ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆÙ†Ø¸Ø§Ù… Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
// ============================================================

window.YT_KEYS_POOL = [
    "AIzaSyAjdVZ2Rodp6ZVEF1pZT195kAtGELolxSI", // 0
    "AIzaSyDULoFJLWNIO9hn0u8siLz-BzTi7eM-CX4",
    "AIzaSyBYThRM6tVnzgFgdHOUAN6DN8jQd54OKeg", // 1
    "AIzaSyB7QdfI0br5BfP71hOr36hz2dRWG_l0G8k", // 2
    "AIzaSyBdhcRo-EsvIduedQd-jFHfrEj9NeiP7pU", // 3
    "AIzaSyBLrMA6plsSZtqg2iY9Z1N1fJAHNmgGxos", // 4
    "AIzaSyCaqMPtn-egmEQk7XmTel--xsXV1Xbdp7o", // 5
    "AIzaSyDj4w1H3Is_rmTLhl40zER7AgYhT_tKASo", // 6
    "AIzaSyBYThRM6tVnzgFgdHOUAN6DN8jQd54OKeg", // 7
    "AIzaSyBeTHs25EsKeDFtIS5kq8iDATz-2c8hBrI", // 8
    "AIzaSyAjdVZ2Rodp6ZVEF1pZT195kAtGELolxSI"  // 9
];

window.YOUTUBE_API_KEY = null;
window.YOUTUBE_API_KEY2 = null;
window.isSystemReady = false; 
window.observer = null;

// ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ­Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
(async function initLiveKeyScanner() {
    console.log("ğŸš€ INITIALIZING: Scanning for valid keys...");
    
    // Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø©
    const test = async (k) => {
        try { return (await fetch(`https://www.googleapis.com/youtube/v3/videos?part=id&id=Ks-_Mh1QhMc&key=${k}`)).status === 200; } 
        catch { return false; }
    };

    let found = 0;
    
    for (let i = 0; i < window.YT_KEYS_POOL.length; i++) {
        if (found >= 2) break;

        const isValid = await test(window.YT_KEYS_POOL[i]);
        
        if (isValid) {
            if (found === 0) {
                window.YOUTUBE_API_KEY = window.YT_KEYS_POOL[i];
                localStorage.setItem('yt_idx_1', i);
                console.log(`âœ… Key 1 Assigned: Index ${i}`);
            } else {
                window.YOUTUBE_API_KEY2 = window.YT_KEYS_POOL[i];
                localStorage.setItem('yt_idx_2', i);
                console.log(`âœ… Key 2 Assigned: Index ${i}`);
            }
            found++;
        }
    }
    
    if (found > 0) {
        window.isSystemReady = true;
        console.log("ğŸŸ¢ SYSTEM READY: Scan Complete.");

        // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        if (typeof populateYoutubeSuggestions === 'function') {
            console.log("ğŸ”„ Triggering Suggestions Refresh...");
            populateYoutubeSuggestions(); 
        }

        // ğŸ”¥ ÙˆØ£ÙŠØ¶Ø§Ù‹ ØªØ´ØºÙŠÙ„ Ù…ÙØ¶Ù„Ø© Ù†Ø§Ø³Ø§ Ø£Ùˆ Ø£ÙŠ Ø´ÙŠØ¡ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        if (typeof renderFavoritesDashboard === 'function') {
            renderFavoritesDashboard();
        }

    } else {
        alert("âš ï¸ Fatal Error: No valid API keys found in the pool!");
    }
})();

// Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙƒØªØ§Ø¨Ø© HTML stringØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© render:
const parent = document.querySelector('.dashboard-main-grid'); // Ø£Ùˆ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯

// 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø²Ø±
const btn = document.createElement('button');
btn.className = 'playlist-shuffle-btn navigable grid-item';
btn.innerHTML = `<svg ...>...</svg> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„`; // Ø¶Ø¹ Ø§Ù„Ù€ SVG Ù‡Ù†Ø§

// 2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… CSS class)
Object.assign(btn.style, {
    position: 'absolute',
    bottom: '15px',
    left: '15px',
    zIndex: '9999',
    width: '9rem',
    height: '3rem',
    color:'transparent !important',
    background: 'transparent !important'
// Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
});

// 3. Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø« Ù…Ø¨Ø§Ø´Ø±Ø©
btn.onclick = (e) => {
    console.log("Button Clicked!"); // Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    e.stopPropagation(); // Ù…Ù†Ø¹ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®Ù„ÙÙŠØ©
    e.preventDefault();
    playAsShufflePlaylist();
};

// 4. Ø§Ù„Ø¥Ø¶Ø§ÙØ©
parent.appendChild(btn);

        async function loadDashboardSuggestions() {
    const gridContainer = document.getElementById('favorites-popup-grid');
    if (!gridContainer) return;

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø¨Ø³ÙŠØ· Ø£Ùˆ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
    gridContainer.innerHTML = ''; 

    try {
        // Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ù‡Ø¬ÙŠÙ†: Ø£Ø­Ø¯Ø« + Ø£Ù‡Ù… + Ø¨Ø¯ÙˆÙ† Shorts)
        const videos = await fetchSuggestedVideos();

        if (videos && videos.length > 0) {
            const html = videos.map(video => `
                <div class="simple-suggestion-card flex items-center gap-3 p-2 rounded-lg bg-white/10 cursor-pointer navigable grid-item" 
                     onclick="playSelectedVideo('${video.id}')" 
                     data-id="${video.id}">
                    <div class="video-thumbnail-wrapper" style="position: relative; width: 100%; height: 140px;">
                        <img src="${video.thumbnail}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                        <span class="video-duration-badge" style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.8); color: white; padding: 2px 5px; border-radius: 4px; font-size: 12px;">
                            ${video.duration}
                        </span>
                    </div>
                    <div class="video-info" style="margin-top: 8px; width: 100%;">
                        <div class="video-title" style="color: white; font-weight: bold; font-size: 14px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${video.title}
                        </div>
                        <div class="video-stats" style="color: #ccc; font-size: 12px; margin-top: 4px;">
                            ${video.viewsDisplay} â€¢ ${video.channelTitle}
                        </div>
                    </div>
                </div>
            `).join('');

            gridContainer.innerHTML = html;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ (Navigable) Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Ø±ÙŠÙ…ÙˆØª ÙƒÙ†ØªØ±ÙˆÙ„ Ø£Ùˆ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­
            if (typeof initializeNavigable === 'function') initializeNavigable();
        } else {
            gridContainer.innerHTML = '<div style="color: white; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚ØªØ±Ø­Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
        }
    } catch (error) {
        console.error("Failed to load dashboard suggestions:", error);
    }
}


const CACHE_KEY = 'suggestedVideosCache';

async function initSuggestedDashboard() {
    console.log("ğŸš€ Checking Cache for Dashboard...");

    // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØ§Ø´
    const cachedData = localStorage.getItem(CACHE_KEY);

    if (cachedData) {
        // âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø£: Ø§Ù„ÙƒØ§Ø´ Ù…ÙˆØ¬ÙˆØ¯!
        console.log("ğŸ“¦ Cache FOUND! Loading from local storage...");
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
        const videos = JSON.parse(cachedData);
        
        // âš¡ ØªØ´ØºÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… ÙÙˆØ±Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ÙƒÙˆØªØ§)
        renderSuggestedDashboard(videos);
        
        return; // ØªÙˆÙ‚Ù Ù‡Ù†Ø§ØŒ Ù„Ø§ ØªÙƒÙ…Ù„ Ù„Ù„Ø£Ø³ÙÙ„ (Ù„Ø§ ØªØ·Ù„Ø¨ API)
    }

    // âŒ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨: Ø§Ù„ÙƒØ§Ø´ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (Ø£Ùˆ ØªÙ… Ù…Ø³Ø­Ù‡)
    console.log("ğŸŒ No Cache found. Fetching from API...");
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Øª
    const videos = await fetchVideosFromAPI(); // Ø¯Ø§Ù„ØªÙƒ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¬Ù„Ø¨
    
    if (videos && videos.length > 0) {
        // 1. Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
        localStorage.setItem(CACHE_KEY, JSON.stringify(videos));
        
        // 2. ØªØ´ØºÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
        renderSuggestedDashboard(videos);
    }
}

const TARGET_ID = 'UCZPY2lpYyo6Y5mxk2CczJXg';
const UPDATE_HOURS = [7,10, 14,16, 18]; 
const NEW_JSONBIN_CHANNEL_IDS = '693fb33cae596e708f9ade6a';

// âœ… Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠØ© (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø©)
async function fetchSafely(url, options = {}, retryCount = 0) {

    // 1. Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØµØ¨Ø­ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²Ø§Ù‹ (Scanning Complete)
    while (!window.isSystemReady && !window.YOUTUBE_API_KEY) {
        console.log("â³ Waiting for Key Scanner...");
        await new Promise(r => setTimeout(r, 500)); // Ø§Ù†ØªØ¸Ø± Ù†ØµÙ Ø«Ø§Ù†ÙŠØ©
    }

    if (!window.YT_KEYS_POOL) return fetch(url, options);



    // ğŸ›‘ Ø­Ù…Ø§ÙŠØ©: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…ÙØ±ØºØ© Ø¨Ø¹Ø¯ 4 Ù…Ø­Ø§ÙˆÙ„Ø§Øª
    if (retryCount > 4) {
        console.error("â›” FetchSafely: Too many retries. Aborting.");
        return null;
    }

    try {
        const response = await fetch(url, options);

        // 403 = Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ø­ØªØ±Ù‚
        if (response.status === 403) {
            console.warn(`ğŸ”¥ 403 Error detected (Attempt ${retryCount + 1}/5)`);

            // 1. Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
            const urlObj = new URL(url);
            const currentKeyInUrl = urlObj.searchParams.get('key');
            
            // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ±ØªÙŠØ¨Ù‡ ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
            let failedIdx = window.YT_KEYS_POOL.indexOf(currentKeyInUrl);
            
            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯Ù‡ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            if (failedIdx === -1) {
                // Ù‡Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ùˆ Ù†ÙØ³Ù‡ KEY1ØŸ
                if (window.YOUTUBE_API_KEY && url.includes(window.YOUTUBE_API_KEY)) {
                    failedIdx = window.YT_KEYS_POOL.indexOf(window.YOUTUBE_API_KEY);
                } else {
                    failedIdx = 0; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
                }
            }

            // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù‚Ø§Ø¯Ù…
            let nextIdx = (failedIdx + 1) % window.YT_KEYS_POOL.length;
            
            // 4. Ù‚ÙØ² Ø§Ù„ØªØµØ§Ø¯Ù… (ØªØ¬Ù†Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¢Ø®Ø±)
            const isVar1 = (window.YOUTUBE_API_KEY === window.YT_KEYS_POOL[failedIdx]);
            const otherIdx = parseInt(localStorage.getItem(isVar1 ? 'yt_idx_2' : 'yt_idx_1')) || (isVar1 ? 1 : 0);
            
            if (nextIdx === otherIdx) {
                nextIdx = (nextIdx + 1) % window.YT_KEYS_POOL.length;
            }

            // 5. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± ÙˆØ­ÙØ¸Ù‡
            const newKey = window.YT_KEYS_POOL[nextIdx];
            
            if (isVar1) {
                window.YOUTUBE_API_KEY = newKey;
                localStorage.setItem('yt_idx_1', nextIdx);
                console.log(`â™»ï¸ VAR 1 updated to Index ${nextIdx}`);
            } else {
                window.YOUTUBE_API_KEY2 = newKey;
                localStorage.setItem('yt_idx_2', nextIdx);
                console.log(`â™»ï¸ VAR 2 updated to Index ${nextIdx}`);
            }

            // 6. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø£Ù‡Ù… Ø®Ø·ÙˆØ© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
            let newUrl = url;
            if (newUrl.includes('key=')) {
                // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯Ù‚Ø©
                newUrl = newUrl.replace(/key=[^&]+/, `key=${newKey}`);
            } else {
                const sep = newUrl.includes('?') ? '&' : '?';
                newUrl = `${newUrl}${sep}key=${newKey}`;
            }

            console.log(`ğŸ”„ Retrying with NEW Key (Index ${nextIdx})...`);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ + Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
            return fetchSafely(newUrl, options, retryCount + 1);
        }

        if (!response.ok && response.status !== 404) {
            throw new Error(`HTTP ${response.status}`);
        }

        return await response.json();

    } catch (e) {
        console.error("Fetch Error:", e);
        return null;
    }
}

// ============================================================
// ğŸ› ï¸ UNIVERSAL BOOKMARK MENU FIXER
// Target: #video-popup-bookmark-button
// ============================================================

function fixVideoPopupBookmarkMenu() {
    
    // 1. Ø¥Ø¶Ø§ÙØ© CSS Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    const style = document.createElement('style');
    style.textContent = `
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªÙƒÙˆÙ† Ø¹Ø§Ø¦Ù…Ø© ÙˆØ­Ø±Ø© */
        .video-bookmark-dropdown-fixed {
            position: fixed !important; /* ØªØ«Ø¨ÙŠØª Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø© */
            z-index: 2147483647 !important; /* Ø£Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ */
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 150px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: none; /* Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        }

        .video-bookmark-dropdown-fixed.show {
            display: block !important;
            animation: fadeInMenu 0.2s ease-out;
        }

        @keyframes fadeInMenu {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .video-bookmark-dropdown-fixed div {
            padding: 8px 15px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .video-bookmark-dropdown-fixed div:hover {
            background: rgba(255,255,255,0.1);
            color: #4ade80; /* Ø£Ø®Ø¶Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
        }
    `;
    document.head.appendChild(style);

    // 2. Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù†Ù‚Ø± (Event Delegation)
    document.addEventListener('click', function(e) {
        
        // Ø£. Ù‡Ù„ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ØŸ
        const btn = e.target.closest('#video-popup-bookmark-button');
        
        if (btn) {
            e.stopPropagation(); // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
            e.preventDefault();

            // Ø¨. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©)
            let menu = document.getElementById('global-video-bookmark-menu');
            
            if (!menu) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
                menu = document.createElement('div');
                menu.id = 'global-video-bookmark-menu';
                menu.className = 'video-bookmark-dropdown-fixed';
                
                // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¹Ø¯Ù„Ù‡ Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ)
                menu.innerHTML = `
                    <div onclick="saveToPlaylist('favorites')">â¤ï¸ Favorites</div>
                    <div onclick="saveToPlaylist('watch_later')">â° Watch Later</div>
                    <div onclick="saveToPlaylist('music')">ğŸµ Music</div>
                    <div style="border-top:1px solid #444; margin-top:5px; padding-top:8px; color:#aaa">Cancel</div>
                `;
                document.body.appendChild(menu); // Ù†Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ù€ Body Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Øµ
            }

            // Ø¬. ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¸Ù‡ÙˆØ±
            const isVisible = menu.classList.contains('show');
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ø£Ø®Ø±Ù‰
            closeAllMenus();

            if (!isVisible) {
                // Ø¯. Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹ (Magic Positioning) ğŸ“
                const rect = btn.getBoundingClientRect();
                
                // ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ø²Ø± ØªÙ…Ø§Ù…Ø§Ù‹
                menu.style.top = (rect.bottom + 8) + 'px'; 
                
                // Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø±ØŒ ÙˆÙ„ÙƒÙ† Ù†ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ù„Ø§ ØªØ®Ø±Ø¬ Ø¹Ù† ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø©
                let leftPos = rect.left;
                if (leftPos + 150 > window.innerWidth) {
                    leftPos = window.innerWidth - 160; // Ø¥Ø²Ø§Ø­Ø© Ù„Ù„ÙŠØ³Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø³ØªØ®Ø±Ø¬
                }
                menu.style.left = leftPos + 'px';
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                menu.classList.add('show');
            }
        } 
        // Ù‡Ù€. Ø¥Ø°Ø§ Ø¶ØºØ·Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø²Ø± ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© -> Ø£ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        else if (!e.target.closest('#global-video-bookmark-menu')) {
            closeAllMenus();
        }
    });

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    function closeAllMenus() {
        const menu = document.getElementById('global-video-bookmark-menu');
        if (menu) menu.classList.remove('show');
    }
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± (Scroll) - Ù†ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ±
    window.addEventListener('scroll', closeAllMenus, true);
    window.addEventListener('resize', closeAllMenus);
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­
document.addEventListener('DOMContentLoaded', fixVideoPopupBookmarkMenu);

function shouldRefreshNow(lastTimestamp) {
    if (!lastTimestamp) return true;
    const lastUpdate = new Date(lastTimestamp);
    const now = new Date();
    for (let hour of UPDATE_HOURS) {
        let scheduledTime = new Date();
        scheduledTime.setHours(hour, 0, 0, 0);
        if (now >= scheduledTime && lastUpdate < scheduledTime) return true;
    }
    return false;
}
async function fetchSuggestedVideos() {
    const CACHE_KEY = 'suggestedVideosCache_Official_v3';
    const lastUpdate = localStorage.getItem('last_fetch_timestamp_official');
    const now = Date.now();
    const FOUR_HOURS = 4 * 60 * 60 * 1000;

    // 1. ÙØ­Øµ Ø§Ù„ÙƒØ§Ø´ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù€ API
    const cachedData = localStorage.getItem(CACHE_KEY);
    if (cachedData && lastUpdate && (now - lastUpdate < FOUR_HOURS)) {
        console.log("â™»ï¸ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙƒØ§Ø´...");
        return processSelection(JSON.parse(cachedData));
    }

    // 2. Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ IDs Ù…Ù† JSONBin (Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù€ 6)
    let channelIdsArray = [];
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${NEW_JSONBIN_CHANNEL_IDS}/latest`, {
            headers: { 'X-Access-Key': JSONBIN_ACCESS_KEY_CHANNELS }
        });
        const data = await res.json();
        channelIdsArray = Array.isArray(data.record) ? data.record.slice(0, 6) : [];
    } catch (e) {
        console.error("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù…Ù† JSONBin:", e);
        if (cachedData) return processSelection(JSON.parse(cachedData));
        return [];
    }

    let allFetchedItems = [];

    // 3. Ø­Ù„Ù‚Ø© Ø§Ù„Ø¬Ù„Ø¨ Ù„ÙƒÙ„ Ù‚Ù†Ø§Ø© Ø¨Ù…Ù†Ø·Ù‚ "Ø§Ù„Ù…ÙŠØ¯ÙŠØ§" ÙˆØ§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³Ø¨Ù‚Ø©
    for (const channelId of channelIdsArray) {
        try {
            // Ø£- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠ (Uploads)
            const channelRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${channelId}&key=${YOUTUBE_API_KEY}`);
            const channelData = await channelRes.json();
            const uploadsId = channelData?.items?.[0]?.contentDetails?.relatedPlaylists?.uploads;

            if (uploadsId) {
                // Ø¨- Ø¬Ù„Ø¨ 25 ÙÙŠØ¯ÙŠÙˆ (Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ù„ØªØ®Ø·ÙŠ Ø§Ù„Ù€ Shorts)
                // Ø£Ø¶ÙÙ†Ø§ contentDetails Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
                const videosUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=${uploadsId}&maxResults=25&key=${YOUTUBE_API_KEY}`;
                // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù„Ù‰ part=snippet,contentDetails
                const videosData = await fetch(videosUrl).then(r => r.json());

                if (videosData?.items) {
                    let validVideosFromThisChannel = 0;

                    for (const item of videosData.items) {
                        // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 8 ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† ÙƒÙ„ Ù‚Ù†Ø§Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†ÙˆØ¹ ÙÙŠ Ø§Ù„Ù€ 30 ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒÙ„ÙŠØ©
                        if (validVideosFromThisChannel >= 8) break;

                        const duration = item.contentDetails?.duration; // ØµÙŠØºØ© ISO 8601
                        const durationInSecs = parseDurationToSeconds(duration);

                        // ğŸ›‘ Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ØªØ®Ø·ÙŠ Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ Ø£Ù‚Ù„ Ù…Ù† 180 Ø«Ø§Ù†ÙŠØ© (3 Ø¯Ù‚Ø§Ø¦Ù‚)
                        if (durationInSecs < 180) {
                            console.log(`â© ØªØ®Ø·ÙŠ ÙÙŠØ¯ÙŠÙˆ Ù‚ØµÙŠØ±: ${item.snippet.title} (${durationInSecs}s)`);
                            continue; // Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ
                        }

                        // Ø¥Ø°Ø§ Ø§Ø¬ØªØ§Ø² Ø§Ù„Ø´Ø±Ø·ØŒ ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµÙÙˆÙØ©
                        allFetchedItems.push({
                            id: item.snippet.resourceId.videoId,
                            title: item.snippet.title,
                            thumbnail: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.high?.url,
                            channelTitle: item.snippet.channelTitle,
                            channelId: channelId,
                            duration: duration, // Ù†Ø­ÙØ¸ Ø§Ù„ØµÙŠØºØ© Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø£Ùˆ Ù„ÙÙ„ØªØ±Ø© Ø¥Ø¶Ø§ÙÙŠØ©
                            isLive: false
                        });
                        validVideosFromThisChannel++;
                    }
                }
            }

            // Ø¬- Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ù† ÙˆØ¬Ø¯) - Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ù‚Ø¨ÙˆÙ„
            const liveUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&type=video&eventType=live&key=${YOUTUBE_API_KEY}`;
            const liveData = await fetch(liveUrl).then(r => r.json());
            if (liveData?.items) {
                liveData.items.forEach(item => {
                    allFetchedItems.push({
                        id: item.id.videoId,
                        title: item.snippet.title,
                        thumbnail: item.snippet.thumbnails.medium?.url,
                        channelTitle: item.snippet.channelTitle,
                        channelId: channelId,
                        isLive: true,
                        duration: "LIVE"
                    });
                });
            }

        } catch (err) {
            console.error(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚Ù†Ø§Ø© ${channelId}:`, err);
        }
    }

    // 4. Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
    if (allFetchedItems.length > 0) {
        localStorage.setItem(CACHE_KEY, JSON.stringify(allFetchedItems));
        localStorage.setItem('last_fetch_timestamp_official', Date.now().toString());
    }

    // 5. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (2 Ù…Ø«Ø¨Øª + 12 Ø¹Ø´ÙˆØ§Ø¦ÙŠ)
    return processSelection(allFetchedItems);
}
// Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø¯Ø£ 2 Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© + 12 Ø¹Ø´ÙˆØ§Ø¦ÙŠ (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 14)
function processSelection(allVideos) {
    // 1. ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Completed)
    const completedVideos = JSON.parse(localStorage.getItem('completed_videos_ids') || '[]');
    const available = allVideos.filter(v => !completedVideos.includes(v.id));

    // 2. Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡ÙŠÙ† Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø¨Ø´Ø±Ø· (Ø§Ù„Ù…Ø¯Ø© > 5 Ø¯Ù‚Ø§Ø¦Ù‚)
    const priorityPool = available.filter(v => {
        if (v.channelId !== TARGET_ID) return false;
        const durationInSecs = parseDurationToSeconds(v.duration || "00:00");
        return v.isLive || durationInSecs > 300; 
    }).sort(() => 0.5 - Math.random()); // Ø®Ù„Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ø¬Ù„Ø¨ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø®ØªÙ„ÙØ© ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡ÙŠÙ† Ù…Ø«Ø¨ØªÙŠÙ†
    const fixedTwo = priorityPool.slice(0, 2);

    // 3. ØªØ¬Ù‡ÙŠØ² "Ø®Ø²Ø§Ù†Ø§Øª" Ù„ÙƒÙ„ Ù‚Ù†Ø§Ø© Ù…Ù† Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù€ 5 Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„Ù„ØªÙ†Ø§ÙˆØ¨
    const otherChannelIds = [...new Set(available.map(v => v.channelId))].filter(id => id !== TARGET_ID);
    
    const pools = {};
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ù„Ù…Ø¯Ø§ÙˆØ±Ø© (Ø¨Ù‚ÙŠØ© ÙÙŠØ¯ÙŠÙˆÙ‡Ø§ØªÙ‡Ø§ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ 2)
    pools[TARGET_ID] = priorityPool.slice(2); 
    
    // Ø¥Ø¶Ø§ÙØ© Ø¨Ù‚ÙŠØ© Ø§Ù„Ù‚Ù†ÙˆØ§Øª
    otherChannelIds.forEach(id => {
        pools[id] = available.filter(v => v.channelId === id).sort(() => 0.5 - Math.random());
    });

    // Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø«Ù… Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨)
    const rotationOrder = [TARGET_ID, ...otherChannelIds];

    // 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†Ø§ÙˆØ¨ÙŠ)
    let finalSelection = [...fixedTwo]; // Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ø§Ù„Ù…Ø«Ø¨ØªÙŠÙ†
    
    let poolPointer = 0;
    let safetyCounter = 0;

    // Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ù„Ù€ 14 ÙƒØ±Øª Ø¨Ø§Ù„ØªÙ†Ø§ÙˆØ¨
    while (finalSelection.length < 14 && safetyCounter < 100) {
        const currentChannelId = rotationOrder[poolPointer % rotationOrder.length];
        const currentPool = pools[currentChannelId];

        if (currentPool && currentPool.length > 0) {
            const video = currentPool.shift();
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ©
            if (!finalSelection.find(v => v.id === video.id)) {
                finalSelection.push(video);
            }
        }

        poolPointer++;
        safetyCounter++;
        
        // Ø¥Ø°Ø§ ÙØ±ØºØª ÙƒÙ„ Ø§Ù„Ø®Ø²Ø§Ù†Ø§ØªØŒ Ø§Ø®Ø±Ø¬
        const totalRemaining = Object.values(pools).reduce((acc, curr) => acc + curr.length, 0);
        if (totalRemaining === 0) break;
    }

    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Shuffle)
    window.allFetchedVideos30 = available; 
    
    console.log("âœ… ØªÙ… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†Ø§ÙˆØ¨ÙŠ: 2 Ù…ÙØ¶Ù„Ø© + Ø§Ù„Ø¨Ù‚ÙŠØ© Ø¨Ø§Ù„ØªÙ†Ø§ÙˆØ¨ Ø¨ÙŠÙ† Ø§Ù„Ù‚Ù†ÙˆØ§Øª");
    return finalSelection;
}

function playAsShufflePlaylist() {
    const btn = document.querySelector('.playlist-shuffle-btn') || document.getElementById('popup-shuffle-btn');
    
    if (window.isAutoPlayMode) {
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        window.isAutoPlayMode = false;
        if (btn) {
            btn.innerHTML = `<i data-lucide="shuffle"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„ (Playlist)`;
            btn.style.background = "linear-gradient(135deg, #9333ea 0%, #2563eb 100%)";
        }
    } else {
        // ğŸ›‘ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù‡Ù…: Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† (window.allFetchedVideos30)
        // Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ÙˆØªØµÙÙŠØªÙ‡ Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© processSelection
        let availableVideos = window.allFetchedVideos30 || [];

        if (availableVideos.length === 0) {
            showMessageBox("Ù„Ù‚Ø¯ Ø´Ø§Ù‡Ø¯Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©! Ù‚Ù… Ø¨Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø¡.");
            return;
        }

        window.isAutoPlayMode = true;
        
        // Ø®Ù„Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
        window.currentSuggestedVideos = [...availableVideos].sort(() => 0.5 - Math.random());

        if (btn) {
            btn.innerHTML = `<i data-lucide="square"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ`;
            btn.style.background = "linear-gradient(135deg, #ef4444 0%, #991b1b 100%)";
        }

        // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
        const firstVideo = window.currentSuggestedVideos[0];
        showVideoPopup(firstVideo.id, 0);
    }
    if (window.lucide) lucide.createIcons();
}

function parseISO8601ToSeconds(duration) {
    const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    if (!match) return 0;
    const hours = parseInt(match[1]) || 0;
    const minutes = parseInt(match[2]) || 0;
    const seconds = parseInt(match[3]) || 0;
    return (hours * 3600) + (minutes * 60) + seconds;
}

function renderSuggestedDashboard(videosInput = null) {
    const container = document.getElementById('suggested-d-dashboard-container');
    if (!container) return;

    // 1. ØªØ­Ø¯ÙŠØ¯ Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let list = videosInput;
    if (!list) {
        const cached = localStorage.getItem('suggestedVideosCache');
        if (cached) {
            try { list = JSON.parse(cached); } catch (e) { list = []; }
        }
    }
    
    if (!list && typeof suggestedVideos !== 'undefined') {
        list = suggestedVideos;
    }

    const finalDisplayList = (list && list.length > 0) ? list.slice(0, 20) : [];

    // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØºÙ„Ù Ù„Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
    let parentWrapper = document.getElementById('suggested-dashboard-wrapper');
    if (!parentWrapper) {
        parentWrapper = document.createElement('div');
        parentWrapper.id = 'suggested-dashboard-wrapper';
        parentWrapper.style.position = 'relative';
        parentWrapper.style.width = '100%';
        container.parentNode.insertBefore(parentWrapper, container);
        parentWrapper.appendChild(container);
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    container.innerHTML = ''; 
    const oldBtn = parentWrapper.querySelector('.playlist-shuffle-btn');
    if (oldBtn) oldBtn.remove();

    // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
    if (finalDisplayList.length === 0) {
        container.innerHTML = '<p class="text-center text-muted mt-4 w-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚ØªØ±Ø­Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>';
        return;
    }
    
    // 4. Ø¥Ø¶Ø§ÙØ© Ø²Ø± "ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„" (Ù†ÙØ³ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    const shuffleBtn = document.createElement('button');
    shuffleBtn.id = 'custom-shuffle-play-btn';
    shuffleBtn.className = 'playlist-shuffle-btn navigable grid-item';
    shuffleBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-12.6c.8-1 1.9-1.7 3.1-1.7H22"></path>
            <path d="M2 6h1.4c1.3 0 2.5.6 3.3 1.7l3.2 2.9"></path>
            <path d="M22 18h-2.1c-1.3 0-2.5-.6-3.3-1.7L14.9 14.6"></path>
            <polyline points="18 6 22 2 18 2"></polyline>
            <polyline points="18 18 22 22 18 22"></polyline>
        </svg>
        <span>ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„</span>`;

    shuffleBtn.onclick = (e) => {
        e.stopPropagation();
        if (typeof playAsShufflePlaylist === 'function') playAsShufflePlaylist(finalDisplayList);
    };
    parentWrapper.appendChild(shuffleBtn);

    // 5. Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª (Ø¨Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±)
    const fragment = document.createDocumentFragment(); 

  finalDisplayList.forEach(video => {
        const card = document.createElement('div');
        // âœ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ÙŠØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù€ CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        card.className = 'suggested-d-dashboard-card navigable grid-item p-2'; 
        card.tabIndex = 0; 
        
        card.innerHTML = `
            <div style="position:relative; width:100%;">
                <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
                
                <button id="dash-bk-${video.id}" 
                        class="dashboard-only-bookmark navigable grid-item" 
                        tabindex="0">
                    <i data-lucide="bookmark"></i>
                </button>
            </div>

            <div class="video-details flex-grow-1"> 
                <h6 class="mb-0 text-truncate">${video.title}</h6>
                <p class="mb-1 text-muted small">${video.channelTitle}</p>
            </div>
            <div class="flex flex-col flex-grow min-w-0 h-full justify-between ml-2"></div>
        `;
        
        // 1. Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© (Car/TV)
        const bookmarkBtn = card.querySelector(`#dash-bk-${video.id}`);
        bookmarkBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Ù…Ù†Ø¹ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            if (typeof showFavoritesMenu === 'function') {
                showFavoritesMenu(bookmarkBtn, video);
            }
        });

        // 2. Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ø±Øª ÙŠØ´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¨Ø´Ø±Ø· Ø¹Ø¯Ù… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­ÙØ¸)
        card.addEventListener('click', (e) => {
            if (!e.target.closest('.dashboard-only-bookmark')) {
                window.isAutoPlayMode = false;
                showVideoPopup(video.id); 
            }
        });

        fragment.appendChild(card);
    });
    
    container.appendChild(fragment);

    // 6. Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    if (window.lucide) lucide.createIcons();
    if (typeof updateNavigableElements === 'function') updateNavigableElements();
}

const CACHE_DURATION_MS = 6 * 60 * 60 * 1000;

function startVoiceToText() {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù…
    if (!SpeechRecognition) {
        showMessageBox("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.");
        return;
    }
    
    // ğŸ›‘ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¬Ø¹Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ÙƒØªØ§Ø¨Ø©)
    youtubeSearchInput.readOnly = false;
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø±Ø¦ÙŠ (Ù„Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ø¨ØµØ±ÙŠ)
    floatingKeyboardButton?.classList.add('active-keyboard');
    floatingKeyboardButton?.classList.remove('inactive-keyboard');

    // 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ø¦Ù† (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ù‡ÙŠØ¦Ø§Ù‹)
    if (!recognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false; 
        recognition.lang = 'ar-SA';     
        recognition.interimResults = false; 
    }
    
    // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        if (transcript) {
            // ğŸ›‘ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©: ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„
            youtubeSearchInput.value = transcript.trim();
            youtubeSearchInput.focus();
            
            // ğŸ’¡ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ§Ù‹: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            // youtubeSearchButton.click();
        }
    };

    // 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„ØªÙˆÙ‚Ù (Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©)
    recognition.onerror = (event) => {
        floatingMicButton?.classList.remove('recording');
        // ğŸ›‘ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        youtubeSearchInput.readOnly = true; 
        floatingKeyboardButton?.classList.add('inactive-keyboard');
        floatingKeyboardButton?.classList.remove('active-keyboard');
        console.error('Speech recognition error:', event.error);
        if (event.error === 'not-allowed' || event.error === 'permission-denied') {
             showMessageBox("Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ø±ÙÙˆØ¶. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        }
    };
    
    // 5. Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
    recognition.onstart = () => {
        floatingMicButton?.classList.add('recording');
        showMessageBox("ğŸ¤ Ø§Ø³ØªÙ…Ø¹ Ø§Ù„Ø¢Ù†...");
    };

    recognition.onend = () => {
        floatingMicButton?.classList.remove('recording');
        showMessageBox("âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹.");
        
        // ğŸ›‘ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø®Ø§Ù…Ø³Ø©: Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ØŒ Ù†Ø¹ÙˆØ¯ Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· (Ù„Ù„Ø­Ù…Ø§ÙŠØ©)
        // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªÙØ¶Ù„ ØªØ±Ùƒ Ø§Ù„ÙˆØ¶Ø¹ Ù…ÙØªÙˆØ­Ø§Ù‹ Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØµÙˆØªØŒ Ù‚Ù… Ø¨Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø·Ø± Ø£Ø¯Ù†Ø§Ù‡
        // youtubeSearchInput.readOnly = true; 
        // floatingKeyboardButton?.classList.add('inactive-keyboard'); 
        
        updateNavigableElements(); 
    };

    // 6. Ø§Ù„Ø¨Ø¯Ø¡
    try {
        recognition.start();
    } catch (e) {
        console.error("Recognition already started or permission denied.", e);
        if (floatingMicButton?.classList.contains('recording')) {
            recognition.stop();
        }
    }
}



function playSpeechAnnouncement(message) {
    if (!('speechSynthesis' in window) || !message) {
        console.warn("TTS not supported or message is empty.");
        return;
    }

    const utterance = new SpeechSynthesisUtterance(message);
    const voices = window.speechSynthesis.getVoices();
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØª Ø¹Ø±Ø¨ÙŠ Ø°ÙƒØ± (Ù„Ø¬ÙˆØ¯Ø© Ø£ÙØ¶Ù„)
    let arabicVoice = voices.find(voice => voice.lang.startsWith('ar') && (voice.name.includes('male') || voice.name.includes('Arabic')));
    
    if (arabicVoice) {
        utterance.voice = arabicVoice;
    } else {
        arabicVoice = voices.find(voice => voice.lang.startsWith('ar'));
        if (arabicVoice) utterance.voice = arabicVoice;
    }
    
    utterance.lang = 'ar-SA';
    utterance.rate = 1.0; 
    
    window.speechSynthesis.speak(utterance);
}




// ğŸ’¡ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ù…ØµÙÙˆÙØ© Ù…ÙØ¹Ø±Ù‘ÙÙØ© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯
const PLAYBACK_RATES = [1.0, 1.25, 1.5, 1.65]; // ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… 1.65 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 2.0 Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª

/**
 * FINAL: Sets the playback rate to a specific value based on the selected rate.
 * This is called directly by the individual speed buttons (1.0x, 1.25x, etc.).
 * * @param {string} rateValue - The rate string (e.g., "1.25").
 */
function setSpecificPlaybackRate(rateValue) {
    if (!popupPlayer || typeof popupPlayer.setPlaybackRate !== 'function') return; // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø´ØºÙ„

    const rate = parseFloat(rateValue);

    if (PLAYBACK_RATES.includes(rate)) {
        popupPlayer.setPlaybackRate(rate);
        
        // Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø³ØªÙ…Ø¹ onPlaybackRateChange Ù„ØªØ­Ø¯ÙŠØ« UI
        // (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ updateMinimizedControlsState() Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹ ÙƒØ¥Ø¬Ø±Ø§Ø¡ Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
        updateMinimizedControlsState(); 
    }
}

/**
 * Toggles the playback rate to the next speed in the defined sequence 
 * (Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ ÙÙŠ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨Ø²Ø± ÙˆØ§Ø­Ø¯).
 */
function togglePlaybackRate() {
    if (!popupPlayer || typeof popupPlayer.getPlaybackRate !== 'function') return;

    const currentRate = popupPlayer.getPlaybackRate();
    const currentRateFixed = parseFloat(currentRate.toFixed(2));

    const currentIndex = PLAYBACK_RATES.indexOf(currentRateFixed);
    
    const nextIndex = (currentIndex === -1) ? 0 : (currentIndex + 1) % PLAYBACK_RATES.length;
    const nextRate = PLAYBACK_RATES[nextIndex];
    
    popupPlayer.setPlaybackRate(nextRate);
    updateMinimizedControlsState(); 
}

/**
 * Event handler that fires when YouTube player confirms the playback rate has changed.
 */
function handlePlaybackRateChange(event) {
    // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªØºÙŠØ± Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…Ø±Ø¨ÙˆØ·Ø© ÙÙŠ showVideoPopup)
    updateMinimizedControlsState(); 
}
        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª (ÙŠØ¬Ø¨ Ø£Ù† ØªÙØ¶Ø§Ù ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯) ---
let weatherIntervalId = null;       // 5 Ø¯Ù‚Ø§Ø¦Ù‚ (Ù„Ù„Ø·Ù‚Ø³)
let clockIntervalId = null;         // 1 Ø«Ø§Ù†ÙŠØ© (Ù„Ù„Ø³Ø§Ø¹Ø©)
let timerDisplayIntervalId = null;  // 2 Ø«Ø§Ù†ÙŠØ© (Ù„Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„ØµÙ„Ø§Ø©)
let nextPrayerIntervalId = null;    // 1 Ø¯Ù‚ÙŠÙ‚Ø© (Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©)
let carSimulationIntervalId = null; // 2 Ø«Ø§Ù†ÙŠØ© (Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©/Ø§Ù„Ø§ØªØ¬Ø§Ù‡)
let fullDateIntervalId = null;      // 6 Ù…Ù„ÙŠÙˆÙ† Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®)
let trafficIntervalId = null; 

function startTrafficUpdates() {
    if (trafficIntervalId === null) {
        // ğŸ›‘ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Dashboard
        updateTrafficIndicators(); 
        // ğŸ›‘ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø¨Ø·ÙŠØ¡ Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ
        trafficIntervalId = setInterval(updateTrafficIndicators, 600000); // ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
    }
}
function stopTrafficUpdates() {
    if (trafficIntervalId !== null) {
        clearInterval(trafficIntervalId);
        trafficIntervalId = null;
    }
}


function startWeatherUpdates() {
    if (weatherIntervalId === null) {
        // Ù†ÙØ´ØºÙ‘ÙÙ„ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
        fetchWeatherData();
        // ğŸ›‘ Ø«Ù… Ù†ÙÙ†Ø´Ø¦ Ø§Ù„Ù…Ø¤Ù‚Øª
        weatherIntervalId = setInterval(fetchWeatherData, 300000); // ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
    }
}
function stopWeatherUpdates() {
    if (weatherIntervalId !== null) {
        clearInterval(weatherIntervalId);
        weatherIntervalId = null;
    }
}

function startCarSimulation() {
    if (carSimulationIntervalId === null) {
        carSimulationIntervalId = setInterval(simulateOtherCarData, 2000); // ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©
    }
}
function stopCarSimulation() {
    if (carSimulationIntervalId !== null) {
        clearInterval(carSimulationIntervalId);
        carSimulationIntervalId = null;
    }
}

function startClockAndTimer() {
    if (clockIntervalId === null) {
        clockIntervalId = setInterval(updateDigitalClock, 1000); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¹Ø© ÙƒÙ„ 1 Ø«Ø§Ù†ÙŠØ©
    }
    if (timerDisplayIntervalId === null) {
        timerDisplayIntervalId = setInterval(updateTimerDisplay, 1000); // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙ„Ø§Ø© ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©
    }
}
function stopClockAndTimer() {
    if (clockIntervalId !== null) {
        clearInterval(clockIntervalId);
        clockIntervalId = null;
    }
    if (timerDisplayIntervalId !== null) {
        clearInterval(timerDisplayIntervalId);
        timerDisplayIntervalId = null;
    }
}

// --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø§Ù„Ø¨Ø·ÙŠØ¦Ø© (Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„ Ø¨Ù€ setInterval) ---
function startNextPrayerDetermination() {
    if (nextPrayerIntervalId === null) {
        determineNextPrayer(); // ØªØ´ØºÙŠÙ„ ÙÙˆØ±ÙŠ
        nextPrayerIntervalId = setInterval(determineNextPrayer, 60000); // ÙƒÙ„ 1 Ø¯Ù‚ÙŠÙ‚Ø©
    }
}
function stopNextPrayerDetermination() {
    if (nextPrayerIntervalId !== null) {
        clearInterval(nextPrayerIntervalId);
        nextPrayerIntervalId = null;
    }
}
function startFullDateUpdates() {
    if (fullDateIntervalId === null) {
        updateFullDateWidget(); // ØªØ´ØºÙŠÙ„ ÙÙˆØ±ÙŠ
        fullDateIntervalId = setInterval(updateFullDateWidget, 6000000); // ÙƒÙ„ 100 Ø¯Ù‚ÙŠÙ‚Ø©
    }
}
// Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù€ stopFullDateUpdates Ø­ÙŠØ« Ø£Ù†Ù‡Ø§ ØªØ¹Ù…Ù„ Ø¨Ø¨Ø·Ø¡ Ø´Ø¯ÙŠØ¯
function switchApp(appName) {
    // 1. Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª (Clean Slate)
    stopClockAndTimer();
    stopCarSimulation();
    stopWeatherUpdates(); 
    stopDashboardLocationTracking();

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    const newIndex = appOrder.indexOf(appName);
    if (newIndex === -1) return;
    currentAppIndex = newIndex;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ù„Ø´Ø§Ø´Ø§Øª ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
    appScreens.forEach(s => s.classList.remove('active'));
    sidebarIcons.forEach(i => i.classList.remove('active'));
    
    const screen = document.getElementById(`screen-${appName}`);
    if (screen) screen.classList.add('active');
    
    const icon = document.querySelector(`.app-icon[data-app="${appName}"]`);
    if (icon) icon.classList.add('active');

    // ğŸš€ 3. Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ù†Ø§ØµØ± (Logic-Based UI)
    // Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ class Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¬Ø³Ù… Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ø¨Ø± CSS
    document.body.className = `animated-bg text-white overflow-hidden theme-gradient-1 app-${appName}-active`;
    
    // Ø¥Ø¶Ø§ÙØ© ÙˆØ³Ù… Ø¥Ø¶Ø§ÙÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´ØºÙ„ Ù…ØµØºØ±Ø§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªÙ†Ø§Ø³Ù‚ Ø§Ù„ØªØµÙ…ÙŠÙ…
    if (appState.isVideoPlayerMinimized) {
        document.body.classList.add('video-minimized');
    }

    // 4. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´Ø±Ø·ÙŠ Ù„Ù„Ù…Ø¤Ù‚ØªØ§Øª (Conditional Start)

    // A. Ù…Ù†Ø·Ù‚ Ø´Ø§Ø´Ø© Dashboard
    if (appName === 'Dashboard') {
        startClockAndTimer();       // 1s
        startWeatherUpdates();      // 5m
        startDashboardLocationTracking();
        updateTimerDisplay(); 
        renderFavoritesDashboard();
       
        setTimeout(() => {
            if (dashboardGoogleMap) {
                google.maps.event.trigger(dashboardGoogleMap, 'resize');
               
                if (appState.currentLocation) {
                     dashboardGoogleMap.setCenter(appState.currentLocation);
                     const numericHeading = directionToDegrees(appState.car.direction);
                    dashboardGoogleMap.setHeading(numericHeading);
                }
            }
            updateTrafficIndicators(); 
        }, 0); 
    }
    
    // B. Ù…Ù†Ø·Ù‚ Ø´Ø§Ø´Ø© 3D (Map)
    if (appName === 'Map') {
        startCarSimulation(); 
        startWeatherUpdates();
        startDashboardLocationTracking();
    } 
    
    // C. Ù…Ù†Ø·Ù‚ Ø´Ø§Ø´Ø© Weather
    if (appName === 'Weather') {
        startWeatherUpdates();
    }
    
   // ... (Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ switchApp ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) ...

    const activeScreen = document.getElementById(`screen-${appName}`);
    
    if (activeScreen) {
        if (typeof updateNavigableElements === 'function') updateNavigableElements();
        
        setTimeout(() => {
            let firstItem;

            if (appName === 'Media') {
                // ğŸ›‘ 1. Ø§Ø³ØªÙ‡Ø¯Ø§Ù "Ø§Ù„ÙƒØ±ÙˆØª" ØªØ­Ø¯ÙŠØ¯Ø§Ù‹ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆÙ„ÙŠØ³ grid-item Ø§Ù„Ø¹Ø§Ù…)
                firstItem = activeScreen.querySelector('.youtube-reader-card');

                // ğŸ›‘ 2. Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ ÙƒØ±ÙˆØªØŒ Ù†Ø°Ù‡Ø¨ Ù„Ù„ØªØ§Ø¨ Ø§Ù„Ù†Ø´Ø· (Ù…Ø«Ù„Ø§Ù‹ "Ø§Ù„Ù‚Ø±Ø§Ø¡")
                if (!firstItem) {
                    firstItem = activeScreen.querySelector('.tab-button.active');
                }

                // ğŸ›‘ 3. Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø± Ù‡Ùˆ Ø²Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ±ØŒ ØªØ¬Ø§Ù‡Ù„Ù‡ ÙˆØ§Ø¨Ø­Ø« Ø¹Ù† ØºÙŠØ±Ù‡
                if (firstItem && firstItem.id === 'fullscreen-screen-Media-btn') {
                    // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ù„ÙŠØ³ Ù‡Ùˆ Ø²Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ±
                    const allItems = Array.from(activeScreen.querySelectorAll('.navigable, .grid-item'));
                    firstItem = allItems.find(el => el.id !== 'fullscreen-screen-Media-btn' && el.offsetParent !== null);
                }

            } else {
                // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª
                firstItem = activeScreen.querySelector('.grid-item, .navigable');
            }

            // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ±ÙƒÙŠØ²
            if (firstItem) setFocus(firstItem);
            
        }, 250); // ÙˆÙ‚Øª ÙƒØ§ÙÙ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    }
}
        /**
 * Toggles a section element between its normal state and fullscreen mode.
 * * @param {string} sectionId - The ID of the section element (e.g., 'screen-Dashboard').
 */
/**
 * Function 2: Toggles fullscreen mode specifically for an IFRAME element.
 * (This function is generic and will work on 'reciters-iframe')
 * @param {string} targetId - The ID of the IFRAME element.
 */
/**
 * Converts a 24-hour time string (HH:MM) to a 12-hour time string (H:MM Øµ/Ù…).
 *
 * @param {string} time24h - Time in 24-hour format (e.g., "15:36").
 * @returns {string} Time in 12-hour format with 'Øµ' or 'Ù…' (e.g., "3:36 Ù…").
 */
function convertTo12HourWithAmPm(time24h) {
    if (!time24h || typeof time24h !== 'string' || time24h === '--:--') {
        return time24h; 
    }

    // Split the time string into hours and minutes
    const [hours24, minutes] = time24h.split(':').map(str => parseInt(str, 10));
    
    // Determine AM/PM (Øµ/Ù…)
    const suffix = hours24 >= 12 ? 'Ù…' : 'Øµ';
    
    // Convert to 12-hour format (0 = 12 AM, 13 = 1 PM)
    let hours12 = hours24 % 12;
    hours12 = hours12 ? hours12 : 12; // The hour '0' (midnight) should be '12'

    // Return the formatted string
    return `${hours12}:${minutes.toString().padStart(2, '0')} ${suffix}`;
}
// -------------------------------------------------------------
// --- NEW updateTimerDisplay function ---
// -------------------------------------------------------------
/**
 * UPDATED: Updates the digital clock countdown/count-up display separately.
 * Runs every 2 seconds ONLY IF THE VIDEO POPUP IS NOT ACTIVE.
 */

/**
 * NEW: Updates the directional buttons (the compass) to highlight the current direction.
 * This is called immediately after appState.car.direction is updated.
 */
function updateDirectionButtons() {
    const controlsContainer = document.getElementById('direction-controls-3d');
    if (!controlsContainer) return;

    const currentDir = appState.car.direction; // N, NE, E, SE, S, SW, W, NW, or '--'
    const buttons = controlsContainer.querySelectorAll('button');

    // 1. Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    buttons.forEach(btn => btn.classList.remove('active-direction'));

    if (currentDir === '--') return;

    // 2. ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ù„Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠ
    buttons.forEach(btn => {
        if (btn.textContent.trim() === currentDir) {
            btn.classList.add('active-direction');
        }
    });
}

/**
 * UPDATED: Updates the digital clock countdown/count-up display separately.
 * CRITICAL FIX: Countdown to Azan is now hidden unless it's within 20 minutes of the prayer time.
 */
function updateTimerDisplay() {
    // ğŸ›‘ Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø­Ø§Ø³Ù…: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ Ù†Ø´Ø·Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙˆØ±Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙ‚Ø·ÙŠØ¹
    if (videoPopupContainer.classList.contains('active')) {
        return;
    }
    
    const now = new Date();
    
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† determineNextPrayer Ù‚Ø¯ Ø¹Ù…Ù„Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
    if (!appState.prayerTimes.nextPrayerIqamaTime) {
        digitalDateLine1.textContent = ''; // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        digitalDateLine2.textContent = '';
        return;
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    digitalDateLine1.classList.remove('countdown-azan', 'countdown-iqama', 'countdown-up');
    digitalDateLine2.classList.remove('countdown-azan', 'countdown-iqama', 'countdown-up');

    // 1. Logic for COUNT UP (after Iqama)
    if (appState.prayerTimes.currentPrayer && appState.prayerTimes.currentPrayerIqamaTime && now > appState.prayerTimes.currentPrayerIqamaTime) {
        const diffUp = now - appState.prayerTimes.currentPrayerIqamaTime;
        const upSecs = Math.floor(diffUp / 1000);
        const secs = upSecs % 60;
        const mins = Math.floor(upSecs / 60);

        digitalDateLine1.textContent = `Ø§Ù†ØªÙ‡Øª Ø§Ù‚Ø§Ù…Ø© Ø§Ù„ØµÙ„Ø§Ø© ${appState.prayerTimes.currentPrayer} Ù…Ù†Ø°:`;
        digitalDateLine2.textContent = `+${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        digitalDateLine1.classList.add('countdown-up');
        digitalDateLine2.classList.add('countdown-up');
        return;
    }

    // 2. Logic for COUNT DOWN (to Azan or Iqama)
    const diff = appState.prayerTimes.nextPrayerIqamaTime - now;
    const totalSecs = Math.floor(diff / 1000);
    
    // ğŸ›‘ Ø´Ø±Ø· Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø£ÙƒØ¨Ø± Ù…Ù† 20 Ø¯Ù‚ÙŠÙ‚Ø© (1200 Ø«Ø§Ù†ÙŠØ©)
    const MAX_COUNTDOWN_SECS = 10 * 60; 

    if (totalSecs > MAX_COUNTDOWN_SECS && appState.prayerTimes.currentPrayer !== appState.prayerTimes.nextPrayer) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø£Ø°Ø§Ù† ÙˆØ£ÙƒØ«Ø± Ù…Ù† 20 Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø¥Ø®ÙØ§Ø¡
        digitalDateLine1.textContent = `Ø§Ù„Ø£Ø°Ø§Ù† Ø§Ù„Ù‚Ø§Ø¯Ù…: ${appState.prayerTimes.nextPrayer}`;
        digitalDateLine2.textContent = appState.prayerTimes.nextPrayerIqamaTime.toLocaleTimeString('ar-SA', { hour: 'numeric', minute: '2-digit', hour12: true }); 
        
        // ğŸ’¡ Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø£Ø°Ø§Ù† Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø¨Ø¹ÙŠØ¯Ø§Ù‹
        // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù‡Ù†Ø§ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± "Ù…ØªØ¨Ù‚ÙŠ X Ø³Ø§Ø¹Ø©"
        digitalDateLine1.classList.remove('countdown-azan');
        digitalDateLine2.classList.remove('countdown-azan');

        return; // Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ¹Ø¯Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
    }

    // Ø§Ù„Ù…Ù†Ø·Ù‚ ÙŠØ³ØªÙ…Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ <= 20 Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ùˆ Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¥Ù‚Ø§Ù…Ø©
    if (totalSecs >= 0) {
        const secs = totalSecs % 60;
        const mins = Math.floor((totalSecs / 60) % 60);
        const hrs = Math.floor(totalSecs / 3600);
        
        const isCountdownToIqama = (appState.prayerTimes.currentPrayer === appState.prayerTimes.nextPrayer);

        if (isCountdownToIqama) {
            // Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¥Ù‚Ø§Ù…Ø© (ÙÙŠ ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø©)
            digitalDateLine1.textContent = `Ø¥Ù‚Ø§Ù…Ø© ØµÙ„Ø§Ø© ${appState.prayerTimes.currentPrayer} ÙÙŠ:`;
            digitalDateLine2.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            digitalDateLine1.classList.add('countdown-iqama');
            digitalDateLine2.classList.add('countdown-iqama');
        } else {
            // Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø£Ø°Ø§Ù† (Ø§Ù„Ø¢Ù† Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù€ 20 Ø¯Ù‚ÙŠÙ‚Ø©)
            digitalDateLine1.textContent = `Ø§Ù„Ø£Ø°Ø§Ù† Ø§Ù„Ù‚Ø§Ø¯Ù…: ${appState.prayerTimes.nextPrayer}`;
            digitalDateLine2.textContent = hrs > 0 ? `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}` : `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            digitalDateLine1.classList.add('countdown-azan');
            digitalDateLine2.classList.add('countdown-azan');
        }
    }
}

function toggleIframeFullscreen(targetId) {
    const targetElement = document.getElementById(targetId);
    const body = document.body;

    if (targetElement) {
        // We toggle the is-fullscreen class on the target element (the iframe)
        targetElement.classList.toggle('is-fullscreen');
        
        // We toggle fullscreen-mode on the body to hide global elements
        body.classList.toggle('fullscreen-mode');

        // Optional: Icon update logic here (using a generic button ID if possible)
        const buttonId = `fullscreen-btn-${targetId}`;
        const icon = document.querySelector(`#${buttonId} .fas`); 
        
        if (icon) {
            if (targetElement.classList.contains('is-fullscreen')) {
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
            } else {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }
        }
    } else {
        console.error(`Error: Element with ID ${targetId} not found.`);
    }
}
        
function toggleFullscreen(sectionId) {
    const section = document.getElementById(sectionId);
    const body = document.body;

    if (section) {
        // Toggle the fullscreen class on the section
        section.classList.toggle('is-fullscreen');
        
        // Toggle a class on the body to handle hiding global elements like the navigation bar
        body.classList.toggle('fullscreen-mode');

        // Optional: Update the button icon to indicate the state
        const icon = document.querySelector(`#fullscreen-${sectionId}-btn .fas`);
        if (icon) {
            if (section.classList.contains('is-fullscreen')) {
                // Change to exit fullscreen icon
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
            } else {
                // Change back to expand icon
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }
        }

        console.log(`${sectionId} is now in fullscreen mode: ${section.classList.contains('is-fullscreen')}`);
    } else {
        console.error(`Error: Section with ID ${sectionId} not found.`);
    }
}

document.addEventListener('DOMContentLoaded', () => {
  if (typeof observer === 'undefined' || !observer) {
        console.warn("âš ï¸ Observer was missing, creating a new instance...");
        window.observer = new MutationObserver((mutations) => {
            // Ø¶Ø¹ Ù‡Ù†Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡ Ø£Ù† ÙŠØªÙ†ÙØ° Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« ØªØºÙŠÙŠØ±Ø§Øª
            // mutations.forEach(...)
        });
    }

    // 2. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ document.body Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
    if (document.body) {
        // --- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ø§Ù„Ø¢Ù† Ø£ØµØ¨Ø­ Ø¢Ù…Ù†Ø§Ù‹) ---
        observer.observe(document.body, { 
            childList: true, 
            subtree: true, 
            attributes: true 
        });
        console.log("âœ… Observer started successfully on document.body");
    } else {
        console.error("âŒ document.body not found! Observer could not start.");
    }
});

function updateFullDateWidget() {
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±ÙÙŠÙ† Ù…Ø¹Ø§Ù‹
    const oldContainer = document.getElementById('full-date-widget-container');
    const newContainer = document.getElementById('universal-date-display');

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø£ÙŠ Ù…Ù†Ù‡Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¯Ø§Ù„Ø©
    if (!oldContainer && !newContainer) return;

    // ğŸ›‘ [Ø¥ØµÙ„Ø§Ø­ Ù‡Ø§Ù…]: ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ ReferenceError
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1); // Ø§Ù„Ù‡Ø¬Ø±ÙŠ ÙŠØ³Ø¨Ù‚ Ø¨ÙŠÙˆÙ… Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª
    const dayName = new Intl.DateTimeFormat('ar-SA', { weekday: 'long' }).format(today);
    const gregDate = new Intl.DateTimeFormat('ar-SA', { day: 'numeric', month: 'long', year: 'numeric' }).format(today);
    const hijriDate = new Intl.DateTimeFormat('ar-OM-u-ca-islamic', { day: 'numeric', month: 'long', year: 'numeric' }).format(yesterday);

    // Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ (ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ ÙƒÙˆØ¯Ùƒ)
    const dateHTML = `
        <div class="date-wrapper">
            <span class="day-highlight">${dayName}</span>
            <div class="date-details">
                <span class="greg-text">${gregDate}</span>
                <span class="separator">|</span>
                <span class="hijri-text">${hijriDate}</span>
            </div>
        </div>
    `;

    if (oldContainer) {
        oldContainer.innerHTML = dateHTML;
    }

    // Ù…Ù„Ø¡ Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
    if (newContainer) {
        newContainer.innerHTML = dateHTML;
    }
}

function renderFavoritesDashboard() {
    const container = document.getElementById('fav-d-dashboard-container');
    
    // 1. ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ±
    if (!container) {
        console.warn("âš ï¸ Container #fav-d-dashboard-container not found!");
        return;
    }

    // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙØ§Ø±ØºØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
    const list = favoritesD || []; 
    
    console.log(`ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${list.length} ÙÙŠØ¯ÙŠÙˆ.`);

    // 3. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    container.innerHTML = ''; 
    
    // 4. Ø¶Ø¨Ø· Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Flex & Scroll)
    container.className = 'favorites-dashboard-horizontal-scroll flex-grow overflow-x-auto whitespace-nowrap flex gap-4';

    // 5. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ§Ø±ØºØ©
    if (list.length === 0) {
        container.style.justifyContent = 'center'; 
        container.innerHTML = '<p class="text-white/50 text-center p-4 w-full self-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.</p>';
        return;
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø± Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªÙˆÙ‰
    container.style.justifyContent = 'flex-start';

    // 6. Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª
    list.forEach(video => {
        if (!video || !video.id) return;
        
        const card = document.createElement('div');
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ§Ø±Øª: Ø¹Ø±Ø¶ Ù†Ø³Ø¨ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± 3.5 ÙƒØ§Ø±Øª
        card.className = 'fav-d-dashboard-card navigable grid-item flex-shrink-0 relative group'; 
        card.style.minWidth = '28%'; 
        card.style.maxWidth = '28%';
        card.setAttribute('tabindex', '0');
        card.tabIndex = 0;
        card.dataset.videoId = video.id;

        // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        const durationSec = typeof parseDurationToSeconds === 'function' ? parseDurationToSeconds(video.duration) : 100;
        const progressPercent = (video.progress > 0) ? (video.progress / durationSec) * 100 : 0;

        card.innerHTML = `
            <div class="relative w-full h-32 rounded-xl overflow-hidden border border-white/10 bg-black/20">
                <img src="${video.thumbnail || 'https://placehold.co/320x180'}" 
                     alt="${video.title}"
                     class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                     loading="lazy">
                
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                
                <button class="remove-fav-btn absolute top-2 left-2 p-1.5 bg-red-600/90 rounded-full opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity navigable grid-item" title="Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>

                <div class="absolute bottom-2 right-2 left-2 flex flex-col gap-1">
                    <h4 class="text-sm font-bold text-white truncate text-right leading-tight">${video.title}</h4>
                    <p class="text-[10px] text-gray-300 truncate text-right">${video.channelTitle || ''}</p>
                    
                    <div class="w-full h-1 bg-gray-600/50 rounded-full overflow-hidden mt-1">
                        <div class="h-full bg-blue-500" style="width: ${Math.min(progressPercent, 100)}%"></div>
                    </div>
                </div>
                
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    <i data-lucide="play-circle" class="w-8 h-8 text-white/90 drop-shadow-md"></i>
                </div>
            </div>
        `;

        // --- Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ---

        // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        card.addEventListener('click', (e) => {
            // Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ø°Ø§ Ø¶ØºØ·Ù†Ø§ Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­Ø°Ù
            if (!e.target.closest('.remove-fav-btn')) {
                window.isAutoPlayMode = false;
                showVideoPopup(video.id, video.progress); 
            }
        });

        // 2. Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Binding Fix)
        const delBtn = card.querySelector('.remove-fav-btn');
        if (delBtn) {
            delBtn.addEventListener('click', async (e) => {
                e.stopPropagation(); // Ù…Ù†Ø¹ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù ÙˆØªÙ…Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ¹ 'D' Ù„Ù„Ø³ÙŠØ§Ø±Ø©
                await removeVideoFromFavorites(video.id, 'D'); 
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… ÙÙˆØ±Ø§Ù‹ Ø³ØªØªÙ… Ø¯Ø§Ø®Ù„ removeVideoFromFavorites Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¨Ø±Ù…Ø¬Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŒ
                // Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù‡Ù†Ø§ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„ÙÙˆØ±ÙŠ:
                // renderFavoritesDashboard(); (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù ØªÙ‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ)
            });
        }

        container.appendChild(card);
    });

    // 7. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆÙ†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„
    if (typeof lucide !== 'undefined') lucide.createIcons();
    if (typeof updateNavigableElements === 'function') updateNavigableElements();
}

// REPLACE the current displayLastWatchedVideo function with this one
async function displayLastWatchedVideo() {
    const lastWatchedContainer = document.getElementById('last-watched-container');
    const history = getWatchedHistory();
    
    // Sort by timestamp to show the most recently watched videos first
    const videoIds = Object.keys(history)
        .sort((a, b) => (history[b].lastWatchedTimestamp || 0) - (history[a].lastWatchedTimestamp || 0))
        .slice(0, 3);

    if (videoIds.length === 0) {
        lastWatchedContainer.classList.add('hidden');
        return;
    }

    try {
        const videoDetails = await fetchVideosDetails(videoIds);
        if (!videoDetails || videoDetails.length === 0) {
            lastWatchedContainer.classList.add('hidden');
            return;
        }

        // REVERSE the array so the most recent video is last in the list, ready to be scrolled to.
        videoDetails.reverse();

        const slidesHTML = videoDetails.map(video => {
            const videoData = {
                id: video.id,
                title: video.snippet.title,
                thumbnail: video.snippet.thumbnails.medium.url,
                channelTitle: video.snippet.channelTitle
            };
            const lastVideoInfo = history[videoData.id];
            const progressPercent = (lastVideoInfo && lastVideoInfo.progress > 0 && lastVideoInfo.duration > 0) 
                ? (lastVideoInfo.progress / lastVideoInfo.duration) * 100 
                : 0;

            return `
                <div class="last-watched-slide">
                    <div class="glass-surface glass-surface--svg p-3 rounded-2xl w-full">
                        <div class="flex items-center gap-4">
                            <img src="${videoData.thumbnail}" class="w-28 h-auto rounded-lg flex-shrink-0">
                            <div class="flex flex-col gap-2 flex-grow min-w-0">
                                <h3 class="font-bold text-lg leading-tight">${videoData.title}</h3>
                                <p class="text-sm text-white/70">${videoData.channelTitle}</p>
                                <div class="w-full bg-white/20 rounded-full h-1.5 mt-1">
                                    <div class="bg-red-500 h-1.5 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                                <button class="resume-play-button self-start navigable grid-item" onclick="showVideoPopup('${videoData.id}')">
                                    <i data-lucide="play" class="w-4 h-4"></i>
                                    Ø§Ø³ØªØ¦Ù†Ø§Ù
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        const viewAllCardHTML = `
            <div class="last-watched-slide">
                <div class="glass-surface glass-surface--svg p-3 rounded-2xl w-full h-full flex flex-col items-center justify-center text-center cursor-pointer navigable grid-item" id="view-all-history-card">
                    <div class="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center mb-3">
                        <i data-lucide="history" class="w-8 h-8 text-white"></i>
                    </div>
                    <h3 class="font-bold text-lg">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</h3>
                    <p class="text-sm text-white/70">Ù…Ø´Ø§Ù‡Ø¯Ø© ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„</p>
                </div>
            </div>
        `;

        // Simplified structure for the new scroll-snap container
        lastWatchedContainer.innerHTML = `
            <h2 class="text-xl font-bold mb-3 text-white/90 text-center">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</h2>
            <div class="last-watched-carousel-wrapper">
                 <div class="last-watched-slides-container">
                   
                     <div class="last-watched-slide">
                <div class="glass-surface glass-surface--svg p-3 rounded-2xl w-full h-full flex flex-col items-center justify-center text-center cursor-pointer navigable grid-item" id="istory-card">
                    <div class="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center mb-3">
                       
                    </div>
                  
                </div>
            </div>
             ${slidesHTML}
             ${viewAllCardHTML}
                   
                </div>
                <button id="last-watched-prev" class="carousel-nav-button prev navigable grid-item" tabindex="0"><i data-lucide="chevron-left" class="w-8 h-8"></i></button>
                <button id="last-watched-next" class="carousel-nav-button next navigable grid-item" tabindex="0"><i data-lucide="chevron-right" class="w-8 h-8"></i></button>
            </div>
        `;

        

        lastWatchedContainer.classList.remove('hidden');
        lucide.createIcons();
        
        // NEW: Add event listener for the view all card
        const viewAllCard = document.getElementById('view-all-history-card');
        if (viewAllCard) {
            viewAllCard.addEventListener('click', showAllWatchedHistory);
        }
        
        // Scroll to the last item on load
        setTimeout(() => {
            const slidesContainer = document.querySelector('.last-watched-slides-container');
            if (slidesContainer) {
                // To show the last item (most recent) in an LTR container, scroll all the way to the right.
                slidesContainer.scrollLeft = slidesContainer.scrollWidth;
            }
        }, 0); // Use a timeout of 0 to run this after the browser has rendered the elements

        // NEW: Event listeners for carousel navigation
        const slidesContainer = lastWatchedContainer.querySelector('.last-watched-slides-container');
        const prevButton = lastWatchedContainer.querySelector('#last-watched-prev');
        const nextButton = lastWatchedContainer.querySelector('#last-watched-next');

        if (slidesContainer && prevButton && nextButton && slidesContainer.querySelector('.last-watched-slide')) {
            const scrollAmount = slidesContainer.querySelector('.last-watched-slide').offsetWidth + 16; // 16 is the gap

            prevButton.addEventListener('click', () => {
                slidesContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            });

            nextButton.addEventListener('click', () => {
                slidesContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            });
        }

    } catch (error) {
        console.error("Error fetching details for last watched videos:", error);
        lastWatchedContainer.classList.add('hidden');
    }
}

        // Initialize Lucide icons after they are loaded
        lucide.createIcons();

        // --- API Keys ---
        
        const AI_ASSISTANT_API_KEY = 'AIzaSyBMmtON9ww4dJxMHrl1wKyWTvI0ipJXJws'; 
        const WEATHER_API_KEY = '7acefc26deee4904a2393917252207'; 
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBRqAHJ2elbE_Z7NXXYC50XZpqi6HbG6Rk';



const JSONBIN_API_KEY = '$2a$10$SYrYv.ct8hiMU9YeUxEQ.ecRkOrTqs.TDchJRV3wW.aKJnDXy2oVy';
const JSONBIN_BIN_ID_REMINDERS = '68e3800cae596e708f07cf32';
const JSONBIN_ACCESS_KEY_REMINDERS = '$2a$10$J8o3WrPtnqmKAd///uDw6.BOWnGIBekHFOImbeEZZwsJ/h/XPbVUy';

// NEW: JSONBin IDs for Favorites
const JSONBIN_BIN_ID_FAV_M = '68e4ac20d0ea881f4098138c';
const JSONBIN_BIN_ID_FAV_D = '68e4ac2e43b1c97be95d24af';

// NEW: JSONBin IDs for Channels List
const JSONBIN_BIN_ID_CHANNELS = '68ef1b3dd0ea881f40a38bd1';
const JSONBIN_ACCESS_KEY_CHANNELS = '$2a$10$J8o3WrPtnqmKAd///uDw6.BOWnGIBekHFOImbeEZZwsJ/h/XPbVUy';
let localChannelsCache = []; // To store the list locally

const JSONBIN_BIN_ID_RECITER = '6909c1cd43b1c97be997b522'; 
const JSONBIN_ACCESS_KEY_RECITER = '$2a$10$J8o3WrPtnqmKAd///uDw6.BOWnGIBekHFOImbeEZZwsJ/h/XPbVUy'; 
let localRecitersCache = [];


let favoritesD = [];
let favoritesM = [];

        
        // --- Global App State Management ---
        let appState = {
            currentTime: '',
            mapLocation: { lat: 17.081667, lon: 54.159722, zoom: 18 },
            weather: { temperature: null, description: null, uvIndex: null, iconUrl: '', location: 'Salalah, Oman' },
            car: { speed: 0, rpm: 0, fuel: 0, temp: 0, gear: 'P', direction: '--' }, // Added direction
            prayerTimes: { Fajr: '--:--', Dhuhr: '--:--', Asr: '--:--', Maghrib: '--:--', Isha: '--:--', nextPrayer: null, nextPrayerIqamaTime: null, currentPrayer: null },
            hasShownGeolocationError: false,
            mapZoomChangedByUser: false,
            dashboardReturnCounter: 0,
            custom360Image: localStorage.getItem('custom360Image') || null,
            currentLocation: null,
            previousLocation: null, // For tracking movement
            destinationSet: false,
            isVideoPlayerMinimized: false // NEW state for minimized player
        };
        let googleMapsPromise = null;
        let currentFontSize = 16; // Base size in pixels
        const fontSizeStep = 1; // Change by 1px
        const maxFontSize = 20; // Max size (125%)
        const minFontSize = 12; // Min size (75%)

        // --- Home Locations ---
        // UPDATED: Coordinates for Home 1 and Home 2
        // ğŸ’¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ù†Ø§Ø²Ù„ Ø§Ù„Ø«Ø§Ø¨ØªØ© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø¹Ø±ÙØ© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹)
const HOME1_COORDS = {lat: 17.067330, lng: 54.160190, zoom: 18}; 
const HOME2_COORDS = {lat: 17.081852, lng: 54.158345, zoom: 18};

/**
 * NEW: Determines the color class for traffic status based on the delay percentage.
 */
/**
 * NEW: Displays a marker for a specific location on the Dashboard Google Map.
 *
 * @param {object} coords - The {lat, lng} coordinates of the location (HOME1_COORDS or HOME2_COORDS).
 * @param {string} title - The title for the marker's infowindow.
 */
function displayLocationMarker(coords, title) {
    if (!dashboardGoogleMap || !window.google || !window.google.maps) {
        showMessageBox('Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø© Ø¨Ø¹Ø¯ Ø£Ùˆ Ø®Ø¯Ù…Ø§Øª Ø¬ÙˆØ¬Ù„ ØºÙŠØ± Ù…ØªØ§Ø­Ø©.');
        return;
    }
    
    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¤Ù‚ØªØ©
    const tempMarker = new google.maps.Marker({
        position: coords,
        map: dashboardGoogleMap,
        title: title,
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ù„Ù… Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙˆØ¬Ù‡Ø©
        icon: {
            path: google.maps.SymbolPath.FLAG, 
            scale: 5,
            fillColor: "#FF00FF",
            fillOpacity: 0.8,
            strokeColor: "#FFFFFF",
            strokeWeight: 1
        }
    });

    // 2. ØªØ±ÙƒÙŠØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØªÙƒØ¨ÙŠØ±Ù‡
    dashboardGoogleMap.setCenter(coords);
    dashboardGoogleMap.setZoom(16); 
    
    showMessageBox(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø© "${title}". ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¤ÙŠØ© Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù… Ø¹Ù„ÙŠÙ‡Ø§.`);
    
    // 3. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†Ù (Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø©)
    setTimeout(() => {
        tempMarker.setMap(null); 
    }, 10000); 
}

function getTrafficColorClass(delayPercentage) {
    if (delayPercentage === -1) return 'traffic-unknown';
    // Ø£Ù‚Ù„ Ù…Ù† 5% ØªØ£Ø®ÙŠØ±: Ø§Ø²Ø¯Ø­Ø§Ù… Ø®ÙÙŠÙ (Ø£Ø®Ø¶Ø±)
    if (delayPercentage < 5) return 'traffic-green';    
    // 5% - 20% ØªØ£Ø®ÙŠØ±: Ø§Ø²Ø¯Ø­Ø§Ù… Ù…ØªÙˆØ³Ø· (Ø£ØµÙØ±)
    if (delayPercentage < 20) return 'traffic-yellow';   
    // Ø£ÙƒØ«Ø± Ù…Ù† 20% ØªØ£Ø®ÙŠØ±: Ø§Ø²Ø¯Ø­Ø§Ù… Ø´Ø¯ÙŠØ¯ (Ø£Ø­Ù…Ø±)
    return 'traffic-red';                                
}

/**
 * NEW: Fetches the current traffic status from the user's location to a destination.
 * * @param {object} origin - {lat, lng} of the starting point (appState.currentLocation).
 * @param {object} destination - {lat, lng} of the destination (HOME_COORDS).
 * @returns {Promise<number>} Returns the duration difference percentage (0-100) or -1 on failure.
 */
async function fetchTrafficStatus(origin, destination) {
    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† directionsService Ù…Ù‡ÙŠØ£ ÙÙŠ initMap()
    if (!window.google || !window.google.maps || !directionsService || !origin) return -1;

    const request = {
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions: {
            departureTime: new Date(Date.now()),
            trafficModel: 'bestguess'
        },
        unitSystem: google.maps.UnitSystem.METRIC
    };

    try {
        const response = await directionsService.route(request);
        if (response.status === 'OK') {
            const route = response.routes[0].legs[0];
            const durationInTraffic = route.duration_in_traffic.value; // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ù…Ø¹ Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…
            const predictedDuration = route.duration.value;          // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ø²Ø¯Ø­Ø§Ù… (Ø§ÙØªØ±Ø§Ø¶ÙŠ)

            if (predictedDuration > 0) {
                const trafficDelaySecs = durationInTraffic - predictedDuration;
                // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ£Ø®ÙŠØ±
                return Math.min(100, Math.round((trafficDelaySecs / predictedDuration) * 100));
            }
        }
        return -1;
    } catch (e) {
        console.error("Traffic status fetch failed:", e);
        return -1;
    }
}

/**
 * NEW: Master function to fetch and update the traffic indicators on home buttons.
 * This is the function that should run every 10 minutes.
 */
/**
 * FINAL: Fetches and updates the traffic indicators on home buttons in the Dashboard.
 * It uses the Directions API to calculate delay percentage and colors the buttons accordingly.
 */
/**
 * FINAL: Fetches and updates the traffic indicators on home buttons in the Dashboard.
 */
async function updateTrafficIndicators() {
    const origin = appState.currentLocation || HOME1_COORDS; // Fallback Origin

    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø®Ø¯Ù…Ø§Øª Google Maps
    if (!window.google || !window.google.maps || !directionsService) {
         console.warn("Traffic update postponed: Google Maps services not ready.");
         // ğŸ’¡ Ù†ÙØ­Ø¯Ù‘ÙØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙˆØ±Ø§Ù‹ Ù„Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ù…Ø¹Ø±ÙØ©
         document.getElementById('go-to-home-1-button')?.classList.add('traffic-unknown');
         document.getElementById('go-to-home-2-button')?.classList.add('traffic-unknown');
         return;
    }

    // 2. Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…
    const home1Promise = fetchTrafficStatus(origin, HOME1_COORDS);
    const home2Promise = fetchTrafficStatus(origin, HOME2_COORDS);
    const [delay1, delay2] = await Promise.all([home1Promise, home2Promise]);
    
    // 3. ØªØ­Ø¯ÙŠØ« Ø²Ø± 'Ø¥Ø´Ø§Ø±Ø§Øª Ù‚' (Home 1)
    const btn1 = document.getElementById('go-to-home-1-button');
    if (btn1) {
        const colorClass = getTrafficColorClass(delay1);
        btn1.classList.remove('traffic-red', 'traffic-yellow', 'traffic-green', 'traffic-unknown');
        btn1.classList.add(colorClass);
        // ğŸ›‘ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø³Ù… "Ø¥Ø´Ø§Ø±Ø§Øª Ù‚"
        btn1.innerHTML = `Ø¥Ø´Ø§Ø±Ø§Øª Ù‚ (${delay1 !== -1 ? delay1 + '%' : '--'})`;
    }

    // 4. ØªØ­Ø¯ÙŠØ« Ø²Ø± 'ØªÙ‚Ø§Ø·Ø¹ Ø´' (Home 2)
    const btn2 = document.getElementById('go-to-home-2-button');
    if (btn2) {
        const colorClass = getTrafficColorClass(delay2);
        btn2.classList.remove('traffic-red', 'traffic-yellow', 'traffic-green', 'traffic-unknown');
        btn2.classList.add(colorClass);
        // ğŸ›‘ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø³Ù… "ØªÙ‚Ø§Ø·Ø¹ Ø´"
        btn2.innerHTML = `ØªÙ‚Ø§Ø·Ø¹ Ø´ (${delay2 !== -1 ? delay2 + '%' : '--'})`;
    }
}
        // --- DOM Element References ---
        const appButtons = document.querySelectorAll('button[data-app]');
        const appScreens = document.querySelectorAll('.app-screen');
        const sidebarIcons = document.querySelectorAll('.app-icon');
        const quranQuickAccess = document.getElementById('quran-quick-access');
        const youtubeSearchInput = document.getElementById('youtube-search-input');
        const youtubeSearchButton = document.getElementById('youtube-search-button');
        const youtubeSuggestionsDiv = document.getElementById('youtube-suggestions');
        const youtubeVideoListView = document.getElementById('youtube-video-list-view'); 
        const videoListContainer = document.getElementById('video-list-container'); 
        const youtubeSearchResultsView = document.getElementById('youtube-search-results-view');
        const searchResultsContainer = document.getElementById('search-results-container');
        const backToPlaylistsFromVideosButton = document.getElementById('back-to-playlists-from-videos'); 
        const backToPlaylistsBottomButton = document.getElementById('back-to-playlists-bottom-button');
        const backToPlaylistsBottomButtonSearch = document.getElementById('back-to-playlists-bottom-button-search');
        const previousItemButton = document.getElementById('previous-item-button');
        const nextItemButton = document.getElementById('next-item-button');
        const videoPopupContainer = document.getElementById('video-popup-container');
        const videoPopupPlayerContainer = document.getElementById('video-popup-player-container');
        const videoPopupCloseButton = document.getElementById('video-popup-close-button');
        const quranIframe = document.getElementById('quran-iframe');
        const floatingMediaButton = document.getElementById('floating-media-button');
        const floatingKeyboardButton = document.getElementById('floating-keyboard-button');
        const floatingMinimizedVideoButton = document.getElementById('floating-minimized-video-button');
        const backToSearchFloatingButton = document.getElementById('back-to-search-floating-button'); // NEW
        const clearSearchButton = document.getElementById('clear-search-button');
        const prayerTimesContainer = document.getElementById('prayer-times-container');
        const digitalHoursSpan = document.querySelector('#digital-time .hours');
        const digitalMinutesSpan = document.querySelector('#digital-time .minutes');
        const digitalSecondsSpan = document.querySelector('#digital-time .seconds');
        const digitalDateLine1 = document.getElementById('digital-date-line1');
        const digitalDateLine2 = document.getElementById('digital-date-line2');
        let dashboardGoogleMap, dashboardGoogleMarker, directionsService, directionsRenderer;
        let watchId;
        const getMyLocationButtonDashboard = document.getElementById('get-my-location-button-dashboard');
        const goToHome1Button = document.getElementById('go-to-home-1-button');
        const goToHome2Button = document.getElementById('go-to-home-2-button');
        const car360Image = document.getElementById('car-360-image');
        const upload360ImageInput = document.getElementById('upload-360-image-input');
        const upload360ImageButton = document.getElementById('upload-360-image-button');
        const reset360ImageButton = document.getElementById('reset-360-image-button');
        const carplayMainInterface = document.getElementById('carplay-main-interface');
        const pauseAnimationButton = document.getElementById('pause-animation-button');
        const zoomInButton = document.getElementById('zoom-in-button');
        const zoomOutButton = document.getElementById('zoom-out-button');
        const removeCacheButton = document.getElementById('remove-cache-button');
        const default360ImageSrc = "https://dmusera.netlify.app/es350gb.png";
        let currentPlayingPlaylistId = '', activeMediaView = 'suggestions', currentPlayingVideoId = '', selectedReaderName = '', popupPlayer, isYouTubeApiReady = false, searchMode = 'reciter_surah', progressInterval = null;
        let lastSuccessfulSearchQuery = null; // NEW: To store the last search query
        let initialLocationFetched = false;

        const juzArabicNames = ["Ø§Ù„Ø£ÙˆÙ„", "Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø«", "Ø§Ù„Ø±Ø§Ø¨Ø¹", "Ø§Ù„Ø®Ø§Ù…Ø³", "Ø§Ù„Ø³Ø§Ø¯Ø³", "Ø§Ù„Ø³Ø§Ø¨Ø¹", "Ø§Ù„Ø«Ø§Ù…Ù†", "Ø§Ù„ØªØ§Ø³Ø¹", "Ø§Ù„Ø¹Ø§Ø´Ø±", "Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±", "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±", "Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±", "Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±", "Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±", "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø¹Ø´Ø±", "Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø¹Ø´Ø±", "Ø§Ù„Ø«Ø§Ù…Ù† Ø¹Ø´Ø±", "Ø§Ù„ØªØ§Ø³Ø¹ Ø¹Ø´Ø±", "Ø§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„Ø­Ø§Ø¯ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„Ø«Ø§Ù„Ø« ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„Ø±Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„Ø®Ø§Ù…Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„Ø³Ø§Ø¯Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„Ø³Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„Ø«Ø§Ù…Ù† ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„ØªØ§Ø³Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†"];

       
       /**
 * Fetches the list of Reciters from JSONBin.io and updates the local cache.
 * @returns {Promise<Array>} The list of reciters.
 */
async function fetchRecitersList() {
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID_RECITER}/latest`, {
            headers: { 'X-Access-Key': JSONBIN_ACCESS_KEY_RECITER }
        });
        if (res.status === 404) return []; // Bin is new/empty
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);
        const data = await res.json();
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‡ÙŠ Ù…ØµÙÙˆÙØ© ÙˆØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ clicks
        const fetchedList = Array.isArray(data.record) ? data.record : [];
        localRecitersCache = fetchedList.map(r => ({
            ...r,
            clicksreciter: parseInt(r.clicksreciter, 10) || 0 // ØªØ­ÙˆÙŠÙ„ Click Count Ø¥Ù„Ù‰ Ø±Ù‚Ù…
        }));
        
        return localRecitersCache;
    } catch (error) {
        console.error(`Error fetching reciters list:`, error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©)
        return localRecitersCache || [];
    }
}

/**
 * Updates the Reciters list on JSONBin.io.
 * @param {Array} newRecitersList - The updated list to send.
 * @returns {Promise<boolean>} True if successful.
 */
async function updateRecitersList(newRecitersList) {
    // ØªØµÙÙŠØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù‡Ø§Ù…Ø© ÙÙ‚Ø· Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    const sanitizedList = newRecitersList.map(r => ({
        name: r.name,
        image: r.image,
        clicksreciter: r.clicksreciter // ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡ ÙƒÙ†Øµ Ø£Ùˆ Ø±Ù‚Ù…
    }));
    
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID_RECITER}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': JSONBIN_API_KEY // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
            },
            body: JSON.stringify(sanitizedList)
        });
        if (!res.ok) throw new Error(`Failed to update reciters list: ${res.status}`);
        localRecitersCache = newRecitersList; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        return true;
    } catch (error) {
        console.error(`Error updating reciters list:`, error);
        showMessageBox(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡`);
        return false;
    }
}

/**
 * Increments the click counter for a specific reciter.
 * @param {string} reciterName - The name of the reciter.
 */
function incrementReciterClick(reciterName) {
    if (!reciterName || !localRecitersCache) return;
    
    let reciterFound = false;
    const updatedList = localRecitersCache.map(reciter => {
        if (reciter && reciter.name === reciterName) {
            reciterFound = true;
            const currentClicks = parseInt(reciter.clicksreciter, 10) || 0;
            return { ...reciter, clicksreciter: currentClicks + 1 };
        }
        return reciter;
    });

    if (reciterFound) {
        localRecitersCache = updatedList;
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        updateRecitersList(updatedList).catch(err => {
            console.error("Failed to update reciter clicks in background:", err);
        });
    }
}

 /**
 * Shows the prompt to add a new reciter to the list.
 */
/**
 * NEW: Shows the modal prompt to add a new Reciter.
 * It initiates a search flow (handleSearchForReciterChannel) against the YouTube API 
 * filtered for Arabic channels, allowing the user to select and save a Reciter.
 */
/**
 * REPLACED & COMPLETE: Shows the modal prompt to add a new Reciter by searching YouTube Channels.
 * It dynamically creates the search interface and handles the event binding to the search function.
 */
function showAddReciterPrompt() {
    const existingPrompt = document.getElementById('add-reciter-prompt');
    if (existingPrompt) existingPrompt.remove();

    // 1. Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal Structure)
    const promptHTML = `
        <div id="add-reciter-prompt" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[9999]">
            <div id="add-reciter-prompt-content" class="glass-surface glass-surface--svg p-6 rounded-2xl w-full max-w-lg flex flex-col gap-4 transition-all duration-300">
                <h3 class="text-xl font-bold text-center">Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø±Ø¦/Ù‚Ù†Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <p class="text-sm text-white/70 text-center">Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦ (Ù…Ø«Ù„: ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ) Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ù†Ø§ØªÙ‡ ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§.</p>
                <div class="flex gap-2 grid-container">
                    <input type="text" id="new-reciter-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦..." class="flex-grow p-3 rounded-full bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 navigable grid-item" tabindex="0" />
                    <button id="search-channel-confirm" class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-3 rounded-full navigable grid-item" tabindex="0">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div id="channel-search-results" class="mt-4 max-h-[50vh] overflow-y-auto flex flex-col gap-3 grid-container">
                    <p class="text-center text-white/50">Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§.</p>
                </div>
                
                <button id="add-reciter-cancel" class="mt-2 bg-red-600/80 hover:bg-red-700/80 text-white font-bold py-2 px-4 rounded-full navigable grid-item self-center" tabindex="0">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', promptHTML);
    lucide.createIcons();

    // 2. Ø±Ø¨Ø· Ø§Ù„Ø¹Ù†Ø§ØµØ± (Event Binding)
    const promptEl = document.getElementById('add-reciter-prompt');
    const nameInput = document.getElementById('new-reciter-name-input');
    const searchBtn = document.getElementById('search-channel-confirm');
    const cancelBtn = document.getElementById('add-reciter-cancel');

    const closePrompt = () => {
        promptEl.remove();
        updateNavigableElements(); // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø©
    };

    // ğŸ›‘ Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù„Ù‚Ø±Ø§Ø¡
    searchBtn.addEventListener('click', handleSearchForReciterChannel); 

    // ğŸ›‘ Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø« Ø¨Ø²Ø± Enter
    nameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleSearchForReciterChannel(); 
        }
    });

    cancelBtn.addEventListener('click', closePrompt);
    
    // 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ§Ù„Ù€ Escape
    nameInput.focus();
    setFocus(nameInput);
    
    const escapeHandler = (e) => {
        if (e.key === 'Escape') {
            closePrompt();
            document.removeEventListener('keydown', escapeHandler);
        }
    };
    document.addEventListener('keydown', escapeHandler);

    updateNavigableElements(); // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
}

// -------------------------------------------------------------
// * ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙØ¹Ø±ÙØ© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹:
// * handleSearchForReciterChannel()
// * lucide.createIcons()
// * setFocus()
// * showMessageBox()
// -------------------------------------------------------------

/**
 * Handles the addition of a new reciter to the JSONBin list.
 */
/**
 * RENAMED & REFINED: Handles the search action specifically for finding a Reciter Channel.
 * Applies strong filtering for 'type=channel' and 'relevanceLanguage=ar'.
 */
/**
 * RENAMED & REFINED: Handles the search action specifically for finding a Reciter Channel.
 * Applies strong filtering for 'type=channel' and 'relevanceLanguage=ar'.
 */
async function handleSearchForReciterChannel() {
    // ğŸ›‘ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ¹Ø±Ù‘ÙØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    const inputEl = document.getElementById('new-reciter-name-input');
    const resultsContainer = document.getElementById('channel-search-results');
    const confirmBtn = document.getElementById('search-channel-confirm');
    
    const query = inputEl?.value.trim();

    if (!query) {
        showMessageBox("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦/Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ù„Ø¨Ø­Ø«.");
        return;
    }

    // 1. ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (CRITICAL FIX)
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>`;
    lucide.createIcons();
    resultsContainer.innerHTML = '<p class="text-center text-white/70">...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«</p>';

    try {
        // 2. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API ÙŠÙˆØªÙŠÙˆØ¨ Ù…Ø¹ ÙÙ„ØªØ± Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙˆØ§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        const API_URL = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=channel&key=${YOUTUBE_API_KEY}&maxResults=10&relevanceLanguage=ar`; 
        
        const response = await fetch(API_URL);
        
        if (!response.ok) {
             const errorData = await response.json().catch(() => ({}));
             if (errorData?.error?.message.includes('API key not valid') || response.status === 403) {
                 throw new Error("API_KEY_INVALID");
             }
             throw new Error(`Network response was not ok. Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙØ¹Ø±ÙØ©)
        displayReciterSearchResults(data.items);
        
    } catch (error) {
        console.error("Error searching for Reciter Channel:", error);
        let errorMsg = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        if (error.message === "API_KEY_INVALID") {
             errorMsg = "ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø«: Ù…ÙØªØ§Ø­ YouTube API ØºÙŠØ± ØµØ§Ù„Ø­.";
        }
        showMessageBox(errorMsg);
        resultsContainer.innerHTML = `<p class="text-center text-red-400">${errorMsg}</p>`;
    } finally {
        // 4. Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¨Ø­Ø« (CRITICAL FIX)
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = `<i data-lucide="search" class="w-5 h-5"></i>`;
        lucide.createIcons();
        updateNavigableElements(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ù‚Ù„ Ù„ÙŠØ´Ù…Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
    }
}

async function handleAddReciter(name, image, buttonElement) {
    if (localRecitersCache.some(r => r.name === name)) {
        showMessageBox(`Ø§Ù„Ù‚Ø§Ø±Ø¦ "${name}" Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.`);
        return;
    }

    buttonElement.disabled = true;
    buttonElement.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 text-white animate-spin"></i>`;
    lucide.createIcons();

    const newReciter = {
        name: name,
        image: image || 'https://placehold.co/100x100/334155/ffffff?text=Q',
        clicksreciter: 0
    };

    try {
        const updatedList = [...localRecitersCache, newReciter];
        const success = await updateRecitersList(updatedList);

        if (success) {
            showMessageBox(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø±Ø¦ "${name}" Ø¨Ù†Ø¬Ø§Ø­.`);
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„ØªØ¸Ù‡Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            const suggestionsContent = document.getElementById('suggestions-content');
            if(suggestionsContent) {
                 // Clear and re-populate the suggestions tabs
                suggestionsContent.innerHTML = '';
                await populateYoutubeSuggestions();
                // Switch back to Reciters tab after successful update
                document.getElementById('tab-reciters')?.click();
            }
        }
    } catch (error) {
        console.error("Error adding reciter:", error);
        showMessageBox("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø±Ø¦.");
    } finally {
        buttonElement.disabled = false;
        buttonElement.innerHTML = `<i data-lucide="plus" class="w-5 h-5"></i> Ø¥Ø¶Ø§ÙØ©`;
        lucide.createIcons();
    }
}      
       
        // --- Utility Functions ---
        function showMessageBox(message) { const box = document.createElement('div'); box.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); z-index: 1000; text-align: center; max-width: 80%; font-size: 1.1rem;`; box.innerHTML = `<p>${message}</p><button style="margin-top: 15px; padding: 8px 15px; background-color: #9333ea; border: none; border-radius: 5px; color: white; cursor: pointer;">Ø¥ØºÙ„Ø§Ù‚</button>`; document.body.appendChild(box); box.querySelector('button').addEventListener('click', () => document.body.removeChild(box)); }

        async function showAllWatchedHistory() {
            const history = getWatchedHistory();
            const videoIds = Object.keys(history)
                .sort((a, b) => (history[b].lastWatchedTimestamp || 0) - (history[a].lastWatchedTimestamp || 0));

            if (videoIds.length === 0) {
                showMessageBox('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø´Ø§Ù‡Ø¯Ø©.');
                return;
            }

            try {
                // Fetch details in chunks to avoid long URLs
                const allVideoDetails = [];
                for (let i = 0; i < videoIds.length; i += 50) {
                    const chunk = videoIds.slice(i, i + 50);
                    const details = await fetchVideosDetails(chunk);
                    if(details) {
                        allVideoDetails.push(...details);
                    }
                }
                
                if (allVideoDetails.length > 0) {
                    searchResultsContainer.innerHTML = '<h2 class="text-3xl font-bold mb-4 text-center w-full text-white col-span-full">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</h2>'; // Add a title
                    
                    // NEW: Fetch channel thumbnails for all videos
                    const channelIds = [...new Set(allVideoDetails.map(video => video.snippet.channelId))];
                    const channelThumbnails = await fetchChannelsDetails(channelIds);

                    // Sort details according to original sorted videoIds
                const sortedDetails = allVideoDetails.sort((a, b) => {
                    const aTimestamp = history[a.id]?.lastWatchedTimestamp || 0;
                    const bTimestamp = history[b.id]?.lastWatchedTimestamp || 0;
                    return bTimestamp - aTimestamp;
                });
                
                sortedDetails.forEach(video => {
                    const videoData = {
                        id: video.id,
                        title: video.snippet.title,
                        thumbnail: video.snippet.thumbnails.medium.url,
                        channelTitle: video.snippet.channelTitle,
                        channelId: video.snippet.channelId,
                        channelThumbnail: channelThumbnails[video.snippet.channelId], // Add thumbnail
                        viewCount: formatViewCount(video.statistics.viewCount),
                        publishedAt: formatTimeAgo(video.snippet.publishedAt),
                        duration: formatDuration(video.contentDetails.duration)
                    };
                    searchResultsContainer.appendChild(createVideoCard(videoData));
                });

                youtubeSuggestionsDiv.style.display = 'none';
                youtubeVideoListView.classList.add('hidden');
                    youtubeSearchResultsView.classList.remove('hidden');
                    activeMediaView = 'searchResults'; // Reuse this view
                    backToPlaylistsBottomButton.style.display = 'none';
                    backToPlaylistsBottomButtonSearch.style.display = 'flex';
                    previousItemButton.style.display = 'none'; // No next/prev for history
                    nextItemButton.style.display = 'none';

                    lucide.createIcons();
                    updateNavigableElements();
                    setTimeout(() => {
                        const firstResult = searchResultsContainer.querySelector('.grid-item');
                        if (firstResult) setFocus(firstResult);
                    }, 100);
                } else {
                     showMessageBox('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø´Ø§Ù‡Ø¯Ø©.');
                }

            } catch (error) {
                console.error("Error fetching all history details:", error);
                showMessageBox('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©.');
            }
        }
        
        // --- NEW: Watched History Helpers ---
        function getWatchedHistory() {
            return JSON.parse(localStorage.getItem('youtubeWatchedHistory')) || {};
        }

        async function updateVideoProgress(videoId, currentTime, duration) {
            if (!videoId || !duration || !isFinite(currentTime) || !isFinite(duration)) return;
        
            // 1. Update local history (localStorage)
            const history = getWatchedHistory();
            history[videoId] = { progress: currentTime, duration: duration, lastWatchedTimestamp: Date.now() };
            localStorage.setItem('youtubeWatchedHistory', JSON.stringify(history));
        
            // 2. Check and update favorites in JSONBin.io
            const favDIndex = favoritesD.findIndex(fav => fav.id === videoId);
            const favMIndex = favoritesM.findIndex(fav => fav.id === videoId);
        
            // If the video is not in any favorites list, we don't need to proceed further.
            if (favDIndex === -1 && favMIndex === -1) {
                return;
            }
        
            const updatePromises = [];
        
            if (favDIndex > -1) {
                // To ensure state changes are handled correctly, create a new array using .map
                const updatedFavoritesD = favoritesD.map((fav, index) => {
                    if (index === favDIndex) {
                        // Return a new object with the updated progress
                        return { ...fav, progress: currentTime };
                    }
                    return fav; // Return the original object if it's not the one we're updating
                });
                favoritesD = updatedFavoritesD; // Re-assign the global variable to the newly created array
                updatePromises.push(updateFavorites('D', favoritesD));
            }
        
            if (favMIndex > -1) {
                // Repeat the same immutable update pattern for the 'M' list
                const updatedFavoritesM = favoritesM.map((fav, index) => {
                    if (index === favMIndex) {
                        return { ...fav, progress: currentTime };
                    }
                    return fav;
                });
                favoritesM = updatedFavoritesM; // Re-assign the global variable
                updatePromises.push(updateFavorites('M', favoritesM));
            }
            
            if (updatePromises.length > 0) {
                try {
                    await Promise.all(updatePromises);
                } catch (error) {
                    console.error(`Failed to update favorite progress for video ${videoId}:`, error);
                }
            }
        }

        function markVideoAsWatched(videoId) {
            if (!videoId) return;
            const history = getWatchedHistory();
            // Using a special value to indicate fully watched
            history[videoId] = { progress: -1, duration: 1, lastWatchedTimestamp: Date.now() };
            localStorage.setItem('youtubeWatchedHistory', JSON.stringify(history));
            // Also update the card in the UI if it's visible
            const card = document.querySelector(`.youtube-video-card[data-video-id="${videoId}"]`);
            if(card) {
                // Remove progress bar if it exists
                const progressBar = card.querySelector('.watched-progress-bar-container');
                if(progressBar) progressBar.remove();
                // Add watched badge if it doesn't exist
                if(!card.querySelector('.watched-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'watched-badge';
                    badge.textContent = 'ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©';
                    card.querySelector('.thumbnail-container').appendChild(badge);
                }
            }
        }
        
       // -------------------------------------------------------------
// --- MODIFIED updateUI function (Applies Icon Logic) ---
// -------------------------------------------------------------
function updateUI() {
    const tempEl = document.getElementById('dashboard-weather-temp');
    const descEl = document.getElementById('dashboard-weather-desc');
    const dashboardIcon = document.getElementById('dashboard-weather-icon');
    const locationEl = document.getElementById('dashboard-weather-location');
    
    // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ (Dash Metrics)
    const dashMetricTemp = document.getElementById('dash-metric-temp');
    const dashMetricUV = document.getElementById('dash-metric-uv');
    const dashMetricHumidity = document.getElementById('dash-metric-humidity');
    
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();

    // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (App State)
    const tempValue = appState.weather.temperature;
    const uvValue = appState.weather.uvIndex;
    const humidityValue = appState.weather.humidity;


    // ğŸ›‘ PERIOD FOR MOON DISPLAY (Night Time)
    const isNightTimeOrTest = (currentHour >= 17 || currentHour < 6); 
    
    let iconSrc = appState.weather.iconUrl || 'https://placehold.co/64x64/000000/FFFFFF?text=X';
        
    // --- 1. ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (Dashboard Weather Icon) ---
    if (dashboardIcon) {
        // 1.1. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Ù‚Ù…Ø± NASA)
        if (isNightTimeOrTest && appState.dynamicMoonImageUrl) {
            iconSrc = appState.dynamicMoonImageUrl; 
        } 
        // 1.2. ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø´Ù…Ø³ÙŠØ©/Ø§Ù„ØºÙŠÙˆÙ… Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø±)
        else {
            if ((currentHour > 8 || (currentHour === 8 && currentMinute >= 30)) && (currentHour < 17)) { 
                iconSrc = 'https://cdn.weatherapi.com/weather/64x64/day/113.png'; // Sun Icon
            } else if ((currentHour >= 18 && currentHour < 19)) { 
                iconSrc = 'https://cdn.weatherapi.com/weather/64x64/day/1087.png'; // Sunset Icon
            } else if (currentHour === 6 && currentMinute > 0 && currentMinute <= 30) { 
                iconSrc = 'https://cdn.weatherapi.com/weather/64x64/day/1087.png'; // Sunrise Icon
            } else if ((currentHour === 6 && currentMinute > 30) || (currentHour === 7) || (currentHour === 8 && currentMinute <= 30) || (currentHour >= 17 && currentHour < 18)) { 
                iconSrc = 'https://cdn.weatherapi.com/weather/64x64/day/116.png'; // Cloudy/Sun Icon
            } else {
                 iconSrc = appState.weather.iconUrl || 'https://placehold.co/64x64/000000/FFFFFF?text=X';
            }
        }
        dashboardIcon.src = iconSrc;
    }

    // --- 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„Ù†ØµÙˆØµ ---
    
    // ØªØ­Ø¯ÙŠØ« Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ toFixed Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
    if (tempEl) {
        const tempDisplay = tempValue !== null && !isNaN(tempValue) ? tempValue.toFixed(1) : '--';
        tempEl.textContent = `${tempDisplay}Â°C`;
    }
    
    // ÙˆØµÙ Ø§Ù„Ø·Ù‚Ø³ / Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ù…Ø±
    if (descEl) {
        if (isNightTimeOrTest && appState.moonData && appState.moonData.phase !== undefined) {
            const phase = appState.moonData.phase.toFixed(1);
            descEl.textContent = `Ø§Ù„Ù‚Ù…Ø±: ${phase}% Ù…Ø¶Ø§Ø¡`;
        } else {
            descEl.textContent = appState.weather.description || '--';
        }
    }
    
    if (locationEl) {
        locationEl.textContent = appState.weather.location;
    }

    // --- 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ---

    // Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Metric 1)
    if (dashMetricTemp && tempValue !== null && !isNaN(tempValue)) {
        dashMetricTemp.textContent = `${Math.round(tempValue)}Â°C`;
        dashMetricTemp.className = `font-bold text-lg ${getTempTextColor(tempValue)}`;
    } else if (dashMetricTemp) { dashMetricTemp.textContent = '--Â°C'; dashMetricTemp.className = 'font-bold text-lg text-white/70'; }

    // Ù…Ø¤Ø´Ø± UV (Metric 2)
    if (dashMetricUV && uvValue !== null && !isNaN(uvValue)) {
        dashMetricUV.textContent = `${Math.round(uvValue)}`;
        dashMetricUV.className = `font-bold text-lg ${getUvTextColor(uvValue)}`;
    } else if (dashMetricUV) { dashMetricUV.textContent = '--'; dashMetricUV.className = 'font-bold text-lg text-white/70'; }

    // Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (Metric 3)
    if (dashMetricHumidity && humidityValue !== null && !isNaN(humidityValue)) { 
        dashMetricHumidity.textContent = `${Math.round(humidityValue)}%`;
        dashMetricHumidity.className = `font-bold text-lg ${getHumidityTextColor(humidityValue)}`;
    } else if (dashMetricHumidity) { 
        dashMetricHumidity.textContent = '--%'; 
        dashMetricHumidity.className = 'font-bold text-lg text-white/70'; 
    }

    // 360 Image Update
    const car360Image = document.getElementById('car-360-image');
    if (car360Image) { 
        car360Image.src = appState.custom360Image || default360ImageSrc;
    }

    if (currentAppIndex === appOrder.indexOf('DashboardCarPlay')) {
        updateCarPlayDashboard();
    }

}

function updateCarPlayDashboard() {
    // 1. Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ø§Ù„Ø¢Ù…Ù† Ù„Ù„Ù…Ø´ØºÙ„
    const player = window.popupPlayer || window.player;
    
    // 2. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ø·Ù‚Ø³) - ØªØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…ØªÙˆÙ‚Ù
    try {
        const prayerName = document.getElementById('carplay-next-prayer-name');
        const prayerTime = document.getElementById('carplay-next-prayer-time');
        const weatherTemp = document.getElementById('carplay-weather-temp');

        if (prayerName) prayerName.textContent = appState.prayerTimes.nextPrayer || '--';
        if (prayerTime && appState.prayerTimes.nextPrayerIqamaTime) {
            prayerTime.textContent = appState.prayerTimes.nextPrayerIqamaTime.toLocaleTimeString('ar-SA', { hour: 'numeric', minute: '2-digit', hour12: true });
        }
        if (weatherTemp) weatherTemp.textContent = appState.weather.temperature !== null ? `${Math.round(appState.weather.temperature)}Â°` : '--Â°';
    } catch (e) { console.warn("CarPlay Prayer/Weather Sync Error"); }

    // 3. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙÙŠØ¯ÙŠÙˆ Ù…Ø­Ù…Ù„)
    if (player && typeof player.getVideoData === 'function') {
        try {
            const videoData = player.getVideoData();
            const playerState = player.getPlayerState();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ID Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©
            if (videoData && videoData.video_id) {
                const titleEl = document.getElementById('carplay-media-title');
                const channelEl = document.getElementById('carplay-media-channel');
                const thumbEl = document.getElementById('carplay-media-thumb');
                const thumbEl1 = document.getElementById('dash-media-thumb');
                const playBtn = document.getElementById('carplay-capsule-play-pause');

                if (titleEl) titleEl.textContent = videoData.title;
                if (channelEl) channelEl.textContent = videoData.author;
                if (thumbEl) {
                    const thumbUrl = `https://i.ytimg.com/vi/${videoData.video_id}/mqdefault.jpg`;
                    if (thumbEl.src !== thumbUrl) thumbEl.src = thumbUrl;
                }
                if (thumbEl1) {
                    const thumbUrl = `https://i.ytimg.com/vi/${videoData.video_id}/mqdefault.jpg`;
                    if (thumbEl1.src !== thumbUrl) thumbEl1.src = thumbUrl;
                }

                // Ù…Ø²Ø§Ù…Ù†Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Play/Pause)
                if (playBtn) {
                    const isPlaying = (playerState === 1); // 1 = PLAYING
                    playBtn.innerHTML = isPlaying ? '<i data-lucide="pause"></i>' : '<i data-lucide="play"></i>';
                    if (window.lucide) lucide.createIcons();
                }
            }
        } catch (mediaError) { console.warn("CarPlay Media Sync Pending..."); }
    }
}

function forceUpdateCarPlayMedia(activePlayer) {
    if (!activePlayer || typeof activePlayer.getVideoData !== 'function') return;

    const vData = activePlayer.getVideoData();
    const videoId = vData.video_id;

    console.log("ğŸ¬ CarPlay Syncing:", vData.title);

    // Ø§Ø³ØªÙ‡Ø¯Ø§Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ù‚ÙˆØ©
    const titleEl = document.getElementById('carplay-media-title');
    const channelEl = document.getElementById('carplay-media-channel');
    const thumbEl = document.getElementById('carplay-media-thumb');
    const thumbEl1 = document.getElementById('dash-media-thumb');

    if (titleEl) titleEl.textContent = vData.title;
    if (channelEl) channelEl.textContent = vData.author;
    if (thumbEl && videoId) {
        // Ù†Ø³ØªØ®Ø¯Ù… hqdefault Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ³Ø±Ø¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        thumbEl.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    }
if (thumbEl1 && videoId) {
        // Ù†Ø³ØªØ®Ø¯Ù… hqdefault Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ³Ø±Ø¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        thumbEl1.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    }
    // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©
    const playBtn = document.getElementById('carplay-capsule-play-pause');
    if (playBtn) {
        playBtn.innerHTML = '<i data-lucide="pause"></i>';
        if (window.lucide) lucide.createIcons();
    }
}
// --- 2. Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (The Engine) ---
// Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØ¶Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø­Ø§Ù„ØªÙŠÙ†: Ø¯ÙˆØ±ÙŠØ§Ù‹ ÙˆØ¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function initCarPlaySync() {
    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø·Ù‚Ø³ ÙˆØ§Ù„ØµÙ„Ø§Ø©)
    setInterval(updateCarPlayDashboard, 1000);

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙØ¹Ù„ÙŠØ§Ù‹ Ø¨Ø§Ù„Ù…Ø´ØºÙ„
    const controls = {
        'carplay-capsule-play-pause': () => {
            const state = popupPlayer.getPlayerState();
            state === 1 ? popupPlayer.pauseVideo() : popupPlayer.playVideo();
            setTimeout(updateCarPlayDashboard, 100);
        },
        'carplay-capsule-next': () => popupPlayer.nextVideo(),
        'carplay-capsule-prev': () => popupPlayer.previousVideo()
    };

    Object.entries(controls).forEach(([id, action]) => {
        const el = document.getElementById(id);
        if (el) el.onclick = (e) => { e.stopPropagation(); action(); };
    });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
initCarPlaySync();

        // --- App Switching and Navigation Logic ---
const appOrder = ['Dashboard', 'Media', 'DashboardCarPlay', 'Radio', 'Athkar', 'Reciters', 'Weather', 'Map', 'Quran'];
        let currentAppIndex = 0;

       function switchApp(appName) {
    // 1. Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø°Ø§Øª Ø§Ù„ØªØ±Ø¯Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ (Clean Slate)
    // Ù†ÙˆÙ‚Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø§Ù„ØªÙŠ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø´Ø±Ø·ÙŠ Ø£ÙˆÙ„Ø§Ù‹
    stopClockAndTimer();
    stopCarSimulation();
    stopWeatherUpdates(); 
    // ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: start/stopNextPrayerDetermination Ùˆ startFullDateUpdates ØªØ¹Ù…Ù„Ø§Ù† Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… (Ø¨Ø·ÙŠØ¡).

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    const newIndex = appOrder.indexOf(appName);
    if (newIndex === -1) return;
    currentAppIndex = newIndex;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
    appScreens.forEach(s => s.classList.remove('active'));
    sidebarIcons.forEach(i => i.classList.remove('active'));
    const screen = document.getElementById(`screen-${appName}`);
    if (screen) screen.classList.add('active');
    const icon = document.querySelector(`.app-icon[data-app="${appName}"]`);
    if (icon) icon.classList.add('active');

const floatingVideo = document.getElementById('floating-minimized-video-button');
const minimizeBtn = document.getElementById('video-popup-minimize-button');
const restoreBtn = document.querySelector('.minimized-restore-btn');

if (appName === 'DashboardCarPlay') {
    // 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ØµØºØ± (Capsule)
    const popupContainer = document.getElementById('video-popup-container');
    const isPopupActive = popupContainer && popupContainer.classList.contains('active');
    const minimizeBtn = document.getElementById('video-popup-minimize-button');

    if (isPopupActive && minimizeBtn) {
        minimizeBtn.click(); 
    }
setTimeout(() => {
        // ğŸš€ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø­Ù‚Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø´Ø§Ø´Ø©
        if (window.popupPlayer) forceUpdateCarPlayMedia(window.popupPlayer);
        updateCarPlayDashboard();
    }, 200);
    // 2. ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ­Ø¯ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø®Ø±ÙŠØ·Ø© (Unified UI & Map Refresh)
    // Ù†Ø³ØªØ®Ø¯Ù… ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· (150ms) Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù‚Ø§Ù… Ø¨Ø±Ø³Ù… Ø­Ø§ÙˆÙŠØ© CarPlay Ø£ÙˆÙ„Ø§Ù‹
    setTimeout(() => {
        // Ø£. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ (ÙŠÙˆØªÙŠÙˆØ¨ØŒ ØµÙ„Ø§Ø©ØŒ Ø·Ù‚Ø³)
        if (typeof updateCarPlayDashboard === 'function') {
            updateCarPlayDashboard();
        }


        // Ø¨. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
        if (carplayGoogleMap) {
            // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡)
            google.maps.event.trigger(carplayGoogleMap, 'resize');
            
            if (appState.currentLocation) {
                // Ø¶Ø¨Ø· Ø§Ù„Ù…Ø±ÙƒØ² ÙˆØ§Ù„Ø²ÙˆÙˆÙ… ÙˆØ§Ù„Ù…ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
                carplayGoogleMap.setCenter(appState.currentLocation);
                carplayGoogleMap.setZoom(18); 
                carplayGoogleMap.setTilt(45);
                
                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
                if (typeof directionToDegrees === 'function') {
                    const currentHeading = directionToDegrees(appState.car.direction);
                    carplayGoogleMap.setHeading(currentHeading);
                }
            }
        }

        // Ø¬. ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
        const locationText = document.getElementById('carplay-location-text');
        if (locationText) {
            locationText.textContent = appState.weather.location || "Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ";
        }
        
        console.log("âœ… CarPlay View Sync Complete.");
    }, 150);

} else {
    // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† CarPlay: Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø´ØºÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„
    const restoreBtn = document.getElementById('floating-minimized-video-button');
    // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø²Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ø±Ø¦ÙŠ (Ø£ÙŠ Ø£Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…ØµØºØ±)
    const isMinimized = restoreBtn && restoreBtn.style.display !== 'none';

    if (isMinimized && typeof restoreVideoPopup === 'function') {
        restoreVideoPopup();
    }
}
    
    // A. Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Dashboard
    if (appName === 'Dashboard') {
        startClockAndTimer(); // 1s/2s (Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ)
        startWeatherUpdates(); // Ø§Ù„Ø·Ù‚Ø³ (Ø¬Ù„Ø¨ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚)
        
        // ğŸš€ FIX: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¯ÙˆÙŠØ± ÙˆØ§Ù„Ù…Ø±ÙƒØ² ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø´Ø§Ø´Ø©
        // Ù†Ø³ØªØ®Ø¯Ù… setTimeout(0) Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù€ DOM Ø£ØµØ¨Ø­ Ù…Ø±Ø¦ÙŠØ§Ù‹ Ù‚Ø¨Ù„ ØªØ·Ø¨ÙŠÙ‚ setHeading
        setTimeout(() => {
            if (dashboardGoogleMap) {
                const numericHeading = directionToDegrees(appState.car.direction);
                dashboardGoogleMap.setHeading(numericHeading);
                
                // ğŸ’¡ Ù†Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                if (appState.currentLocation) {
                     dashboardGoogleMap.setCenter(appState.currentLocation);
                }
            }
            
        }, 0); 
    }
    
    // B. Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø´Ø§Ø´Ø© 3D (Map)
    if (appName === 'Map') {
        startCarSimulation(); // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (2 Ø«Ø§Ù†ÙŠØ©)
        startWeatherUpdates(); // Ø§Ù„Ø·Ù‚Ø³ (Ø¬Ù„Ø¨ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚)
    } 
    
    // C. Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø´Ø§Ø´Ø© Weather
    if (appName === 'Weather') {
        startWeatherUpdates();
    }
    
    // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ switchApp)
    
    // 4. Ù†Ù‚Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    const activeScreen = document.getElementById(`screen-${appName}`);
    if (activeScreen) {
        setTimeout(() => {
            const firstItem = activeScreen.querySelector('.grid-item');
            if (firstItem) setFocus(firstItem);
        }, 150);
    }

}

        function navigateToNextApp() {
            currentAppIndex = (currentAppIndex + 1) % appOrder.length;
            switchApp(appOrder[currentAppIndex]);
        }

        function navigateToPrevApp() {
            currentAppIndex = (currentAppIndex - 1 + appOrder.length) % appOrder.length;
            switchApp(appOrder[currentAppIndex]);
        }

        function handleMediaViewSwitch(appName) {
            floatingMediaButton.style.display = (appName === 'Media') ? 'none' : 'flex';
            floatingKeyboardButton.style.display = (appName === 'Media') ? 'flex' : 'none';
            clearSearchButton.style.display = (appName === 'Media') ? 'flex' : 'none';
             
             if (appName === 'Media') {
        // ğŸš€ FIX: ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (Active/Inactive)
        if (floatingKeyboardButton) {
            floatingKeyboardButton.style.display = 'flex'; // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø±
            floatingKeyboardButton.classList.toggle('active-keyboard', !youtubeSearchInput.readOnly);
            floatingKeyboardButton.classList.toggle('inactive-keyboard', youtubeSearchInput.readOnly);
        }
        
        // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
        if (clearSearchButton) {
            clearSearchButton.style.display = 'flex';
        }
        
        // ğŸ’¡ Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        if (floatingMediaButton) {
            floatingMediaButton.style.display = 'none';
        }
        

        // --- Logic to show the correct view ---
        youtubeVideoListView.classList.add('hidden');
        youtubeSearchResultsView.classList.add('hidden');
        youtubeSuggestionsDiv.style.display = 'flex'; // Make suggestions visible

        if (activeMediaView === 'videoList' && currentPlayingPlaylistId) {
            youtubeVideoListView.classList.remove('hidden');
        } else if (activeMediaView === 'searchResults') {
            youtubeSearchResultsView.classList.remove('hidden');
        } else {
            // Default to suggestions view
            resetYoutubeSearchUI();
        }
    } else {
        // ğŸ›‘ 2. Ù…Ù†Ø·Ù‚ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        if (floatingKeyboardButton) {
            floatingKeyboardButton.style.display = 'none';
        }
        if (clearSearchButton) {
            clearSearchButton.style.display = 'none';
        }
        if (floatingMediaButton) {
            floatingMediaButton.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ø¹Ø§Ø¦Ù…
        }
        youtubeSuggestionsDiv.style.display = 'none';
    }
        }
        appButtons.forEach(b => b.addEventListener('click', () => switchApp(b.dataset.app)));
        sidebarIcons.forEach(el => el.classList.add('w-16', 'h-16', 'rounded-2xl', 'flex', 'items-center', 'justify-center', 'transition-all', 'duration-300', 'ease-in-out'));
        
        // --- YouTube/Media Functions (REFACTORED) ---
        function onYouTubeIframeAPIReady() { isYouTubeApiReady = true; }
        
        /**
 * Creates an HTML element (Card) for displaying a YouTube video search result 
 * or a video in a playlist.
 *
 * @param {object} video - Object containing video details (title, thumbnail, duration, etc.).
 * @returns {HTMLElement} The complete video card DIV element.
 */
function createVideoCard(video) {
    const card = document.createElement('div');
    card.className = 'glass-surface glass-surface--svg youtube-video-card navigable grid-item';
    card.tabIndex = 0;
    card.dataset.videoId = video.id;

    // Get watched history for this video (assumes getWatchedHistory is defined globally)
    const history = getWatchedHistory();
    const watchedInfo = history[video.id];
    let progressHTML = '';

    if (watchedInfo) {
        if (watchedInfo.progress === -1) { // Fully watched
            progressHTML = `<div class="watched-badge">ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</div>`;
        } else if (watchedInfo.progress > 0 && watchedInfo.duration > 0) {
            const progressPercent = (watchedInfo.progress / watchedInfo.duration) * 100;
            progressHTML = `<div class="watched-progress-bar-container"><div class="watched-progress-bar" style="width: ${progressPercent}%"></div></div>`;
        }
    }
    
    // Determine bookmark state
    const isSavedD = favoritesD.some(fav => fav.id === video.id);
    const isSavedM = favoritesM.some(fav => fav.id === video.id);
    let bookmarkClass = '';
    if (isSavedD && isSavedM) bookmarkClass = 'saved-both';
    else if (isSavedD) bookmarkClass = 'saved-d';
    else if (isSavedM) bookmarkClass = 'saved-m';

    const isLive = video.duration === 'Ù…Ø¨Ø§Ø´Ø±'; // Used for live video styling

    card.innerHTML = `
        <div class="video-details">
            <h3 class="video-title">${video.title}</h3>
            <div class="video-meta">
                <div class="flex items-center justify-between w-full gap-2">
                    <div class="flex items-center gap-2 cursor-pointer channel-link min-w-0" data-channel-id="${video.channelId}" data-channel-title="${video.channelTitle}">
                       <img src="${video.channelThumbnail || 'https://placehold.co/24x24/334155/ffffff?text=?'}" alt="${video.channelTitle}" class="w-6 h-6 rounded-full object-cover flex-shrink-0">
                       <span class="hover:underline truncate">${video.channelTitle}</span>
                    </div>
                    <button class="add-channel-from-search-btn p-1 rounded-full hover:bg-white/20 transition-colors flex-shrink-0 navigable grid-item" data-channel-id="${video.channelId}" data-channel-title="${video.channelTitle}" data-channel-thumbnail="${video.channelThumbnail || ''}" title="Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©" tabindex="0">
                        <i data-lucide="plus-circle" class="w-5 h-5 text-green-400"></i>
                    </button>
                </div>
                <span class="text-xs text-white/60">${video.viewCount} Ù…Ø´Ø§Ù‡Ø¯Ø© â€¢ ${video.publishedAt}</span>
            </div>
        </div>
        <div class="thumbnail-container relative">
            <img src="${video.thumbnail}" alt="${video.title}" class="w-[180px] h-[101.25px] object-cover rounded-md ml-4 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/180x101';">
            <span class="video-duration ${isLive ? 'bg-red-600 font-bold' : ''}">${video.duration}</span>
            ${progressHTML}
            <button class="bookmark-button ${bookmarkClass}" data-video-id="${video.id}"><i data-lucide="bookmark" class="w-5 h-5"></i></button>
        </div>
    `;
    
    // --- Event Listeners ---

    // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    card.addEventListener('click', () => showVideoPopup(video.id));
    
    // 2. ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­ÙØ¸
    card.querySelector('.bookmark-button').addEventListener('click', (e) => {
        e.stopPropagation(); 
        showFavoritesMenu(e.currentTarget, video);
    });

    // 3. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø©
    const channelLink = card.querySelector('.channel-link');
    if (channelLink) {
        channelLink.addEventListener('click', (e) => {
            e.stopPropagation();
            const channelId = e.currentTarget.dataset.channelId;
            const channelTitle = e.currentTarget.dataset.channelTitle;
            if(channelId && channelTitle) {
                searchVideosByChannel(channelId, channelTitle);
            }
        });
    }

    // 4. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø© Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
    const addChannelBtn = card.querySelector('.add-channel-from-search-btn');
    if (addChannelBtn) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ù†Ø§Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (localChannelsCache.some(c => c.channelid === video.channelId)) {
            addChannelBtn.disabled = true;
            addChannelBtn.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>`;
        } else {
            addChannelBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const btn = e.currentTarget;
                const channelId = btn.dataset.channelId;
                const channelTitle = btn.dataset.channelTitle;
                const channelThumbnail = btn.dataset.channelThumbnail;
                addChannelFromSearchResult(channelId, channelTitle, channelThumbnail, btn);
            });
        }
    }

    // 5. ØªÙ‡ÙŠØ¦Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Lucide
    if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
        lucide.createIcons();
    }
    
    return card;
}

        async function fetchVideosDetails(videoIds) {
            if (!videoIds || videoIds.length === 0) return [];
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&id=${videoIds.join(',')}&key=${YOUTUBE_API_KEY}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error("YouTube API error (videos):", errorData?.error?.message || response.status);
                    return null; // Indicate failure
                }
                const data = await response.json();
                return data.items;
            } catch (error) {
                console.error("Network error in fetchVideosDetails:", error);
                return null; // Indicate failure
            }
        }

        async function fetchChannelsDetails(channelIds) {
            if (!channelIds || channelIds.length === 0) return {};
            const uniqueIds = [...new Set(channelIds)];
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${uniqueIds.join(',')}&key=${YOUTUBE_API_KEY}`);
                if (!response.ok) {
                    console.error("YouTube API error (channels):", response.status);
                    return {};
                }
                const data = await response.json();
                const channelMap = {};
                if (data.items) {
                    data.items.forEach(channel => {
                        channelMap[channel.id] = channel.snippet.thumbnails.default.url;
                    });
                }
                return channelMap;
            } catch (error) {
                console.error("Network error in fetchChannelsDetails:", error);
                return {};
            }
        }

    function formatDuration(duration) {
    if (!duration) return "00:00";
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Regex
    const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    
    // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù€ Match (ÙƒÙ…Ø§ ÙÙŠ Ø­Ø§Ù„ØªÙƒ)ØŒ Ù†Ø¹ÙŠØ¯ Ù†ØµØ§Ù‹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù†Ù‡ÙŠØ§Ø± Ø§Ù„ÙƒÙˆØ¯
    if (!match) {
        return duration.includes('P') ? "Live" : "00:00";
    }

    const hours = (parseInt(match[1]) || 0);
    const minutes = (parseInt(match[2]) || 0);
    const seconds = (parseInt(match[3]) || 0);

    const parts = [];
    if (hours > 0) parts.push(hours.toString().padStart(2, '0'));
    parts.push(minutes.toString().padStart(2, '0'));
    parts.push(seconds.toString().padStart(2, '0'));

    return parts.join(':');
}

        function formatViewCount(views) {
            if (views >= 1000000) return `${(views / 1000000).toFixed(1)} Ù…Ù„ÙŠÙˆÙ†`;
            if (views >= 1000) return `${(views / 1000).toFixed(0)} Ø£Ù„Ù`;
            return views;
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return `Ù‚Ø¨Ù„ ${Math.floor(interval)} Ø³Ù†ÙˆØ§Øª`;
            interval = seconds / 2592000;
            if (interval > 1) return `Ù‚Ø¨Ù„ ${Math.floor(interval)} Ø£Ø´Ù‡Ø±`;
            interval = seconds / 86400;
            if (interval > 1) return `Ù‚Ø¨Ù„ ${Math.floor(interval)} Ø£ÙŠØ§Ù…`;
            interval = seconds / 3600;
            if (interval > 1) return `Ù‚Ø¨Ù„ ${Math.floor(interval)} Ø³Ø§Ø¹Ø§Øª`;
            interval = seconds / 60;
            if (interval > 1) return `Ù‚Ø¨Ù„ ${Math.floor(interval)} Ø¯Ù‚Ø§Ø¦Ù‚`;
            return `Ù‚Ø¨Ù„ ${Math.floor(seconds)} Ø«ÙˆØ§Ù†`;
        }
        
        // --- START: NEW Channel List Functions (JSONBin.io) ---
        async function fetchChannelsList() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID_CHANNELS}/latest`, {
                    headers: { 'X-Access-Key': JSONBIN_ACCESS_KEY_CHANNELS }
                });
                if (res.status === 404) return []; // Bin is new/empty
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                const data = await res.json();
                localChannelsCache = Array.isArray(data.record) ? data.record : [];
                return localChannelsCache;
            } catch (error) {
                console.error(`Error fetching channels list:`, error);
                return []; // Return empty on error
            }
        }

        async function updateChannelsList(newChannelsList) {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID_CHANNELS}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(newChannelsList)
                });
                if (!res.ok) throw new Error(`Failed to update channels list: ${res.status}`);
                localChannelsCache = newChannelsList; // Update local cache
                return true;
            } catch (error) {
                console.error(`Error updating channels list:`, error);
                showMessageBox(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª`);
                return false;
            }
        }

        // --- ADD THIS NEW FUNCTION ---
Â  Â  function incrementChannelClick(channelId) {
Â  Â  Â  Â  Â  Â  if (!channelId || !localChannelsCache) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let channelFound = false;
Â  Â  Â  Â  Â  Â  const updatedList = localChannelsCache.map(channel => {
Â  Â  Â  Â  Â  Â  Â  Â  if (channel && channel.channelid === channelId) { // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† 'channel' Ù…ÙˆØ¬ÙˆØ¯
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  channelFound = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentClicks = parseInt(channel.clickschannel, 10) || 0; // ØªØ­ÙˆÙŠÙ„ Ø¢Ù…Ù† Ø¥Ù„Ù‰ Ø±Ù‚Ù…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...channel, clickschannel: currentClicks + 1 };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return channel;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (channelFound) {
Â  Â  Â  Â  Â  Â  Â  Â  localChannelsCache = updatedList; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙÙˆØ±Ù‹Ø§
Â  Â  Â  Â  Â  Â  Â  Â  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
Â  Â  Â  Â  Â  Â  Â  Â  updateChannelsList(updatedList).catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to update channel clicks in background:", err);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 2. Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
Â  Â  Â  Â  // (Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØµÙ„Ø­ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙŠ JSONBin Ø¨Ø¥Ø¶Ø§ÙØ© clickschannel: 0)
Â  Â  Â  Â  async function migrateChannelData() {
Â  Â  Â  Â  Â  Â  if (localStorage.getItem('channelMigrationDone')) {
Â  Â  Â  Â  Â  Â  Â  Â  return; // ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ù…Ù† Ù‚Ø¨Ù„
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  console.log("Running channel data migration (one time only)...");
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let currentList = await fetchChannelsList(); // Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
Â  Â  Â  Â  Â  Â  Â  Â  let needsUpdate = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const updatedList = currentList.map(channel => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (channel && typeof channel === 'object' && channel.channelid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø§ØµÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof channel.clickschannel === 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  needsUpdate = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...channel, clickschannel: 0 }; // Ø£Ø¶ÙÙ‡Ø§ Ø¨Ù‚ÙŠÙ…Ø© 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return channel;
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (needsUpdate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Updating channels in JSONBin with default clickschannel: 0...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateChannelsList(updatedList);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localChannelsCache = updatedList; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Migration complete.");
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("No channel data migration needed.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('channelMigrationDone', 'true'); // ØªØ³Ø¬ÙŠÙ„ Ø£Ù†Ù‡ ØªÙ…
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error during channel data migration:", error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        function showAddChannelPrompt() {
            const existingPrompt = document.getElementById('add-channel-prompt');
            if (existingPrompt) existingPrompt.remove();

            const promptHTML = `
                <div id="add-channel-prompt" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[9999]">
                    <div id="add-channel-prompt-content" class="glass-surface glass-surface--svg p-6 rounded-2xl w-full max-w-lg flex flex-col gap-4 transition-all duration-300">
                        <h3 class="text-xl font-bold text-center">Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© ÙŠÙˆØªÙŠÙˆØ¨ Ø¬Ø¯ÙŠØ¯Ø©</h3>
                        <p class="text-sm text-white/70 text-center">Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…ØªÙƒ.</p>
                        <div class="flex gap-2">
                            <input type="text" id="new-channel-search-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©..." class="flex-grow p-3 rounded-full bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 navigable grid-item" tabindex="0" />
                            <button id="search-channel-confirm" class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-3 rounded-full navigable grid-item" tabindex="0">
                                <i data-lucide="search" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="channel-search-results" class="mt-4 max-h-[50vh] overflow-y-auto flex flex-col gap-3">
                            <!-- Search results will appear here -->
                        </div>
                         <button id="add-channel-cancel" class="mt-2 bg-red-600/80 hover:bg-red-700/80 text-white font-bold py-2 px-4 rounded-full navigable grid-item self-center" tabindex="0">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', promptHTML);
            lucide.createIcons();

            const promptEl = document.getElementById('add-channel-prompt');
            const inputEl = document.getElementById('new-channel-search-input');
            const confirmBtn = document.getElementById('search-channel-confirm');
            const cancelBtn = document.getElementById('add-channel-cancel');

            const closePrompt = () => promptEl.remove();

            confirmBtn.addEventListener('click', handleSearchForChannel);
            cancelBtn.addEventListener('click', closePrompt);
            inputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSearchForChannel();
                }
            });
            
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    closePrompt();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);

            inputEl.focus();
            setFocus(inputEl);
        }

        async function handleSearchForChannel() {
            const inputEl = document.getElementById('new-channel-search-input');
            const resultsContainer = document.getElementById('channel-search-results');
            const confirmBtn = document.getElementById('search-channel-confirm');
            const query = inputEl.value.trim();

            if (!query) {
                showMessageBox("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù‚Ù†Ø§Ø© Ù„Ù„Ø¨Ø­Ø«.");
                return;
            }

            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>`;
            lucide.createIcons();
            resultsContainer.innerHTML = '<p class="text-center text-white/70">...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«</p>';

            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=channel&key=${YOUTUBE_API_KEY}&maxResults=10`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                displayChannelSearchResults(data.items);
            } catch (error) {
                console.error("Error searching for channel:", error);
                resultsContainer.innerHTML = '<p class="text-center text-red-400">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>';
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = `<i data-lucide="search" class="w-5 h-5"></i>`;
                lucide.createIcons();
            }
        }

        function displayChannelSearchResults(channels) {
            const resultsContainer = document.getElementById('channel-search-results');
            resultsContainer.innerHTML = '';

            if (!channels || channels.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-white/70">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….</p>';
                return;
            }

            channels.forEach(channel => {
                const isSaved = localChannelsCache.some(c => c.channelid === channel.id.channelId);
                const resultCard = document.createElement('div');
                resultCard.className = 'flex items-center gap-4 p-3 rounded-xl bg-white/5';
                resultCard.innerHTML = `
                    <img src="${channel.snippet.thumbnails.default.url}" alt="${channel.snippet.title}" class="w-16 h-16 rounded-full object-cover">
                    <div class="flex-grow min-w-0">
                        <h4 class="font-bold truncate">${channel.snippet.title}</h4>
                        <p class="text-sm text-white/60 truncate">${channel.snippet.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                    </div>
                    <button 
                        class="add-channel-from-modal-btn p-2 rounded-full transition-colors flex-shrink-0 navigable grid-item ${isSaved ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-700'}" 
                        data-channel-id="${channel.id.channelId}" 
                        data-channel-title="${channel.snippet.title}" 
                        data-channel-thumbnail="${channel.snippet.thumbnails.default.url}"
                        ${isSaved ? 'disabled' : ''}
                        tabindex="0"
                    >
                        <i data-lucide="${isSaved ? 'check' : 'plus'}" class="w-5 h-5 text-white"></i>
                    </button>
                `;
                resultsContainer.appendChild(resultCard);

                if (!isSaved) {
                    resultCard.querySelector('.add-channel-from-modal-btn').addEventListener('click', (e) => {
                        const btn = e.currentTarget;
                        const channelId = btn.dataset.channelId;
                        const channelTitle = btn.dataset.channelTitle;
                        const channelThumbnail = btn.dataset.channelThumbnail;
                        handleAddChannelFromModal(channelId, channelTitle, channelThumbnail);
                    });
                }
            });
            lucide.createIcons();
            updateNavigableElements();
        }

/**
 * NEW: Displays a modal prompt to input a YouTube video URL/ID for adding to favorites.
 */
function promptAddVideoByUrl() {
    const existingPrompt = document.getElementById('add-video-prompt');
    if (existingPrompt) existingPrompt.remove();

    const promptHTML = `
        <div id="add-video-prompt" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[9999]">
            <div id="add-video-prompt-content" class="glass-surface glass-surface--svg p-6 rounded-2xl w-full max-w-md flex flex-col gap-4">
                <h3 class="text-xl font-bold text-center">Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·</h3>
                <p class="text-sm text-white/70 text-center">Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ Ù…ÙØ¹Ø±Ù‘Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (ID) Ø£Ø¯Ù†Ø§Ù‡.</p>
                <div class="flex gap-2 grid-container">
                    <input type="text" id="new-video-url-input" placeholder="Ù…Ø«Ø§Ù„: https://youtu.be/dQw4w9WgXcQ" class="flex-grow p-3 rounded-full bg-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 navigable grid-item" tabindex="0" />
                </div>
                
                <div id="url-action-buttons" class="flex justify-between mt-2 gap-3">
                    <button id="add-video-cancel" class="bg-gray-600/80 hover:bg-gray-700/80 text-white font-bold py-2 px-4 rounded-full navigable grid-item flex-1" tabindex="0">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="add-video-confirm" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full navigable grid-item flex-1" tabindex="0">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', promptHTML);
    lucide.createIcons();

    const promptEl = document.getElementById('add-video-prompt');
    const urlInput = document.getElementById('new-video-url-input');
    const confirmBtn = document.getElementById('add-video-confirm');
    const cancelBtn = document.getElementById('add-video-cancel');

    const closePrompt = () => {
        promptEl.remove();
        updateNavigableElements(); 
    };

    // ğŸ›‘ Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    confirmBtn.addEventListener('click', () => addVideoFromUrl(urlInput.value));
    
    // Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø« Ø¨Ø²Ø± Enter
    urlInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addVideoFromUrl(urlInput.value); 
        }
    });

    cancelBtn.addEventListener('click', closePrompt);
    urlInput.focus();
    setFocus(urlInput);
    updateNavigableElements();
}

/**
 * NEW: Extracts video ID from URL and adds the video to the Car Favorites List (D).
 * * @param {string} url - The URL or video ID provided by the user.
 */
async function addVideoFromUrl(url) {
    // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù€ ID Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const videoIdMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/|youtube\.com\/(?:shorts\/))([\w-]{11})/);
    const videoId = videoIdMatch ? videoIdMatch[1] : url.trim();

    if (videoId.length !== 11) {
        showMessageBox("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ ØµØ­ÙŠØ­ Ø£Ùˆ Ù…ÙØ¹Ø±Ù‘Ù ÙÙŠØ¯ÙŠÙˆ (ID).");
        return;
    }
    
    const confirmBtn = document.getElementById('add-video-confirm');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>`;
    lucide.createIcons();

    try {
        // 2. Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ ID
        const videoDetailsList = await fetchVideosDetails([videoId]);

        if (!videoDetailsList || videoDetailsList.length === 0) {
            showMessageBox("ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­ ÙˆØ¹Ø§Ù….");
            return;
        }

        const video = videoDetailsList[0];
        
        // 3. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙØ¸
        const videoToSave = {
            id: video.id,
            title: video.snippet.title,
            thumbnail: video.snippet.thumbnails.medium.url,
            channelTitle: video.snippet.channelTitle,
            channelId: video.snippet.channelId,
            duration: formatDuration(video.contentDetails.duration),
            progress: 0 // ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±
        };

        // 4. Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© (D)
        const favoritesList = favoritesD;
        if (favoritesList.some(fav => fav.id === video.id)) {
            showMessageBox("Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.");
            return;
        }

        const updatedList = [videoToSave, ...favoritesList];
        const success = await updateFavorites('D', updatedList);

        if (success) {
            favoritesD = updatedList; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
            showMessageBox(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ "${video.snippet.title}" Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.`);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ø§Ø´Ø© Ù…ÙØªÙˆØ­Ø©
            const activeTab = document.querySelector('#screen-Media .tab-button.active')?.id;
            if (activeTab === 'tab-saved-d') { loadSavedVideos('D'); }
        }
        
    } catch (error) {
        console.error("Error adding video by URL:", error);
        showMessageBox("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙØªØ§Ø­ API.");
    } finally {
        document.getElementById('add-video-prompt').remove();
        updateNavigableElements();
    }
}

// --- REPLACE THIS FUNCTION ---
Â  Â  Â  Â  async function handleAddChannelFromModal(channelId, channelTitle, channelThumbnail) {
Â  Â  Â  Â  Â  Â  const modalButton = document.querySelector(`.add-channel-from-modal-btn[data-channel-id="${channelId}"]`);
Â  Â  Â  Â  Â  Â  if (modalButton) {
Â  Â  Â  Â  Â  Â  Â  Â  modalButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  modalButton.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 text-yellow-400 animate-spin"></i>`;
Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (localChannelsCache.some(c => c.channelid === channelId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox("Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙƒ.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (modalButton) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalButton.innerHTML = `<i data-lucide="check" class="w-5 h-5 text-white"></i>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalButton.classList.add('bg-green-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // [FIX] Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© clickschannel: 0
Â  Â  Â  Â  Â  Â  Â  Â  const newChannel = { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: channelTitle, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  image: channelThumbnail, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  channelid: channelId, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  channeltitle: channelTitle,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clickschannel: 0 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const updatedList = [...localChannelsCache, newChannel];
Â  Â  Â  Â  Â  Â  Â  Â  const success = await updateChannelsList(updatedList);

Â  Â  Â  Â  Â  Â  Â  Â  if (success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© "${newChannel.name}" Ø¨Ù†Ø¬Ø§Ø­.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (modalButton) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalButton.innerHTML = `<i data-lucide="check" class="w-5 h-5 text-white"></i>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalButton.classList.add('bg-green-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ... (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©) ...
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const suggestionsContent = document.getElementById('suggestions-content');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(suggestionsContent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const activeTabId = document.querySelector('#screen-Media .tab-button.active')?.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  suggestionsContent.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await populateYoutubeSuggestions();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (activeTabId) { document.getElementById(activeTabId)?.click(); } 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else { document.getElementById('tab-channels')?.click(); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error adding channel from modal:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø©.");
Â  Â  Â  Â  Â  Â  Â  Â  if (modalButton) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalButton.innerHTML = `<i data-lucide="plus" class="w-5 h-5 text-white"></i>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

       async function addChannelFromSearchResult(channelId, channelTitle, channelThumbnail, buttonElement) {
Â  Â  Â  Â  Â  Â  if (!channelId || !channelTitle) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (buttonElement) {
Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>`;
Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (localChannelsCache.some(c => c.channelid === channelId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox("Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙƒ.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const newChannel = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: channelTitle,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  image: channelThumbnail,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  channelid: channelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  channeltitle: channelTitle,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clickschannel: 0 // [ØªØ¹Ø¯ÙŠÙ„] Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ù†Ù‚Ø±Ø§Øª
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const updatedList = [...localChannelsCache, newChannel];
Â  Â  Â  Â  Â  Â  Â  Â  const success = await updateChannelsList(updatedList);

Â  Â  Â  Â  Â  Â  Â  Â  if (success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© "${newChannel.name}" Ø¨Ù†Ø¬Ø§Ø­.`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (buttonElement) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5 text-green-400"></i>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error adding channel from search result:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø©.");
Â  Â  Â  Â  Â  Â  Â  Â  if (buttonElement) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5 text-green-400"></i>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        async function removeChannelFromList(channelId, channelName) {
            if (!channelId) return;

            // This function directly removes the channel. A confirmation modal would be a good addition later.
            try {
                const updatedList = localChannelsCache.filter(c => c.channelid !== channelId);
                const success = await updateChannelsList(updatedList);
                
                if (success) {
                    showMessageBox(`ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ù‚Ù†Ø§Ø© "${channelName}" Ø¨Ù†Ø¬Ø§Ø­.`);
                    // Refresh the entire suggestions view to reflect the deletion
                    const suggestionsContent = document.getElementById('suggestions-content');
                    if(suggestionsContent) {
                       suggestionsContent.innerHTML = '';
                       await populateYoutubeSuggestions(); // await to ensure it completes
                       // After refresh, focus might be lost, so let's refocus on the tab
                       const activeTab = document.querySelector('#screen-Media .tab-button.active');
                       if(activeTab) setFocus(activeTab);
                    }
                }
            } catch (error) {
                console.error("Error removing channel from list:", error);
                showMessageBox("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ù†Ø§Ø©.");
            }
        }
        // --- END: NEW Channel List Functions ---
        
        async function searchYouTubeVideos(query) {
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}&maxResults=25`);
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    console.error("YouTube API error (search):", errorData?.error?.message || res.status);
                    throw new Error("API search request failed.");
                }
                const data = await res.json();
                if (data.items && data.items.length > 0) {
                    const videoIds = data.items.map(item => item.id.videoId);
                    const videoDetails = await fetchVideosDetails(videoIds);

                    if (videoDetails === null) {
                        throw new Error("Failed to fetch details for search results.");
                    }
                    
                    // NEW: Fetch channel thumbnails
                    const channelIds = [...new Set(videoDetails.map(video => video.snippet.channelId))];
                    const channelThumbnails = await fetchChannelsDetails(channelIds);

                    lastSuccessfulSearchQuery = query; // NEW: Save the last successful query
                    searchResultsContainer.innerHTML = '';
                    videoDetails.forEach(video => {
                        const isLive = video.snippet.liveBroadcastContent === 'live';
                        const durationString = video.contentDetails.duration;

                        if (!isLive) {
                            const durationSeconds = durationString.match(/\d+/g)?.map(Number).reduce((acc, time, i, arr) => acc + time * (arr.length === 3 ? [3600, 60, 1][i] : (arr.length === 2 ? [60, 1][i] : 1)), 0) || 0;
                            if (durationSeconds <= 61) return;
                        }

                        const videoData = {
                            id: video.id,
                            title: video.snippet.title,
                            thumbnail: video.snippet.thumbnails.medium.url,
                            channelTitle: video.snippet.channelTitle,
                            channelId: video.snippet.channelId,
                            channelThumbnail: channelThumbnails[video.snippet.channelId],
                            viewCount: formatViewCount(video.statistics.viewCount),
                            publishedAt: formatTimeAgo(video.snippet.publishedAt),
                            duration: isLive ? 'Ù…Ø¨Ø§Ø´Ø±' : formatDuration(durationString)
                        };
                        searchResultsContainer.appendChild(createVideoCard(videoData));
                    });
                    
                    youtubeSuggestionsDiv.style.display = 'none';
                    youtubeVideoListView.classList.add('hidden');
                    youtubeSearchResultsView.classList.remove('hidden');
                    activeMediaView = 'searchResults';
                    backToPlaylistsBottomButton.style.display = 'none';
                    backToPlaylistsBottomButtonSearch.style.display = 'flex';
                    backToSearchFloatingButton.style.display = 'flex'; // NEW: Show the floating button
                    // The back button is now inside a container, so we don't hide/show it directly
                    updateNavigationButtons(query); // NEW: Update navigation buttons
                    setTimeout(() => { const firstResult = searchResultsContainer.querySelector('.grid-item'); if (firstResult) setFocus(firstResult); }, 100);
                } else {
                    showMessageBox('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ù„Ù€: ' + query);
                }
            } catch (err) {
                console.error('Error searching YouTube videos:', err);
                showMessageBox('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨. Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ù…ÙØªØ§Ø­ API.');
            }
        }
        
      /**
 * Searches for a channel's content, prioritizing currently live videos over regular uploads,
 * then displays the combined results on the search results screen.
 *
 * @param {string} channelId - The ID of the YouTube channel.
 * @param {string} channelTitle - The name of the YouTube channel.
 */
async function searchVideosByChannel(channelId, channelTitle) {
    if (!channelId) return;

    searchResultsContainer.innerHTML = `<h2 class="text-3xl font-bold mb-4 text-center w-full text-white col-span-full">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† ${channelTitle}...</h2>`;
    youtubeSuggestionsDiv.style.display = 'none';
    youtubeVideoListView.classList.add('hidden');
    youtubeSearchResultsView.classList.remove('hidden');
    activeMediaView = 'searchResults';

    try {
        // 1. Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª (Uploads Playlist ID)
        const channelRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=contentDetails,snippet&id=${channelId}&key=${YOUTUBE_API_KEY}`);
        if (!channelRes.ok) throw new Error("Failed to fetch channel details.");
        const channelData = await channelRes.json();
        const uploadsPlaylistId = channelData?.items?.[0]?.contentDetails?.relatedPlaylists?.uploads;
        const channelThumbnail = channelData?.items?.[0]?.snippet?.thumbnails?.default?.url;

        if (!uploadsPlaylistId) {
             throw new Error("Could not find the uploads playlist for this channel.");
        }

        // 2. Ø¬Ù„Ø¨ Ù…Ù‚Ø§Ø·Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª (Uploads Playlist)
        const playlistRes = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${uploadsPlaylistId}&key=${YOUTUBE_API_KEY}&maxResults=15`);
        if (!playlistRes.ok) throw new Error("Failed to fetch videos from the channel's playlist.");
        const playlistData = await playlistRes.json();

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ IDs Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        let videoIds = playlistData.items.map(item => item.snippet.resourceId.videoId).filter(id => id);
        
        // 3. Ø¬Ù„Ø¨ Ù…Ù‚Ø§Ø·Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Live Broadcasts) - Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
        const liveRes = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&type=video&eventType=live&key=${YOUTUBE_API_KEY}&maxResults=10`);
        const liveData = await liveRes.json();
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ IDs Ù„Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
        const liveVideoIds = liveData.items.map(item => item.id.videoId);

        // 4. Ø¯Ù…Ø¬ Ø§Ù„Ù€ IDs: Ù†Ø¶Ø¹ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ù…Ø¹ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª)
        const combinedVideoIds = [...new Set([...liveVideoIds, ...videoIds])]; 
        
        if (combinedVideoIds.length === 0) {
            searchResultsContainer.innerHTML = `<h2 class="text-3xl font-bold mb-4 text-center w-full text-white col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù‚Ù†Ø§Ø© ${channelTitle}</h2>`;
            // ğŸ›‘ FIX: ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø¨Ø­Ø« Ø§Ù„Ù‚Ù†Ø§Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©
            lastSuccessfulSearchQuery = `CHANNEL_ID:${channelId}:${channelTitle}`;
            return;
        }

        // 5. Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ù…Ø¯Ø©ØŒ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŒ Ø¥Ù„Ø®)
        const videoDetails = await fetchVideosDetails(combinedVideoIds);

        searchResultsContainer.innerHTML = `<h2 class="text-3xl font-bold mb-4 text-center w-full text-white col-span-full"> ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† ${channelTitle}</h2>`;

        videoDetails.forEach(video => {
            const isLive = video.snippet.liveBroadcastContent === 'live';
            const durationString = video.contentDetails?.duration;
            
            // ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ Ø§Ù„Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹
            if (!isLive && (!durationString || durationString.match(/\d+/g)?.map(Number).reduce((acc, time, i, arr) => acc + time * (arr.length === 3 ? [3600, 60, 1][i] : (arr.length === 2 ? [60, 1][i] : 1)), 0) || 0) <= 61) return;

            const videoData = {
                id: video.id,
                title: video.snippet.title,
                thumbnail: video.snippet.thumbnails.medium.url,
                channelTitle: video.snippet.channelTitle,
                channelId: video.snippet.channelId,
                channelThumbnail: channelThumbnail,
                viewCount: formatViewCount(video.statistics?.viewCount || 0),
                publishedAt: formatTimeAgo(video.snippet.publishedAt),
                duration: isLive ? 'Ù…Ø¨Ø§Ø´Ø±' : formatDuration(durationString)
            };
            searchResultsContainer.appendChild(createVideoCard(videoData));
        });

        // ğŸ›‘ CRITICAL FIX: ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†Ø§Ø¬Ø­ Ù„Ù„Ù‚Ù†Ø§Ø© Ù„ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©
        lastSuccessfulSearchQuery = `CHANNEL_ID:${channelId}:${channelTitle}`; 

        // 6. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„ØªÙ†Ù‚Ù„
        lucide.createIcons();
        updateNavigableElements();
        backToPlaylistsBottomButton.style.display = 'none';
        backToPlaylistsBottomButtonSearch.style.display = 'flex';
        backToSearchFloatingButton.style.display = 'flex';
        previousItemButton.style.display = 'none';
        nextItemButton.style.display = 'none';
        setTimeout(() => { const firstResult = searchResultsContainer.querySelector('.grid-item'); if (firstResult) setFocus(firstResult); }, 100);
        
    } catch (err) {
        console.error('Error searching videos by channel:', err);
        searchResultsContainer.innerHTML = `<h2 class="text-3xl font-bold mb-4 text-center w-full text-white col-span-full text-red-400">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø©. Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ù…ÙØªØ§Ø­ API.</h2>`;
    }
}   

/**
 * Asynchronously loads and displays the YouTube video player in a floating popup window.
 * Complete Version with API Safety & JSONBINIO Bookmark Integration.
 */
async function showVideoPopup(videoId, startOverride = null) {
    // 1. ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„ (Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø£Ùˆ Ù…Ù† Ø§Ù„ØµÙØ±)
    const start = startOverride !== null ? startOverride : (() => {
        const history = getWatchedHistory();
        const watchedInfo = history[videoId];
        // Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… Ù…Ø´Ø§Ù‡Ø¯Ø© Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø«ÙˆØ§Ù†Ù
        return (watchedInfo && watchedInfo.progress > 5) ? watchedInfo.progress : 0;
    })();
    
    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.body.classList.add('animation-paused');
    const playIcon = pauseAnimationButton ? pauseAnimationButton.querySelector('[data-lucide="play"]') : null;
    const pauseIcon = pauseAnimationButton ? pauseAnimationButton.querySelector('[data-lucide="pause"]') : null;
    if (playIcon && pauseIcon) {
        playIcon.classList.remove('hidden'); 
        pauseIcon.classList.add('hidden');
    }

    // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© YouTube API (Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ)
    // Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ø¯Ø§Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª (retryCount) ÙƒØ®Ø§ØµÙŠØ© Ø«Ø§Ø¨ØªØ© Ù„Ù„Ø¯Ø§Ù„Ø© Ø£Ùˆ Ù†ØªØ­Ù‚Ù‚ Ø¨Ø¨Ø³Ø§Ø·Ø©
    if (!window.isYouTubeApiReady || !window.YT || !window.YT.Player) {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø¬Ø§Ù‡Ø²Ø©ØŒ Ù†Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¹Ø¯ 200 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© Ø«Ù… Ù†ØªÙˆÙ‚Ù Ø£Ùˆ Ù†Ø¸Ù‡Ø± Ø®Ø·Ø£
        // Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…ÙØ±ØºØ©ØŒ Ù†ØªØ­Ù‚Ù‚ Ù‡Ù„ Ù‡Ø°Ù‡ "Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©" Ø£Ù… Ù„Ø§
        if (!showVideoPopup.retries) showVideoPopup.retries = 0;
        
        if (showVideoPopup.retries < 10) {
            console.warn(`â³ YouTube API not ready. Retrying (${showVideoPopup.retries}/10)...`);
            showVideoPopup.retries++;
            return setTimeout(() => showVideoPopup(videoId, startOverride), 200);
        } else {
            console.error("âŒ YouTube API failed to load.");
            alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.");
            showVideoPopup.retries = 0; // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
            return;
        }
    }
    showVideoPopup.retries = 0; // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­

    // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    currentPlayingVideoId = videoId;
    videoPopupContainer.style.display = 'flex'; 
    videoPopupContainer.classList.add('active');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø´Ø·Ø©
    if (floatingMinimizedVideoButton) floatingMinimizedVideoButton.style.display = 'none';
    appState.isVideoPlayerMinimized = false;

    // ============================================================
    // ğŸ’ Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„Ù…Ø§Ø±Ùƒ Ø¨ÙˆÙƒ (ID Ø¬Ø¯ÙŠØ¯ + ÙˆØ¸ÙŠÙØ© JSONBINIO Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
    // ============================================================
    const controlsContainer = videoPopupCloseButton.parentElement;
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ù€ ID Ø§Ù„Ù…Ù…ÙŠØ² Ø§Ù„Ø¬Ø¯ÙŠØ¯
    let bookmarkBtn = document.getElementById('video-popup-bookmark-button');
    
    if (!bookmarkBtn && controlsContainer) {
        bookmarkBtn = document.createElement('button');
        bookmarkBtn.id = 'video-popup-bookmark-button'; // âœ… ID ÙØ±ÙŠØ¯ Ù„Ù„Ø¨ÙˆØ¨-Ø£Ø¨
        
        // Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ
        bookmarkBtn.className = 'navigable grid-item p-3 rounded-full glass-surface glass-surface--svg hover:bg-white/20 transition-colors';
        bookmarkBtn.innerHTML = `<i data-lucide="bookmark" class="w-6 h-6"></i>`;
        bookmarkBtn.title = "Save to Favorites";
        bookmarkBtn.tabIndex = 0;
        
        // âœ… Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø« Ø¨Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        bookmarkBtn.onclick = (e) => {
             e.stopPropagation();
             e.preventDefault();

             // 1. ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…
             // Ù†Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø§Ù„Ù…Ø´ØºÙ„ØŒ Ø£Ùˆ Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ù†ÙˆØ§Ù† Ù…Ø¤Ù‚Øª
             const playerTitle = (popupPlayer && typeof popupPlayer.getVideoData === 'function') 
                                ? popupPlayer.getVideoData().title 
                                : ""; 
             
             // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®Ø²Ù† ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ± ÙÙŠ Ø§Ù„Ù…Ø´ØºÙ„
             const finalTitle = playerTitle || appState.currentVideoTitle || "Unknown Video";

             const videoData = {
                 id: currentPlayingVideoId,
                 title: finalTitle,
                 thumbnail: `https://i.ytimg.com/vi/${currentPlayingVideoId}/mqdefault.jpg`
             };
             
             // 2. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (JSONBINIO Logic)
             // Ù†Ù…Ø±Ø± Ù„Ù‡Ø§ Ø§Ù„Ø²Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ø¶Ø¨Ø· Ø§Ù„Ù…ÙƒØ§Ù†) ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
             if (typeof showFavoritesMenu === 'function') {
                 showFavoritesMenu(bookmarkBtn, videoData);
             } else {
                 console.error("showFavoritesMenu function is missing!");
             }
        };
        
        // Ø¥Ø¶Ø§ÙØªÙ‡ Ù‚Ø¨Ù„ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        controlsContainer.insertBefore(bookmarkBtn, videoPopupCloseButton);
    }
    
    // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØµØºÙŠØ± (Minimize)
    const videoPopupMinimizeButton = document.getElementById('video-popup-minimize-button');
    if (videoPopupMinimizeButton) {
        videoPopupMinimizeButton.onclick = (e) => {
            e.stopPropagation();
            minimizeVideoPopup(); 
        };
    }

    // 5. ØªÙ‡ÙŠØ¦Ø© ÙˆØªØ´ØºÙŠÙ„ Ù…Ø´ØºÙ„ ÙŠÙˆØªÙŠÙˆØ¨ (YT.Player)
    if (popupPlayer && typeof popupPlayer.loadVideoById === 'function') { 
        // Ø§Ù„Ù…Ø´ØºÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ -> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        popupPlayer.loadVideoById({ videoId, startSeconds: start });
        // Ù„Ø§ ØªÙ†Ø³ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø©
        // popupPlayer.addEventListener('onPlaybackRateChange', handlePlaybackRateChange);
    } else {
        // Ø§Ù„Ù…Ø´ØºÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ -> Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
        videoPopupPlayerContainer.innerHTML = '<div id="video-popup-player"></div>';
        
        window.popupPlayer = new YT.Player('video-popup-player', {
            height: '100%', 
            width: '100%', 
            videoId: videoId,
            playerVars: { 
                'autoplay': 1, 
                'controls': 1, 
                'start': Math.floor(start),
                'origin': window.location.origin, // Ø­Ù…Ø§ÙŠØ© CORS
                'rel': 0, // Ù…Ù†Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
                'modestbranding': 1
            },
            events: { 
                'onReady': (e) => {
                    e.target.playVideo();
                    // ØªØ·Ø¨ÙŠÙ‚ Ø¢Ø®Ø± Ø³Ø±Ø¹Ø© Ù…Ø­ÙÙˆØ¸Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
                    // if (lastPlaybackRate) e.target.setPlaybackRate(lastPlaybackRate);
                },
                'onStateChange': onPlayerStateChange, 
                'onPlaybackRateChange': handlePlaybackRateChange 
            }
        });
    }

    // 6. Ù†Ù‚Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Accessibility) ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
    setTimeout(() => {
        if (typeof setFocus === 'function') setFocus(videoPopupCloseButton);
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }, 100);
}

// ============================================================
// ğŸ“‹ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø³ÙŠØ§Ø±Ø©ØŒ ØªÙ„ÙØ§Ø²ØŒ Ù…ÙØ¶Ù„Ø©)
// ============================================================
function showPopupBookmarkMenu(anchorBtn, videoId) {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØªÙˆØ­Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹
    const existingMenu = document.getElementById('popup-options-menu');
    if (existingMenu) existingMenu.remove();

    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const menu = document.createElement('div');
    menu.id = 'popup-options-menu';
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªÙƒÙˆÙ† ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ (High Z-Index)
    Object.assign(menu.style, {
        position: 'fixed',
        zIndex: '2147483647', // Ø£Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© Ù…Ù…ÙƒÙ†Ø©
        background: 'rgba(25, 25, 25, 0.95)',
        backdropFilter: 'blur(12px)',
        border: '1px solid rgba(255, 255, 255, 0.1)',
        borderRadius: '12px',
        padding: '8px',
        minWidth: '220px',
        boxShadow: '0 8px 32px rgba(0,0,0,0.5)',
        display: 'flex', flexDirection: 'column', gap: '4px',
        opacity: '0', transform: 'translateY(-10px)', transition: 'all 0.2s ease'
    });

    // 3. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const options = [
        { id: 'favorites', label: 'Ø§Ù„Ù…ÙØ¶Ù„Ø© (Favorites)', icon: 'â¤ï¸' },
        { id: 'car',       label: 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø©', icon: 'ğŸš—' }, // âœ… Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        { id: 'tv',        label: 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø§Ù„ØªÙ„ÙØ§Ø²', icon: 'ğŸ“º' }, // âœ… Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        { id: 'watch_later', label: 'Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹',   icon: 'â°' }
    ];

    // 4. Ø¨Ù†Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    options.forEach(opt => {
        const item = document.createElement('div');
        Object.assign(item.style, {
            padding: '10px 12px',
            borderRadius: '8px',
            cursor: 'pointer',
            color: 'white',
            fontSize: '14px',
            display: 'flex', alignItems: 'center', gap: '10px',
            transition: 'background 0.2s'
        });
        
        item.innerHTML = `<span>${opt.icon}</span> <span style="font-weight:500">${opt.label}</span>`;
        
        // ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­ÙˆÙŠÙ…
        item.onmouseenter = () => item.style.background = 'rgba(255,255,255,0.1)';
        item.onmouseleave = () => item.style.background = 'transparent';
        
        // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
        item.onclick = (e) => {
            e.stopPropagation();
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù†Ø¸Ø§Ù…Ùƒ
            if (typeof saveToPlaylist === 'function') {
                saveToPlaylist(opt.id, videoId); 
                console.log(`Saving to ${opt.id}`);
            } else {
                console.warn(`Function saveToPlaylist not found. Action: ${opt.id}`);
            }
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            menu.style.opacity = '0';
            setTimeout(() => menu.remove(), 200);
        };
        
        menu.appendChild(item);
    });

    // 5. ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© (Ø¯Ø§Ø®Ù„ Body Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Øµ)
    document.body.appendChild(menu);

    // 6. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Positioning Logic)
    const rect = anchorBtn.getBoundingClientRect();
    
    // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø£Ø³ÙŠ: Ø£Ø³ÙÙ„ Ø§Ù„Ø²Ø±
    menu.style.top = (rect.bottom + 8) + 'px';
    
    // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙÙ‚ÙŠ: Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø±ØŒ Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø©
    if (rect.left + 230 > window.innerWidth) {
        menu.style.left = (window.innerWidth - 240) + 'px';
    } else {
        menu.style.left = rect.left + 'px';
    }

    // 7. Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¸Ù‡ÙˆØ±
    requestAnimationFrame(() => {
        menu.style.opacity = '1';
        menu.style.transform = 'translateY(0)';
    });

    // 8. Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    setTimeout(() => {
        const closeHandler = (e) => {
            if (!menu.contains(e.target) && e.target !== anchorBtn) {
                menu.remove();
                document.removeEventListener('click', closeHandler);
            }
        };
        document.addEventListener('click', closeHandler);
    }, 100);
}

async function hideVideoPopup() {
    // 1. Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
    if (progressInterval) clearInterval(progressInterval);

    let videoId, currentTime, duration;

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø´ØºÙ„ ÙˆØ¥ÙŠÙ‚Ø§ÙÙ‡ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ¯Ù…ÙŠØ±Ù‡)
    if (popupPlayer && typeof popupPlayer.pauseVideo === 'function') {
        popupPlayer.pauseVideo(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        
        // 3. Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        const videoData = popupPlayer.getVideoData();
        videoId = videoData ? videoData.video_id : null;
        currentTime = popupPlayer.getCurrentTime();
        duration = popupPlayer.getDuration();
        
        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (localStorage/JSONBin)
        if (videoId) {
            await updateVideoProgress(videoId, currentTime, duration);
        }
        
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´ØºÙ„ ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†
        videoId = currentPlayingVideoId; 
    }
    
    // ğŸ›‘ CRITICAL FIX: Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…Ø´ØºÙ„ Ù‡Ù†Ø§ØŒ ÙÙ‚Ø· Ù†ØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
    
    // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
    document.body.classList.remove('animation-paused');
    const playIcon = pauseAnimationButton.querySelector('[data-lucide="play"]');
    const pauseIcon = pauseAnimationButton.querySelector('[data-lucide="pause"]');
    if (playIcon && pauseIcon) {
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
    }
    
    videoPopupContainer.classList.remove('active');
    videoPopupContainer.style.display = 'none';
    floatingMinimizedVideoButton.style.display = 'none';
    appState.isVideoPlayerMinimized = false;

    // 6. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ DOM (Ø¥Ø²Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¤Ù‚Øª)
    const bookmarkBtn = document.getElementById('video-popup-bookmark-button');
    if (bookmarkBtn) {
        bookmarkBtn.remove();
    }
    
    // 7. Ù†Ù‚Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ²
    const screen = document.querySelector('.app-screen.active');
    if (screen) {
        const item = screen.querySelector('.grid-item');
        if (item) setFocus(item);
    }
}
        
        // NEW: Functions to minimize and restore the video popup
       // ... (ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
const minimizedPlayPauseBtn = document.getElementById('minimized-play-pause-btn');
const minimizedRestoreBtn = document.getElementById('minimized-restore-btn');
const minimizedPlaybackSpeed = document.getElementById('minimized-playback-speed');
// ...


/**
 * REPLACED & FINALIZED: Minimizes the active YouTube popup player into the 
 * floating audio capsule. Reduces playback quality to 'tiny' for resource saving.
 */
function minimizeVideoPopup() {
    if (!videoPopupContainer.classList.contains('active')) return;
    
    // ğŸ›‘ 1. Ø¶Ø¨Ø· Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù„Ù‰ Ø£Ø¯Ù†Ù‰ Ø­Ø¯ Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ÙˆØªÙˆÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
    if (popupPlayer && typeof popupPlayer.setPlaybackQuality === 'function') {
        // Ù†Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¹Ù„Ù‰ "Tiny" Ø£Ùˆ "Small" Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª
        popupPlayer.setPlaybackQuality('tiny'); 
        
        // ğŸ’¡ ØªÙ„Ù…ÙŠØ­: Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ Play Ø¥Ù„Ù‰ Ø§Ù„Ù€ iframe ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        const iframe = popupPlayer.getIframe();
        if (iframe && iframe.contentWindow) {
             iframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
        }
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´ØºÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ£ØŒ Ù†Ø­Ø§ÙˆÙ„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„)
        console.warn("Cannot minimize: YouTube player is not ready for background mode.");
    }
    
    // 2. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„ÙƒØ¨ÙŠØ± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©
    videoPopupContainer.style.display = 'none';
    floatingMinimizedVideoButton.style.display = 'flex';
    floatingMinimizedVideoButton.classList.add('active'); // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©

    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    appState.isVideoPlayerMinimized = true;
    
    // 4. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©
    updateMinimizedControlsState(); 

    // 5. ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©
    const videoData = popupPlayer ? popupPlayer.getVideoData() : null;
    const titleElement = floatingMinimizedVideoButton.querySelector('.minimized-title');
    if(titleElement) titleElement.textContent = (videoData && videoData.title) ? videoData.title : 'Ø§Ù„ØµÙˆØª ÙŠØ¹Ù…Ù„...';
    
    // 6. Ù†Ù‚Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©
    setFocus(floatingMinimizedVideoButton);
}

function restoreVideoPopup() {
    // 1. Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù…Ø§Ù†
    if (!appState.isVideoPlayerMinimized) return;
    
    // 2. ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶
    videoPopupContainer.style.display = 'flex'; // ğŸ‘ˆ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡)
    floatingMinimizedVideoButton.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ù…ØµØºØ±Ø©
    floatingMinimizedVideoButton.classList.remove('active');
    
    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    appState.isVideoPlayerMinimized = false;
    
    // ğŸ›‘ FIX: Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØ¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ iframe
    if (popupPlayer && typeof popupPlayer.playVideo === 'function') {
        // Ù†Ø·Ù„Ø¨ Ø¬ÙˆØ¯Ø© Ù…ØªÙˆØ³Ø·Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†Ø´ÙŠØ· Ø§Ù„Ø¹Ø±Ø¶
        popupPlayer.setPlaybackQuality('medium'); 
        popupPlayer.playVideo();
    }
    
    // 4. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ±ÙƒÙŠØ² (Focus) 
    // Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙÙŠ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø±ÙŠÙ…ÙˆØª
    const videoPopupCloseButton = document.getElementById('video-popup-close-button'); 
    
    if (videoPopupCloseButton) {
        setFocus(videoPopupCloseButton);
    } else {
        setFocus(videoPopupContainer); 
    }
}

function updateMinimizedControlsState() {
    // ğŸ›‘ 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø´ØºÙ„ ÙˆØªÙ‡ÙŠØ¦ØªÙ‡
    if (!popupPlayer || typeof popupPlayer.getPlayerState !== 'function') return; 

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø¹Ù†Ø§ØµØ±
    const minimizedPlayPauseBtn = document.getElementById('minimized-play-pause-btn');
    const rateButtons = document.querySelectorAll('#playback-rates-group .rate-btn'); 
    
    if (!minimizedPlayPauseBtn || rateButtons.length === 0) return;

    const currentRate = popupPlayer.getPlaybackRate();
    // ğŸ’¡ Ù†Ø³ØªØ®Ø¯Ù… toFixed(2) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø© ÙÙŠ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    const currentRateFixed = parseFloat(currentRate.toFixed(2));
    
    const playerState = popupPlayer.getPlayerState();
    const isPlaying = (playerState === YT.PlayerState.PLAYING);

    // --- 3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ„ÙˆÙŠÙ† (CRITICAL FIX) ---
    rateButtons.forEach(btn => {
        // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ ÙƒÙ„ ØªØ­Ø¯ÙŠØ«
        btn.classList.remove('active-rate');
        
        // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†ØµÙŠØ© Ù„Ù„Ø²Ø±
        const btnRateString = parseFloat(btn.dataset.rate).toFixed(2);
        
        if (btnRateString === currentRateFixed.toFixed(2)) { // Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
            btn.classList.add('active-rate');
        }
    });

    // --- 4. ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù (Play/Pause Icons) ---
    const playIcon = minimizedPlayPauseBtn.querySelector('.play-icon');
    const pauseIcon = minimizedPlayPauseBtn.querySelector('.pause-icon');
    
    if (playIcon && pauseIcon) {
        playIcon.classList.toggle('hidden', isPlaying);
        pauseIcon.classList.toggle('hidden', !isPlaying);
    }
    
    // --- 5. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„ÙƒØ¨ÙŠØ± (Ù„Ù„ØªØ²Ø§Ù…Ù†) ---
    const playbackSelect = document.getElementById('playback-rate-select');
    if (playbackSelect) {
         playbackSelect.value = currentRate.toFixed(1).toString(); 
    }
}
function onPlayerStateChange(event) {
    updateCarPlayDashboard();
    if (event.data == YT.PlayerState.PLAYING || event.data == YT.PlayerState.BUFFERING) {
        forceUpdateCarPlayMedia(event.target);
    }

    if (event.data == YT.PlayerState.ENDED) {
        const videoData = popupPlayer.getVideoData();
        const videoId = videoData ? videoData.video_id : null;

        // âœ… 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒÙ€ "Ù…ÙƒØªÙ…Ù„" ÙÙˆØ± Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¸Ù‡ÙˆØ±Ù‡ Ù…Ø¬Ø¯Ø¯Ø§Ù‹
        if (videoId) {
            let completed = JSON.parse(localStorage.getItem('completed_videos_ids') || '[]');
            if (!completed.includes(videoId)) {
                completed.push(videoId);
                localStorage.setItem('completed_videos_ids', JSON.stringify(completed));
                console.log(`âœ… Video ${videoId} marked as completed.`);
            }
        }

        // 2. Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆØ¶Ø¹ Shuffle Ù…ÙØ¹Ù„
        if (window.isAutoPlayMode && window.currentSuggestedVideos) {
            const currentIndex = window.currentSuggestedVideos.findIndex(v => v.id === videoId);
            
            if (currentIndex > -1 && currentIndex < window.currentSuggestedVideos.length - 1) {
                // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ
                const nextVideo = window.currentSuggestedVideos[currentIndex + 1];
                showVideoPopup(nextVideo.id, 0);
                return; 
            } else {
                // Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
                window.isAutoPlayMode = false;
                showMessageBox("Ø§Ù†ØªÙ‡Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø©");
            }
        }

        // 3. Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø³ØªÙ‚ÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©)
        if (popupPlayer) { 
            popupPlayer.destroy(); 
            popupPlayer = null; 
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©: Ø³ØªÙ‚ÙˆÙ… fetchSuggestedVideos Ø§Ù„Ø¢Ù† Ø¨ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø°ÙŠ Ø§Ù†ØªÙ‡Ù‰ Ù„Ù„ØªÙˆ
        showDashboardSuggestionsInPopup(); 
    }
}

function createSimpleSuggestionCard(video, type) {
    const card = document.createElement('div');
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„ØªÙŠ ØªØ¶Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆØ² ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡
    card.className = 'simple-suggestion-card flex flex-col gap-2 p-3 rounded-xl bg-white/10 cursor-pointer navigable grid-item flex-shrink-0';
    card.tabIndex = 0;
    card.setAttribute('tabindex', '0');
    card.dataset.videoId = video.id;

    card.innerHTML = `
        <div class="video-thumbnail-wrapper relative w-full h-[140px] overflow-hidden rounded-lg">
            <img src="${video.thumbnail}" class="w-full h-full object-cover">
            <span class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-2 py-1 rounded">
                ${video.duration || '00:00'}
            </span>
        </div>
        <div class="video-info flex flex-col gap-1">
            <h4 class="font-bold text-sm text-white line-clamp-2 leading-tight">${video.title}</h4>
            <p class="text-xs text-white/60 truncate">${video.channelTitle || ''}</p>
            <p class="text-[10px] text-white/40">${video.viewsDisplay || ''}</p>
        </div>
    `;
    return card;
}

function playAsShufflePlaylist() {
    const btn = document.querySelector('.playlist-shuffle-btn');
    
    if (window.isAutoPlayMode) {
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
        window.isAutoPlayMode = false;
        if (btn) {
            btn.innerHTML = `<i data-lucide="shuffle"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„ (Playlist)`;
            btn.style.background = "linear-gradient(135deg, #9333ea 0%, #2563eb 100%)";
        }
    } else {
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
        if (!window.allFetchedVideos30 || window.allFetchedVideos30.length === 0) return;
        
        window.isAutoPlayMode = true;
        window.currentSuggestedVideos = [...window.allFetchedVideos30].sort(() => 0.5 - Math.random());

        if (btn) {
            btn.innerHTML = `<i data-lucide="square"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ`;
            btn.style.background = "linear-gradient(135deg, #ef4444 0%, #991b1b 100%)"; // Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù
        }

        const firstVideo = window.currentSuggestedVideos[0];
        showVideoPopup(firstVideo.id, 0);
    }
    if (window.lucide) lucide.createIcons();
}
async function showDashboardSuggestionsInPopup() {
    const container = videoPopupPlayerContainer;
    
    // 1. Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    container.innerHTML = `
        <div class="p-8 text-center text-white flex flex-col items-center justify-center min-h-[200px]">
            <div class="animate-spin inline-block w-10 h-10 border-4 border-t-transparent border-purple-500 rounded-full mb-4"></div>
            <p class="text-lg font-medium">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ù…Ù‚ØªØ±Ø­Ø§Øª Ø°ÙƒÙŠØ©...</p>
        </div>`;
    
    videoPopupContainer.style.display = 'flex';
    videoPopupContainer.classList.add('active');

    try {
        const suggestedVideos = await fetchSuggestedVideos();

        if (!suggestedVideos || suggestedVideos.length === 0) {
            container.innerHTML = `<p class="p-8 text-center text-white/70">Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù‚ØªØ±Ø­Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
            return;
        }

        const isAuto = window.isAutoPlayMode;
        const btnText = isAuto ? "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ" : "ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„ (Playlist)";
        const btnIcon = isAuto ? "square" : "shuffle";
        const btnStyle = isAuto 
            ? "background: linear-gradient(135deg, #ef4444 0%, #991b1b 100%) !important;" 
            : "background: linear-gradient(135deg, #9333ea 0%, #2563eb 100%) !important;";

        // 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„: 
        // Ø£Ø¶ÙÙ†Ø§ container Ø®Ø§Ø±Ø¬ÙŠ Ø¨Ù€ overflow-x: auto Ùˆ container Ø¯Ø§Ø®Ù„ÙŠ Ø¨Ù€ overflow: visible
        let fullHTML = `
            <div class="suggestions-main-wrapper flex flex-col items-center gap-2 w-full h-full" style="overflow: hidden;">
                
                <button class="playlist-shuffle-btn navigable grid-item" 
                        onclick="playAsShufflePlaylist()" 
                        style="${btnStyle} z-index: 100; margin-bottom: 10px; flex-shrink: 0;">
                    <i data-lucide="${btnIcon}"></i> 
                    <span>${btnText}</span>
                </button>

                <div class="scroll-viewport w-full" style="overflow-x: auto; overflow-y: visible; padding: 20px 0; scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                    
                    <div id="favorites-popup-grid" class="flex flex-row flex-nowrap gap-6 px-10" style="overflow: visible; width: max-content; min-width: 100%;">
        `;

        suggestedVideos.forEach(video => {
            const card = createSimpleSuggestionCard(video, 'SUGGEST');
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒØ±Øª Ù„Ø§ ÙŠÙ†ÙƒÙ…Ø´ ÙˆÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¨Ø±ÙˆØ²
            card.style.flexShrink = "0";
            card.style.transition = "transform 0.3s ease"; 
            fullHTML += card.outerHTML;
        });

        fullHTML += `
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = fullHTML;

        if (window.lucide) lucide.createIcons();
        if (typeof updateNavigableElements === 'function') updateNavigableElements();

        // 8. Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø±
        container.querySelectorAll('.simple-suggestion-card').forEach(card => {
            card.addEventListener('click', (e) => {
                const videoId = e.currentTarget.dataset.videoId;
                if (videoId) {
                    window.isAutoPlayMode = false;
                    showVideoPopup(videoId, 0); 
                }
            });
        });

        setTimeout(() => {
            const mainBtn = container.querySelector('.playlist-shuffle-btn');
            if (mainBtn) setFocus(mainBtn);
        }, 200);

    } catch (e) {
        console.error("Error in showDashboardSuggestionsInPopup:", e);
        container.innerHTML = `<p class="p-8 text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª.</p>`;
    }
}
        function handleFullScreenChange() {
            if (popupPlayer && typeof popupPlayer.getPlayerState === 'function' && popupPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                const isFullScreen = document.fullscreenElement === popupPlayer.getIframe() || document.webkitFullscreenElement === popupPlayer.getIframe();
                if (isFullScreen) {
                    popupPlayer.setPlaybackQuality('hd720');
                } else {
                    popupPlayer.setPlaybackQuality('large'); // 'large' for 480p
                }
            }
        }

        // This function is duplicated, removing one instance.
        
        // NEW: Function to handle next/previous navigation buttons
        function updateNavigationButtons(currentQuery) {
            // Reset and hide buttons by default
            previousItemButton.style.display = 'none';
            nextItemButton.style.display = 'none';
            previousItemButton.onclick = null;
            nextItemButton.onclick = null;

            // --- Case 1: Surah Navigation ---
            const surahMatch = currentQuery.match(/Ø³ÙˆØ±Ø© (.+)/);
            if (surahMatch && surahMatch[1]) {
                const currentSurah = surahMatch[1].trim();
                const currentIndex = youtubeSurahSuggestions.indexOf(currentSurah);

                if (currentIndex !== -1) {
                    const baseQuery = currentQuery.substring(0, currentQuery.indexOf('Ø³ÙˆØ±Ø©'));

                    // Previous Surah Button
                    if (currentIndex > 0) {
                        const prevSurah = youtubeSurahSuggestions[currentIndex - 1];
                        previousItemButton.innerHTML = `<i data-lucide="arrow-left"></i> ${prevSurah}`;
                        previousItemButton.style.display = 'flex';
                        previousItemButton.onclick = () => searchYouTubeVideos(`${baseQuery} Ø³ÙˆØ±Ø© ${prevSurah}`);
                    }

                    // Next Surah Button
                    if (currentIndex < youtubeSurahSuggestions.length - 1) {
                        const nextSurah = youtubeSurahSuggestions[currentIndex + 1];
                        nextItemButton.innerHTML = `${nextSurah} <i data-lucide="arrow-right"></i>`;
                        nextItemButton.style.display = 'flex';
                        nextItemButton.onclick = () => searchYouTubeVideos(`${baseQuery} Ø³ÙˆØ±Ø© ${nextSurah}`);
                    }
                    lucide.createIcons();
                    return;
                }
            }

            // --- Case 2: Juz Navigation ---
            const juzMatch = currentQuery.match(/Ø§Ù„Ø¬Ø²Ø¡ (.+)/);
            if (juzMatch && juzMatch[1]) {
                const currentJuz = juzMatch[1].trim();
                const currentIndex = juzArabicNames.indexOf(currentJuz);

                if (currentIndex !== -1) {
                    const baseQuery = currentQuery.substring(0, currentQuery.indexOf('Ø§Ù„Ø¬Ø²Ø¡')).trim();

                    // Previous Juz Button
                    if (currentIndex > 0) {
                        const prevJuz = juzArabicNames[currentIndex - 1];
                        previousItemButton.innerHTML = `<i data-lucide="arrow-left"></i> Ø§Ù„Ø¬Ø²Ø¡ ${prevJuz}`;
                        previousItemButton.style.display = 'flex';
                        previousItemButton.onclick = () => searchYouTubeVideos(`${baseQuery} Ø§Ù„Ø¬Ø²Ø¡ ${prevJuz}`.trim());
                    }

                    // Next Juz Button
                    if (currentIndex < juzArabicNames.length - 1) {
                        const nextJuz = juzArabicNames[currentIndex + 1];
                        nextItemButton.innerHTML = `Ø§Ù„Ø¬Ø²Ø¡ ${nextJuz} <i data-lucide="arrow-right"></i>`;
                        nextItemButton.style.display = 'flex';
                        nextItemButton.onclick = () => searchYouTubeVideos(`${baseQuery} Ø§Ù„Ø¬Ø²Ø¡ ${nextJuz}`.trim());
                    }
                    lucide.createIcons();
                    return;
                }
            }

            // --- Case 3: Reciter-Only Navigation ---
            const reciters = youtubeReaderSuggestions.filter(r => r.name !== "Ø±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª").map(r => r.name);
            const reciterIndex = reciters.indexOf(currentQuery.trim());

            if (reciterIndex !== -1) {
                // Previous Reciter Button
                if (reciterIndex > 0) {
                    const prevReciter = reciters[reciterIndex - 1];
                    previousItemButton.innerHTML = `<i data-lucide="arrow-left"></i> ${prevReciter}`;
                    previousItemButton.style.display = 'flex';
                    previousItemButton.onclick = () => {
                        searchMode = 'reciter_only'; // Preserve mode
                        searchYouTubeVideos(prevReciter);
                    };
                }

                // Next Reciter Button
                if (reciterIndex < reciters.length - 1) {
                    const nextReciter = reciters[reciterIndex + 1];
                    nextItemButton.innerHTML = `${nextReciter} <i data-lucide="arrow-right"></i>`;
                    nextItemButton.style.display = 'flex';
                    nextItemButton.onclick = () => {
                        searchMode = 'reciter_only'; // Preserve mode
                        searchYouTubeVideos(nextReciter);
                    };
                }
                lucide.createIcons();
                return;
            }
        }

         const youtubeReaderSuggestions = [             {"name":"Ø§Ù„Ø±Ù‚ÙŠØ©", "image":"https://imgs.search.brave.com/afZfY6pdMu-EfuTtrt2hNKEW9TsUAnPOX2QnIlIFi1c/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jZG4u/YXJhYnNzdG9jay5j/b20vdXBsb2Fkcy92/ZWN0b3JzLzIzMDQx/L3J1cWF5YS1hbi1h/cmFiaWMtbmFtZS1m/b3ItcHJldmlldy0y/MzA0MS53ZWJw"},
{"name":"Ù…Ø­Ù…Ø¯ Ø§ÙŠÙˆØ¨","image":"https://dmusera.netlify.app/512px-Muhammad_Ayyub.webp"},{"name":"Ø¹Ù„ÙŠ Ø¬Ø§Ø¨Ø±","image":"https://dmusera.netlify.app/ali-jaber.webp"},{"name":"Ù…Ø­Ù…Ø¯ Ø§Ù„ØºØ²Ø§Ù„ÙŠ","image":"https://imgs.search.brave.com/QWUpKrFCLEvXilcNhgSRM6xKPjTlBtGA-BAsH9sN-Tc/rs:fit:200:200:1:0/g:ce/aHR0cHM6Ly9hci5p/c2xhbXdheS5uZXQv/dXBsb2Fkcy9hdXRo/b3JzLzUwNjEuanBn"},{"name":"Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ","image":"https://dmusera.netlify.app/512px-%D0%9C%D0%B8%D1%88%D0%B0%D1%80%D0%B8_%D0%A0%D0%B0%D1%88%D0%B8%D0%B4.webp"},{"name":"Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ù‚Ø±Ø§ÙÙŠ","image":"https://yt3.googleusercontent.com/mHTg3RIX-a3NAR22lAnOvSq3-U_KBcL_Ax4FTNirc3flsb5OU8RWksKu6X8Ush9JhO0EOxxAwQY=s160-c-k-c0x00ffffff-no-rj"},{"name":"Ø§Ø³Ù„Ø§Ù… ØµØ¨Ø­ÙŠ","image":"https://imgs.search.brave.com/Sq4qNywnl1HmDjSuxWTshlQ8yV9fplcVnUoiErGC-38/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9tZWRp/YS51bml0ZWRtdXNs/aW13b3JsZC5jb20v/aW1nLzIzLzEyLzIz/LzEyNDk1LmpwZw"},{"name":"Ø§Ø­Ù…Ø¯ Ø§Ù„Ù†ÙÙŠØ³","image":"https://dmusera.netlify.app/ahmednafes.jpg"},{"name":"ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ","image":"https://dmusera.netlify.app/Yasser_Al-Dosari.jpg"},
{"name":"Ø±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª","image":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEwIDEzYTUgNSAwIDAgMCA3LjU0LjU0bD MtM2E1IDUgMCAwIDAtNy4wNy03LjA3bC0xLjcyIDEuNzIiLz48cGF0aCBkPSJNMTQgMTFhNSA1IDAgMCAwLTcuNTQtLjU0bC0zIDNhNSA1IDAgMCAwIDcuMDcgNy4wN2wxLjcyLTEuNzIiLz48L3N2Zz4="}, {"name":"Ø±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª","image":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEwIDEzYTUgNSAwIDAgMCA3LjU0LjU0bDMtM2E1IDUgMCAwIDAtNy4wNy03LjA3bC0xLjcyIDEuNzIiLz48cGF0aCBkPSJNMTQgMTFhNSA1IDAgMCAwLTcuNTQtLjU0bC0zIDNhNSA1IDAgMCAwIDcuMDcgNy4wN2wxLjcyLTEuNzIiLz48L3N2Zz4="}
        ];
          const youtubeReaderSuggestions2 = [
            {"name":"Ø§Ù„Ø±Ù‚ÙŠØ©", "image":"https://imgs.search.brave.com/afZfY6pdMu-EfuTtrt2hNKEW9TsUAnPOX2QnIlIFi1c/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jZG4u/YXJhYnNzdG9jay5j/b20vdXBsb2Fkcy92/ZWN0b3JzLzIzMDQx/L3J1cWF5YS1hbi1h/cmFiaWMtbmFtZS1m/b3ItcHJldmlldy0y/MzA0MS53ZWJw", "channelid": "", "channeltitle": ""},
            {"name":"Ù…Ø­ÙÙˆÙ -BYMAHFOOF", "image":"https://yt3.googleusercontent.com/obc8dOfYmoZe50tvHCJNZgbLAnJAKb-YPSUnguahWqJ-Jm12At_lV8CjfPPuhAsM9i2K26QK=s160-c-k-c0x00ffffff-no-rj", "channelid": "UCABzsyFLLA-fKu05lR-49RA", "channeltitle": "Ù…Ø­ÙÙˆÙ"},
            {"name":"ØªÙ„Ø§ÙˆØ§Øª ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ", "image":"https://yt3.googleusercontent.com/ytc/AIdro_k1n9v-3Z3x-v6Q2wY5kX1c8z-G4xQ6X1X5Xw=s176-c-k-c0x00ffffff-no-rj-mo", "channelid": "UClncV9OLPto_MinRzGfjr2g", "channeltitle": "ØªÙ„Ø§ÙˆØ§Øª ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ Ø¥Ù…Ø§Ù… Ø§Ù„Ø­Ø±Ù… Ø§Ù„Ù…ÙƒÙŠ"},
            {"name":"Ù…Ø²Ø§Ù…ÙŠØ± Ø§Ù„ÙØ±Ù‚Ø§Ù† - ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ", "image":"https://yt3.googleusercontent.com/ATOVX4RIsbt20_VS0Ly0bNkm5NPCoseg-S28jEEFsMBhHxBRUGXWW1dFOSuKG5p1_Sx8C8fMqFs=s160-c-k-c0x00ffffff-no-rj", "channelid": "UCCoB7Hf8gjQzpAyzhvx7Ktg", "channeltitle": "Ù…Ø²Ø§Ù…ÙŠØ± Ø§Ù„ÙØ±Ù‚Ø§Ù† - ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ"},
            {"name":"Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ø­Ø±ÙŠ", "image":"https://yt3.ggpht.com/KZblM_WDIfUaDyB0wmNZOfVDogOhHThprmFyzLL3AkvnLcKqFmhoJ00nsKHKCXizM94hGy1DSdo=s176-c-k-c0x00ffffff-no-rj-mo", "channelid": "UCyXm7QL-vmBIZcYCoPfmXgw", "channeltitle": "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ø­Ø±ÙŠ"},
            {"name":"ØªØ±ØªÙŠÙ„-@TarteelArabic", "image":"https://yt3.googleusercontent.com/pUYEmNtUgk7zmyKXVwzTyYCfli0AavVRgAomZITpyh3i6HT0mk35CCJv32Ra79-gKk276qSeYfw=s900-c-k-c0x00ffffff-no-rj", "channelid": "UCHVX6sawuLNAuRbJdfruXVA", "channeltitle": "ØªØ±ØªÙŠÙ„"},
            {"name":"Ù‚Ù†Ø§Ø© Ø§Ø®Ø¶Ø±", "image":"https://yt3.ggpht.com/CNJHtl9UOLJwzpGI6_8meaFK6-nWkaXABqu4cXfx2oZnTZmvYgHANXoOY-IpGlNk2U9I5nbIX9I=s176-c-k-c0x00ffffff-no-rj-mo", "channelid": "UCtUor2SqesPS3b_SMFtLT_w", "channeltitle": "Ø£Ø®Ø¶Ø±"},
            {"name":"Ø§Ø°Ø§Ø¹Ø© Ù…Ø®ØªÙ„Ù", "image":"https://yt3.ggpht.com/73c3-iw_Lubnz8tI6uxN17s1p8kOvwwsF5tatPe3JYAw_SRKeJfjprdH2wxHGPz3UHBM9NDxzs0=s176-c-k-c0x00ffffff-no-rj-mo", "channelid": "UC8vdjzu_0QMQlG9qNT5D_AQ", "channeltitle": "Ø¥Ø°Ø§Ø¹Ø© Ù…Ø®ØªÙ„Ù"},
            {"name":"Qtratel", "image":"https://yt3.googleusercontent.com/4op5oT580d20t3w4i4dWjZmfT1YkVSDok-MVlx-c1--EaYt-wZuw1tebFOc-iQ_XRMfUIO0gYA=s160-c-k-c0x00ffffff-no-rj", "channelid": "", "channeltitle": ""},
            {"name":"Mohamed abubakr", "image":"https://yt3.ggpht.com/yp7xPPh1JotsxKkOMos1KWumw7UFFibydMnoPzhP100gsUGWnDXRTAhdV88gd6coAPkXQ5n1Rw=s176-c-k-c0x00ffffff-no-rj-mo", "channelid": "UC9i6gCxiph_aBj68Xs9Iqng", "channeltitle": "Mohamed Aboubakr"},
            {"name":"Ø¨ÙˆØ¯ÙƒØ§Ø³Øª", "image":"https://yt3.googleusercontent.com/0Vs32Zwp0qjXovZuV0kCCxCkKkCdTpAn_9_tky7mxQUM69EIrWK_oJawKy_fKpzL1KZN0LG7=s160-c-k-c0x00ffffff-no-rj", "channelid": "", "channeltitle": ""},
            {"name":"Ø±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª","image":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEwIDEzYTUgNSAwIDAgMCA3LjU0LjU0bDMtM2E1IDUgMCAwIDAtNy4wNy03LjA3bC0xLjcyIDEuNzIiLz48cGF0aCBkPSJNMTQgMTFhNSA1IDAgMCAwLTcuNTQtLjU0bC0zIDNhNSA1IDAgMCAwIDcuMDcgNy4wN2wxLjcyLTEuNzIiLz48L3N2Zz4=", "channelid": "", "channeltitle": ""}
        ];
        
        const youtubeSurahSuggestions = ["Ø§Ù„ÙØ§ØªØ­Ø©","Ø§Ù„Ø¨Ù‚Ø±Ø©","Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†","Ø§Ù„Ù†Ø³Ø§Ø¡","Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©","Ø§Ù„Ø£Ù†Ø¹Ø§Ù…","Ø§Ù„Ø£Ø¹Ø±Ø§Ù","Ø§Ù„Ø£Ù†ÙØ§Ù„","Ø§Ù„ØªÙˆØ¨Ø©","ÙŠÙˆÙ†Ø³","Ù‡ÙˆØ¯","ÙŠÙˆØ³Ù","Ø§Ù„Ø±Ø¹Ø¯","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø§Ù„Ø­Ø¬Ø±","Ø§Ù„Ù†Ø­Ù„","Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡","Ø§Ù„ÙƒÙ‡Ù","Ù…Ø±ÙŠÙ…","Ø·Ù‡","Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡","Ø§Ù„Ø­Ø¬","Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†","Ø§Ù„Ù†ÙˆØ±","Ø§Ù„ÙØ±Ù‚Ø§Ù†","Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡","Ø§Ù„Ù†Ù…Ù„","Ø§Ù„Ù‚ØµØµ","Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª","Ø§Ù„Ø±ÙˆÙ…","Ù„Ù‚Ù…Ø§Ù†","Ø§Ù„Ø³Ø¬Ø¯Ø©","Ø§Ù„Ø£Ø­Ø²Ø§Ø¨","Ø³Ø¨Ø£","ÙØ§Ø·Ø±","ÙŠØ³","Ø§Ù„ØµØ§ÙØ§Øª","Øµ","Ø§Ù„Ø²Ù…Ø±","ØºØ§ÙØ±","ÙØµÙ„Øª","Ø§Ù„Ø´ÙˆØ±Ù‰","Ø§Ù„Ø²Ø®Ø±Ù","Ø§Ù„Ø¯Ø®Ø§Ù†","Ø§Ù„Ø¬Ø§Ø«ÙŠØ©","Ø§Ù„Ø£Ø­Ù‚Ø§Ù","Ù…Ø­Ù…Ø¯","Ø§Ù„ÙØªØ­","Ø§Ù„Ø­Ø¬Ø±Ø§Øª","Ù‚","Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª","Ø§Ù„Ø·ÙˆØ±","Ø§Ù„Ù†Ø¬Ù…","Ø§Ù„Ù‚Ù…Ø±","Ø§Ù„Ø±Ø­Ù…Ù†","Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©","Ø§Ù„Ø­Ø¯ÙŠØ¯","Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©","Ø§Ù„Ø­Ø´Ø±","Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©","Ø§Ù„ØµÙ","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†","Ø§Ù„ØªØºØ§Ø¨Ù†","Ø§Ù„Ø·Ù„Ø§Ù‚","Ø§Ù„ØªØ­Ø±ÙŠÙ…","Ø§Ù„Ù…Ù„Ùƒ","Ø§Ù„Ù‚Ù„Ù…","Ø§Ù„Ø­Ø§Ù‚Ø©","Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬","Ù†ÙˆØ­","Ø§Ù„Ø¬Ù†","Ø§Ù„Ù…Ø²Ù…Ù„","Ø§Ù„Ù…Ø¯Ø«Ø±","Ø§Ù„Ù‚ÙŠØ§Ù…Ø©","Ø§Ù„Ø¥Ù†Ø³Ø§Ù†","Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª","Ø§Ù„Ù†Ø¨Ø£","Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª","Ø¹Ø¨Ø³","Ø§Ù„ØªÙƒÙˆÙŠØ±","Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±","Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚","Ø§Ù„Ù…Ø·ÙÙÙŠÙ†","Ø§Ù„Ø¨Ø±ÙˆØ¬","Ø§Ù„Ø·Ø§Ø±Ù‚","Ø§Ù„Ø£Ø¹Ù„Ù‰"];
        const surahToJuzMap = {"Ø§Ù„ÙØ§ØªØ­Ø©":1,"Ø§Ù„Ø¨Ù‚Ø±Ø©":1,"Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†":3,"Ø§Ù„Ù†Ø³Ø§Ø¡":4,"Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©":6,"Ø§Ù„Ø£Ù†Ø¹Ø§Ù…":7,"Ø§Ù„Ø£Ø¹Ø±Ø§Ù":8,"Ø§Ù„Ø£Ù†ÙØ§Ù„":9,"Ø§Ù„ØªÙˆØ¨Ø©":10,"ÙŠÙˆÙ†Ø³":11,"Ù‡ÙˆØ¯":11,"ÙŠÙˆØ³Ù":12,"Ø§Ù„Ø±Ø¹Ø¯":13,"Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…":13,"Ø§Ù„Ø­Ø¬Ø±":14,"Ø§Ù„Ù†Ø­Ù„":14,"Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡":15,"Ø§Ù„ÙƒÙ‡Ù":15,"Ù…Ø±ÙŠÙ…":16,"Ø·Ù‡":16,"Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡":17,"Ø§Ù„Ø­Ø¬":17,"Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†":18,"Ø§Ù„Ù†ÙˆØ±":18,"Ø§Ù„ÙØ±Ù‚Ø§Ù†":18,"Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡":19,"Ø§Ù„Ù†Ù…Ù„":19,"Ø§Ù„Ù‚ØµØµ":20,"Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª":20,"Ø§Ù„Ø±ÙˆÙ…":21,"Ù„Ù‚Ù…Ø§Ù†":21,"Ø§Ù„Ø³Ø¬Ø¯Ø©":21,"Ø§Ù„Ø£Ø­Ø²Ø§Ø¨":21,"Ø³Ø¨Ø£":22,"ÙØ§Ø·Ø±":22,"ÙŠØ³":22,"Ø§Ù„ØµØ§ÙØ§Øª":23,"Øµ":23,"Ø§Ù„Ø²Ù…Ø±":23,"ØºØ§ÙØ±":24,"ÙØµÙ„Øª":24,"Ø§Ù„Ø´ÙˆØ±Ù‰":25,"Ø§Ù„Ø²Ø®Ø±Ù":25,"Ø§Ù„Ø¯Ø®Ø§Ù†":25,"Ø§Ù„Ø¬Ø§Ø«ÙŠØ©":25,"Ø§Ù„Ø£Ø­Ù‚Ø§Ù":26,"Ù…Ø­Ù…Ø¯":26,"Ø§Ù„ÙØªØ­":26,"Ø§Ù„Ø­Ø¬Ø±Ø§Øª":26,"Ù‚":26,"Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª":27,"Ø§Ù„Ø·ÙˆØ±":27,"Ø§Ù„Ù†Ø¬Ù…":27,"Ø§Ù„Ù‚Ù…Ø±":27,"Ø§Ù„Ø±Ø­Ù…Ù†":27,"Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©":27,"Ø§Ù„Ø­Ø¯ÙŠØ¯":27,"Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©":28,"Ø§Ù„Ø­Ø´Ø±":28,"Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©":28,"Ø§Ù„ØµÙ":28,"Ø§Ù„Ø¬Ù…Ø¹Ø©":28,"Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†":28,"Ø§Ù„ØªØºØ§Ø¨Ù†":28,"Ø§Ù„Ø·Ù„Ø§Ù‚":28,"Ø§Ù„ØªØ­Ø±ÙŠÙ…":28,"Ø§Ù„Ù…Ù„Ùƒ":29,"Ø§Ù„Ù‚Ù„Ù…":29,"Ø§Ù„Ø­Ø§Ù‚Ø©":29,"Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬":29,"Ù†ÙˆØ­":29,"Ø§Ù„Ø¬Ù†":29,"Ø§Ù„Ù…Ø²Ù…Ù„":29,"Ø§Ù„Ù…Ø¯Ø«Ø±":29,"Ø§Ù„Ù‚ÙŠØ§Ù…Ø©":29,"Ø§Ù„Ø¥Ù†Ø³Ø§Ù†":29,"Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª":29,"Ø§Ù„Ù†Ø¨Ø£":30,"Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª":30,"Ø¹Ø¨Ø³":30,"Ø§Ù„ØªÙƒÙˆÙŠØ±":30,"Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±":30,"Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚":30,"Ø§Ù„Ù…Ø·ÙÙÙŠÙ†":30,"Ø§Ù„Ø¨Ø±ÙˆØ¬":30,"Ø§Ù„Ø·Ø§Ø±Ù‚":30,"Ø§Ù„Ø£Ø¹Ù„Ù‰":30};
        const juzColors =  [
  // ğŸ”µ Blues
  "#2563eb", // Strong Blue
  "#3b82f6", // Blue
  "#0ea5e9", // Sky Blue
  "#0891b2", // Deep Cyan
  "#06b6d4", // Cyan
  "#14b8a6", // Teal
  "#0d9488", // Dark Teal

  // ğŸŸ£ Purples / Violets
  "#6366f1", // Indigo
  "#4f46e5", // Deep Indigo
  "#6d28d9", // Royal Violet
  "#8b5cf6", // Violet
  "#a855f7", // Purple
  "#9333ea", // Electric Purple
  "#c026d3", // Magenta
  "#d946ef", // Fuchsia

  // ğŸŒ¸ Pinks / Rose
  "#ec4899", // Pink
  "#be185d", // Dark Pink
  "#f43f5e", // Rose
  "#fb7185", // Coral

  // ğŸ”´ Reds
  "#ef4444", // Red
  "#dc2626", // Crimson

  // ğŸŸ  Oranges
  "#ea580c", // Burnt Orange
  "#f97316", // Orange

  // ğŸŸ¡ Yellows / Gold
  "#f59e0b", // Amber
  "#139c7e", // tealy
  "#c99716", // Gold
  "#7a6510", // dark gold
  "#ca8a04", // Dark Mustard

  // ğŸŸ¢ Greens
  "#22c55e", // Green
  "#16a34a", // Strong Green
  "#10b981", // Emerald
  "#059669", // Dark Emerald

  // âš« Dark / Neutral
  "#1e293b", // Slate Dark
];
        function resetYoutubeSearchUI() {
            const suggestionsContent = document.getElementById('suggestions-content');
            if (suggestionsContent) {
                suggestionsContent.innerHTML = ''; // Clear old suggestions
                suggestionsContent.classList.remove('hidden'); //  ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ù…Ø¬Ø¯Ø¯Ø§Ù‹
            }
            
            // Ø¥ØµÙ„Ø§Ø­: Ø¥Ø²Ø§Ù„Ø© Ù‚Ø³Ù… Ø§Ù„Ø³ÙˆØ± Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            const existingSurahSection = document.getElementById('youtube-surah-section');
            if (existingSurahSection) {
                existingSurahSection.remove();
            }
            
            youtubeSuggestionsDiv.style.display = 'flex';
            selectedReaderName = '';
            youtubeSearchInput.value = '';

            if (lastSuccessfulSearchQuery) {
                backToSearchFloatingButton.style.display = 'flex';
            } else {
                backToSearchFloatingButton.style.display = 'none';
            }

            displayLastWatchedVideo(); // This will populate #last-watched-container
            populateYoutubeSuggestions(); // This will populate #suggestions-content
        }
        
        /**
 * UPDATED: Handles the click event for readers, channels, and special tools.
 * Applies specific formatting for the 'BALWASL' tool.
 */
function handleReaderOrToolClick(selection, tabContainer, tabsContentContainer) {
    let newInputValue = '';

    if (selection === "Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ¹Ø¨Ø© ÙÙŠ") {
        selectedReaderName = '';
        newInputValue = 'Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ¹Ø¨Ø© ÙÙŠ ';
    } else if (selection === "JUST_SURAH") {
        selectedReaderName = '';
        newInputValue = '';
    } else if (selection === "BALWASL") { // ğŸ›‘ NEW LOGIC FOR "Ø¨Ø§Ù„ÙˆØµÙ„"
        selectedReaderName = 'Ø¨Ø§Ù„ÙˆØµÙ„'; // Ù†Ø­ÙØ¸ 'Ø¨Ø§Ù„ÙˆØµÙ„' ÙƒÙ‚Ø§Ø±Ø¦ Ù„ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§
        newInputValue = 'Ø¨Ø§Ù„ÙˆØµÙ„ '; // Ø§Ù„Ø³ÙˆØ±Ø© Ø³ØªØ£ØªÙŠ Ù‚Ø¨Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø©
    } else if (selection === "Ù‚ØµØµ" || selection === "Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù†Ø²ÙˆÙ„" || selection === "Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØªØ¬ÙˆÙŠØ¯" || selection === "Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª" || selection === "Ø±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª") {
        selectedReaderName = selection;
        newInputValue = selection + ' '; // Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø© + Ù…Ø³Ø§ÙØ©
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø§Ø±Ø¦Ø§Ù‹ Ø¹Ø§Ø¯ÙŠØ§Ù‹
        selectedReaderName = selection;
        newInputValue = selection + ' ';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    youtubeSearchInput.value = newInputValue;

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³ÙˆØ± (ÙƒÙ…Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ)
    tabContainer.style.display = 'none';
    tabsContentContainer.style.display = 'none';
    showSurahSuggestions();
    
    setTimeout(() => {
        const firstSurahButton = document.querySelector('#youtube-surah-section .grid-item');
        if (firstSurahButton) setFocus(firstSurahButton);
    }, 100);
}

/**
 * NEW: Removes a reciter entry from the global cache and updates the JSONBin Reciters list.
 * @param {string} reciterName - The name of the reciter to remove.
 */
async function removeReciterFromList(reciterName) {
    if (!reciterName) return;

    try {
        // 1. ØªØµÙÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø±Ø¦
        const updatedList = localRecitersCache.filter(r => r.name !== reciterName);
        
        // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ø¥Ù„Ù‰ JSONBin
        const success = await updateRecitersList(updatedList); // Ù†ÙØªØ±Ø¶ Ø£Ù† updateRecitersList ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ùˆ localRecitersCache
        
        if (success) {
            showMessageBox(`ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø±Ø¦ "${reciterName}" Ø¨Ù†Ø¬Ø§Ø­.`);
            
            // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù‚Ø±Ø§Ø¡ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØºÙŠÙŠØ±
            const suggestionsContent = document.getElementById('suggestions-content');
            if(suggestionsContent) {
                // Clear and re-populate the suggestions tabs
                suggestionsContent.innerHTML = '';
                await populateYoutubeSuggestions();
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù‚Ø±Ø§Ø¡
                document.getElementById('tab-reciters')?.click();
            }
        }
    } catch (error) {
        console.error("Error removing reciter:", error);
        showMessageBox(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø±Ø¦ ${reciterName}.`);
    }
}
async function populateYoutubeSuggestions() {
    const suggestionsContent = document.getElementById('suggestions-content');
    if (!suggestionsContent) {
        console.error("suggestions-content element not found!");
        return;
    }
    console.log("[Debug] Starting populateYoutubeSuggestions...");

    suggestionsContent.innerHTML = '';
    suggestionsContent.className = 'flex flex-col gap-4 w-full';

    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Tab Structure)
    const tabContainer = document.createElement('div');
    tabContainer.className = 'tabs-container flex p-1 rounded-full bg-black/20 self-center';

    const recitersTabButton = document.createElement('button');
    recitersTabButton.id = 'tab-reciters';
    recitersTabButton.className = 'tab-button active navigable grid-item';
    recitersTabButton.tabIndex = 0;
    recitersTabButton.textContent = 'Ø§Ù„Ù‚Ø±Ø§Ø¡';

    const channTabButton = document.createElement('button');
    channTabButton.id = 'tab-channels';
    channTabButton.className = 'tab-button navigable grid-item';
    channTabButton.tabIndex = 0;
    channTabButton.textContent = 'Ù‚Ù†ÙˆØ§Øª';

    const toolsTabButton = document.createElement('button');
    toolsTabButton.id = 'tab-tools';
    toolsTabButton.className = 'tab-button navigable grid-item';
    toolsTabButton.tabIndex = 0;
    toolsTabButton.textContent = 'Ø£Ø¯ÙˆØ§Øª';

    const savedMTabButton = document.createElement('button');
    savedMTabButton.id = 'tab-saved-m';
    savedMTabButton.className = 'tab-button navigable grid-item';
    savedMTabButton.tabIndex = 0;
    savedMTabButton.textContent = 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø§Ù„ØªÙ„ÙØ§Ø²';

    const savedDTabButton = document.createElement('button');
    savedDTabButton.id = 'tab-saved-d';
    savedDTabButton.className = 'tab-button navigable grid-item';
    savedDTabButton.tabIndex = 0;
    savedDTabButton.textContent = 'Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø©';

    tabContainer.appendChild(recitersTabButton);
    tabContainer.appendChild(channTabButton);
    tabContainer.appendChild(toolsTabButton);
    tabContainer.appendChild(savedMTabButton);
    tabContainer.appendChild(savedDTabButton);

    const tabsContentContainer = document.createElement('div');
    tabsContentContainer.id = 'tabs-content-container';
    tabsContentContainer.className = 'flex-grow w-full overflow-y-auto';

    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ø­ (Content Panels)
    const recitersContent = document.createElement('div');
    recitersContent.id = 'tab-content-reciters';
    recitersContent.className = 'tab-content';
    const readerButtonsContainer = document.createElement('div');
    readerButtonsContainer.className = 'reader-container';
    readerButtonsContainer.dir = 'rtl';
    recitersContent.appendChild(readerButtonsContainer);

    const channContent = document.createElement('div');
    channContent.id = 'tab-content-channels';
    channContent.className = 'tab-content hidden';
    const channButtonsContainer = document.createElement('div');
    channButtonsContainer.className = 'reader-container';
    channButtonsContainer.dir = 'rtl';
    channContent.appendChild(channButtonsContainer);

    const toolsContent = document.createElement('div');
    toolsContent.id = 'tab-content-tools';
    toolsContent.className = 'tab-content hidden';
    const toolsButtonsContainer = document.createElement('div');
    toolsButtonsContainer.className = 'reader-container';
    toolsContent.appendChild(toolsButtonsContainer);

    const savedDContent = document.createElement('div');
    savedDContent.id = 'tab-content-saved-d';
    savedDContent.className = 'tab-content hidden h-full';
    savedDContent.innerHTML = `<div id="favorites-d-grid" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>`;

    const savedMContent = document.createElement('div');
    savedMContent.id = 'tab-content-saved-m';
    savedMContent.className = 'tab-content hidden h-full';
    savedMContent.innerHTML = `<div id="favorites-m-grid" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>`;

    // 3. Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    try {
        // -----------------------------------------------------
        // ğŸš€ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù‚Ø±Ø§Ø¡ (Reciters) - Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        // -----------------------------------------------------
        let recitersList = localRecitersCache; 
        if (!recitersList || recitersList.length === 0) {
            recitersList = await fetchRecitersList();
        }
        
        if (Array.isArray(recitersList)) {
            recitersList.sort((a, b) => (parseInt(b?.clicksreciter, 10) || 0) - (parseInt(a?.clicksreciter, 10) || 0));
        } else {
            recitersList = [];
        }
        
        readerButtonsContainer.innerHTML = '';
        let displayElements = [];
        
        recitersList.forEach((reader, index) => {
            if (!reader || !reader.name) return;

            const card = document.createElement('div');
            card.className = 'youtube-reader-card navigable grid-item relative group';
            card.setAttribute('tabindex', '0');
            card.tabIndex = 0;
            // ğŸ’¡ Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙˆÙ„ ÙŠØ£Ø®Ø° order: 1ØŒ ÙˆØ§Ù„Ø¨Ù‚ÙŠØ© ØªØ¨Ø¯Ø£ Ù…Ù† 3 (Ù„ØªÙØ³Ø­ Ø§Ù„Ù…Ø¬Ø§Ù„ Ù„Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
            card.style.order = (index < 1) ? 1 : index + 2; 

            const imageUrl = reader.image || 'https://placehold.co/100x100/334155/ffffff?text=Q';

            card.innerHTML = `
                <button class="delete-channel-btn absolute bottom-2 right-2 p-1.5 bg-red-600/80 hover:bg-red-500 rounded-full transition-colors z-10 navigable grid-item" title="Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø±Ø¦" tabindex="0">
                    <i data-lucide="trash-2" class="w-4 h-4 text-white pointer-events-none"></i>
                </button>
                <h3>${reader.name}</h3>
                <img src="${imageUrl}" alt="${reader.name}" onerror="this.onerror=null;this.src='https://placehold.co/100x100';">
            `;

            card.addEventListener('click', (e) => {
                if (e.target.closest('.delete-channel-btn')) return; 

                if (reader.name === "Ø§Ù„Ø±Ù‚ÙŠØ©" || reader.name === "Ø±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª") {
                    handleReaderOrToolClick(reader.name, tabContainer, tabsContentContainer);
                } else {
                    incrementReciterClick(reader.name);
                    handleReaderOrToolClick(reader.name, tabContainer, tabsContentContainer);
                }
            });
            
            const deleteBtn = card.querySelector('.delete-channel-btn');
            deleteBtn?.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                removeReciterFromList(reader.name); 
            });

            displayElements.push(card);
        });

        // ğŸ›‘ Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø±Ø¦" ÙˆÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ (order: 2)
        const addReciterCard = document.createElement('div');
        addReciterCard.className = 'youtube-reader-card navigable grid-item';
        addReciterCard.tabIndex = 0;
        addReciterCard.style.order = 2; // ğŸ‘ˆ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ: ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù†ØµØ± Ø°ÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ 1
        addReciterCard.innerHTML = `<h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø±Ø¦</h3><div class="w-[100px] h-[100px] rounded-full border-2 border-dashed border-white/30 flex items-center justify-center bg-black/20"><i data-lucide="plus" class="w-12 h-12 text-white/50"></i></div>`;
        addReciterCard.addEventListener('click', showAddReciterPrompt);
        
        displayElements.push(addReciterCard);
        
        // Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
        displayElements.forEach(el => readerButtonsContainer.appendChild(el));


        // -----------------------------------------------------
        // ğŸŒ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª (Channels) - Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        // -----------------------------------------------------
        let channList = localChannelsCache; 
        if (!channList || channList.length === 0) {
             channList = await fetchChannelsList(); 
        }

        if (Array.isArray(channList)) {
            channList.sort((a, b) => (parseInt(b?.clickschannel, 10) || 0) - (parseInt(a?.clickschannel, 10) || 0));
        } else {
            channList = [];
        }
        
        const channelIdsToFetch = channList.filter(r => r && r.channelid).map(r => r.channelid);
        const channelThumbnails = channelIdsToFetch.length > 0 ? await fetchChannelsDetails(channelIdsToFetch) : {};
        channButtonsContainer.innerHTML = '';
        
        let channelDisplayElements = [];

        channList.forEach((reader, index) => {
             if (!reader || typeof reader !== 'object') return;
             const card = document.createElement('div');
             card.className = 'youtube-reader-card navigable grid-item relative group';
             card.tabIndex = 0;
             card.style.order = (index < 1) ? 1 : index + 2; // ğŸ‘ˆ Ø§Ù„ØªØ±ØªÙŠØ¨: 1ØŒ 3ØŒ 4ØŒ 5...
             const imageUrl = reader.channelid ? (channelThumbnails[reader.channelid] || 'https://placehold.co/100x100/334155/ffffff?text=?') : (reader.image || 'https://placehold.co/100x100/334155/ffffff?text=?');
             card.innerHTML = `
                 <button class="delete-channel-btn absolute bottom-2 right-2 p-1.5 bg-red-600/80 hover:bg-red-500 rounded-full transition-colors z-10 navigable grid-item" title="Ø­Ø°Ù Ø§Ù„Ù‚Ù†Ø§Ø©" tabindex="0"><i data-lucide="trash-2" class="w-4 h-4 text-white pointer-events-none"></i></button>
                 <h3>${reader.name}</h3>
                 <img src="${imageUrl}" alt="${reader.name}" onerror="this.onerror=null;this.src='https://placehold.co/64x64';">`;
             
             card.addEventListener('click', (e) => {
                 if (e.target.closest('.delete-channel-btn')) return;
                 if (reader.channelid && reader.channeltitle) {
                     incrementChannelClick(reader.channelid);
                     searchVideosByChannel(reader.channelid, reader.channeltitle);
                 } else {
                     handleReaderOrToolClick(reader.name, tabContainer, tabsContentContainer);
                 }
             });
             const deleteChannBtn = card.querySelector('.delete-channel-btn');
             deleteChannBtn?.addEventListener('click', (e) => { e.stopPropagation(); removeChannelFromList(reader.channelid, reader.name); });
             
             channelDisplayElements.push(card);
        });

        // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© ÙˆÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ
        const addChannelCard = document.createElement('div');
        addChannelCard.className = 'youtube-reader-card navigable grid-item';
        addChannelCard.tabIndex = 0;
        addChannelCard.style.order = 2; // ğŸ‘ˆ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ
        addChannelCard.innerHTML = `<h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©</h3><div class="w-[100px] h-[100px] rounded-full border-2 border-dashed border-white/30 flex items-center justify-center bg-black/20"><i data-lucide="plus" class="w-12 h-12 text-white/50"></i></div>`;
        addChannelCard.addEventListener('click', showAddChannelPrompt);
        
        channelDisplayElements.push(addChannelCard);
        
        channelDisplayElements.forEach(el => channButtonsContainer.appendChild(el)); // Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±

        // --- Populating Tools (Existing Logic) ---
        const tools = [
            { name: "Ø±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª", icon: "link", action: "Ø±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª" },
            { name: "Ù‚ØµØµ", icon: "book-open-check", action: "Ù‚ØµØµ" },
            { name: "Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù†Ø²ÙˆÙ„", icon: "feather", action: "Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù†Ø²ÙˆÙ„" },
            { name: "Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØªØ¬ÙˆÙŠØ¯", icon: "volume-2", action: "Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØªØ¬ÙˆÙŠØ¯" },
            { name: "Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª", icon: "layers-3", action: "Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª" },
            { name: "Ø¨Ø§Ù„ÙˆØµÙ„", icon: "type", specialAction: "BALWASL" }, // ğŸ‘ˆ Ø§Ù„Ø£Ø¯Ø§Ø© Ø°Ø§Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®Ø§Øµ
            { name: "ÙÙ‚Ø· Ø§Ù„Ø³ÙˆØ±Ø©", icon: "book-open", specialAction: "JUST_SURAH" }
        ];

        toolsButtonsContainer.innerHTML = '';

       tools.forEach(tool => {
            const card = document.createElement('div');
            card.className = 'youtube-reader-card navigable grid-item';
            card.tabIndex = 0;
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… action Ø£Ùˆ specialAction Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªÙ…Ø±ÙŠØ±Ù‡Ø§
            const selectionValue = tool.specialAction || tool.action; 

            card.innerHTML = `<h3>${tool.name}</h3><div class="w-[100px] h-[100px] rounded-full border-2 border-white/30 flex items-center justify-center bg-black/20"><i data-lucide="${tool.icon}" class="w-12 h-12 text-white/50"></i></div>`;
            
            card.addEventListener('click', () => handleReaderOrToolClick(selectionValue, tabContainer, tabsContentContainer));
            toolsButtonsContainer.appendChild(card);
        });
        
        // --- Tab Switching Logic ---
        const tabs = [recitersTabButton, channTabButton, toolsTabButton, savedDTabButton, savedMTabButton];
        const contents = [recitersContent, channContent, toolsContent, savedDContent, savedMContent];

       tabs.forEach((tab, index) => {
    tab.addEventListener('click', () => {
        // 1. Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ Ø¨ÙŠÙ† Ø§Ù„ØªØ§Ø¨Ø§Øª
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.add('hidden'));
        tab.classList.add('active');
        contents[index].classList.remove('hidden');

        // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        if (tab.id === 'tab-saved-d') { loadSavedVideos('D'); } 
        else if (tab.id === 'tab-saved-m') { loadSavedVideos('M'); }

        // 3. ğŸš€ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ÙƒØ±ÙˆØª ÙÙŠ Ø§Ù„Ù€ DOM
        setTimeout(() => {
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†Ù‚Ù„ Ù„ØªØ´Ù…Ù„ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            if (typeof updateNavigableElements === 'function') {
                updateNavigableElements();
            }

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ ÙƒØ§Ø±Øª (grid-item) Ø£Ùˆ Ø£ÙŠ Ø¹Ù†ØµØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù…Ù„Ø§Ø­Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø·
            const firstItem = contents[index].querySelector('.grid-item, .navigable');
            
            if (firstItem) {
                // Ø³Ø­Ø¨ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù…Ù† Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ±ÙˆØª Ù…Ø¨Ø§Ø´Ø±Ø©
                setFocus(firstItem); 
                console.log("ğŸ¯ Focus moved to content: " + tab.textContent);
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ÙƒØ±ÙˆØª (Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©)ØŒ Ø§Ø¨Ù‚Ù Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø¨ Ù†ÙØ³Ù‡
                setFocus(tab);
            }
        }, 200); // 200 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© ÙƒØ§ÙÙŠØ© Ù„Ø±Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ CarPlay UI
    });
});

    } catch (error) {
        console.log("[Debug] Error in populating tabs:", error);
    }
    
    // 4. ØªØ¬Ù…ÙŠØ¹ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
    suggestionsContent.appendChild(tabContainer);
    tabsContentContainer.appendChild(recitersContent);
    tabsContentContainer.appendChild(channContent);
    tabsContentContainer.appendChild(toolsContent);
    tabsContentContainer.appendChild(savedDContent);
    tabsContentContainer.appendChild(savedMContent);
    suggestionsContent.appendChild(tabsContentContainer);

    lucide.createIcons();
    updateNavigableElements();
}

async function handleSearchForReciterChannel() {
    // ğŸ›‘ Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§ Ø§Ù„Ù…ÙØ¹Ø±Ù‘Ù Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    const inputEl = document.getElementById('new-reciter-name-input'); 
    const resultsContainer = document.getElementById('channel-search-results'); // Ù†ÙØ³ Ø§Ø³Ù… Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const confirmBtn = document.getElementById('search-channel-confirm'); // Ù†ÙØ³ Ø§Ø³Ù… Ø²Ø± Ø§Ù„Ø¨Ø­Ø«
    const query = inputEl.value.trim();

    if (!query) {
        showMessageBox("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦/Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ù„Ø¨Ø­Ø«.");
        return;
    }
    // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ£ÙƒØ¯) ...
    // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ£ÙƒØ¯) ...

    try {
        // ğŸ›‘ API Call: Filtered for Channel Type and Arabic Relevance
        const API_URL = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=channel&key=${YOUTUBE_API_KEY}&maxResults=10&relevanceLanguage=ar`; 
        
        const response = await fetch(API_URL);
        
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        displayReciterSearchResults(data.items);
        
    } catch (error) {
        // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø·Ø£) ...
    } finally {
        // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„) ...
    }
}

/**
 * NEW: Displays the search results (channels) inside the "Add Reciter" modal.
 * It creates cards with an "Add" button, which calls handleAddReciter.
 * @param {Array} channels - List of channel search results from YouTube API.
 */
function displayReciterSearchResults(channels) {
    const resultsContainer = document.getElementById('channel-search-results');
    resultsContainer.innerHTML = '';

    if (!channels || channels.length === 0) {
        resultsContainer.innerHTML = '<p class="text-center text-white/70">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.</p>';
        updateNavigableElements();
        return;
    }

    channels.forEach(channel => {
        const channelId = channel.id.channelId;
        const channelTitle = channel.snippet.title;
        const channelThumbnail = channel.snippet.thumbnails.default.url;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø§Ø±Ø¦ (Ø§Ù„Ø§Ø³Ù…) Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡
        const isSaved = localRecitersCache.some(r => r.name === channelTitle); 

        const resultCard = document.createElement('div');
        resultCard.className = 'flex items-center gap-4 p-3 rounded-xl bg-white/5 navigable grid-item';
        resultCard.tabIndex = 0; // Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø§Ù„Ø±ÙŠÙ…ÙˆØª
        
        resultCard.innerHTML = `
            <img src="${channelThumbnail}" alt="${channelTitle}" class="w-16 h-16 rounded-full object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/64x64';">
            <div class="flex-grow min-w-0">
                <h4 class="font-bold truncate text-lg">${channelTitle}</h4>
                <p class="text-sm text-white/60 truncate">${channel.snippet.description || 'Ù‚Ù†Ø§Ø© ÙŠÙˆØªÙŠÙˆØ¨'}</p>
            </div>
            <button 
                class="add-reciter-from-search-btn p-2 rounded-full transition-colors flex-shrink-0 navigable grid-item" 
                data-reciter-name="${channelTitle}" 
                data-reciter-image="${channelThumbnail}"
                ${isSaved ? 'disabled' : ''}
                tabindex="0"
                style="background-color: ${isSaved ? '#10B981' : '#9333ea'};"
            >
                <i data-lucide="${isSaved ? 'check' : 'plus'}" class="w-5 h-5 text-white"></i>
            </button>
        `;
        resultsContainer.appendChild(resultCard);

        // Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        if (!isSaved) {
            resultCard.querySelector('.add-reciter-from-search-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const btn = e.currentTarget;
                const name = btn.dataset.reciterName;
                const image = btn.dataset.reciterImage;
                handleAddReciter(name, image, btn); 
            });
            // Ø±Ø¨Ø· Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù†ÙØ³Ù‡Ø§ Ø¨ÙØªØ­ Ø§Ù„Ù‚Ù†Ø§Ø© (Ù…ÙŠØ²Ø© Ø¥Ø¶Ø§ÙÙŠØ©)
            resultCard.addEventListener('click', (e) => {
                if(e.target.closest('button')) return; // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ù‹Ø§ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
                showMessageBox(`Ù„ØªØ´ØºÙŠÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø©ØŒ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø«Ù… Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.`);
            });
        } else {
             // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸Ù‹Ø§ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"
             resultCard.addEventListener('click', () => showMessageBox(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø±Ø¦ "${channelTitle}" Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¨Ø­Ø« Ø¨Ù‡ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·.`));
        }
    });
    
    lucide.createIcons();
    // ğŸ›‘ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    updateNavigableElements();
    
    // Ù†Ù‚Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¥Ù„Ù‰ Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø©
    setTimeout(() => {
        const firstResult = resultsContainer.querySelector('.grid-item');
        if (firstResult) setFocus(firstResult);
    }, 50);
}

/**
 * RENAMED & REFINED: Handles the search action specifically for finding a Reciter Channel.
 * Applies strong filtering for 'type=channel' and 'relevanceLanguage=ar'.
 */
async function handleSearchForReciterChannel() {
    // ğŸ›‘ Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§ Ø§Ù„Ù…ÙØ¹Ø±Ù‘Ù Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    const inputEl = document.getElementById('new-reciter-name-input'); 
    const resultsContainer = document.getElementById('channel-search-results'); // Ù†ÙØ³ Ø§Ø³Ù… Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const confirmBtn = document.getElementById('search-channel-confirm'); // Ù†ÙØ³ Ø§Ø³Ù… Ø²Ø± Ø§Ù„Ø¨Ø­Ø«
    const query = inputEl.value.trim();

    if (!query) {
        showMessageBox("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦/Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ù„Ø¨Ø­Ø«.");
        return;
    }
    // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ£ÙƒØ¯) ...
    // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ£ÙƒØ¯) ...

    try {
        // ğŸ›‘ API Call: Filtered for Channel Type and Arabic Relevance
        const API_URL = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=channel&key=${YOUTUBE_API_KEY}&maxResults=10&relevanceLanguage=ar`; 
        
        const response = await fetch(API_URL);
        
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        displayReciterSearchResults(data.items);
        
    } catch (error) {
        // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø·Ø£) ...
    } finally {
        // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„) ...
    }
}
/**
 * Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Lexus ES350
 * ÙŠØ¯Ù…Ø¬ Ø¨ÙŠÙ† Ø¯Ù‚Ø© Ø§Ù„Ù€ GPS ÙˆØ³Ù„Ø§Ø³Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ§Øª
 */

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ù„Ø§Ø³Ø©
// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„ØªØ­ÙƒÙ…
window.carOverlay = null; 
window.carModel = null;

async function setup3DCarMarker(map) {
    if (!map || window.carOverlay) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù‚Ø§Ø·Ø¹

    const loader = new window.GLTFLoader();
    const overlay = new google.maps.WebGLOverlayView();
    window.carOverlay = overlay;

    overlay.onAdd = () => {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera();
        scene.add(new THREE.AmbientLight(0xffffff, 5.5));
        const sun = new THREE.DirectionalLight(0xffffff, 4.4);
        sun.position.set(10, 25, 10);
        scene.add(sun);

       loader.load('https://dmusera.netlify.app/ES350E.gltf', (gltf) => {
            window.carModel = gltf.scene;
            
            window.carModel.traverse(node => {
                if (node.isMesh) {
                    // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø©
                    if (node.material) {
                        // Ù…Ù†Ø¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ù† Ø§Ù„Ø§Ù†Ø·ÙØ§Ø¡ Ø¨Ø³Ø¨Ø¨ ØºÙŠØ§Ø¨ Ø§Ù„Ø¶ÙˆØ¡ Ø§Ù„Ù…Ø­ÙŠØ·
                        node.material.emissive = node.material.color.clone().multiplyScalar(0.2); 
                        
                        // 2. Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ Ø§Ù„Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø§Ù„Ù…Ø¹Ø¯Ù†ÙŠØ© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©
                        node.material.metalness = 0.4; // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù†ÙŠØ© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                        node.material.roughness = 0.5; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø®Ø´ÙˆÙ†Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³Ø§Øª Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡

                        // 3. Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ± ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø®Ø§Ø·Ø¦Ø©
                        node.material.depthWrite = true;
                        node.material.transparent = false;
                        node.material.side = THREE.DoubleSide; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ ÙˆØ§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ø§Ù„Ø¯Ø§Ø®Ù„ ÙˆØ§Ù„Ø®Ø§Ø±Ø¬
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙˆØ±Ø§Ù‹
                        node.material.needsUpdate = true;
                    }
                }
            });

            window.carModel.rotation.x = Math.PI / 2;
            scene.add(window.carModel);
        });
        overlay.scene = scene; overlay.camera = camera;
    };

    overlay.onContextRestored = ({ gl }) => {
        overlay.renderer = new THREE.WebGLRenderer({
            canvas: gl.canvas, context: gl, antialias: true, alpha: true,
        });
        overlay.renderer.autoClear = false;
    };

    
    overlay.setMap(map);
}

function displayReciterSearchResults(channels) {
    const resultsContainer = document.getElementById('channel-search-results');
    resultsContainer.innerHTML = '';

    if (!channels || channels.length === 0) {
        resultsContainer.innerHTML = '<p class="text-center text-white/70">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.</p>';
        updateNavigableElements();
        return;
    }

    channels.forEach(channel => {
        const channelId = channel.id.channelId;
        const channelTitle = channel.snippet.title;
        const channelThumbnail = channel.snippet.thumbnails.default.url;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø§Ø±Ø¦ (Ø§Ù„Ø§Ø³Ù…) Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡
        const isSaved = localRecitersCache.some(r => r.name === channelTitle); 

        const resultCard = document.createElement('div');
        resultCard.className = 'flex items-center gap-4 p-3 rounded-xl bg-white/5 navigable grid-item';
        resultCard.tabIndex = 0; // Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø§Ù„Ø±ÙŠÙ…ÙˆØª
        
        resultCard.innerHTML = `
            <img src="${channelThumbnail}" alt="${channelTitle}" class="w-16 h-16 rounded-full object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/64x64';">
            <div class="flex-grow min-w-0">
                <h4 class="font-bold truncate text-lg">${channelTitle}</h4>
                <p class="text-sm text-white/60 truncate">${channel.snippet.description || 'Ù‚Ù†Ø§Ø© ÙŠÙˆØªÙŠÙˆØ¨'}</p>
            </div>
            <button 
                class="add-reciter-from-search-btn p-2 rounded-full transition-colors flex-shrink-0 navigable grid-item" 
                data-reciter-name="${channelTitle}" 
                data-reciter-image="${channelThumbnail}"
                ${isSaved ? 'disabled' : ''}
                tabindex="0"
                style="background-color: ${isSaved ? '#10B981' : '#9333ea'};"
            >
                <i data-lucide="${isSaved ? 'check' : 'plus'}" class="w-5 h-5 text-white"></i>
            </button>
        `;
        resultsContainer.appendChild(resultCard);

        // Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        if (!isSaved) {
            resultCard.querySelector('.add-reciter-from-search-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const btn = e.currentTarget;
                const name = btn.dataset.reciterName;
                const image = btn.dataset.reciterImage;
                handleAddReciter(name, image, btn); 
            });
            // Ø±Ø¨Ø· Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù†ÙØ³Ù‡Ø§ Ø¨ÙØªØ­ Ø§Ù„Ù‚Ù†Ø§Ø© (Ù…ÙŠØ²Ø© Ø¥Ø¶Ø§ÙÙŠØ©)
            resultCard.addEventListener('click', (e) => {
                if(e.target.closest('button')) return; // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ù‹Ø§ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
                showMessageBox(`Ù„ØªØ´ØºÙŠÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø©ØŒ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø«Ù… Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.`);
            });
        } else {
             // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸Ù‹Ø§ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"
             resultCard.addEventListener('click', () => showMessageBox(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø±Ø¦ "${channelTitle}" Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¨Ø­Ø« Ø¨Ù‡ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·.`));
        }
    });
    
    lucide.createIcons();
    // ğŸ›‘ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    updateNavigableElements();
    
    // Ù†Ù‚Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¥Ù„Ù‰ Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø©
    setTimeout(() => {
        const firstResult = resultsContainer.querySelector('.grid-item');
        if (firstResult) setFocus(firstResult);
    }, 50);
}

        function showSurahSuggestions() {
            const existing = document.getElementById('youtube-surah-section');
            if (existing) existing.remove();

            const lastWatchedContainer = document.getElementById('last-watched-container');
            if (lastWatchedContainer) lastWatchedContainer.classList.add('hidden');

            // Hide the main suggestions content container to remove the top gap
            const suggestionsContent = document.getElementById('suggestions-content');
            if (suggestionsContent) suggestionsContent.classList.add('hidden');

            const surahSection = document.createElement('div');
            surahSection.id = 'youtube-surah-section';
            surahSection.className = 'flex flex-col gap-2 p-3 rounded-xl glass-surface glass-surface--svg w-full flex-grow';

            // 1. Create Tab Structure
            const tabContainer = document.createElement('div');
            tabContainer.className = 'tabs-container flex p-1 rounded-full bg-black/20 self-center mb-2';

            const surahTabButton = document.createElement('button');
            surahTabButton.id = 'tab-surah';
            surahTabButton.className = 'tab-button active navigable grid-item';
            surahTabButton.tabIndex = 0;
            surahTabButton.textContent = 'Ø§Ù„Ø³ÙˆØ±Ø©';

            const juzTabButton = document.createElement('button');
            juzTabButton.id = 'tab-juz';
            juzTabButton.className = 'tab-button navigable grid-item';
            juzTabButton.tabIndex = 0;
            juzTabButton.textContent = 'Ø§Ù„Ø¬Ø²Ø¡';

            tabContainer.appendChild(surahTabButton);
            tabContainer.appendChild(juzTabButton);

            const tabsContentContainer = document.createElement('div');
            tabsContentContainer.id = 'tabs-content-container-surah';
            tabsContentContainer.className = 'flex-grow w-full overflow-hidden'; // Let inner container scroll

            // 2. Create Surah content panel
            const surahContent = document.createElement('div');
            surahContent.id = 'tab-content-surah';
            surahContent.className = 'tab-content h-full';
            
              const scrollableSurahContainer = document.createElement('div');
            scrollableSurahContainer.className = 'surah-buttons-scrollable h-full';
            const surahButtonsContainer = document.createElement('div');
            surahButtonsContainer.className = 'flex flex-wrap justify-center gap-2 w-full';
            
            youtubeSurahSuggestions.forEach(name => {
                const button = document.createElement('button');
                button.className = 'youtube-suggestion-button navigable grid-item';
                button.tabIndex = 0;
                button.innerHTML = `<span class="surah-name-text">${name}</span> <span class="juz-badge">${surahToJuzMap[name] || '?'}</span>`;
                button.style.backgroundColor = juzColors[(surahToJuzMap[name] || 1) - 1];
                // Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© showSurahSuggestions()ØŒ ÙÙŠ Ø­Ù„Ù‚Ø© youtubeSurahSuggestions.forEach(name => { ...

button.addEventListener('click', () => {
    let query = '';
    const currentInput = youtubeSearchInput.value.trim();
    const surahName = name; // Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø©

    if (currentInput.includes('Ø¨Ø§Ù„ÙˆØµÙ„')) { // ğŸ›‘ NEW: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ Ù‡Ùˆ 'Ø¨Ø§Ù„ÙˆØµÙ„'
        // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚: Ø³ÙˆØ±Ø© {Ø§Ù„Ø³ÙˆØ±Ø©} Ø¨Ø§Ù„ÙˆØµÙ„
        query = `Ø³ÙˆØ±Ø© ${surahName} Ø¨Ø§Ù„ÙˆØµÙ„`; 
        
    } else if (youtubeSearchInput.value.startsWith('Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ¹Ø¨Ø© ÙÙŠ')) {
        query = 'Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ¹Ø¨Ø© ÙÙŠ Ø³ÙˆØ±Ø© ' + surahName;
    } else if (currentInput === '') {
        query = 'Ø³ÙˆØ±Ø© ' + surahName;
    } else {
        // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ø¯ÙŠ: {Ø§Ù„Ù‚Ø§Ø±Ø¦/Ø§Ù„Ø£Ø¯Ø§Ø©} Ø³ÙˆØ±Ø© {Ø§Ù„Ø³ÙˆØ±Ø©}
        query = selectedReaderName + ' Ø³ÙˆØ±Ø© ' + surahName;
    }
    
    youtubeSearchInput.value = query;
    searchYouTubeVideos(query);
});
                surahButtonsContainer.appendChild(button);
            });
            scrollableSurahContainer.appendChild(surahButtonsContainer);
            surahContent.appendChild(scrollableSurahContainer);

            // 3. Create Juz content panel
            const juzContent = document.createElement('div');
            juzContent.id = 'tab-content-juz';
            juzContent.className = 'tab-content hidden h-full';

            const scrollableJuzContainer = document.createElement('div');
            scrollableJuzContainer.className = 'surah-buttons-scrollable h-full';
            const juzButtonsContainer = document.createElement('div');
            juzButtonsContainer.className = 'flex flex-wrap justify-center gap-2 w-full';

            for (let i = 1; i <= 30; i++) {
                const button = document.createElement('button');
                button.className = 'youtube-suggestion-button navigable grid-item';
                button.tabIndex = 0;
                button.style.backgroundColor = juzColors[(i % juzColors.length)];
                button.innerHTML = `Ø§Ù„Ø¬Ø²Ø¡ ${i}`;
                button.addEventListener('click', () => {
                    const juzName = juzArabicNames[i - 1];
                    let query = '';
                    const currentSearch = youtubeSearchInput.value;
                    if (currentSearch.trim() && !currentSearch.startsWith('Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ¹Ø¨Ø© ÙÙŠ')) {
                        query = currentSearch + `Ø§Ù„Ø¬Ø²Ø¡ ${juzName}`;
                    } else {
                        query = `Ø§Ù„Ø¬Ø²Ø¡ ${juzName}`;
                    }
                    youtubeSearchInput.value = query;
                    searchYouTubeVideos(query);
                });
                juzButtonsContainer.appendChild(button);
            }
            scrollableJuzContainer.appendChild(juzButtonsContainer);
            juzContent.appendChild(scrollableJuzContainer);

            // 4. Tab Switching Logic
            surahTabButton.addEventListener('click', () => {
                surahTabButton.classList.add('active');
                juzTabButton.classList.remove('active');
                surahContent.classList.remove('hidden');
                juzContent.classList.add('hidden');
                const firstItem = surahContent.querySelector('.grid-item');
                if (firstItem) setFocus(firstItem);
            });
            juzTabButton.addEventListener('click', () => {
                juzTabButton.classList.add('active');
                surahTabButton.classList.remove('active');
                juzContent.classList.remove('hidden');
                surahContent.classList.add('hidden');
                const firstItem = juzContent.querySelector('.grid-item');
                if (firstItem) setFocus(firstItem);
            });

            // 5. Append everything
            surahSection.appendChild(tabContainer);
            tabsContentContainer.appendChild(surahContent);
            tabsContentContainer.appendChild(juzContent);
            surahSection.appendChild(tabsContentContainer);
            youtubeSuggestionsDiv.appendChild(surahSection);
        }

        function navigateBackToMainSearch() { 
            youtubeVideoListView.classList.add('hidden'); 
            youtubeSearchResultsView.classList.add('hidden'); 
            youtubeSuggestionsDiv.style.display = 'flex'; 
            activeMediaView = 'suggestions'; 
            currentPlayingPlaylistId = ''; 
            backToPlaylistsBottomButton.style.display = 'none'; 
            backToPlaylistsBottomButtonSearch.style.display = 'none'; 
            
            // Ø¥ØµÙ„Ø§Ø­: Ø¥Ø²Ø§Ù„Ø© Ù‚Ø³Ù… Ø§Ù„Ø³ÙˆØ± Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
            const existingSurahSection = document.getElementById('youtube-surah-section');
            if (existingSurahSection) {
                existingSurahSection.remove();
            }
            
            resetYoutubeSearchUI(); 
            setTimeout(() => { const firstReader = youtubeSuggestionsDiv.querySelector('.grid-item'); if (firstReader) setFocus(firstReader); }, 100); 
        }

        // --- Google Map and Geolocation (REFACTORED FOR RELIABILITY) ---
       
        
        function showGeolocationErrorOnMap(message) {
            const overlay = document.getElementById('geolocation-error-overlay');
            const mapControls = document.querySelector('#dashboard-google-map ~ .absolute'); 

            if (overlay) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                if (message) {
                    const p = overlay.querySelector('p');
                    if (p) p.textContent = message;
                }
                lucide.createIcons();
            }
            if (mapControls) {
                mapControls.style.display = 'none';
            }
        }

        // --- Favorites (Bookmark) Functions ---
        function closeFavoritesMenu() {
            const existingMenu = document.querySelector('.favorites-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            // Remove the global click listener that was added to close the menu
             document.body.removeEventListener('click', closeFavoritesMenu);
        }

 function showFavoritesMenu(button, video) {
            closeFavoritesMenu(); // Close any existing menu first

            const menu = document.createElement('div');
            menu.className = 'favorites-menu';
            const rect = button.getBoundingClientRect();

            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.left = `${rect.left}px`;
            
            menu.innerHTML = `
                <button data-type="D" class="navigable grid-item" tabindex="0">
                     <i data-lucide="folder-plus" class="w-4 h-4 text-blue-400"></i> CAR LIST
                </button>
                <button data-type="M" class="navigable grid-item" tabindex="0">
                    <i data-lucide="folder-plus" class="w-4 h-4 text-pink-400"></i> TV LIST
                </button>
            `;

            document.body.appendChild(menu);
            menu.classList.add('show');

            menu.addEventListener('click', e => e.stopPropagation());

            menu.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const type = btn.dataset.type;
                    await saveVideoToFavorites(video, type);
                    closeFavoritesMenu();
                });
            });

            lucide.createIcons();
            setFocus(menu.querySelector('button'));

            setTimeout(() => {
                document.body.addEventListener('click', closeFavoritesMenu, { once: true });
            }, 0);
        }


async function addManualKeySwitcher() {
    // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    if (document.getElementById('manual-key-switcher')) return;

    // ============================================================
    // 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹)
    // ============================================================
    const container = document.createElement('div');
    container.id = 'manual-key-switcher';
    Object.assign(container.style, {
        position: 'fixed', 
        bottom: '150px', 
        left: '2rem', 
        transform: 'translateX(-50%)', 
        zIndex: '9999999', 
        display: 'flex', 
        gap: '15px', 
        padding: '12px 25px', 
        background: 'rgba(20, 20, 20, 0.8)', 
        borderRadius: '50px', 
        backdropFilter: 'blur(10px)', 
        boxShadow: '0 8px 32px rgba(0,0,0,0.5)',
        border: '1px solid rgba(255,255,255,0.1)'
    });

    // ============================================================
    // 2. Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø²Ø± (Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ­Øµ)
    // ============================================================
    const createVisualBtn = (label) => {
        const btn = document.createElement('button');
        btn.className = 'navigable';
        
        // Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ)
        Object.assign(btn.style, {
            border: 'none', cursor: 'pointer',
            padding: '10px 24px', borderRadius: '30px',
            fontSize: '13px', fontWeight: 'bold', fontFamily: 'sans-serif',
            color: '#fff', 
            background: '#f59e0b', // ğŸŸ¡ Ø£ØµÙØ± (Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙØ­Øµ)
            boxShadow: '0 4px 12px rgba(245, 158, 11, 0.3)',
            display: 'flex', alignItems: 'center', gap: '10px',
            transition: 'all 0.3s ease', outline: 'none'
        });

        btn.innerHTML = `
            <span>${label}</span>
            <span class="status-badge" style="background:rgba(0,0,0,0.25); padding:2px 10px; border-radius:12px; font-size:11px;">
                â³ Scanning...
            </span>
        `;
        return btn;
    };

    const btn1 = createVisualBtn("KEY 1");
    const btn2 = createVisualBtn("KEY 2");

    container.appendChild(btn1);
    container.appendChild(btn2);
    document.body.appendChild(container);

    // ============================================================
    // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„ÙØ­Øµ (Scanning Logic)
    // ============================================================
    
    // Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙØªØ§Ø­
    const testKey = async (key) => {
        try {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=id&id=Ks-_Mh1QhMc&key=${key}`);
            return res.status === 200;
        } catch { return false; }
    };

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„ÙŠØµØ¨Ø­ "Ø£Ø®Ø¶Ø±" ÙˆÙ‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„Ù†Ù‚Ø± (Manual Switcher)
    const activateButton = (btn, label, storageKey, otherStorageKey, foundIndex) => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„ Ù„Ù„Ø£Ø®Ø¶Ø± (Active)
        btn.style.background = '#10b981';
        btn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
        btn.querySelector('.status-badge').innerText = `Idx: ${foundIndex}`;

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù…Ø§ÙˆØ³
        btn.onmouseenter = () => btn.style.transform = 'scale(1.05)';
        btn.onmouseleave = () => btn.style.transform = 'scale(1)';

        // ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·)
        btn.onclick = () => {
            btn.style.background = '#f59e0b'; // Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£ØµÙØ±
            btn.innerHTML = `<span>Switching...</span> âŒ›`;

            // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚)
            let otherIndex = parseInt(localStorage.getItem(otherStorageKey)) || 0;
            let nextIndex = (foundIndex + 1) % window.YT_KEYS_POOL.length;

            if (nextIndex === otherIndex) {
                nextIndex = (nextIndex + 1) % window.YT_KEYS_POOL.length;
            }

            localStorage.setItem(storageKey, nextIndex);
            
            console.log(`âœ… Manual Switch: ${label} -> Index ${nextIndex}`);
            setTimeout(() => location.reload(), 250);
        };
    };

    console.log("ğŸš€ Starting Key Scan...");

    // ============================================================
    // 4. Ø­Ù„Ù‚Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­
    // ============================================================
    let foundKeysCount = 0;

    for (let i = 0; i < window.YT_KEYS_POOL.length; i++) {
        // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ù…ÙØªØ§Ø­ÙŠÙ†ØŒ Ù†ØªÙˆÙ‚Ù
        if (foundKeysCount >= 2) break;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø§Ø±ÙŠ ÙØ­ØµÙ‡
        const activeBtn = (foundKeysCount === 0) ? btn1 : btn2;
        activeBtn.querySelector('.status-badge').innerText = `Checking [${i}]...`;

        const isValid = await testKey(window.YT_KEYS_POOL[i]);

        if (isValid) {
            if (foundKeysCount === 0) {
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£ÙˆÙ„
                window.YOUTUBE_API_KEY = window.YT_KEYS_POOL[i];
                localStorage.setItem('yt_idx_1', i);
                activateButton(btn1, "KEY 1", 'yt_idx_1', 'yt_idx_2', i);
                foundKeysCount++;
            } 
            else if (foundKeysCount === 1) {
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø§Ù†ÙŠ
                window.YOUTUBE_API_KEY2 = window.YT_KEYS_POOL[i];
                localStorage.setItem('yt_idx_2', i);
                activateButton(btn2, "KEY 2", 'yt_idx_2', 'yt_idx_1', i);
                foundKeysCount++;
            }
        }
    }

    // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­
    if (foundKeysCount === 0) {
        btn1.style.background = '#ef4444'; // Ø£Ø­Ù…Ø±
        btn1.innerHTML = `<span>FAILED</span> <span>âŒ</span>`;
    }
}

// ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
document.addEventListener('DOMContentLoaded', addManualKeySwitcher);


function handleMenuAction(action, videoId) {
    const menu = document.getElementById('fav-popup-menu');
    if (menu) menu.remove();

    if (action === 'ADD' && videoId) {
        if (typeof addToFavorites === 'function') {
            addToFavorites(videoId);
        } else {
            console.warn("addToFavorites function is missing!");
        }
    } else if (action === 'SHARE' && videoId) {
        const url = `https://youtu.be/${videoId}`;
        navigator.clipboard.writeText(url).then(() => {
            // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø¨Ù€ showMessageBox
            alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ!");
        });
    }
}

        async function fetchFavorites(type) {
            const binId = type === 'D' ? JSONBIN_BIN_ID_FAV_D : JSONBIN_BIN_ID_FAV_M;
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: { 'X-Access-Key': JSONBIN_ACCESS_KEY_REMINDERS }
                });
                if (res.status === 404) return []; // Bin is new/empty
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                const data = await res.json();
                return Array.isArray(data.record) ? data.record : [];
            } catch (error) {
                console.error(`Error fetching favorites ${type}:`, error);
                return [];
            }
        }

        async function updateFavorites(type, newFavoritesList) {
            const binId = type === 'D' ? JSONBIN_BIN_ID_FAV_D : JSONBIN_BIN_ID_FAV_M;
            
            // If the list is empty, send a placeholder object to avoid API errors.
            const dataToSend = (Array.isArray(newFavoritesList) && newFavoritesList.length === 0)
                ? { _init: true } 
                : newFavoritesList;

            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(dataToSend)
                });
                if (!res.ok) throw new Error(`Failed to update favorites: ${res.status}`);
                return true;
            } catch (error) {
                console.error(`Error updating favorites ${type}:`, error);
                showMessageBox(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØ¶Ù„Ø© ${type}`);
                return false;
            }
        }
// ============================================================
// ğŸ§¹ Ù†Ø¸Ø§Ù… Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø°ÙƒÙŠ (Smart Cache Cleaner)
// ÙŠØ­Ù…ÙŠ Ø§Ù„ÙƒÙˆØªØ§ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ø­Ø°Ù
// ============================================================

function clearAppCache() {
    // 1. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø­Ù…ÙŠØ© (WhiteList)
    // Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ù† ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ø£Ø¨Ø¯Ø§Ù‹
    const protectedKeys = [
        'suggestedVideosCache',
        // Ø£. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª (Ù„ØªÙˆÙÙŠØ± Ø§Ù„ÙƒÙˆØªØ§)
        'dashboard_cached_data',       // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„ÙƒØ§Ø´ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
        'dashboard_cache_timestamp',   // ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
        'suggested_videos_cache',      // ÙƒØ§Ø´ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯)
        
        // Ø¨. Ù…Ø¤Ø´Ø±Ø§Øª API (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø¹Ø¯Ù… Ø­Ø°ÙÙ‡Ø§ Ù„ÙƒÙŠ Ù„Ø§ ÙŠØ¹ÙˆØ¯ Ù„Ù„ØµÙØ±)
        'yt_idx_1',
        'yt_idx_2',
        
        // Ø¬. Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠÙØ¶Ù„ Ø¹Ø¯Ù… Ø­Ø°Ù Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        'playlist_car_mode',
        'playlist_tv_mode',
        'playlist_watch_later',
        'fav_dashboard_data',
        'favorites_simple'
    ];

    let deletedCount = 0;
    const totalKeys = localStorage.length;

    // 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§
    // Ù„Ø§ Ù†Ø­Ø°Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù„Ù‚Ø© Ù„Ø£Ù† Ø·ÙˆÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø³ÙŠØªØºÙŠØ±
    const keysToRemove = [];

    for (let i = 0; i < totalKeys; i++) {
        const key = localStorage.key(i);
        
        // Ù‡Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙŠØ©ØŸ
        if (!protectedKeys.includes(key)) {
            keysToRemove.push(key);
        }
    }

    // 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù
    keysToRemove.forEach(key => {
        localStorage.removeItem(key);
        deletedCount++;
    });

    console.log(`ğŸ§¹ Cache Cleaned: Removed ${deletedCount} items, Kept ${protectedKeys.length} important items.`);

    // 4. Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    // Ù†Ø³ØªØ®Ø¯Ù… showMessageBox Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø£Ùˆ alert
    const msg = `ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (${deletedCount} Ù…Ù„ÙØ§Øª).\nØªÙ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ù„ØªÙˆÙÙŠØ± Ø§Ù„ÙƒÙˆØªØ§.`;
    
    if (typeof showMessageBox === 'function') {
        showMessageBox("âœ… " + msg);
    } else {
        alert("âœ… " + msg);
    }

    // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    setTimeout(() => location.reload(), 1000);
}
        async function saveVideoToFavorites(rawVideoData, type) {
    const videoToSave = {
        id: rawVideoData.id,
        title: rawVideoData.title || rawVideoData.snippet?.title || 'Unknown Title',
        thumbnail: rawVideoData.thumbnail || rawVideoData.snippet?.thumbnails?.medium?.url || '',
        channelTitle: rawVideoData.channelTitle || rawVideoData.snippet?.channelTitle || 'Unknown Channel',
        channelId: rawVideoData.channelId || rawVideoData.snippet?.channelId || '',
        duration: rawVideoData.duration, 
        progress: rawVideoData.progress || 0 
    };

    let favoritesList = type === 'D' ? favoritesD : favoritesM;
    
    // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¶ÙŠÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø¯ÙˆÙ† Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Ø³Ø® Ù‚Ø¯ÙŠÙ…Ø© (ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙƒØ±Ø§Ø±).
    const updatedList = [videoToSave, ...favoritesList];
    
    if (updatedList.length > 50) {
        updatedList.pop();
    }

    const success = await updateFavorites(type, updatedList);

    if (success) {
        if (type === 'D') favoritesD = updatedList; else favoritesM = updatedList;
        showMessageBox(`ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø© ${type}`);

        const bookmarkBtn = document.querySelector(`.bookmark-button[data-video-id="${videoToSave.id}"]`);
        if(bookmarkBtn) {
            bookmarkBtn.classList.remove('saved-d', 'saved-m', 'saved-both');
            const isD = favoritesD.some(fav => fav.id === videoToSave.id);
            const isM = favoritesM.some(fav => fav.id === videoToSave.id);
            if (isD && isM) bookmarkBtn.classList.add('saved-both');
            else if (isD) bookmarkBtn.classList.add('saved-d');
            else if (isM) bookmarkBtn.classList.add('saved-m');
        }

        const activeTab = document.querySelector('#screen-Media .tab-button.active')?.id;
        if ((type === 'D' && activeTab === 'tab-saved-d') || (type === 'M' && activeTab === 'tab-saved-m')) {
             loadSavedVideos(type);
        }
    }
}

        async function removeVideoFromFavorites(videoId, type) {
            const favoritesList = type === 'D' ? favoritesD : favoritesM;
            const updatedList = favoritesList.filter(fav => fav.id !== videoId);
            const success = await updateFavorites(type, updatedList);
            if (success) {
                if (type === 'D') favoritesD = updatedList; else favoritesM = updatedList;
                showMessageBox(`ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø© ${type}`);
                loadSavedVideos(); 
            }
        }

        // Replace the existing loadSavedVideos function
async function loadSavedVideos(type) { // Added 'type' parameter ('D', 'M', or undefined)
    console.log(`[Debug SavedVideos] Starting loadSavedVideos(${type || 'both'})...`);

    const gridD = document.getElementById('favorites-d-grid');
    const gridM = document.getElementById('favorites-m-grid');
    const savedDContent = document.getElementById('tab-content-saved-d');
    const savedMContent = document.getElementById('tab-content-saved-m');

    // Determine which grids/content areas to update
    const updateD = !type || type === 'D';
    const updateM = !type || type === 'M';

    if (updateD && !gridD) console.error("[Debug SavedVideos] favorites-d-grid not found!");
    if (updateM && !gridM) console.error("[Debug SavedVideos] favorites-m-grid not found!");

    // Show loading messages only in the relevant grids
    if (updateD && gridD) gridD.innerHTML = '<p class="text-white/70 text-center col-span-full">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©...</p>';
    if (updateM && gridM) gridM.innerHTML = '<p class="text-white/70 text-center col-span-full">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ„ÙØ§Ø²...</p>';

    try {
        let fetchedD = [], fetchedM = [];

        // Fetch only the necessary lists
        if (updateD && updateM) { // Fetch both if no type specified
             const results = await Promise.allSettled([fetchFavorites('D'), fetchFavorites('M')]);
             fetchedD = results[0].status === 'fulfilled' ? results[0].value : [];
             fetchedM = results[1].status === 'fulfilled' ? results[1].value : [];
             favoritesD = fetchedD; // Update global cache
             favoritesM = fetchedM; // Update global cache
        } else if (updateD) { // Fetch only D
             fetchedD = await fetchFavorites('D');
             favoritesD = fetchedD; // Update global cache
        } else if (updateM) { // Fetch only M
             fetchedM = await fetchFavorites('M');
             favoritesM = fetchedM; // Update global cache
        }

        console.log("[Debug SavedVideos] Fetched D:", fetchedD);
        console.log("[Debug SavedVideos] Fetched M:", fetchedM);

        // Render D list if needed
        if (updateD && gridD) {
            gridD.innerHTML = '';
            if (fetchedD.length > 0) {
                 fetchedD.forEach(video => {
                     const cardElement = createFavoriteVideoCard(video, 'D');
                     if (cardElement) gridD.appendChild(cardElement);
                 });
            } else {
                 gridD.innerHTML = '<p class="text-white/70 text-center col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù‡Ù†Ø§.</p>';
            }
        }

        // Render M list if needed
        if (updateM && gridM) {
             gridM.innerHTML = '';
             if (fetchedM.length > 0) {
                 fetchedM.forEach(video => {
                     const cardElement = createFavoriteVideoCard(video, 'M');
                     if (cardElement) gridM.appendChild(cardElement);
                 });
             } else {
                 gridM.innerHTML = '<p class="text-white/70 text-center col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù‡Ù†Ø§.</p>';
             }
        }

        lucide.createIcons();
        updateNavigableElements(); // Ensure focusable elements are updated after rendering
        console.log("[Debug SavedVideos] Finished rendering saved videos.");

    } catch (error) {
        console.error("[Debug SavedVideos] Error in loadSavedVideos:", error);
        if (updateD && gridD) gridD.innerHTML = '<p class="text-red-500 text-center col-span-full">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø©.</p>';
        if (updateM && gridM) gridM.innerHTML = '<p class="text-red-500 text-center col-span-full">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø©.</p>';
    }
}

        function createFavoriteVideoCard(video, type) {
            const card = document.createElement('div');
            card.className = 'glass-surface glass-surface--svg youtube-video-card navigable grid-item';
            card.tabIndex = 0;
            card.dataset.videoId = video.id;

            card.innerHTML = `
                <div class="video-details">
                    <h3 class="video-title">${video.title}</h3>
                    <div class="video-meta">
                        <span>${video.channelTitle || ''}</span>
                    </div>
                </div>
                <div class="thumbnail-container relative">
                     <img src="${video.thumbnail}" alt="${video.title}" class="w-[180px] h-[101.25px] object-cover rounded-md ml-4 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/180x101';">
                     <span class="video-duration">${video.duration || ''}</span>
                     <button class="remove-favorite-button" title="Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `;
            // Ensure the progress value is treated as a number and passed to the video player
            const startProgress = parseFloat(video.progress || 0);
            card.addEventListener('click', () => showVideoPopup(video.id, startProgress));
            card.querySelector('.remove-favorite-button').addEventListener('click', (e) => {
                e.stopPropagation();
                removeVideoFromFavorites(video.id, type);
            });
            return card;
        }

function directionToDegrees(direction) {
    const directionsMap = {
        'N': 0,
        'NE': 45,
        'E': 90,
        'SE': 135,
        'S': 180,
        'SW': 225,
        'W': 270,
        'NW': 315
    };
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… 0 (Ø§Ù„Ø´Ù…Ø§Ù„) ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
    return directionsMap[direction.toUpperCase()] || 0; 
}

        // --- Google Map and Geolocation (REFACTORED FOR RELIABILITY) ---
        function loadGoogleMaps() {
            if (googleMapsPromise) return googleMapsPromise;

            googleMapsPromise = new Promise((resolve, reject) => {
                if (typeof google !== 'undefined' && google.maps) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=geometry,places`;
                script.async = true;
                script.defer = true;
                script.onload = () => resolve();
                script.onerror = () => reject('Failed to load Google Maps script.');
                document.head.appendChild(script);
            });

            return googleMapsPromise;
        }


let carplayGoogleMap;   // Ø®Ø±ÙŠØ·Ø© CarPlay Ø§Ù„Ù…ØµØºØ±Ø©

let mapsInitialized = false;
async function initMaps() {
    // 1. ğŸ›¡ï¸ Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ Ù„Ù„Ø®Ø·Ø£ 9335: ØªØ£Ù…ÙŠÙ† appState ÙÙˆØ±Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù†Ù‡ÙŠØ§Ø± onDraw
    window.appState = window.appState || {
        currentLocation: { lat: 17.021, lng: 54.110 }, // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (ØµÙ„Ø§Ù„Ø©)
        car: { heading: 0 }
    };

    if (mapsInitialized) return;
    
    try {
        const mainMapElement = document.getElementById('dashboard-google-map');
        const miniMapElement = document.getElementById('carplay-mini-map');

        if (!mainMapElement) {
            console.error("âŒ Ø¹Ù†ØµØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            return;
        }

        // 2. ğŸš€ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©: Ø²ÙˆÙˆÙ… Ø£Ø¨Ø¹Ø¯ (17.5) Ù„Ø±Ø¤ÙŠØ© Ø£ÙˆØ³Ø¹ ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù†Ø¸ÙˆØ±
        const commonConfigs = {
            center: window.appState.currentLocation,
            mapTypeId: 'roadmap',
            disableDefaultUI: true,
            renderingType: google.maps.RenderingType.VECTOR,
            headingInteractionEnabled: true,
            tiltInteractionEnabled: true,
            gestureHandling: 'greedy'
        };
 
        // 3. --- Ø£. Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (3D) ---
        window.dashboardGoogleMap = new google.maps.Map(mainMapElement, {
            ...commonConfigs,
            mapId: '6c6951a9289b612a97923702', 
            zoom: 17.5, // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø²ÙˆÙˆÙ… Ù„Ø±Ø¤ÙŠØ© Ø£Ø¨Ø¹Ø¯ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
            tilt: 65,   
            heading: 0, disableDefaultUI: false
        });

        // ğŸš— Ø­Ù‚Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ 3D Ù…Ø¹ ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø¥Ø²Ø§Ø­Ø© Ù„Ù„ÙŠØ³Ø§Ø±
        setup3DCarSystem(window.dashboardGoogleMap);

        // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        new google.maps.TrafficLayer().setMap(window.dashboardGoogleMap);

        // 4. --- Ø¨. Ø®Ø±ÙŠØ·Ø© CarPlay (Ø§Ù„Ù…ØµØºØ±Ø©) ---
        if (miniMapElement) {
            window.carplayGoogleMap = new google.maps.Map(miniMapElement, {
                ...commonConfigs,
                mapId: '6c6951a9289b612af6d86b8d',
                colorScheme: google.maps.ColorScheme.DARK,
                zoom: 17, // Ø²ÙˆÙˆÙ… Ø£Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ØµØºØ±Ø©
                tilt: 45
            });

            new google.maps.TrafficLayer().setMap(window.carplayGoogleMap);
            
            window.carplayGoogleMarker = new google.maps.Marker({
                position: commonConfigs.center,
                map: window.carplayGoogleMap,
                icon: { 
                    url: 'https://dmusera.netlify.app/3606.png', 
                    scaledSize: new google.maps.Size(60, 70), // ØªØµØºÙŠØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
                    anchor: new google.maps.Point(30, 35)
                }
            });
        }

        mapsInitialized = true;
        console.log("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ ÙƒØ§ÙØ© Ø§Ù„Ø®Ø±Ø§Ø¦Ø· ÙˆØªØµØ­ÙŠØ­ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø±Ø¤ÙŠØ© ÙˆØ§Ù„Ø­Ø¬Ù….");
        
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø­ÙŠ
        startContinuousLocationTracking();

    } catch (error) {
        console.error("âŒ Map Init Error:", error);
    }
}
// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒØ§Ø¦Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
if (window.dashboardGoogleMap) {
    window.dashboardGoogleMap.setOptions({
        disableDefaultUI: false,
        fullscreenControl: true,
        streetViewControl: true,
        fullscreenControlOptions: {
        position: google.maps.ControlPosition.LEFT_BOTTOM // Ù†Ù‚Ù„Ù‡ Ù„Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø±
    }
    });
} else {
    console.warn("âš ï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù… ØªØ¬Ù‡Ø² Ø¨Ø¹Ø¯ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©...");
    setTimeout(() => { if(window.dashboardGoogleMap) window.dashboardGoogleMap.setOptions({disableDefaultUI: false}); }, 1000);
}
// --- 2. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¬Ø±Ø§ÙÙŠÙƒ Ø§Ù„Ù…Ø·ÙˆØ± (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø¥Ø²Ø§Ø­Ø©) ---
async function setup3DCarSystem(map) {
    if (!map || window.carOverlay) return;

    const overlay = new google.maps.WebGLOverlayView();
    window.carOverlay = overlay;

    overlay.onAdd = () => {
        const loader = new window.GLTFLoader();
        overlay.scene = new THREE.Scene();
        overlay.camera = new THREE.PerspectiveCamera();
        
        // 1. Ù†Ø¸Ø§Ù… Ø¥Ø¶Ø§Ø¡Ø© "Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ" Ù„Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ù„Ù…Ø¹Ø© Ø§Ù„Ù†Ù‚Ø·ÙŠØ© (Specular)
        overlay.scene.add(new THREE.AmbientLight(0xffffff, 0.65)); // Ø¶ÙˆØ¡ Ù…Ø­ÙŠØ·ÙŠ Ù…ØªÙˆØ§Ø²Ù†
        
        // ÙƒØ´Ø§ÙØ§Øª Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø© Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ù„Ù…Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ ÙˆÙ„ÙŠØ³ Ø§Ù„Ø³Ù‚Ù
        const light1 = new THREE.DirectionalLight(0xffffff, 0.68);
        light1.position.set(25, 8, 15); 
        overlay.scene.add(light1);

        const light2 = new THREE.DirectionalLight(0xffffff, 0.75);
        light2.position.set(-25, 5, 15); 
        overlay.scene.add(light2);

        loader.load('https://dmusera.netlify.app/ES350E.gltf', (gltf) => {
            window.carModel = gltf.scene;
            
            window.carModel.traverse(node => {
                if (node.isMesh) {
                    const originalColor = node.material.color.clone();
                    const isTransparent = node.material.transparent || node.material.opacity < 0.9;
                    
                    // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„ÙØ±Ø² Ø§Ù„Ù„ÙˆÙ†ÙŠ Ø§Ù„Ø°ÙƒÙŠ (Ø¹Ø¬Ù„Ø§Øª ÙˆØ²Ø¬Ø§Ø¬ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù‡ÙŠÙƒÙ„)
                    const isNeutral = (originalColor.r === originalColor.g && originalColor.g === originalColor.b) || 
                                     (originalColor.r < 0.5 && originalColor.g < 0.5 && originalColor.b < 0.5);

                    if (isTransparent || isNeutral) {
                        // Ø§Ù„Ø¹Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ø²Ø¬Ø§Ø¬: Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨Ø§ÙŠÙ† Ø§Ù„Ø¯Ø§ÙƒÙ† ÙˆØ§Ù„Ø´ÙØ§ÙÙŠØ©
                        node.material = new THREE.MeshPhongMaterial({
                            color: isTransparent ? originalColor : 0x050505,
                            specular: 0x444444,
                            shininess: 100,
                            side: THREE.DoubleSide,
                            transparent: isTransparent,
                            opacity: node.material.opacity
                        });
                    } else {
                        // 3. Ø§Ù„Ù‡ÙŠÙƒÙ„: Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ‚ (Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©)
                        node.material = new THREE.MeshPhongMaterial({
                            color: 0xcccaac,       // Ø°Ù‡Ø¨ÙŠ ØºÙ†ÙŠ Ø£ØºÙ…Ù‚ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¨Ù‡ØªØ§Ù†
                            specular: 0x888888,    // Ø±Ù…Ø§Ø¯ÙŠ Ø®Ø§ÙØª Ù„ØªÙ‚Ù„ÙŠÙ„ ÙˆÙ‡Ø¬ Ø§Ù„Ø¨ÙŠØ§Ø¶
                            shininess: 2000,       // Ù„Ù…Ø¹Ø© Ù…Ø±ÙƒØ²Ø© Ø¬Ø¯Ø§Ù‹ ÙˆÙ†Ù‚Ø·ÙŠØ©
                            emissive: 0x221100,    // ØªÙˆÙ‡Ø¬ Ø¯Ø§ÙØ¦ Ù„Ø¹Ù…Ù‚ Ø§Ù„Ù„ÙˆÙ†
                            emissiveIntensity: 0.2,
                            side: THREE.DoubleSide,
                            flatShading: false
                        });
                    }
                    node.material.needsUpdate = true;
                }
            });

            window.carModel.rotation.x = Math.PI / 2;
            overlay.scene.add(window.carModel);
        });
    };

    overlay.onContextRestored = ({ gl }) => {
        overlay.renderer = new THREE.WebGLRenderer({
            canvas: gl.canvas, context: gl, antialias: true, alpha: true
        });
        overlay.renderer.autoClear = false;
    };

    overlay.onDraw = ({ transformer }) => {
        const { renderer, scene, camera } = overlay;
        if (!renderer || !window.carModel || !window.appState?.currentLocation) return;

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù…Ù†Ø¹ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        renderer.resetState();

        const pos = window.appState.currentLocation;
        const heading = window.appState.car.heading || 0;
        const zoom = window.dashboardGoogleMap.getZoom();

        // Ø±Ø¨Ø· Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø«Ø§Ø¨Øª
        const matrix = transformer.fromLatLngAltitude({ ...pos, altitude: 3.5 });
        camera.projectionMatrix = new THREE.Matrix4().fromArray(matrix);

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø¯ÙˆØ±Ø§Ù†
        const baseScale = window.tuner?.scale || 0.85; 
        const finalScale = baseScale * Math.pow(2, 20 - zoom); 
        
        window.carModel.scale.set(finalScale, finalScale, finalScale);
        window.carModel.rotation.y = -(heading * Math.PI) / 180 + Math.PI;

        renderer.render(scene, camera);
        overlay.requestRedraw(); 
    };

    overlay.setMap(map);
}
// 1. Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© Ø§Ù„ØªÙŠ Ø§Ø®ØªØ±ØªÙ‡Ø§
window.tuner = {
    zoom: 19.5,
    tilt: 65,
    scale: 1.02,
    offset: 45
};

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø³ØªÙ…Ø± (Live Stream)
window.startLiveTracking = function() {
    if (navigator.geolocation) {
        // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ù…Ø±Ø§Ù‚Ø¨ Ù‚Ø¯ÙŠÙ… Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
        if (window.locationWatchId) {
            navigator.geolocation.clearWatch(window.locationWatchId);
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù…Ø³ØªÙ…Ø± (watchPosition)
        window.locationWatchId = navigator.geolocation.watchPosition(
            (pos) => {
                // Ù†Ø±Ø³Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹ Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                // ÙˆÙ‡ÙŠ Ø§Ù„ØªÙŠ ØªØªÙˆÙ„Ù‰ ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŒ ÙˆØ¥Ø²Ø§Ø­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©
                if (typeof window.updateGoogleMapLocation === 'function') {
                    window.updateGoogleMapLocation(pos);
                }
            },
            (err) => {
                console.error("ğŸš¨ ÙØ´Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:", err.message);
            },
            {
                enableHighAccuracy: true, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯Ù‚ Ø¥Ø´Ø§Ø±Ø© GPS Ù…Ù…ÙƒÙ†Ø©
                maximumAge: 0,            // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø¯Ù‚Ø© Ø§Ù„Ù„Ø­Ø¸Ø©
                timeout: 10000            // Ù…Ù‡Ù„Ø© 10 Ø«ÙˆØ§Ù†Ù Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ù‚Ù…Ø§Ø±
            }
        );
        console.log("%cğŸ“¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ù‚Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ù†Ø´Ø· Ø§Ù„Ø¢Ù†...", "color: #00e676; font-weight: bold;");
    }
};

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙˆØ± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ¨Ø¯Ø£ Ø§Ù„Ù…Ù„Ø§Ø­Ù‚Ø© ÙÙˆØ±Ø§Ù‹
window.startLiveTracking();
// Ù…ØªØºÙŠØ± Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ù…Ø³
let isUserInteracting = false;

// Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
if (window.dashboardGoogleMap) {
    const map = window.dashboardGoogleMap;
    map.addListener('dragstart', () => isUserInteracting = true);
    map.addListener('zoom_changed', () => {
        if (isUserInteracting) {
            // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ… Ø§Ù„ØªÙˆÙ†Ø± ÙÙˆØ±ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø²ÙˆÙ… Ø¨Ø§Ù„Ø£ØµØ§Ø¨Ø¹
            window.tuner.zoom = map.getZoom();
        }
    });
}



// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
startLiveTracking();

function stopDashboardLocationTracking() {
    if (locationWatchId !== null) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
    }
}
        /**
 * REPLACED & FINALIZED: Gets the user's current geolocation (One-Time Fetch), 
 * centers the map, and immediately updates the traffic indicators. 
 * CRITICAL FIX: Uses a fallback location if permission is denied.
 */
async function centerMapOnUserLocation() { 
    if (navigator.geolocation) { 
        navigator.geolocation.getCurrentPosition(
            // ğŸ›‘ Ø§Ù„Ù†Ø¬Ø§Ø­: ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (pos)
            async (pos) => { 
                // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆÙ…ØªØºÙŠØ±Ø§Øª AppState (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… Ø£ÙˆÙ„Ø§Ù‹)
                updateGoogleMapLocation(pos); 
                
                // 2. Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                await updateTrafficIndicators(); 
                
               
            }, 
            // ğŸ›‘ Ø§Ù„ÙØ´Ù„: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„
            async (err) => { // ğŸ‘ˆ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø¯Ø§Ù„Ø© async Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ await
                let msg = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.';
                
                if (err.code === 1) { // PERMISSION_DENIED
                     msg = 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ.';
                } else if (err.code === 2) {
                     msg = 'ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ.';
                }
                
                // 1. ğŸš€ FIX: ØªØ¹ÙŠÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Fallback Logic)
                const FALLBACK_COORDS = { lat: 17.067330, lng: 54.160190 }; // HOME1_COORDS

                appState.currentLocation = FALLBACK_COORDS; // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                
                // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù€ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ setCenter/setHeading)
                // ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø±Ø³Ù„ ÙƒØ§Ø¦Ù† 'pos' Ù…Ø¨Ø³Ø· ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ updateGoogleMapLocation
                const fallbackPos = {
                    coords: {
                        latitude: FALLBACK_COORDS.lat, 
                        longitude: FALLBACK_COORDS.lng, 
                        heading: 0 // Heading Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø´Ù…Ø§Ù„)
                    }
                };
                updateGoogleMapLocation(fallbackPos);
                
                // 3. ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                await updateTrafficIndicators(); 

                showMessageBox(msg); 
                console.error("Geolocation Error Code:", err.code);
            }, 
            { enableHighAccuracy: true } 
        ); 
    } else { 
        showGeolocationErrorOnMap('Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.');
    }
}

function parseDurationToSeconds(durationStr) {
    if (!durationStr || durationStr === "Ù…Ø¨Ø§Ø´Ø±") return 9999; // Ù‚ÙŠÙ…Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø¨Ø§Ø´Ø±
    const parts = durationStr.split(':').map(Number);
    if (parts.length === 3) return (parts[0] * 3600) + (parts[1] * 60) + parts[2]; // H:M:S
    if (parts.length === 2) return (parts[0] * 60) + parts[1]; // M:S
    return 0;
}
        
        async function calculateAndDisplayRouteTo(destinationCoords) {
            if (!appState.currentLocation) {
                showMessageBox('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
                return;
            }
            if (!directionsService || !directionsRenderer) {
                showMessageBox('Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.');
                return;
            }
            
            const request = {
                origin: appState.currentLocation,
                destination: destinationCoords,
                travelMode: 'DRIVING'
            };

            try {
                const response = await directionsService.route(request);
                if (response.status === 'OK') {
                    directionsRenderer.setDirections(response);
                    const route = response.routes[0].legs[0];
                   
                    showMessageBox(`Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„Ù‰ ÙˆØ¬Ù‡ØªÙƒ: ${route.distance.text}, Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±: ${route.duration.text}`);
                } else {
                    showMessageBox('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§ØªØ¬Ø§Ù‡Ø§Øª: ' + response.status);
                }
            } catch (err) {
                console.error('Error calculating directions:', err);
                
            }
        }


// -------------------------------------------------------------
// --- MODIFIED fetchWeatherData function (Fetches Weather + NASA Moon) ---
// -------------------------------------------------------------
async function fetchWeatherData() {
    const now = new Date(); // Ø¬Ù„Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØªÙ…Ø±ÙŠØ±Ù‡ Ø¥Ù„Ù‰ API Ø§Ù„Ø·Ù‚Ø³ ÙˆØ§Ù„Ù‚Ù…Ø±
    
    if (WEATHER_API_KEY.startsWith('YOUR_')) return showMessageBox('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ WeatherAPI.');
    
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    try {
        const locationQuery = appState.currentLocation ? `${appState.currentLocation.lat},${appState.currentLocation.lng}` : appState.weather.location.split(',')[0].trim();
        const res = await fetch(`https://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${locationQuery}&days=2&aqi=yes&alerts=no&lang=ar`);
        
        if (!res.ok) throw new Error(`Ø®Ø·Ø£ HTTP! Ø§Ù„Ø­Ø§Ù„Ø©: ${res.status}`);
        const data = await res.json();
        
        // 2. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        appState.weather.temperature = data.current.temp_c;
        appState.weather.description = data.current.condition.text;
        appState.weather.uvIndex = data.current.uv;
        appState.weather.iconUrl = `https:${data.current.condition.icon}`;
        appState.weather.location = `${data.location.name}, ${data.location.country}`;
        appState.weather.humidity = data.current.humidity; // âœ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ø·ÙˆØ¨Ø©

        // 3. Ø¬Ù„Ø¨ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚Ù…Ø± Ù…Ù† NASA SVS (Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹Ù‚Ø¯Ø©)
        // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ ØªØ±Ø¬Ø¹ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±
        const moonUrl = await fetchNasaMoonImage(now);
        if (moonUrl) {
            appState.dynamicMoonImageUrl = moonUrl;
        } else {
             // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù…Ø±ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚Ù…Ø± Ø§Ù„Ø«Ø§Ø¨ØªØ©
            appState.dynamicMoonImageUrl = 'https://cdn.weatherapi.com/weather/64x64/night/113.png'; 
        }

        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
        const hourlyData = [...data.forecast.forecastday[0].hour, ...data.forecast.forecastday[1]?.hour || []];
        const currentHourData = {
            time: "Ø§Ù„Ø¢Ù†",
            temp_c: data.current.temp_c,
            condition: { icon: data.current.condition.icon }
        };
        const upcomingHours = hourlyData.filter(h => new Date(h.time_epoch * 1000) > now).slice(0, 6);
        const forecastToRender = [currentHourData, ...upcomingHours];
        
        renderHourlyForecast(forecastToRender);
        renderAdvancedWeatherCards(data);
        update3dMoonWidget();
        updateUI(); // ğŸ›‘ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
        
    } catch (err) {
        console.error('Error fetching weather data:', err);
    }
}

/**
 * Generates the current date/time string in NASA SVS format (YYYY-MM-DDT HH:MM).
 */
/**
 * Generates the current date/time string in NASA SVS format (YYYY-MM-DDT HH:MM).
 * NASA API uses the hour/minute of the current system time for the comparison.
 */
/**
 * REPLACED: Generates the date string for NASA SVS API based on the current hour.
 * Ensures that if it's past 18:00 UTC, it fetches the next day's data (if needed).
 * Since the API updates at 18:00, we fetch the CURRENT date until 18:00 local time.
 */
function getNasaDateTime(date) {
    const hours = date.getHours();
    let targetDate = new Date(date);

    // ğŸ›‘ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ø³Ù…: Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù‚Ø¨Ù„ 18:00 (ÙˆÙ‚Øª ØªØ­Ø¯ÙŠØ« NASA)ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚
    // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ø¨Ø¹Ø¯ 18:00ØŒ Ù†Ø¨Ø¯Ø£ ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
    if (hours < 18) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ù‚Ø¨Ù„ 6 Ù…Ø³Ø§Ø¡Ù‹ØŒ Ù†Ø±Ø¬Ø¹ Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù…Ø³ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ "Ø¢Ø®Ø± ØµÙˆØ±Ø© Ù…Ø³ØªÙ‚Ø±Ø©"
        targetDate.setDate(targetDate.getDate() - 1);
    } 
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙŠØ®Øµ Ø§Ù„ØµÙˆØ±Ø© Ù„ÙŠÙˆÙ… ÙƒØ§Ù…Ù„ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù…Ø³ Ø­ØªÙ‰ ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«.
    // (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø­Ø³Ø¨ ØªÙˆÙ‚ÙŠØª UTC Ø¥Ø°Ø§ ÙƒØ§Ù†Øª NASA ØªØ³ØªØ®Ø¯Ù… UTC)

    const year = targetDate.getFullYear();
    const month = (targetDate.getMonth() + 1).toString().padStart(2, '0'); 
    const day = targetDate.getDate().toString().padStart(2, '0');
    
    // Ø³Ù†Ø³ØªØ®Ø¯Ù… 18:00 ÙƒÙ€ Time Marker Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„ÙŠÙˆÙ… ÙƒØ§Ù…Ù„Ø§Ù‹
    const markerHours = 18; 
    const markerMinutes = 0; 

    // YYYY-MM-DDT 18:00 format (Ù„Ø¶Ù…Ø§Ù† Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…)
    return `${year}-${month}-${day}T${markerHours.toString().padStart(2, '0')}:${markerMinutes.toString().padStart(2, '0')}`;
}


/**
 * Fetches the dynamic moon data object from the NASA SVS Dial-A-Moon API.
 * * @param {Date} dateObj - The current Date object.
 * @returns {Promise<object|null>} The moon data JSON object, or null if failed.
 */
async function fetchNasaMoonData(dateObj) {
    const nasaDateString = getNasaDateTime(dateObj); 
    const API_URL = `https://svs.gsfc.nasa.gov/api/dialamoon/${nasaDateString}`;

    try {
        const response = await fetch(API_URL);
        
        if (!response.ok) {
            console.error(`NASA Dial-A-Moon API failed: Status ${response.status}.`);
            return null;
        }

        const data = await response.json();
        
        // Ù†Ø±Ø¬Ø¹ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø§Ù‹ Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† 'phase' Ùˆ 'image.url'
        if (data && data.image && data.image.url) {
            console.log("NASA SVS data fetched successfully.");
            return data; 
        }
        
        return null;
        
    } catch (error) {
        console.error("Network error during NASA API call:", error);
        return null;
    }
}

/**
 * Fetches the dynamic moon image URL using the NASA SVS Dial-A-Moon API.
 */
async function fetchNasaMoonImage(dateObj) {
    const nasaDateString = getNasaDateTime(dateObj); 
    const API_URL = `https://svs.gsfc.nasa.gov/api/dialamoon/${nasaDateString}`;
    const FALLBACK_ICON = 'https://cdn.weatherapi.com/weather/64x64/night/113.png'; 

    try {
        const response = await fetch(API_URL);
        
        if (!response.ok) {
            console.error(`NASA Dial-A-Moon API failed: Status ${response.status}.`);
            return FALLBACK_ICON;
        }

        const data = await response.json();
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯: data.image.url
        if (data && data.image && data.image.url) {
            console.log("NASA SVS image URL fetched successfully.");
            return data.image.url; 
        }
        
        return FALLBACK_ICON;
        
    } catch (error) {
        console.error("Network error during NASA API call:", error);
        return FALLBACK_ICON;
    }
}
        /// -------------------------------------------------------------
// --- MODIFIED fetchWeatherData function (Fetches Weather + Dynamic Moon) ---
// -------------------------------------------------------------
// -------------------------------------------------------------
// --- MODIFIED fetchWeatherData function (Fetches Weather + NASA Moon) ---
// -------------------------------------------------------------
// -------------------------------------------------------------
// --- MODIFIED fetchWeatherData function (Fetches Weather + NASA Moon) ---
// -------------------------------------------------------------
async function fetchWeatherData() {
    const now = new Date(); 
    
    if (WEATHER_API_KEY.startsWith('YOUR_')) return showMessageBox('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ WeatherAPI.');
    
    // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù‚Ø³
    try {
        const locationQuery = appState.currentLocation ? `${appState.currentLocation.lat},${appState.currentLocation.lng}` : appState.weather.location.split(',')[0].trim();
        const res = await fetch(`https://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${locationQuery}&days=2&aqi=yes&alerts=no&lang=ar`);
        
        if (!res.ok) throw new Error(`Ø®Ø·Ø£ HTTP! Ø§Ù„Ø­Ø§Ù„Ø©: ${res.status}`);
        const data = await res.json();
        
        // 2. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        appState.weather.temperature = data.current.temp_c;
        appState.weather.description = data.current.condition.text;
        appState.weather.uvIndex = data.current.uv;
        appState.weather.iconUrl = `https:${data.current.condition.icon}`;
        appState.weather.location = `${data.location.name}, ${data.location.country}`;
        appState.weather.humidity = data.current.humidity; 

        // 3. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ù…Ø± (Moon Data)
        const moonResult = await fetchNasaMoonData(now); // âœ… Ù†Ø·Ù„Ø¨ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø§Ù‹

        // 4. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ù…Ø± ÙÙŠ AppState
        if (moonResult) {
    appState.dynamicMoonImageUrl = moonResult.image.url;
    appState.moonData = moonResult; // âœ… ØªØ®Ø²ÙŠÙ† ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ 'phase'
    appState.moonData.fetchDate = new Date();
        } else {
            appState.dynamicMoonImageUrl = 'https://cdn.weatherapi.com/weather/64x64/night/113.png'; 
            appState.moonData = null;
        }

        // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
        const hourlyData = [...data.forecast.forecastday[0].hour, ...data.forecast.forecastday[1]?.hour || []];
        const currentHourData = {
            time: "Ø§Ù„Ø¢Ù†",
            temp_c: data.current.temp_c,
            condition: { icon: data.current.condition.icon }
        };
        const upcomingHours = hourlyData.filter(h => new Date(h.time_epoch * 1000) > now).slice(0, 6);
        const forecastToRender = [currentHourData, ...upcomingHours];
        
        renderHourlyForecast(forecastToRender);
        renderAdvancedWeatherCards(data);
        updateUI(); // ğŸ›‘ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
        
    } catch (err) {
        console.error('Error fetching weather data:', err);
    }
}

        function renderHourlyForecast(forecastData) {
            const container = document.getElementById('hourly-forecast-container');
            if (!container) return;
            container.innerHTML = '';
            forecastData.forEach(hour => {
                  const timeLabel = hour.time === "Ø§Ù„Ø¢Ù†"
                    ? "Ø§Ù„Ø¢Ù†"
                    : new Date(hour.time_epoch * 1000).toLocaleTimeString('ar-SA', { hour: 'numeric', hour12: true });

                const card = document.createElement('div');
                card.className = 'flex flex-col items-center justify-center p-1 rounded-lg';
                card.innerHTML = `
                    <span class="text-base font-medium text-white/80">${timeLabel}</span>
                    <img src="https:${hour.condition.icon}" alt="weather" class="w-8 h-8 my-1">
                    <span class="text-xl font-bold">${Math.round(hour.temp_c)}Â°</span>
                `;
                container.appendChild(card);
            });
        }

        function renderAdvancedWeatherCards(data) {
            const container = document.getElementById('location-temps-container');
            if (!container) return;
            container.innerHTML = '';
             // Change layout to a flex column to stack the cards vertically
            container.className = 'flex flex-col gap-4 w-full flex-grow';

            // Create a container for the top two cards (Humidity and Best Time)
            const topCardsContainer = document.createElement('div');
            topCardsContainer.className = 'grid grid-cols-2 gap-4 w-full flex-grow';
            container.appendChild(topCardsContainer); // Append this container first

            // Card 1: Humidity
            const humidity = data.current.humidity;
            let humidityColor = 'text-green-400';
            let humidityDesc = 'Ù…Ù†Ø®ÙØ¶Ø©';
            if (humidity >= 60 && humidity < 75) {
                humidityColor = 'text-yellow-400';
                humidityDesc = 'Ù…Ø¹ØªØ¯Ù„Ø©';
            } else if (humidity >= 75 && humidity < 85) {
                humidityColor = 'text-orange-400';
                humidityDesc = 'Ù…Ø±ØªÙØ¹Ø©';
            } else if (humidity >= 85) {
                humidityColor = 'text-red-400';
                humidityDesc = 'Ù…Ø±ØªÙØ¹Ø© Ø¬Ø¯Ø§Ù‹';
            }

            const humidityCard = document.createElement('div');
            humidityCard.className = 'glass-surface glass-surface--svg p-4 rounded-3xl flex flex-col items-center justify-center text-center navigable grid-item';
            humidityCard.tabIndex = 0;
            humidityCard.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="droplets" class="w-8 h-8 ${humidityColor}"></i>
                    <h3 class="text-xl font-bold">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</h3>
                </div>
                <div class="text-6xl font-extrabold ${humidityColor}">${humidity}%</div>
                <div class="text-lg text-white/80 mt-2">${humidityDesc}</div>
            `;
            topCardsContainer.appendChild(humidityCard);

            // Card 2: Best Time to Go Out (with 30-min intervals for next 6 hours)
            const hourlyData = [...data.forecast.forecastday[0].hour, ...data.forecast.forecastday[1]?.hour || []];
            const now = new Date();
            const sixHoursFromNowEpoch = (now.getTime() / 1000) + (6 * 3600);

            // Get the next 7 hours to have enough data for interpolation
            const upcomingRawHours = hourlyData.filter(h => new Date(h.time_epoch * 1000) > now).slice(0, 7);
            
            const interpolatedSlots = [];
            // Create slots for every 30 mins over the next 6 hours
            if (upcomingRawHours.length > 1) {
                for (let i = 0; i < upcomingRawHours.length - 1; i++) {
                    const currentHour = upcomingRawHours[i];
                    const nextHour = upcomingRawHours[i+1];

                    // Add the current full hour
                    interpolatedSlots.push(currentHour);

                    // Create the half-hour slot
                    const halfHourSlot = {
                        time_epoch: currentHour.time_epoch + 1800,
                        temp_c: (currentHour.temp_c + nextHour.temp_c) / 2,
                        uv: (currentHour.uv + nextHour.uv) / 2,
                        humidity: (currentHour.humidity + nextHour.humidity) / 2
                    };
                    interpolatedSlots.push(halfHourSlot);
                }
            } else if (upcomingRawHours.length === 1) {
                interpolatedSlots.push(upcomingRawHours[0]);
            }

            // Filter the final list to be strictly within the next 6 hours
            const next6HourSlots = interpolatedSlots.filter(slot => slot.time_epoch <= sixHoursFromNowEpoch);

            let bestHour = null;
            let bestScore = Infinity;

            if (next6HourSlots.length > 0) {
                next6HourSlots.forEach(hour => {
                    // ØªØ­Ø¯ÙŠØ« Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·: Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ø£Ù‚Ù„ØŒ Ø«Ù… Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ù„ØŒ Ø«Ù… Ø§Ù„Ø£Ø´Ø¹Ø© ÙÙˆÙ‚ Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠØ© Ø§Ù„Ø£Ù‚Ù„
                    const score = (hour.humidity * 1000) + (hour.temp_c * 100) + hour.uv;
                    if (score < bestScore) {
                        bestScore = score;
                        bestHour = hour;
                    }
                });
            } else {
                 // Fallback if no data is available
                 bestHour = { time_epoch: Date.now()/1000 + 3600, temp_c: data.current.temp_c, uv: data.current.uv, humidity: data.current.humidity };
            }


            const bestTime = new Date(bestHour.time_epoch * 1000).toLocaleTimeString('ar-OM', { hour: 'numeric', minute: '2-digit', hour12: true });

            const bestTimeCard = document.createElement('div');
            bestTimeCard.className = 'glass-surface glass-surface--svg p-4 rounded-3xl flex flex-col items-center justify-center text-center navigable grid-item';
            bestTimeCard.tabIndex = 0;
            bestTimeCard.innerHTML = `
                <div class="flex items-center gap-3 mb-3">
                     <i data-lucide="walk" class="w-8 h-8 text-green-300"></i>
                    <h3 class="text-xl font-bold">Ø£ÙØ¶Ù„ ÙˆÙ‚Øª Ù„Ù„Ø®Ø±ÙˆØ¬</h3>
                </div>
                <div class="text-4xl font-extrabold text-green-300 mb-3">${bestTime}</div>
                <div class="grid grid-cols-3 gap-2 text-sm w-full">
                    <div class="bg-black/20 p-2 rounded-lg text-center">
                        <div class="font-bold text-lg ${getTempTextColor(bestHour.temp_c)}">${Math.round(bestHour.temp_c)}Â°C</div>
                        <div class="text-xs opacity-90">Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div>
                    </div>
                    <div class="bg-black/20 p-2 rounded-lg text-center">
                        <div class="font-bold text-lg ${getUvTextColor(bestHour.uv)}">${Math.round(bestHour.uv)}</div>
                        <div class="text-xs opacity-90">UV</div>
                    </div>
                    <div class="bg-black/20 p-2 rounded-lg text-center">
                        <div class="font-bold text-lg ${getHumidityTextColor(bestHour.humidity)}">${bestHour.humidity}%</div>
                        <div class="text-xs opacity-90">Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div>
                    </div>
                </div>
            `;
            topCardsContainer.appendChild(bestTimeCard);
            
            // NOW, create and append the horizontal card LAST to the main container
            const currentConditions = data.current;
            const aqi = currentConditions.air_quality ? currentConditions.air_quality['us-epa-index'] : null;

            const nowCard = document.createElement('div');
            nowCard.className = 'glass-surface glass-surface--svg p-4 rounded-3xl w-full flex justify-around items-center text-center navigable grid-item';
            nowCard.tabIndex = 0;
            nowCard.innerHTML = `
                <div class="flex flex-col items-center gap-2">
                    <h4 class="text-sm font-bold text-white/70">Ù…Ø¤Ø´Ø± UV</h4>
                    <div class="text-2xl font-bold px-4 py-1 rounded-lg ${getUvColor(currentConditions.uv)}">
                        ${currentConditions.uv || '--'}
                  </div>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <h4 class="text-sm font-bold text-white/70">Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¢Ù†</h4>
                    <div class="text-2xl font-bold px-4 py-1 rounded-lg ${getTempColor(currentConditions.temp_c)}">
                        ${Math.round(currentConditions.temp_c)}Â°C
                    </div>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <h4 class="text-sm font-bold text-white/70">Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡</h4>
                    <div class="text-2xl font-bold px-4 py-1 rounded-lg ${getAqiColor(aqi)}">
                        ${aqi || '--'}
                    </div>
                </div>
            `;
            container.appendChild(nowCard);

            lucide.createIcons();
        }

        function getUvIndexColor(uv) { if (uv <= 2) return '#4ade80'; if (uv <= 5) return '#facc15'; if (uv <= 7) return '#fb923c'; if (uv <= 10) return '#f87171'; return '#c084fc'; }

        // --- NEW COLORING FUNCTIONS ---
        const getTempColor = (temp) => {
            const tempValue = parseFloat(temp);
            if (tempValue < 25) return 'bg-blue-500 text-white';
            if (tempValue <= 30) return 'bg-green-500 text-white';
            if (tempValue <= 35) return 'bg-yellow-400 text-black';
            return 'bg-red-500 text-white';
        };

        const getHumidityColorBestTime = (humidity) => {
            const humidityValue = parseInt(humidity);
            if (humidityValue < 60) return 'bg-cyan-500/90 text-white';
            if (humidityValue < 75) return 'bg-yellow-400/90 text-black';
            return 'bg-orange-500/90 text-white';
        };

        const getAqiColor = (aqi) => {
            const aqiValue = parseInt(aqi);
            if (aqiValue <= 1) return 'bg-green-500 text-white'; // US EPA Index 1-50 is 1
            if (aqiValue <= 2) return 'bg-yellow-400 text-black'; // 51-100 is 2
            if (aqiValue <= 3) return 'bg-orange-500 text-white'; // 101-150 is 3
            if (aqiValue <= 4) return 'bg-red-500 text-white'; // 151-200 is 4
            if (aqiValue <= 5) return 'bg-purple-500 text-white'; // 201-300 is 5
            return 'bg-red-800 text-white'; // > 300
        };

        const getUvColor = (uv) => {
            const uvValue = Math.round(uv);
            if (uvValue <= 2) return 'bg-green-500 text-white';
            if (uvValue <= 5) return 'bg-yellow-400 text-black';
            if (uvValue <= 7) return 'bg-orange-500 text-white';
            if (uvValue <= 10) return 'bg-red-500 text-white';
            return 'bg-purple-500 text-white';
        };

        // --- NEW TEXT COLORING FUNCTIONS ---
        const getTempTextColor = (temp) => {
            const tempValue = parseFloat(temp);
            if (tempValue < 25) return 'text-blue-400';
            if (tempValue <= 30) return 'text-green-400';
            if (tempValue <= 35) return 'text-yellow-400';
            return 'text-red-400';
        };

        const getHumidityTextColor = (humidity) => {
            const humidityValue = parseInt(humidity);
            if (humidityValue < 60) return 'text-cyan-400';
            if (humidityValue < 75) return 'text-yellow-400';
            return 'text-orange-400';
        };
        
        const getUvTextColor = (uv) => {
            const uvValue = Math.round(uv);
            if (uvValue <= 2) return 'text-green-400';
            if (uvValue <= 5) return 'text-yellow-400';
            if (uvValue <= 7) return 'text-orange-400';
            if (uvValue <= 10) return 'text-red-400';
            return 'text-purple-400';
        };


        // --- Simulated Car Data ---
        function simulateOtherCarData() { 
            
            appState.car.temp = (Math.random() * 30 + 70).toFixed(1); 
            update3dScreenWidgets(); 
        }
   
const prayerTimes = [
    {"date":"2026-02-01","day":"Ø§Ù„Ø£Ø­Ø¯","fajr":"05:41","sunrise":"06:55","dhuhr":"12:42","asr":"15:59","maghrib":"18:24","isha":"19:34"},
    {"date":"2026-02-02","day":"Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","fajr":"05:41","sunrise":"06:55","dhuhr":"12:42","asr":"15:59","maghrib":"18:25","isha":"19:34"},
    {"date":"2026-02-03","day":"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","fajr":"05:40","sunrise":"06:55","dhuhr":"12:42","asr":"15:59","maghrib":"18:25","isha":"19:34"},
    {"date":"2026-02-04","day":"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","fajr":"05:40","sunrise":"06:54","dhuhr":"12:43","asr":"16:00","maghrib":"18:26","isha":"19:35"},
    {"date":"2026-02-05","day":"Ø§Ù„Ø®Ù…ÙŠØ³","fajr":"05:40","sunrise":"06:54","dhuhr":"12:43","asr":"16:00","maghrib":"18:26","isha":"19:35"},
    {"date":"2026-02-06","day":"Ø§Ù„Ø¬Ù…Ø¹Ø©","fajr":"05:40","sunrise":"06:54","dhuhr":"12:43","asr":"16:00","maghrib":"18:27","isha":"19:36"},
    {"date":"2026-02-07","day":"Ø§Ù„Ø³Ø¨Øª","fajr":"05:40","sunrise":"06:53","dhuhr":"12:43","asr":"16:01","maghrib":"18:27","isha":"19:36"},
    {"date":"2026-02-08","day":"Ø§Ù„Ø£Ø­Ø¯","fajr":"05:39","sunrise":"06:53","dhuhr":"12:43","asr":"16:01","maghrib":"18:28","isha":"19:36"},
    {"date":"2026-02-09","day":"Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","fajr":"05:39","sunrise":"06:53","dhuhr":"12:43","asr":"16:01","maghrib":"18:28","isha":"19:37"},
    {"date":"2026-02-10","day":"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","fajr":"05:39","sunrise":"06:52","dhuhr":"12:43","asr":"16:01","maghrib":"18:28","isha":"19:37"},
    {"date":"2026-02-11","day":"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","fajr":"05:38","sunrise":"06:52","dhuhr":"12:43","asr":"16:01","maghrib":"18:29","isha":"19:37"},
    {"date":"2026-02-12","day":"Ø§Ù„Ø®Ù…ÙŠØ³","fajr":"05:38","sunrise":"06:51","dhuhr":"12:43","asr":"16:02","maghrib":"18:29","isha":"19:38"},
    {"date":"2026-02-13","day":"Ø§Ù„Ø¬Ù…Ø¹Ø©","fajr":"05:38","sunrise":"06:51","dhuhr":"12:43","asr":"16:02","maghrib":"18:30","isha":"19:38"},
    {"date":"2026-02-14","day":"Ø§Ù„Ø³Ø¨Øª","fajr":"05:37","sunrise":"06:51","dhuhr":"12:43","asr":"16:02","maghrib":"18:30","isha":"19:38"},
    {"date":"2026-02-15","day":"Ø§Ù„Ø£Ø­Ø¯","fajr":"05:37","sunrise":"06:50","dhuhr":"12:43","asr":"16:02","maghrib":"18:30","isha":"19:39"},
    {"date":"2026-02-16","day":"Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","fajr":"05:37","sunrise":"06:50","dhuhr":"12:43","asr":"16:02","maghrib":"18:31","isha":"19:39"},
    {"date":"2026-02-17","day":"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","fajr":"05:36","sunrise":"06:49","dhuhr":"12:43","asr":"16:02","maghrib":"18:31","isha":"19:39"},
    {"date":"2026-02-18","day":"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","fajr":"05:36","sunrise":"06:49","dhuhr":"12:43","asr":"16:03","maghrib":"18:32","isha":"19:40"},
    {"date":"2026-02-19","day":"Ø§Ù„Ø®Ù…ÙŠØ³","fajr":"05:35","sunrise":"06:48","dhuhr":"12:43","asr":"16:03","maghrib":"18:32","isha":"19:40"},
    {"date":"2026-02-20","day":"Ø§Ù„Ø¬Ù…Ø¹Ø©","fajr":"05:35","sunrise":"06:48","dhuhr":"12:42","asr":"16:03","maghrib":"18:32","isha":"19:40"},
    {"date":"2026-02-21","day":"Ø§Ù„Ø³Ø¨Øª","fajr":"05:34","sunrise":"06:47","dhuhr":"12:42","asr":"16:03","maghrib":"18:33","isha":"19:40"},
    {"date":"2026-02-22","day":"Ø§Ù„Ø£Ø­Ø¯","fajr":"05:34","sunrise":"06:46","dhuhr":"12:42","asr":"16:03","maghrib":"18:33","isha":"19:41"},
    {"date":"2026-02-23","day":"Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","fajr":"05:33","sunrise":"06:46","dhuhr":"12:42","asr":"16:03","maghrib":"18:33","isha":"19:41"},
    {"date":"2026-02-24","day":"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","fajr":"05:33","sunrise":"06:45","dhuhr":"12:42","asr":"16:03","maghrib":"18:34","isha":"19:41"},
    {"date":"2026-02-25","day":"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","fajr":"05:32","sunrise":"06:45","dhuhr":"12:42","asr":"16:03","maghrib":"18:34","isha":"19:41"},
    {"date":"2026-02-26","day":"Ø§Ù„Ø®Ù…ÙŠØ³","fajr":"05:32","sunrise":"06:44","dhuhr":"12:42","asr":"16:03","maghrib":"18:34","isha":"19:42"},
    {"date":"2026-02-27","day":"Ø§Ù„Ø¬Ù…Ø¹Ø©","fajr":"05:31","sunrise":"06:43","dhuhr":"12:41","asr":"16:03","maghrib":"18:35","isha":"19:42"}
];
function convertTo12Hour(time24h) {
    if (!time24h || typeof time24h !== 'string' || time24h === '--:--') {
        return time24h; // Return as is if invalid or not loaded
    }

    // Split the time string into hours and minutes
    const [hours24, minutes] = time24h.split(':').map(str => parseInt(str, 10));

    // Convert hours from 24h to 12h format
    let hours12 = hours24 % 12;

    // The hour '0' (midnight) should be '12' in 12-hour format
    hours12 = hours12 ? hours12 : 12;

    // Return the formatted string (we don't pad the hour, but keep minutes padded)
    return `${hours12}:${minutes.toString().padStart(2, '0')}`;
}


        function loadPrayerTimes() {
            const today = new Date().toISOString().split('T')[0];
            const data = prayerTimes.find(p => p.date === today);
            if (data) {
                appState.prayerTimes = { ...appState.prayerTimes, Fajr: data.fajr, Dhuhr: data.dhuhr, Asr: data.asr, Maghrib: data.maghrib, Isha: data.isha };
                prayerTimesContainer.innerHTML = '';
               const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                const prayerNames = { Fajr: 'Ø§Ù„ÙØ¬Ø±', Dhuhr: 'Ø§Ù„Ø¸Ù‡Ø±', Asr: 'Ø§Ù„Ø¹ØµØ±', Maghrib: 'Ø§Ù„Ù…ØºØ±Ø¨', Isha: 'Ø§Ù„Ø¹Ø´Ø§Ø¡' };
                const iqamaOffsets = { Fajr: 25, Dhuhr: 20, Asr: 20, Maghrib: 5, Isha: 20 };
                
                prayerOrder.forEach(key => {
                    const item = document.createElement('div');
                    item.className = 'prayer-time-item navigable grid-item';
                    item.tabIndex = 0;
                    
                    // 1. Get the 24-hour time
                    const time24h = data[key.toLowerCase()]; 
                    
                    // 2. Convert to 12-hour time (e.g., 3:30 Ù…)
                    const time12hDisplay = convertTo12HourWithAmPm(time24h); // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    
                    // 3. Calculate Iqama time (24h format string)
                    const iqamaTime24h = addMinutes(time24h, iqamaOffsets[key]); 
                    
                    // 4. Convert Iqama time for display (e.g., 3:50 Ù…)
                    const iqamaTime12hDisplay = convertTo12HourWithAmPm(iqamaTime24h); // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    
                    // 5. Update the inner HTML using the 12h format
                    item.innerHTML = `<span class="prayer-name">${prayerNames[key]}</span><span class="prayer-time">${time12hDisplay}</span><span class="prayer-iqama text-xs text-white/50">Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©: ${iqamaTime12hDisplay}</span>`;
                    
                    prayerTimesContainer.appendChild(item);
                });

                // Create a container for the action buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex gap-2 mt-2 homebtn';

                // Ruqyah Button
                const ruqyahButton = document.createElement('button');
                ruqyahButton.id = 'ruqyah-tv-button';
                ruqyahButton.className = 'navigable grid-item w-1/2 bg-teal-500/50 hover:bg-teal-400/50 text-white font-bold p-2 rounded-lg shadow-lg text-lg transition-all duration-300 ease-in-out flex items-center justify-center gap-2';
                ruqyahButton.innerHTML = `<i data-lucide="shield-check" class="w-6 h-6"></i><span>Ø§Ù„Ø±Ù‚ÙŠØ© Ø§Ù„Ø´Ø±Ø¹ÙŠØ©</span>`;
                ruqyahButton.tabIndex = 0;
                ruqyahButton.addEventListener('click', () => {
                setTimeout(() => searchYouTubeVideos('Ø§Ù„Ø±Ù‚ÙŠØ© Ø§Ù„Ø´Ø±Ø¹ÙŠØ© Ø§Ù„Ù†ÙÙŠØ³'), 100);
                switchApp('Media');
                });
                
                // Adhkar Button
                const adhkarButton = document.createElement('button');
                adhkarButton.id = 'adhkar-tv-button';
                adhkarButton.className = 'navigable grid-item w-1/2 bg-sky-500/50 hover:bg-sky-400/50 text-white font-bold p-2 rounded-lg shadow-lg text-lg transition-all duration-300 ease-in-out flex items-center justify-center gap-2';
                adhkarButton.innerHTML = `<i data-lucide="sunrise" class="w-6 h-6"></i><span>Ø§Ù„Ø£Ø°ÙƒØ§Ø±</span>`;
                adhkarButton.tabIndex = 0;
                adhkarButton.addEventListener('click', () => {
                    setTimeout(() => searchYouTubeVideos('Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡'), 100);
                     switchApp('Media');
                });
                
                // Add buttons to their container, then add the container to the main prayer times area
                buttonContainer.appendChild(ruqyahButton);
                buttonContainer.appendChild(adhkarButton);
                prayerTimesContainer.appendChild(buttonContainer);

                lucide.createIcons();
                determineNextPrayer();
                updateDigitalClock();
            } else {
                prayerTimesContainer.innerHTML = `<p class="text-white/70 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª ØµÙ„Ø§Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</p>`;
            }
        }
        function addMinutes(time, min) { const [h, m] = time.split(':').map(Number); const d = new Date(); d.setHours(h, m + min, 0, 0); return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }); }
// -------------------------------------------------------------
// --- CORRECTED timeToDate function (Crucial for 24H -> Date conversion) ---
// -------------------------------------------------------------
// -------------------------------------------------------------
// --- CORRECTED timeToDate function (Uses CURRENT System Date) ---
// -------------------------------------------------------------
function timeToDate(time) {
    // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (24-hour format)
    const [h, m] = time.split(':').map(Number);
    
    // 2. Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Date Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† Ù„Ù„Ù†Ø¸Ø§Ù…
    const d = new Date();
    
    // 3. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
    // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù‡Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…ØŒ Ù„ÙƒÙ† Ø§Ù„ØªÙˆÙ‚ÙŠØª Ù‡Ùˆ ØªÙˆÙ‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© (Ù…Ø«Ù„ 15:30)
    d.setHours(h, m, 0, 0); 
    
    return d;
}

// -------------------------------------------------------------
// --- MODIFIED determineNextPrayer function (FINAL Time Context FIX) ---
// -------------------------------------------------------------
function determineNextPrayer() {
    const now = new Date();
    const todayTimings = appState.prayerTimes;
    if (!todayTimings.Fajr || todayTimings.Fajr === '--:--') return;

    // 1. Define constants
    const PRAYER_OFFSETS = { Fajr: 25, Dhuhr: 20, Asr: 20, Maghrib: 5, Isha: 15 };
    const PRAYER_GRACE = { Fajr: 5, Dhuhr: 15, Asr: 20, Maghrib: 20, Isha: 15 };
    const PRAYER_NAMES = { Fajr: 'Ø§Ù„ÙØ¬Ø±', Dhuhr: 'Ø§Ù„Ø¸Ù‡Ø±', Asr: 'Ø§Ù„Ø¹ØµØ±', Maghrib: 'Ø§Ù„Ù…ØºØ±Ø¨', Isha: 'Ø§Ù„Ø¹Ø´Ø§Ø¡' };
    const ORDER = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
    const FIVE_MINUTES = 5 * 60 * 1000;

    let prayerEvents = [];
    
    // 2. Populate Events for TODAY
    ORDER.forEach(key => {
        const pTime = timeToDate(todayTimings[key]);
        const iqamaTime = new Date(pTime.getTime() + PRAYER_OFFSETS[key] * 60000);
        const graceEnd = new Date(iqamaTime.getTime() + PRAYER_GRACE[key] * 60000);

        prayerEvents.push({ 
            name: PRAYER_NAMES[key], 
            azan: pTime, 
            iqama: iqamaTime, 
            graceEnd: graceEnd 
        });
    });

    // 3. Prepare Tomorrow's Fajr (and Iqama)
    const fajrTomorrow = timeToDate(todayTimings.Fajr);
    fajrTomorrow.setDate(fajrTomorrow.getDate() + 1);
    
    prayerEvents.push({
        name: 'Ø§Ù„ÙØ¬Ø± (ØºØ¯Ù‹Ø§)', azan: fajrTomorrow,
        iqama: new Date(fajrTomorrow.getTime() + PRAYER_OFFSETS.Fajr * 60000),
        graceEnd: new Date(fajrTomorrow.getTime() + PRAYER_OFFSETS.Fajr * 60000 + PRAYER_GRACE.Fajr * 60000)
    });


    // 4. Find CURRENT and NEXT States
    appState.prayerTimes.currentPrayer = null;
    appState.prayerTimes.currentPrayerIqamaTime = null;
    let nextEvent = null;
    let currentEvent = null;
    
    for (let i = prayerEvents.length - 1; i >= 0; i--) {
        const event = prayerEvents[i];
        if (now >= event.azan && now < event.graceEnd) {
              currentEvent = event;
              break;
        }
    }
    nextEvent = prayerEvents.find(event => event.azan > now);

    
    // 5. Set Final Application State
    if (currentEvent) {
        appState.prayerTimes.currentPrayer = currentEvent.name.replace(' (ØºØ¯Ù‹Ø§)', '');
        appState.prayerTimes.currentPrayerIqamaTime = currentEvent.iqama;

        if (now < currentEvent.iqama) {
            appState.prayerTimes.nextPrayer = appState.prayerTimes.currentPrayer;
            appState.prayerTimes.nextPrayerIqamaTime = currentEvent.iqama;
        } else if (nextEvent) {
            appState.prayerTimes.nextPrayer = nextEvent.name;
            appState.prayerTimes.nextPrayerIqamaTime = nextEvent.azan;
        }
    } else if (nextEvent) {
        appState.prayerTimes.nextPrayer = nextEvent.name;
        appState.prayerTimes.nextPrayerIqamaTime = nextEvent.azan;
    } else {
        appState.prayerTimes.nextPrayer = "Ø§Ù„ÙØ¬Ø± (ØºØ¯Ù‹Ø§)";
        appState.prayerTimes.nextPrayerIqamaTime = fajrTomorrow;
    }

    // ğŸš€ CRITICAL FIX: ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ Ù‚Ø¨Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©
    if (nextEvent && nextEvent.iqama) {
        const diffToIqama = nextEvent.iqama.getTime() - now.getTime();
        
        // ğŸ›‘ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† 0 Ùˆ 5 Ø¯Ù‚Ø§Ø¦Ù‚ (300,000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
        if (diffToIqama > 0 && diffToIqama <= FIVE_MINUTES) {
            const nextPrayerName = nextEvent.name.replace(' (ØºØ¯Ù‹Ø§)', '');
            const alertKey = `iqama_alert_${nextPrayerName}_${nextEvent.iqama.getHours()}`;
            
            // Ù†Ø³ØªØ®Ø¯Ù… localStorage Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ¥Ø·Ù„Ø§Ù‚Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
            if (localStorage.getItem(alertKey) !== 'sent') {
                playSpeechAnnouncement(`ØªÙ†Ø¨ÙŠÙ‡: ØªØ¨Ù‚Ù‰ Ø£Ù‚Ù„ Ù…Ù† Ø®Ù…Ø³ Ø¯Ù‚Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø¥Ù‚Ø§Ù…Ø© ØµÙ„Ø§Ø© ${nextPrayerName}.`);
                localStorage.setItem(alertKey, 'sent');
            }
        }
    }
    
    // 6. Render Updates
    renderPrayerTimesHighlights();
}

       function renderPrayerTimesHighlights() { if (!prayerTimesContainer) return; document.querySelectorAll('.prayer-time-item').forEach(i => i.classList.remove('current-prayer', 'next-prayer')); if (appState.prayerTimes.currentPrayer) { const item = Array.from(prayerTimesContainer.querySelectorAll('.prayer-name')).find(s => s.textContent === appState.prayerTimes.currentPrayer)?.parentElement; if (item) item.classList.add('current-prayer'); } if (appState.prayerTimes.nextPrayer && appState.prayerTimes.nextPrayer !== appState.prayerTimes.currentPrayer) { const nextPrayerName = appState.prayerTimes.nextPrayer.replace(' (ØºØ¯Ù‹Ø§)', ''); const item = Array.from(prayerTimesContainer.querySelectorAll('.prayer-name')).find(s => s.textContent === nextPrayerName)?.parentElement; if (item && !item.classList.contains('current-prayer')) item.classList.add('next-prayer'); } }
        
        // --- Digital Clock ---
        // --- Digital Clock ---
/**
 * Generates the current date string in YYYY-MM-DD format (e.g., 2025-11-03).
 * This is crucial for dynamic APIs that require date input.
 * @param {Date} date - The current Date object.
 * @returns {string} The formatted date string.
 */
function getTodayDateString(date) {
    const year = date.getFullYear();
    // getMonth() is 0-indexed, so we add 1.
    const month = (date.getMonth() + 1).toString().padStart(2, '0'); 
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function updateDigitalClock() {
    // 1. Get current system time (Crucial for icon logic)
    const now = new Date();
    const h24 = now.getHours(); // 24-hour format (0-23)
    let h12 = h24;
    const m = now.getMinutes();
    const s = now.getSeconds();
    
    // Convert to 12-hour format for display
    h12 = h12 % 12;
    h12 = h12 ? h12 : 12;

    // 2. Update the Digital Display
    digitalHoursSpan.textContent = h12; 
    digitalMinutesSpan.textContent = m.toString().padStart(2, '0');
    
    if (digitalSecondsSpan) {
        digitalSecondsSpan.textContent = s.toString().padStart(2, '0');
    }
    
    // --- 3. Update the TIME ICON Container (#time-icon-container) ---
    // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØ¹Ø±Ø¶ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø´Ù…Ø³/Ø§Ù„ØºÙŠÙˆÙ…/Ø§Ù„Ù‚Ù…Ø± Ø­Ø³Ø¨ Ø§Ù„ØªÙˆÙ‚ÙŠØª (ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª ÙÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    const iconContainer = document.getElementById('time-icon-container');
    if (iconContainer) {
        let iconSrc = '';
        
        // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© 24 (h24)
        if ((h24 > 8 || (h24 === 8 && m >= 30)) && (h24 < 17)) { 
            iconSrc = 'https://cdn.weatherapi.com/weather/64x64/day/113.png'; // Sun Icon
        } else if ((h24 >= 18 && h24 < 19)) { 
            iconSrc = 'https://cdn.weatherapi.com/weather/64x64/day/1087.png'; // Sunset Icon
        } else if (h24 >= 19 || h24 < 6 || (h24 === 6 && m === 0)) {
            // Night Time: Use a fixed moon icon (NOT the dynamic one, for simplicity)
            iconSrc = 'https://cdn.weatherapi.com/weather/64x64/night/113.png'; 
        } else if (h24 === 6 && m > 0 && m <= 30) { 
            iconSrc = 'https://cdn.weatherapi.com/weather/64x64/day/1087.png'; // Sunrise Icon
        } else if ((h24 === 6 && m > 30) || (h24 === 7) || (h24 === 8 && m <= 30) || (h24 >= 17 && h24 < 18)) { 
            iconSrc = 'https://cdn.weatherapi.com/weather/64x64/day/116.png'; // Cloudy/Sun Icon
        }
        
        if (iconSrc) {
            iconContainer.innerHTML = `<img src="${iconSrc}" alt="Time Icon" class="w-8 h-8 inline-block ml-2" style="transform: translateY(4px);">`;
        } else {
            iconContainer.innerHTML = '';
        }
    }
    
    // 4. Trigger Next Prayer Logic Updates
    determineNextPrayer(now); 
}

        // --- 360 Camera ---
        function handleImageUpload(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { appState.custom360Image = ev.target.result; localStorage.setItem('custom360Image', ev.target.result); updateUI(); }; reader.readAsDataURL(file); } }
        function resetImageToDefault() { appState.custom360Image = null; localStorage.removeItem('custom360Image'); updateUI(); }

        // --- NEW: 3D Screen Widgets Update ---
        /**
 * UPDATED & FINAL: Updates the informational widgets on the 3D Map/Screen-Map.
 * Ensures the Car data, Weather Temp, Moon widget, and Direction Buttons are synchronized.
 * CRITICAL FIX: Applies the current car direction (N, NE, etc.) as the heading
 * to the Google Map object in the Dashboard for an oriented view.
 */
function update3dScreenWidgets() {
    // Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ù†Ø§ØµØ± ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø´Ø§Ø´Ø© 3D
    const weatherTempEl = document.getElementById('3d-screen-weather-temp');
    const nextPrayerEl = document.getElementById('3d-screen-next-prayer');
    const speedEl = document.getElementById('3d-screen-speed');
    const gearEl = document.getElementById('3d-screen-gear');
    const dirEl = document.getElementById('3d-screen-dir');

    // 1. ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø·Ù‚Ø³ (Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± ÙˆØ§Ù„Ø£ÙŠÙ…Ù†)
    
    // ØªØ­Ø¯ÙŠØ« Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©
    if (weatherTempEl) {
        const temp = appState.weather.temperature !== null ? Math.round(appState.weather.temperature) : '--';
        weatherTempEl.textContent = `${temp}Â°C`;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    const currentCarDirection = appState.car.direction; // N, NE, E, etc.
    
    if (nextPrayerEl) nextPrayerEl.textContent = appState.prayerTimes.nextPrayer || '--';
    if (speedEl) speedEl.textContent = `${appState.car.speed} km/h`;
    if (gearEl) gearEl.textContent = appState.car.gear;
    if (dirEl) dirEl.textContent = currentCarDirection; // Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ø±ÙÙŠ

    // --- 2. ğŸ§­ ØªØ·Ø¨ÙŠÙ‚ Heading Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Dashboard ---
    if (dashboardGoogleMap) {
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ø±ÙÙŠ (N, SW) Ø¥Ù„Ù‰ Ø¯Ø±Ø¬Ø© Ø±Ù‚Ù…ÙŠØ© (0-360)
        const numericHeading = directionToDegrees(currentCarDirection); 
        
        // ğŸ›‘ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: ØªØ·Ø¨ÙŠÙ‚ Heading Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        dashboardGoogleMap.setHeading(numericHeading); 
        
        // ğŸ’¡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ£Ø«ÙŠØ± Ø£ÙØ¶Ù„ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªØ±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙŠØ¶Ø§Ù‹
        if (appState.currentLocation) {
            dashboardGoogleMap.setCenter(appState.currentLocation);
        }
    }

    // --- 3. ØªØ­Ø¯ÙŠØ« ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø¨ÙˆØµÙ„Ø© Ùˆ Ø§Ù„Ù‚Ù…Ø± ---
    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨ÙˆØµÙ„Ø© (Direction Buttons) Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ù†Ø§Ø¸Ø±
    updateDirectionButtons(); 
    
    // ØªØ­Ø¯ÙŠØ« ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ù‚Ù…Ø± (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„ÙŠÙ„Ø§Ù‹)
    update3dMoonWidget(); 
}
        /**
 * NEW: Updates the Moon Widget in the 3D screen using data from fetchWeatherData.
 */
/**
 * UPDATED: Updates the Moon Widget in the 3D screen (screen-Map).
 * It shows dynamic NASA Moon data ONLY during local nighttime (18:00 to 06:00).
 * Otherwise, it shows an inactive state.
 */
function update3dMoonWidget() {
    // ğŸ›‘ Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø´Ø§Ø´Ø© screen-Map (Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù†)
    const moonIcon = document.getElementById('3d-moon-icon');
    const moonPhase = document.getElementById('3d-moon-phase');
    const moonWidgetContainer = document.getElementById('3d-screen-moon-widget'); 

    if (!moonIcon || !moonPhase || !moonWidgetContainer) {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ù‚Ø¯ ØªÙƒÙˆÙ† ÙÙŠ Ø´Ø§Ø´Ø© Ø£Ø®Ø±Ù‰)ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹
        return;
    }

    const now = new Date();
    const currentHour = now.getHours();
    
    // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙØªØ±Ø© Ù„ÙŠÙ„ (6 Ù…Ø³Ø§Ø¡Ù‹ Ø­ØªÙ‰ 6 ØµØ¨Ø§Ø­Ø§Ù‹)
    const isNightTime = (currentHour >= 9 || currentHour < 6);

    if (isNightTime && appState.moonData && appState.moonData.phase !== undefined) {
        // 1. Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
        
        // ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ù…Ø± (phase) ØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙƒÙ€ Ø±Ù‚Ù… ÙÙŠ fetchNasaMoonData
        const phaseValue = appState.moonData.phase ? appState.moonData.phase.toFixed(1) : '--';
        
        // Ø§Ù„ØµÙˆØ±Ø© ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙƒÙ€ appState.dynamicMoonImageUrl
        moonIcon.src = appState.dynamicMoonImageUrl || 'https://cdn.weatherapi.com/weather/64x64/night/113.png';
        moonPhase.textContent = `${phaseValue}%`; 
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ø¨Ø­Ø§Ù„Ø© Ù†Ø´Ø·Ø©
        moonWidgetContainer.style.opacity = '1';
        moonWidgetContainer.style.display = 'flex'; 

    } else {
        // 2. Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ (Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ù…ÙˆÙ„/Ø¹Ø¯Ù… Ø§Ù„Ù†Ø´Ø§Ø·)
        
        // Ø¹Ø±Ø¶ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù‚Ù…Ø± Ø«Ø§Ø¨ØªØ© (Ù„Ù„ØªØµÙ†ÙŠÙ) Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©
        moonIcon.src = 'https://cdn.weatherapi.com/weather/64x64/night/113.png'; 
        moonPhase.textContent = '--%';
        
        // ğŸ’¡ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ø¨Ø´ÙØ§ÙÙŠØ© Ù…Ù†Ø®ÙØ¶Ø© Ù„ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ø£Ù†Ù‡ ØºÙŠØ± Ù†Ø´Ø· Ø§Ù„Ø¢Ù† (ÙˆÙ„ÙƒÙ†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ Layout)
        moonWidgetContainer.style.opacity = '0.3'; 
        moonWidgetContainer.style.display = 'flex'; 
    }
}

        // --- Draggable/Resizable Popup Logic ---
        let isDragging = false;
        let offsetX, offsetY;
        videoPopupContainer.addEventListener('mousedown', (e) => {
            if (e.target === videoPopupContainer || e.target.closest('.video-popup-controls')) {
                isDragging = true;
                offsetX = e.clientX - videoPopupContainer.offsetLeft;
                offsetY = e.clientY - videoPopupContainer.offsetTop;
                videoPopupContainer.style.cursor = 'grabbing';
                videoPopupPlayerContainer.style.pointerEvents = 'none';
            }
        });
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                videoPopupContainer.style.left = `${e.clientX - offsetX}px`;
                videoPopupContainer.style.top = `${e.clientY - offsetY}px`;
                videoPopupContainer.style.bottom = 'auto';
                videoPopupContainer.style.right = 'auto';
            }
        });
        document.addEventListener('mouseup', () => {
            isDragging = false;
            videoPopupContainer.style.cursor = 'grab';
            videoPopupPlayerContainer.style.pointerEvents = 'auto';
        });

        // --- Swipe Gesture Handling (NEW) ---
    

        // --- TV Remote / Keyboard Navigation ---
        let currentFocus = null;
        let navigableElements = []; // Global array for focusable items

        function updateNavigableElements() {
            // This function rebuilds the list of all currently visible, focusable elements.
            // It's called after the UI changes, like loading new search results or switching tabs.
            navigableElements = Array.from(
                document.querySelectorAll('.app-screen.active .navigable, nav .navigable, .video-popup-controls.grid-container .navigable, #bottom-left-controls .navigable, #floating-minimized-video-button.navigable')
            ).filter(el => el.offsetParent !== null && !el.closest('.hidden'));
        }

        function setFocus(el) { if (currentFocus) currentFocus.classList.remove('tv-focus'); if (el) { el.classList.add('tv-focus'); el.focus({ preventScroll: true }); currentFocus = el; el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' }); } else { if (currentFocus) currentFocus.classList.remove('tv-focus'); currentFocus = null; } }
        
        // --- MASTER KEY HANDLER (REFACTORED) ---
        function handleRemoteControlInput(e) {
    const key = e.key.toLowerCase();
    const activeEl = document.activeElement;

    // --- Ø§Ù„Ø£ÙˆÙ„ÙˆÙ„ÙŠØ© 1: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù†Ø´Ø·Ø§Ù‹ ---
    if (videoPopupContainer.classList.contains('active') || appState.isVideoPlayerMinimized) {
        const customHandledKeys = [
            'arrowup', 'arrowdown', 'arrowleft', 'arrowright',
            'enter', 'ok', 'p',
            'b', 'stop', 'red', 'colorf0red', 'x',
            'yellow', 'colorf2yellow', '8',
            '9' 
        ];

        if (customHandledKeys.includes(key)) {
            e.preventDefault();

            if (key === 'yellow' || key === 'colorf2yellow' || key === '8') {
                if (appState.isVideoPlayerMinimized) restoreVideoPopup();
                else minimizeVideoPopup();
                return;
            }
            if (key === 'b' || key === 'stop' || key === 'red' || key === 'colorf0red' || key === 'x') {
                hideVideoPopup();
                return;
            }
            if (key === 'enter' || key === 'ok' || key === 'p') {
                const playerState = popupPlayer.getPlayerState();
                if (playerState === YT.PlayerState.PLAYING) popupPlayer.pauseVideo();
                else popupPlayer.playVideo();
                return;
            }
            if (key === '9') {
                toggleFullScreen();
                return;
            }
        }
        return;
    }

    // --- Ø§Ù„Ø£ÙˆÙ„ÙˆÙ„ÙŠØ© 2: ÙˆØ¶Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ---
    const isSearchArea = activeEl === youtubeSearchInput || activeEl === youtubeSearchButton || activeEl === document.getElementById('add-video-by-url-btn');
    if (isSearchArea && key === 'arrowdown') {
        e.preventDefault();
        const activeScreen = document.querySelector('.app-screen.active');
        const firstContentItem = activeScreen.querySelector('.navigable, .grid-item');
        if (firstContentItem) setFocus(firstContentItem);
        return;
    }

    const isTyping = !youtubeSearchInput.readOnly && activeEl === youtubeSearchInput;
    if (isTyping) {
        if (key === 'enter' || key === 'ok') {
            e.preventDefault();
            youtubeSearchButton.click();
        } else if (key.length === 1 || key === 'backspace') {
            // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        } else {
            handleNavigationLogic(e); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ù‚Ù„ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰
        }
        return;
    }

    // --- Ø§Ù„Ø£ÙˆÙ„ÙˆÙ„ÙŠØ© 3: Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø°ÙƒÙŠ (Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯) ---
    handleNavigationLogic(e);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„ØªÙŠ ØªØ®ØªØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
function handleNavigationLogic(e) {
    const key = e.key.toLowerCase();
    const activeEl = document.activeElement;
    if (!activeEl) return;

    // ÙØ­Øµ: Ù‡Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø²Ù„Ù‚Ø© Ø£ÙÙ‚ÙŠØ©ØŸ
    const isHorizontalList = activeEl.closest('.favorites-dashboard-horizontal-scroll') || 
                             activeEl.closest('.scroll-viewport') ||
                             activeEl.closest('#favorites-popup-grid');

    if (isHorizontalList) {
        handleHorizontalMapping(key, activeEl);
    } else {
        handleGridMapping(key, activeEl);
    }
}

// Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙÙ‚ÙŠØ© (Dashboard & Suggestions)
function handleHorizontalMapping(key, el) {
    const parent = el.parentElement;
    const items = Array.from(parent.querySelectorAll('.grid-item'));
    const idx = items.indexOf(el);

    switch(key) {
        case 'arrowright': // ÙÙŠ RTL Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø£ÙŠÙ…Ù† ÙŠØ¹ÙˆØ¯ Ù„Ù„Ø®Ù„Ù
            if (idx > 0) setFocus(items[idx - 1]);
            else setFocus(document.querySelector('nav .app-icon.active')); // Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø±
            break;
        case 'arrowleft': // Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø£ÙŠØ³Ø± ÙŠØªÙ‚Ø¯Ù… Ù„Ù„Ø£Ù…Ø§Ù…
            if (idx < items.length - 1) setFocus(items[idx + 1]);
            break;
        case 'arrowup': // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ø£Ø¹Ù„Ù‰
            setFocus(document.getElementById('youtube-search-input'));
            break;
    }
}

// Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Channels & Reciters Grid)
function handleGridMapping(key, el) {
    const container = el.closest('.grid-container') || el.closest('.reader-container') || el.closest('.grid-content-area') || el.closest('.app-screen');
    if (!container) return;

    // Ø¬Ù„Ø¨ ÙƒØ§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø¸Ø§Ù‡Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø«Ø§Ø¨ØªØ©
    const items = Array.from(container.querySelectorAll('.navigable, .grid-item')).filter(i => {
        const style = window.getComputedStyle(i);
        // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ position: fixed Ø£Ùˆ Ø§Ù„Ù…Ø·Ù„Ù‚Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
        const isFloating = style.position === 'fixed' || i.closest('#floating-minimized-video-button') || i.closest('#floating-mic-button') || i.closest('#floating-media-button');
        return i.offsetParent !== null && style.display !== 'none' && style.visibility !== 'hidden' && !isFloating;
    });
    
    const idx = items.indexOf(el);
    if (idx === -1) return;

    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù†ÙØ³ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Top position)
    const currentRect = el.getBoundingClientRect();
    const rowItems = items.filter(item => {
        const rect = item.getBoundingClientRect();
        return Math.abs(rect.top - currentRect.top) < 5; // Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
    });
    
    // ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ ØµÙ ÙƒØ§Ù…Ù„
    const firstItemTop = items[0].getBoundingClientRect().top;
    const cols = items.filter(item => Math.abs(item.getBoundingClientRect().top - firstItemTop) < 5).length || 1;

    switch(key) {
        case 'arrowright': // Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ÙŠØ°Ù‡Ø¨ Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„ØªØ§Ù„ÙŠ (ÙŠÙ…ÙŠÙ†)
            if (idx < items.length - 1 && Math.abs(items[idx+1].getBoundingClientRect().top - currentRect.top) < 5) {
                setFocus(items[idx + 1]);
            }
            break;
        case 'arrowleft': // Ø§Ù„ÙŠØ³Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ÙŠØ°Ù‡Ø¨ Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø³Ø§Ø¨Ù‚ (ÙŠØ³Ø§Ø±) Ø£Ùˆ ÙŠØ¹ÙˆØ¯ Ù„Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø±
            if (idx > 0 && Math.abs(items[idx-1].getBoundingClientRect().top - currentRect.top) < 5) {
                setFocus(items[idx - 1]);
            } else {
                // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø±
                const activeSidebarIcon = document.querySelector('nav .app-icon.active');
                if (activeSidebarIcon) setFocus(activeSidebarIcon);
            }
            break;
        case 'arrowup': 
            if (idx >= cols) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø¹ ÙÙˆÙ‚Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹
                let bestMatch = items[idx - cols];
                let minDiff = Math.abs(bestMatch.getBoundingClientRect().left - currentRect.left);
                
                for (let i = Math.max(0, idx - cols - 5); i <= Math.min(items.length - 1, idx - cols + 5); i++) {
                    let diff = Math.abs(items[i].getBoundingClientRect().left - currentRect.left);
                    if (diff < minDiff && items[i].getBoundingClientRect().top < currentRect.top) {
                        minDiff = diff;
                        bestMatch = items[i];
                    }
                }
                setFocus(bestMatch);
            } else {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø£ÙˆÙ„ ØµÙØŒ Ù†Ø°Ù‡Ø¨ Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø«
                const searchControls = Array.from(document.querySelectorAll('#youtube-search-input, #youtube-search-button, #add-video-by-url-btn')).filter(el => el.offsetParent !== null);
                if (searchControls.length > 0) setFocus(searchControls[0]);
            }
            break;
        case 'arrowdown': 
            if (idx + cols < items.length) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø¹ ØªØ­ØªÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹
                let bestMatch = items[idx + cols];
                let minDiff = Math.abs(bestMatch.getBoundingClientRect().left - currentRect.left);
                
                for (let i = Math.max(0, idx + cols - 2); i <= Math.min(items.length - 1, idx + cols + 2); i++) {
                    let diff = Math.abs(items[i].getBoundingClientRect().left - currentRect.left);
                    if (diff < minDiff && items[i].getBoundingClientRect().top > currentRect.top) {
                        minDiff = diff;
                        bestMatch = items[i];
                    }
                }
                setFocus(bestMatch);
            }
            break;
        case 'enter': case 'ok': 
            el.click(); 
            break;
    }
}

       function handleNavSidebarNavigation(e, activeEl) {
    const icons = Array.from(document.querySelectorAll('nav .app-icon'));
    const idx = icons.indexOf(activeEl);
    let nextIdx = -1;
    
    const key = e.key.toLowerCase();

    switch (key) {
        case 'arrowup':
            nextIdx = idx > 0 ? idx - 1 : icons.length - 1;
            break;
        case 'arrowdown':
            nextIdx = idx < icons.length - 1 ? idx + 1 : 0;
            break;
        case 'arrowright': // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø¥Ù„Ù‰ Ø£ÙˆÙ„ Ø¹Ù†ØµØ± ÙŠØ³Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            const activeScreen = document.querySelector('.app-screen.active');
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø´Ø·Ø©
            const contentItems = Array.from(activeScreen.querySelectorAll('.navigable, .grid-item')).filter(i => {
                const style = window.getComputedStyle(i);
                return i.offsetParent !== null && style.display !== 'none' && style.visibility !== 'hidden' && style.position !== 'fixed';
            });
            
            if (contentItems.length > 0) {
                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹Ù‡Ø§ Ø§Ù„Ø£ÙÙ‚ÙŠ (Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†) ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„
                contentItems.sort((a, b) => a.getBoundingClientRect().left - b.getBoundingClientRect().left);
                setFocus(contentItems[0]);
            }
            break;
        case 'enter': case 'ok':
            activeEl.click();
            return;
    }
    if (nextIdx !== -1) setFocus(icons[nextIdx]);
}
        
        function handleMediaScreenNavigation(e, activeEl) {
            const searchRow = document.querySelector('#screen-Media .flex.flex-row.items-center.gap-2.grid-container');
            const readersContainer = document.querySelector('.reader-container');
            const surahContainer = document.querySelector('#youtube-surah-section');
            const videoListContainer = document.querySelector('#video-list-container');
            const searchResultsContainer = document.querySelector('#search-results-container');
            const inSearchRow = activeEl.closest('.flex.flex-row.items-center.gap-2.grid-container');
            const inReaders = activeEl.closest('.reader-container');

            if (e.key.toLowerCase() === 'arrowdown') {
                if (inSearchRow) {
                    const nextVisibleContainer = [readersContainer, surahContainer, videoListContainer, searchResultsContainer].find(c => c && c.offsetParent !== null);
                    if (nextVisibleContainer) {
                        const firstItem = nextVisibleContainer.querySelector('.grid-item');
                        if (firstItem) { setFocus(firstItem); return; }
                    }
                }
                if (inReaders) {
                    if (surahContainer && surahContainer.offsetParent !== null) {
                        const firstItem = surahContainer.querySelector('.grid-item');
                        if (firstItem) { setFocus(firstItem); return; }
                    }
                }
            }

            if (e.key.toLowerCase() === 'arrowup') {
                const currentContainer = activeEl.closest('.grid-container, .reader-container');
                if (currentContainer && currentContainer !== searchRow) {
                    const items = Array.from(currentContainer.querySelectorAll('.grid-item:not([style*="display: none"])')).filter(el => el.offsetParent !== null);
                    const idx = items.indexOf(activeEl);
                    if (idx !== -1) {
                        const firstItemTop = items[0].getBoundingClientRect().top;
                        let cols = items.filter(item => Math.abs(item.getBoundingClientRect().top - firstItemTop) < 20).length;
                        if (cols === 0) cols = 1;
                        if (idx < cols) { setFocus(youtubeSearchInput); return; }
                    }
                }
            }
            if (inReaders) {
                const items = Array.from(readersContainer.querySelectorAll('.grid-item'));
                const idx = items.indexOf(activeEl);
                if (e.key.toLowerCase() === 'arrowleft') { if (idx > 0) setFocus(items[idx - 1]); } 
                else if (e.key.toLowerCase() === 'arrowright') { if (idx < items.length - 1) setFocus(items[idx + 1]); } 
                else if (e.key.toLowerCase() === 'enter' || e.key.toLowerCase() === 'ok') { activeEl.click(); } 
                else if (e.key.toLowerCase() === 'arrowleft' && idx === 0) { const navIcon = document.querySelector('nav .app-icon.active'); if (navIcon) setFocus(navIcon); }
                return;
            }
            const container = activeEl.closest('.grid-container');
            if (container) { handleGenericGridNavigation(e, activeEl, container); }
        }

        function handleGenericGridNavigation(e, activeEl, container) {
            const items = Array.from(container.querySelectorAll('.grid-item:not([style*="display: none"])')).filter(el => el.offsetParent !== null);
            if (items.length === 0) return;
            const idx = items.indexOf(activeEl);
            if (idx === -1) return;
            const firstItemTop = items[0].getBoundingClientRect().top;
            let cols = items.filter(item => Math.abs(item.getBoundingClientRect().top - firstItemTop) < 20).length;
            if (cols === 0) cols = 1;
            const isTopRow = idx < cols;
            let nextIdx = -1;
            switch (e.key.toLowerCase()) {
                case 'arrowup': if (!isTopRow) { nextIdx = idx - cols; } break;
                case 'arrowdown': nextIdx = idx + cols; break;
                case 'arrowright': if (idx % cols !== 0) { nextIdx = idx - 1; } break;
                case 'arrowleft':
                    if ((idx + 1) % cols === 0 || idx === items.length - 1) {
                        const navIcon = document.querySelector('nav .app-icon.active');
                        if (navIcon) setFocus(navIcon);
                        return;
                    } else { nextIdx = idx + 1; }
                    break;
                case 'enter': case 'ok': activeEl.click(); return;
            }
            if (nextIdx >= 0 && nextIdx < items.length) { setFocus(items[nextIdx]); }
        }
        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‡Ø¬Ø±ÙŠ ÙÙˆÙ‚ Ø§Ù„Ù‚Ù…Ø±
function updateMoonHijriOverlay() {
    const today = new Date();
     const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);// Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø¬Ù„Ø¨ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù‡Ø¬Ø±ÙŠ
    const hijriDay = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {day: 'numeric'}).format(yesterday);
    
    // Ø±Ø¨Ø· Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const hijriOverlay = document.getElementById('hijri-moon-overlay');
    
    if (hijriOverlay) {
        hijriOverlay.innerText = hijriDay;
        console.log("ğŸŒ™ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù‡Ø¬Ø±ÙŠ ÙÙˆÙ‚ Ø§Ù„Ù‚Ù…Ø± Ø¥Ù„Ù‰: " + hijriDay);
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙˆØ±Ø§Ù‹
updateMoonHijriOverlay();
        // --- Welcome Voice Message ---
        function playWelcomeMessage() {
            const today = new Date();
            today.setFullYear(2026);
            const gregorianDate = new Intl.DateTimeFormat('en-UK', { month: 'long', day: 'numeric' }).format(today);
            const hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { weekday: 'long'}).format(today);
            const hijriDay = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {day: 'numeric'}).format(today);


            let welcomeText = '';
            let weatherText = '';

            const speak = (textToSpeak) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    const voices = window.speechSynthesis.getVoices();
                    // Try to find a male Arabic voice, fallback to any Arabic voice
                    let arabicVoice = voices.find(voice => voice.lang.startsWith('ar') && voice.name.includes('Male'));
                    if (!arabicVoice) {
                        arabicVoice = voices.find(voice => voice.lang.startsWith('ar'));
                    }
                    if (arabicVoice) {
                        utterance.voice = arabicVoice;
                    }
                    utterance.lang = 'ar-SA';
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.log('Text-to-speech not supported in this browser.');
                }
            };

            const speakWithVoicesReady = (text) => {
                 if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        speak(text);
                    };
                } else {
                    speak(text);
                }
            }
// 1. Ø§Ù„ØªØ­Ù‚



            
            // NEW/UPDATED: Event listener for the floating back button
            backToSearchFloatingButton.addEventListener('click', () => {
                // If we are on the suggestions screen AND we have a previous search to go back to...
                if (activeMediaView === 'suggestions' && lastSuccessfulSearchQuery) {
                    searchYouTubeVideos(lastSuccessfulSearchQuery); // ...then re-run that search.
                } else {
                    // Otherwise (i.e., we are on the search results screen), perform the original "back" action.
                    navigateBackToMainSearch();
                }
            });

            upload360ImageButton?.addEventListener('click', () => upload360ImageInput.click()); 
            upload360ImageInput?.addEventListener('change', handleImageUpload); 
            reset360ImageButton?.addEventListener('click', resetImageToDefault); 
            document.addEventListener('keydown', handleRemoteControlInput);

    // ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©: Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø±
    setTimeout(() => {
        const firstSidebarIcon = document.querySelector('nav .app-icon');
        if (firstSidebarIcon) setFocus(firstSidebarIcon);
    }, 1000);

    document.addEventListener('fullscreenchange', handleFullScreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullScreenChange); // For Safari
            
            videoPopupCloseButton.addEventListener('click', hideVideoPopup);
            backToPlaylistsFromVideosButton.addEventListener('click', navigateBackToMainSearch);
            backToPlaylistsBottomButton.addEventListener('click', navigateBackToMainSearch);
            backToPlaylistsBottomButtonSearch.addEventListener('click', navigateBackToMainSearch);
            floatingKeyboardButton.addEventListener('click', () => { 
                youtubeSearchInput.readOnly = !youtubeSearchInput.readOnly; 
                if (!youtubeSearchInput.readOnly) {
                    youtubeSearchInput.focus(); 
                } else {
                    youtubeSearchInput.blur();
                    // Return focus to the search button after disabling keyboard
                    setFocus(youtubeSearchButton);
                }
                floatingKeyboardButton.classList.toggle('active-keyboard', !youtubeSearchInput.readOnly); 
                floatingKeyboardButton.classList.toggle('inactive-keyboard', youtubeSearchInput.readOnly); 
            });
            
            // UPDATED: Clear button logic
            clearSearchButton.addEventListener('click', () => {
                youtubeSearchInput.value = ''; // Clear input immediately
                lastSuccessfulSearchQuery = null; // NEW: Clear the last search memory
                navigateBackToMainSearch();
            });

            youtubeSearchInput.addEventListener('focus', () => { if (youtubeSearchInput.value.trim() === '') { resetYoutubeSearchUI(); } });
            youtubeSearchButton.addEventListener('click', () => { const query = youtubeSearchInput.value.trim(); if (query) searchYouTubeVideos(query); else showMessageBox('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«.'); });
            
            // UPDATED: Auto-search for Tarteel channel with pre-click effect
            youtubeSearchInput.addEventListener('input', () => {
                const targetText = 'ØªØ±ØªÙŠÙ„-@TarteelArabic';
                const currentText = youtubeSearchInput.value;

                if (currentText.includes(targetText + ' ')) {
                    // If text with space is present, visually confirm and trigger the click
                    youtubeSearchButton.classList.add('tv-focus'); 
                    setTimeout(() => {
                        youtubeSearchButton.click();
                        // Optional: remove focus style after click to reset state
                        setTimeout(() => youtubeSearchButton.classList.remove('tv-focus'), 100);
                    }, 50);
                } else if (currentText.includes(targetText)) {
                    // If only the text (no space) is present, show pre-click effect
                    youtubeSearchButton.classList.add('tv-focus');
                } else {
                    // If the text is not present, remove the effect
                    youtubeSearchButton.classList.remove('tv-focus');
                }
            });

            // NEW Listeners for Animation and Zoom Controls
            pauseAnimationButton.addEventListener('click', () => {
                document.body.classList.toggle('animation-paused');
                const isPaused = document.body.classList.contains('animation-paused');
                const playIcon = pauseAnimationButton.querySelector('[data-lucide="play"]');
                const pauseIcon = pauseAnimationButton.querySelector('[data-lucide="pause"]');
                playIcon.classList.toggle('hidden', !isPaused);
                pauseIcon.classList.toggle('hidden', isPaused);
            });

            removeCacheButton.addEventListener('click', () => {
                localStorage.clear();
                showMessageBox('ØªÙ… Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            });

            zoomInButton.addEventListener('click', () => {
                if (currentFontSize < maxFontSize) {
                    currentFontSize += fontSizeStep;
                    document.documentElement.style.fontSize = `${currentFontSize}px`;
                }
            });

            zoomOutButton.addEventListener('click', () => {
                if (currentFontSize > minFontSize) {
                    currentFontSize -= fontSizeStep;
                    document.documentElement.style.fontSize = `${currentFontSize}px`;
                }
            });


if (!window.hasInitializedWeatherSpeaker) {

    // 2. Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ù† Ù‚Ø¨Ù„ØŒ Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ø±Ø³ ÙÙˆØ±Ø§Ù‹
    window.hasInitializedWeatherSpeaker = true;
    
    // 3. Ø§Ù„Ø¢Ù†ØŒ Ø¶Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§
    let hasSpokenWelcome = false; // Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù„Ù… Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­

    const checkWeatherAndSpeak = () => {
        // Ù†Ø·Ù‚ Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
        if (!hasSpokenWelcome) {
            const welcomeText = `Ù…Ø±Ø­Ø¨Ø§ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ${hijriDate} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${gregorianDate}`;
            speakWithVoicesReady(welcomeText);
            hasSpokenWelcome = true;
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù‚Ø³ Ø¬Ø§Ù‡Ø²Ø©ØŒ Ù†Ø·Ù‚Ù‡Ø§ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
        if (appState.weather.temperature !== null) {
            setTimeout(() => {
                const weatherText = `Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø¢Ù† ${appState.weather.temperature} Ø¯Ø±Ø¬Ø© Ù…Ø¦ÙˆÙŠØ©`;
                speakWithVoicesReady(weatherText);
            }, 7000);
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙƒØ±Ø± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
            setTimeout(checkWeatherAndSpeak, 500);
        }
    };

    // 4. Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø³ÙŠØ­Ø¯Ø« Ù‡Ø°Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
    checkWeatherAndSpeak();
}
// 5. ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø«Ø§Ù„Ø«Ø© Ø§Ù„ØªÙŠ ÙŠØ­Ø§ÙˆÙ„ ÙÙŠÙ‡Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ØŒ
// Ø³ÙŠÙØ´Ù„ Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø£ÙˆÙ„ (!window.hasInitializedWeatherSpeaker)
// ÙˆØ³ÙŠØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.

        }

        // --- Fullscreen Toggle ---
        function toggleFullScreen() {
            let elem;
            if (videoPopupContainer.classList.contains('active')) {
                elem = popupPlayer.getIframe();
            } else {
                elem = document.documentElement;
            }

            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
switchApp('Dashboard');
updateTrafficIndicators();
renderFavoritesDashboard();


document.addEventListener('DOMContentLoaded', () => {
    // 1. **Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ø¨ÙŠØ§Ù†Ø§Øª JSONBin (ASYNCHRONOUS)**
    // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
const recitersIframe = document.getElementById('reciters-iframe');
const iframeSrcButtons = document.querySelectorAll('#screen-Reciters .iframe-src-button');

    if (recitersIframe && iframeSrcButtons.length > 0) {
        iframeSrcButtons.forEach(button => {
            button.addEventListener('click', () => {
                const newSrc = button.dataset.src;
                if (newSrc && recitersIframe.src !== newSrc) {
                    console.log(`Changing iframe src to: ${newSrc}`);
                    recitersIframe.src = newSrc; // Change the iframe source

                    // Update active button state
                    iframeSrcButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                }
            });
        });
    }
window.initMap = function() { initMaps(); };
loadGoogleMaps().then(initMap);
loadPrayerTimes();
        // 3. ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©
        fetchWeatherData();
  // 1. ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¬Ù„Ø¨ Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ
    Promise.all([
        fetchRecitersList(),    // [0]
        fetchChannelsList(),    // [1]
        fetchFavorites('D'),    // [2] Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹Ø© Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
        fetchFavorites('M'),    // [3] Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹Ø© Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø§Ù„ØªÙ„ÙØ§Ø²
        fetchSuggestedVideos()  // [4] Ø§Ù„Ù€ 30 ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªÙŠ Ø¬Ù„Ø¨Ù†Ø§Ù‡Ø§ Ù…Ù† Ø§Ù„Ù€ 6 Ù‚Ù†ÙˆØ§Øª
    ]).then(results => {
        
        // âœ… Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµØ­ÙŠØ­ Ø­Ø³Ø¨ Ø§Ù„ÙÙ‡Ø±Ø³ (Index)
        favoritesD      = results[2] || [];
        favoritesM      = results[3] || []; 
        suggestedVideos = results[4] || []; // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙÙ‡Ø±Ø³ 4 Ù‡Ùˆ Ù„Ù€ fetchSuggestedVideos
        
        console.log(`[System] Initialized: ${favoritesD.length} Car Favs, ${suggestedVideos.length} Suggestions.`);

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´ ÙÙˆØ±Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© (Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØªØ§)
        if (suggestedVideos.length > 0) {
            localStorage.setItem('suggestedVideosCache', JSON.stringify(suggestedVideos));
            window.allFetchedVideos30 = suggestedVideos; // Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„ (Shuffle)
        }
 
        populateYoutubeSuggestions();
        
        
        migrateChannelData();
        
        // 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª
        startNextPrayerDetermination(); 
        startFullDateUpdates();         

        // 5. ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI)
        switchApp('Dashboard'); 
        renderFavoritesDashboard(); 
        centerMapOnUserLocation(); 
        updateTimerDisplay();
        renderDailyReminders();

        // ğŸš€ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø­Ø§Ø³Ù…: Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
        // Ù†Ø³ØªØ®Ø¯Ù… suggestedVideos Ù„Ø£Ù†Ù‡Ø§ Ø£ØµØ¨Ø­Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù€ 30 ÙÙŠØ¯ÙŠÙˆ
        renderSuggestedDashboard(suggestedVideos);

    }).catch(error => {
        console.error("Critical Initialization Failure:", error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ØŒ Ù†Ø­Ø§ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„ÙƒÙŠ Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø´Ø§Ø´Ø© ÙØ§Ø±ØºØ©
        renderSuggestedDashboard(); 
    });

    // 6. **ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± (Listeners & Button Bindings)**
    
    // Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const getMyLocationButtonDashboard = document.getElementById('get-my-location-button-dashboard');
    const goToHome1Button = document.getElementById('go-to-home-1-button');
    const goToHome2Button = document.getElementById('go-to-home-2-button');
    const minimizedRestoreBtn = document.getElementById('minimized-restore-btn');
    const minimizedPlayPauseBtn = document.getElementById('minimized-play-pause-btn');
    const videoPopupMinimizeButton = document.getElementById('video-popup-minimize-button');
    const floatingMinimizedVideoButton = document.getElementById('floating-minimized-video-button');
    const floatingMicButton = document.getElementById('floating-mic-button'); // ğŸ›‘ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const addVideoByUrlBtn = document.getElementById('add-video-by-url-btn');

    // ğŸ›‘ Ø±Ø¨Ø· Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·
    addVideoByUrlBtn?.addEventListener('click', promptAddVideoByUrl);

    // ğŸ’¡ Ù…Ù†Ø·Ù‚ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©
    const todayDate = new Date().toLocaleDateString('en-US');
    const lastReset = localStorage.getItem('lastPrayerAlertReset');

    if (lastReset !== todayDate) {
        for (const key in localStorage) {
            if (key.startsWith('iqama_alert_')) {
                localStorage.removeItem(key);
            }
        }
        localStorage.setItem('lastPrayerAlertReset', todayDate);
    }

    getMyLocationButtonDashboard?.addEventListener('click', centerMapOnUserLocation);
    floatingMediaButton?.addEventListener('click', () => switchApp('Media'));

    // ğŸ›‘ Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù„ØªØ¹ÙŠÙŠÙ† Marker ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…)
    goToHome1Button?.addEventListener('click', () => {
        displayLocationMarker(HOME1_COORDS, 'Ø¥Ø´Ø§Ø±Ø§Øª Ù‚'); 
    });
    goToHome2Button?.addEventListener('click', () => {
        displayLocationMarker(HOME2_COORDS, 'ØªÙ‚Ø§Ø·Ø¹ Ø´');
    });

    // ğŸ›‘ Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© (Minimize/Restore Logic)
    minimizedRestoreBtn?.addEventListener('click', restoreVideoPopup); 
    floatingMinimizedVideoButton?.addEventListener('click', restoreVideoPopup);

    // Listener Ø²Ø± Ø§Ù„ØªØµØºÙŠØ± Ù…Ù† Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚
    videoPopupMinimizeButton?.addEventListener('click', (e) => {
        e.stopPropagation();
        minimizeVideoPopup();
    });
    
    // Listener Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© (ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©)
    minimizedPlayPauseBtn?.addEventListener('click', (e) => {
        e.stopPropagation(); 
        if (popupPlayer && typeof popupPlayer.getPlayerState === 'function') {
            const playerState = popupPlayer.getPlayerState();
            if (playerState === YT.PlayerState.PLAYING) {
                popupPlayer.pauseVideo();
            } else {
                popupPlayer.playVideo();
            }
        }
    });

    // ğŸš€ Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ù†ÙØµÙ„Ø© (ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… data-rate ÙÙŠ HTML)
    document.querySelectorAll('#playback-rates-group .rate-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            const rateValue = e.currentTarget.dataset.rate; 
            setSpecificPlaybackRate(rateValue); 
        });
    });
    
    // ğŸ’¡ Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª
    document.addEventListener('click', (e) => {
        const reminderItem = e.target.closest('.reminder-item');
        const dropdownButton = e.target.closest('.reminder-status-dropdown button');

        if (dropdownButton) return;

        if (!reminderItem && !e.target.closest('.reminder-status-dropdown')) {
            closeAllDropdowns();
            return;
        }

        if (!reminderItem) return;

        e.stopPropagation();

        const existingDropdown = reminderItem.querySelector('.reminder-status-dropdown');

        if (existingDropdown) {
            existingDropdown.remove();
        } else {
            closeAllDropdowns();
            const reminderId = reminderItem.dataset.reminderId;
            const iconWrapper = reminderItem.querySelector('.icon-wrapper');
            if (iconWrapper) {
                 createReminderDropdown(reminderId, iconWrapper);
            }
        }
    });

    // ğŸ›‘ Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† (Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    floatingMicButton?.addEventListener('click', () => {
        if (currentAppIndex === appOrder.indexOf('Media')) {
            // Ù†ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¨Ø¯Ø£Ù‡
            if (floatingMicButton.classList.contains('recording')) {
                stopVoiceToText();
            } else {
                startVoiceToText();
            }
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ØŒ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„ÙŠÙ‡Ø§ Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            switchApp('Media');
            // Ù†Ø³ØªØ®Ø¯Ù… setTimeout Ù„Ø¶Ù…Ø§Ù† Ø§ÙƒØªÙ…Ø§Ù„ DOM Switch Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            setTimeout(startVoiceToText, 100); 
        }
    });

    // 7. **Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©**
    
    // ğŸ’¡ ÙŠØ¬Ø¨ ØªÙ‡ÙŠØ¦Ø© Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø·Ù‚Ø³ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
    if (!window.hasInitializedWeatherSpeaker) {
        window.hasInitializedWeatherSpeaker = true;
        let hasSpokenWelcome = false;

        const checkWeatherAndSpeak = () => {
             const today = new Date();
             today.setFullYear(2026);
             const gregorianDate = new Intl.DateTimeFormat('en-UK', { month: 'long', day: 'numeric' }).format(today);
             const hijriDate = new Intl.DateTimeFormat('ar-OM-u-ca-islamic', { weekday: 'long'}).format(today);

            const speak = (textToSpeak) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    const voices = window.speechSynthesis.getVoices();
                    let arabicVoice = voices.find(voice => voice.lang.startsWith('ar') && voice.name.includes('Male'));
                    if (!arabicVoice) {
                        arabicVoice = voices.find(voice => voice.lang.startsWith('ar'));
                    }
                    if (arabicVoice) {
                        utterance.voice = arabicVoice;
                    }
                    utterance.lang = 'ar-SA';
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.log('Text-to-speech not supported in this browser.');
                }
            };
            const speakWithVoicesReady = (text) => {
                 if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        speak(text);
                    };
                } else {
                    speak(text);
                }
            }

            if (!hasSpokenWelcome) {
                const welcomeText = `Ù…Ø±Ø­Ø¨Ø§ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ${hijriDate} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${gregorianDate}`;
                speakWithVoicesReady(welcomeText);
                hasSpokenWelcome = true;
            }

            if (appState.weather.temperature !== null) {
                setTimeout(() => {
                    const weatherText = `Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø¢Ù† ${appState.weather.temperature} Ø¯Ø±Ø¬Ø© Ù…Ø¦ÙˆÙŠØ©`;
                    speakWithVoicesReady(weatherText);
                }, 7000);
            } else {
                setTimeout(checkWeatherAndSpeak, 500);
            }
        };
        setTimeout(checkWeatherAndSpeak, 1500); 
    }


    upload360ImageButton?.addEventListener('click', () => upload360ImageInput.click()); 
    upload360ImageInput?.addEventListener('change', handleImageUpload); 
    reset360ImageButton?.addEventListener('click', resetImageToDefault); 
    document.addEventListener('keydown', handleRemoteControlInput);
    document.addEventListener('fullscreenchange', handleFullScreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullScreenChange); 
    
    videoPopupCloseButton.addEventListener('click', hideVideoPopup);
    backToPlaylistsFromVideosButton.addEventListener('click', navigateBackToMainSearch);
    backToPlaylistsBottomButton.addEventListener('click', navigateBackToMainSearch);
    backToPlaylistsBottomButtonSearch.addEventListener('click', navigateBackToMainSearch);
    floatingKeyboardButton.addEventListener('click', () => { 
        youtubeSearchInput.readOnly = !youtubeSearchInput.readOnly; 
        if (!youtubeSearchInput.readOnly) {
            youtubeSearchInput.focus(); 
        } else {
            youtubeSearchInput.blur();
            setFocus(youtubeSearchButton);
        }
        floatingKeyboardButton.classList.toggle('active-keyboard', !youtubeSearchInput.readOnly); 
        floatingKeyboardButton.classList.toggle('inactive-keyboard', youtubeSearchInput.readOnly); 
    });
    
    // UPDATED: Clear button logic
    clearSearchButton.addEventListener('click', () => {
        youtubeSearchInput.value = ''; 
        lastSuccessfulSearchQuery = null; 
        navigateBackToMainSearch();
    });

    youtubeSearchInput.addEventListener('focus', () => { if (youtubeSearchInput.value.trim() === '') { resetYoutubeSearchUI(); } });
    youtubeSearchButton.addEventListener('click', () => { const query = youtubeSearchInput.value.trim(); if (query) searchYouTubeVideos(query); else showMessageBox('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«.'); });
    
    // UPDATED: Auto-search for Tarteel channel with pre-click effect
    youtubeSearchInput.addEventListener('input', () => {
        const targetText = 'ØªØ±ØªÙŠÙ„-@TarteelArabic';
        const currentText = youtubeSearchInput.value;

        if (currentText.includes(targetText + ' ')) {
            youtubeSearchButton.classList.add('tv-focus'); 
            setTimeout(() => {
                youtubeSearchButton.click();
                setTimeout(() => youtubeSearchButton.classList.remove('tv-focus'), 100);
            }, 50);
        } else if (currentText.includes(targetText)) {
            youtubeSearchButton.classList.add('tv-focus');
        } else {
            youtubeSearchButton.classList.remove('tv-focus');
        }
    });

    // NEW Listeners for Animation and Zoom Controls
    pauseAnimationButton.addEventListener('click', () => {
        document.body.classList.toggle('animation-paused');
        const isPaused = document.body.classList.contains('animation-paused');
        const playIcon = pauseAnimationButton.querySelector('[data-lucide="play"]');
        const pauseIcon = pauseAnimationButton.querySelector('[data-lucide="pause"]');
        playIcon.classList.toggle('hidden', !isPaused);
        pauseIcon.classList.toggle('hidden', isPaused);
    });

    removeCacheButton.addEventListener('click', () => {
        const protectedKeys = [
        'dashboard_cached_data',     // ğŸ›¡ï¸ ÙƒØ§Ø´ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (Ø£Ù‡Ù… ÙˆØ§Ø­Ø¯ Ù„ØªÙˆÙÙŠØ± Ø§Ù„ÙƒÙˆØªØ§)
        'dashboard_cache_timestamp', // â° ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
        'yt_idx_1',                  // ğŸ”‘ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£ÙˆÙ„
        'yt_idx_2',                  // ğŸ”‘ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø§Ù†ÙŠ
        'playlist_car_mode',         // ğŸš— Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©
        'playlist_tv_mode',          // ğŸ“º Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ„ÙØ§Ø²
        'playlist_watch_later',      // â° Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
        'fav_dashboard_data',        // â¤ï¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©
        'FAV_CATEGORIES'             // ğŸ“‚ ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©
    ];

    let deletedCount = 0;

    // 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø­Ø°ÙÙ‡Ø§
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!protectedKeys.includes(key)) {
            keysToRemove.push(key);
        }
    }

    // 3. Ø§Ù„ØªÙ†ÙÙŠØ°: Ø­Ø°Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ØºÙŠØ± Ø§Ù„Ù…Ø­Ù…ÙŠØ© ÙÙ‚Ø·
    keysToRemove.forEach(key => {
        localStorage.removeItem(key);
        deletedCount++;
    });

    console.log(`ğŸ§¹ Cache Cleanup: Removed ${deletedCount} items. Protected Dashboard & Keys.`);

    // 4. Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    showMessageBox(`ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (${deletedCount} Ù…Ù„ÙØ§Øª). ØªÙ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ø´ ÙˆØ§Ù„Ù…ÙØ¶Ù„Ø©.`);
    
    setTimeout(() => {
        location.reload();
    }, 2000);
    });

    zoomInButton.addEventListener('click', () => {
        if (currentFontSize < maxFontSize) {
            currentFontSize += fontSizeStep;
            document.documentElement.style.fontSize = `${currentFontSize}px`;
        }
    });

    zoomOutButton.addEventListener('click', () => {
        if (currentFontSize > minFontSize) {
            currentFontSize -= fontSizeStep;
            document.documentElement.style.fontSize = `${currentFontSize}px`;
        }
    });
    
    // NEW/UPDATED: Event listener for the floating back button
    backToSearchFloatingButton.addEventListener('click', () => {
        if (activeMediaView === 'suggestions' && lastSuccessfulSearchQuery) {
            searchYouTubeVideos(lastSuccessfulSearchQuery); 
        } else {
            navigateBackToMainSearch();
        }
    });
});


async function getManualReminderStates() {
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID_REMINDERS}/latest`, {
            headers: {
                'X-Access-Key': JSONBIN_ACCESS_KEY_REMINDERS
            }
        });
        if (!response.ok) {
            console.error('Failed to fetch reminder states:', response.statusText);
            return {};
        }
        const data = await response.json();
        const states = data.record || {};
        
        // If the only thing in the bin is our placeholder, return an empty object
        if (Object.keys(states).length === 1 && states._init) {
            return {};
        }
        return states;

    } catch (error) {
        if (error instanceof SyntaxError) {
             console.log("Bin is likely empty or invalid. Returning default state.");
             return {};
        }
        console.error('Error in getManualReminderStates:', error);
        return {};
    }
}

async function setManualReminderState(reminderId, state) {
    let currentStates = await getManualReminderStates();
    
    if (state === 'auto') {
        delete currentStates[reminderId];
    } else {
        currentStates[reminderId] = state;
    }

    // âœ… THE FIX: If the object becomes empty, add a placeholder
    if (Object.keys(currentStates).length === 0) {
        currentStates = { "_init": true };
    }

    try {
        await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID_REMINDERS}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': JSONBIN_API_KEY
            },
            body: JSON.stringify(currentStates)
        });
    } catch (error) {
        console.error('Error writing to JSONBin:', error);
        showMessageBox('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©.');
    }
    
    // We pass the *real* state (without the placeholder) to the renderer
    if (currentStates._init) {
        renderDailyReminders({});
    } else {
        renderDailyReminders(currentStates);
    }
    closeAllDropdowns();
}

            // NEW: Function to create and manage the dropdown
            function createReminderDropdown(reminderId, parentElement) {
                closeAllDropdowns(); // Close any other open dropdowns first

                const dropdown = document.createElement('div');
                dropdown.className = 'reminder-status-dropdown show';
                dropdown.innerHTML = `
                    <button data-state="active" class="navigable grid-item" tabindex="0">Ø­Ø§Ù„ÙŠ</button>
                    <button data-state="completed" class="navigable grid-item" tabindex="0">Ù…Ù†ØªÙ‡ÙŠ</button>
                    <button data-state="missed" class="navigable grid-item" tabindex="0">ÙØ§Ø¦Øª</button>
                    <hr class="border-white/10 my-1">
                    <button data-state="auto" class="navigable grid-item" tabindex="0">ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                `;
                parentElement.appendChild(dropdown);

                dropdown.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the main click listener from firing again
                        const state = button.dataset.state;
                        setManualReminderState(reminderId, state);
                    });
                });
                 // Focus the first button in the dropdown
                const firstButton = dropdown.querySelector('button');
                if (firstButton) setFocus(firstButton);
            }

            function closeAllDropdowns() {
                document.querySelectorAll('.reminder-status-dropdown').forEach(d => d.remove());
            }

            // 1. ØªØ¹Ø±ÙŠÙ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø°ÙƒØ§Ø± ÙˆØ§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª Ù…Ø¹ Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø§
            const dailyReminders = [
    { id: 'adhkar_morning', name: 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­', icon: 'sunrise', isActive: (now, times) => now >= times.Fajr && now < times.Dhuhr, getStartTime: (now, times) => times.Fajr, getEndTime: (now, times) => times.Dhuhr, action: () => { switchApp('Media'); searchYouTubeVideos('Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ÙƒØ§Ù…Ù„Ø©'); } },
    { id: 'salat_duha', name: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¶Ø­Ù‰', icon: 'sun', isActive: (now, times) => { if (!times.Sunrise || !times.Dhuhr) return false; const sunriseTime = new Date(times.Sunrise.getTime() + 20 * 60000); const dhuhrTime = new Date(times.Dhuhr.getTime() - 10 * 60000); return now >= sunriseTime && now < dhuhrTime; }, getStartTime: (now, times) => { if (!times.Sunrise) return null; return new Date(times.Sunrise.getTime() + 20 * 60000); }, getEndTime: (now, times) => { if (!times.Dhuhr) return null; return new Date(times.Dhuhr.getTime() - 10 * 60000); }, action: () => showMessageBox('ØµÙ„Ø§Ø© Ø§Ù„Ø¶Ø­Ù‰ Ø³Ù†Ø© Ù…Ø¤ÙƒØ¯Ø©ØŒ ÙˆÙˆÙ‚ØªÙ‡Ø§ Ù…Ù† Ø¨Ø¹Ø¯ Ø´Ø±ÙˆÙ‚ Ø§Ù„Ø´Ù…Ø³ ÙˆØ§Ø±ØªÙØ§Ø¹Ù‡Ø§ Ù‚Ø¯Ø± Ø±Ù…Ø­ Ø¥Ù„Ù‰ Ù‚Ø¨ÙŠÙ„ ÙˆÙ‚Øª ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±.') },
    { id: 'sunan_rawatib', name: 'Ø§Ù„Ø³Ù†Ù† Ø§Ù„Ø±ÙˆØ§ØªØ¨', icon: 'calendar-check', isActive: (now, times) => { if (!times.Fajr || !times.Dhuhr || !times.Maghrib || !times.Isha) return false; const tenMinutes = 10 * 60 * 1000; if (now < times.Fajr && (times.Fajr.getTime() - now.getTime()) <= tenMinutes) return true; if (now < times.Dhuhr && (times.Dhuhr.getTime() - now.getTime()) <= tenMinutes) return true; if (now > times.Dhuhr && (now.getTime() - times.Dhuhr.getTime()) <= tenMinutes) return true; if (now > times.Maghrib && (now.getTime() - times.Maghrib.getTime()) <= tenMinutes) return true; if (now > times.Isha && (now.getTime() - times.Isha.getTime()) <= tenMinutes) return true; return false; }, getStartTime: null, getEndTime: null, action: () => showMessageBox('Ø§Ù„Ø³Ù†Ù† Ø§Ù„Ø±ÙˆØ§ØªØ¨: Ø±ÙƒØ¹ØªØ§Ù† Ù‚Ø¨Ù„ Ø§Ù„ÙØ¬Ø±ØŒ Ø£Ø±Ø¨Ø¹ Ù‚Ø¨Ù„ Ø§Ù„Ø¸Ù‡Ø±ØŒ Ø±ÙƒØ¹ØªØ§Ù† Ø¨Ø¹Ø¯Ù‡ØŒ Ø±ÙƒØ¹ØªØ§Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØºØ±Ø¨ØŒ ÙˆØ±ÙƒØ¹ØªØ§Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡.') },
    { id: 'adhkar_evening', name: 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡', icon: 'sunset', isActive: (now, times) => now >= times.Asr && now.getHours() < 23, getStartTime: (now, times) => times.Asr, getEndTime: (now, times) => { const d = new Date(now); d.setHours(22, 59, 59, 999); return d; }, action: () => { switchApp('Media'); searchYouTubeVideos('Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡ ÙƒØ§Ù…Ù„Ø©'); } },
    { id: 'wird_daily', name: 'Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ', icon: 'book-marked', isActive: (now, times) => true, getStartTime: null, getEndTime: null, action: () => switchApp('Quran') },
    { id: 'surah_mulk', name: 'Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ', icon: 'moon', isActive: (now, times) => now >= times.Isha || now < times.Fajr, getStartTime: (now, times) => times.Isha, getEndTime: (now, times) => { if (now < times.Fajr) return times.Fajr; return new Date(times.Fajr.getTime() + 24 * 60 * 60 * 1000); }, action: () => { switchApp('Media'); searchYouTubeVideos('Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ ÙƒØ§Ù…Ù„Ø©'); } },
                { id: 'salat_witr', name: 'ØµÙ„Ø§Ø© Ø§Ù„ÙˆØªØ±', icon: 'star', isActive: (now, times) => now >= times.Isha || now < times.Fajr, getStartTime: (now, times) => times.Isha, getEndTime: (now, times) => { if (now < times.Fajr) return times.Fajr; return new Date(times.Fajr.getTime() + 24 * 60 * 60 * 1000); }, action: () => showMessageBox('ØµÙ„Ø§Ø© Ø§Ù„ÙˆØªØ± Ø³Ù†Ø© Ù…Ø¤ÙƒØ¯Ø©ØŒ ÙˆØ£Ù‚Ù„Ù‡Ø§ Ø±ÙƒØ¹Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ ÙˆÙˆÙ‚ØªÙ‡Ø§ Ù…Ù† Ø¨Ø¹Ø¯ ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡ Ø¥Ù„Ù‰ Ø·Ù„ÙˆØ¹ Ø§Ù„ÙØ¬Ø±.') },
                { id: 'adhkar_sleep', name: 'Ù‚ÙŠØ§Ù… Ø§Ù„Ù„ÙŠÙ„ ', icon: 'bed', isActive: (now, times) => now.getHours() >= 23, getStartTime: (now, times) => { const d = new Date(now); d.setHours(23, 0, 0, 0); return d; }, getEndTime: (now, times) => { const d = new Date(now); d.setHours(23, 59, 59, 999); return d; }, action: () => { switchApp('Media'); searchYouTubeVideos('Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ…'); } }
            ];

            // 2. Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (MODIFIED)
         // âœ… Corrected Version of the function
async function renderDailyReminders(states) { // We added 'async' and 'states' here
    const container = document.getElementById('tv');
    if (!container || !appState.prayerTimes.Fajr || appState.prayerTimes.Fajr === '--:--') return;

    // If no states are passed in, fetch them. Otherwise, use the states that were passed.
    const manualStates = states || await getManualReminderStates(); // We added 'await' here

    const now = new Date();
    const prayerDateTimes = {
        Fajr: timeToDate(appState.prayerTimes.Fajr),
        Sunrise: timeToDate(appState.prayerTimes.Sunrise || '06:15'),
        Dhuhr: timeToDate(appState.prayerTimes.Dhuhr),
        Asr: timeToDate(appState.prayerTimes.Asr),
        Maghrib: timeToDate(appState.prayerTimes.Maghrib),
        Isha: timeToDate(appState.prayerTimes.Isha)
    };

    container.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'reminders-grid grid-container'; // Added grid-container for navigation
    grid.id = 'reminders-grid-container';

    dailyReminders.forEach(reminder => {
        const manualState = manualStates[reminder.id];
        let classList = 'reminder-item navigable grid-item';
        let iconName = '';

        if (manualState) {
            classList += ` ${manualState}`;
            switch (manualState) {
                case 'active':    iconName = 'clock'; break;
                case 'completed': iconName = 'check-check'; break;
                case 'missed':    iconName = 'x-circle'; break;
            }
        } else {
            const isActive = reminder.isActive(now, prayerDateTimes);
            let isUpcoming = false;
            if (reminder.getStartTime && !isActive) {
                const startTime = reminder.getStartTime(now, prayerDateTimes);
                if (startTime && startTime > now) { isUpcoming = true; }
            }
            let isCompleted = false;
            if (!isActive && !isUpcoming && reminder.getEndTime) {
                const endTime = reminder.getEndTime(now, prayerDateTimes);
                if (endTime && now > endTime) { isCompleted = true; }
            }

            if (isActive) { classList += ' active'; iconName = 'play-circle'; } 
            else if (isUpcoming) { classList += ' upcoming'; iconName = 'bell'; } 
            else if (isCompleted) { classList += ' completed'; iconName = 'check-check'; } 
            else { iconName = 'circle'; }
        }

        const item = document.createElement('div');
        item.className = classList;
        item.dataset.reminderId = reminder.id;
        item.tabIndex = 0;

        item.innerHTML = `
            <div class="icon-wrapper relative">
                <i data-lucide="${iconName || 'circle'}" class="icon w-12 h-12"></i>
            </div>
            <span class="text">${reminder.name}</span>
        `;
        grid.appendChild(item);
    });

    container.appendChild(grid);
    lucide.createIcons();
}

document.addEventListener('click', (e) => {
    const reminderItem = e.target.closest('.reminder-item');
    const dropdownButton = e.target.closest('.reminder-status-dropdown button');

    // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©ØŒ Ø¯Ø¹Ù‡ ÙŠØ¹Ù…Ù„ (Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡ Ø³ÙŠØ¹Ù…Ù„)
    if (dropdownButton) {
        return;
    }

    // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø¹Ù†ØµØ± ØªØ°ÙƒÙŠØ± ÙˆØ®Ø§Ø±Ø¬ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø©ØŒ Ø£ØºÙ„Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    if (!reminderItem && !e.target.closest('.reminder-status-dropdown')) {
        closeAllDropdowns();
        return;
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± ØªØ°ÙƒÙŠØ±ØŒ ØªÙˆÙ‚Ù Ù‡Ù†Ø§
    if (!reminderItem) return;

    // --- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ---
    // Ø£ÙˆÙ‚Ù Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø­Ø¯Ø« Ù„Ù…Ù†Ø¹ Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø£Ø®Ø±Ù‰
    e.stopPropagation();

    const reminderId = reminderItem.dataset.reminderId;
    const iconWrapper = reminderItem.querySelector('.icon-wrapper'); // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©

    if (!iconWrapper) return; // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©

    // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙØªÙˆØ­Ø© Ø¨Ø§Ù„ÙØ¹Ù„
    const existingDropdown = reminderItem.querySelector('.reminder-status-dropdown');

    if (existingDropdown) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©ØŒ Ø£ØºÙ„Ù‚Ù‡Ø§
        existingDropdown.remove();
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØºÙ„Ù‚Ø©ØŒ Ø£ØºÙ„Ù‚ Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ø£Ø®Ø±Ù‰ ÙˆØ§ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        closeAllDropdowns(); // Ø£ØºÙ„Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ Ø£ÙˆÙ„Ø§Ù‹
        createReminderDropdown(reminderId, iconWrapper); // Ø§ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    }
    // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ---

    // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù…Ø«Ù„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨)
});
            
          
            // --- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
// 3. Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù†Ù‚Ø± ÙˆØ§Ø­Ø¯ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (MODIFIED)

        // --- Athkar App Logic ---
        const tabSabah = document.getElementById('tab-sabah');
        const tabMasaa = document.getElementById('tab-masaa');
        const athkarSabahContent = document.getElementById('athkar-sabah-content');
        const athkarMasaaContent = document.getElementById('athkar-masaa-content');
        const tabMonthly = document.getElementById('tab-monthly');
        const athkarMonthlyContent = document.getElementById('athkar-monthly-content');

        if (tabSabah && tabMasaa && athkarSabahContent && athkarMasaaContent && tabMonthly && athkarMonthlyContent) {
            tabSabah.addEventListener('click', () => {
                tabSabah.classList.add('active');
                tabMasaa.classList.remove('active');
                tabMonthly.classList.remove('active');
                athkarSabahContent.classList.remove('hidden');
                athkarMasaaContent.classList.add('hidden');
                athkarMonthlyContent.classList.add('hidden');
                setFocus(tabSabah); // Keep focus on the active tab
            });

            tabMasaa.addEventListener('click', () => {
                tabMasaa.classList.add('active');
                tabSabah.classList.remove('active');
                tabMonthly.classList.remove('active');
                athkarMasaaContent.classList.remove('hidden');
                athkarSabahContent.classList.add('hidden');
                athkarMonthlyContent.classList.add('hidden');
                setFocus(tabMasaa); // Keep focus on the active tab
            });

            tabMonthly.addEventListener('click', () => {
                tabMonthly.classList.add('active');
                tabSabah.classList.remove('active');
                tabMasaa.classList.remove('active');
                athkarMonthlyContent.classList.remove('hidden');
                athkarSabahContent.classList.add('hidden');
                athkarMasaaContent.classList.add('hidden');
                setFocus(tabMonthly);
            });
        }
    </script>
</body> 
</html>
